<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Learning - 知也无涯</title>
  
  <subtitle>人生就是一个不断做减法的过程；</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://subtraction.tech/"/>
  <updated>2018-06-13T15:16:40.094Z</updated>
  <id>http://subtraction.tech/</id>
  
  <author>
    <name>执念</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>源代码编译安装Nginx</title>
    <link href="http://subtraction.tech/WEB/%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Nginx/"/>
    <id>http://subtraction.tech/WEB/源代码编译安装Nginx/</id>
    <published>2018-05-22T13:54:47.000Z</published>
    <updated>2018-06-13T15:16:40.094Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Nginx是一个免费、开源、高性能的HTTP服务和反向代理软件，也是一个IMAP/POP3代理服务，是为数不多解决了C10K问题的HTTP服务器之一。Nginx以其高性能、高并发、高度模块化、低内存消耗等特点闻名，具有多种Web服务器功能特性，如：负载均衡、缓存、访问控制、反向代理以及高效整合各种应用的能力，这些特性使得Nginx很适合于现代互联网架构。</p><a id="more"></a><p>Nginx作为一款优秀的开源软件，安装方法主要有以下两种，接下来介绍的是编译安装Nginx的方法；</p><ul><li><p>使用包管理器进行安装</p><ul><li>sudo apt-get install nginx       #基于deb包</li><li>sudo yum install nginx             #基于rpm包  </li></ul></li><li><p>使用源代码编译安装</p><ul><li><p>cd ./build/nginx-&lt;version-number> &amp;&amp; ./configure</p></li><li><p>make &amp;&amp; sudo make install</p></li></ul></li></ul><hr><h3 id="Nginx的常用编译选项"><a href="#Nginx的常用编译选项" class="headerlink" title="Nginx的常用编译选项"></a>Nginx的常用编译选项</h3><p>Nginx的编译选项众多，通过Nginx编译脚本的帮助选项，可以查看支持的所有编译选项，并且针对给出的每一个选项，都做了简单的介绍，通过下面的命令可以来了解一下。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> wget http://nginx.org/download/nginx-1.12.2.tar.gz<span class="comment">#通过wget将源码包下载到本地</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tar xvf nginx-1.12.2.tar.gz </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> nginx-1.12.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ./configure --<span class="built_in">help</span><span class="comment">#可以查看到所有支持的编译选项，并有简单的使用介绍</span></span></span><br></pre></td></tr></table></figure><p>由于篇幅原因不在这里对所有的选项都做说明，接下来我会参考RPM包中Nginx的编译选项，来对一些主要的编译选项做些介绍，使用<code>nginx -V</code>命令可以查看RPM包中Nginx使用的编译选项都有哪些；</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180530/7AhC4CBiei.png?imageslim" alt="mark"></p><h4 id="通用配置选项"><a href="#通用配置选项" class="headerlink" title="通用配置选项"></a>通用配置选项</h4><table><thead><tr><th style="text-align:left">选项</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">- -prefix=PATH</td><td style="text-align:left">Nginx安装的根路径，其它安装选项不明确指定安装路径，默认安装在此路径下</td></tr><tr><td style="text-align:left">- -sbin-path=PATH</td><td style="text-align:left">指定Nginx二进制文件的路径，如果没有指定，默认使用–prefix选项指定的路径</td></tr><tr><td style="text-align:left">- -modules-path=PATH</td><td style="text-align:left">指定模块文件放置的路径</td></tr><tr><td style="text-align:left">- -conf-path=PATH</td><td style="text-align:left">命令行未明确指定配置文件时，使用的配置文件所在路径</td></tr><tr><td style="text-align:left">- -error-log-path=PATH</td><td style="text-align:left">指定错误日志的路径</td></tr><tr><td style="text-align:left">- -pid-path=PATH</td><td style="text-align:left">指定写入nginx master进程pid的文件，通常在/var/run/下</td></tr><tr><td style="text-align:left">- -lock-path=PATH</td><td style="text-align:left">共享存储器互斥锁文件的路径</td></tr><tr><td style="text-align:left">- -user=USER</td><td style="text-align:left">运行worker进程的用户</td></tr><tr><td style="text-align:left">- -group=GROUP</td><td style="text-align:left">运行worker进程的组</td></tr><tr><td style="text-align:left">- -with-file-aio</td><td style="text-align:left">为Linux 2.6.22+ 系统启用异步I/O</td></tr><tr><td style="text-align:left">- -with-debug</td><td style="text-align:left">这个选项用于启用调试日志，在生产环境的系统中不推荐使用该选项</td></tr></tbody></table><h4 id="配置优化选项"><a href="#配置优化选项" class="headerlink" title="配置优化选项"></a>配置优化选项</h4><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>- -with-cc-opt=OPTIONS</td><td>设置将被添加到CFLAGS变量的附加参数</td></tr><tr><td>- -with-ld-opt=OPTIONS</td><td>设置将在链接期间使用的额外参数</td></tr></tbody></table><h4 id="HTTP配置选项"><a href="#HTTP配置选项" class="headerlink" title="HTTP配置选项"></a>HTTP配置选项</h4><table><thead><tr><th>选项</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>- -http-log-path=PATH</td><td style="text-align:left">http访问日志的默认路径</td></tr><tr><td>- -http-client-body-temp-path=PATH</td><td style="text-align:left">设置临时存储http客户端请求报文的目录路径</td></tr><tr><td>- -http-proxy-temp-path=PATH</td><td style="text-align:left">设置使用代理后存放临时文件的路径</td></tr><tr><td>–http-fastcgi-temp-path=PATH</td><td style="text-align:left">设置fastcgi后存放临时文件的路径</td></tr><tr><td>- -http-uwsgi-temp-path=PATH</td><td style="text-align:left">设置uwsgi后存放临时文件的路径</td></tr><tr><td>- -http-scgi-temp-path=PATH</td><td style="text-align:left">设置scgi后存放临时文件的路径</td></tr></tbody></table><h4 id="HTTP模块配置选项"><a href="#HTTP模块配置选项" class="headerlink" title="HTTP模块配置选项"></a>HTTP模块配置选项</h4><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>- -with-http_auth_request_module</td><td>启用构建ngx_http_auth_request_module模块，该模块基于子请求的结果实现客户端授权。默认情况下不生成此模块。</td></tr><tr><td>- -with-http_ssl_module</td><td>使用https协议进行通信，对通信的流量进行加密，需要依赖OpenSSL库。</td></tr><tr><td>- -with-http_v2_module</td><td>构建一个支持http协议2.0版本的模块，该模块默认是不生成的。</td></tr><tr><td>- -with-http_realip_module</td><td>Nginx在七层负载均衡器或者其它设备之后时，启用此模块，可以获取调度器转发的请求报文首部中真实客户端的IP。</td></tr><tr><td>- -with-http_addition_module</td><td>这是一个作为输出过滤器的模块，能够在一个请求经过location前或后时在该location自身添加内容。</td></tr><tr><td>- -with-http_xslt_module=dynamic</td><td>该模块用于处理XML响应转换，基于一个或多个XSLT格式，需要依赖libxml2和libxslt库。</td></tr><tr><td>- -with-http_image_filter_module=dynamic</td><td>该模块作为图像过滤器使用，在将图像发送给客户之前进行处理，需要依赖libgd库。</td></tr><tr><td>- -with-http_geoip_module=dynamic</td><td>使用该模块能，可以设置各种变量在配置文件中的区段使用，能够基于客户端的ip地址查找代理位置，需要依赖MaxMind GeoIP库和相应的预编译数据库文件。</td></tr><tr><td>- -with-http_sub_module</td><td>该模块实现替代过滤，在响应中用一个字符串替代另一个字符串，Note：使用该模块隐式禁用标头缓存。</td></tr><tr><td>- -with-http_dav_module</td><td>启用这个模块将激活使用WebDAV的配置指令，Note：建议该模块只有在需要时才进行启用，如果配置不正确可能会带来安全隐患。</td></tr><tr><td>- -with-http_flv_module</td><td>如果需要提供Flash流媒体视频文件，需要启用该模块提供伪流媒体。</td></tr><tr><td>- -with-http_mp4_module</td><td>该模块支持H.264/AA文件伪流媒体</td></tr><tr><td>- -with-http_gunzip_module</td><td>对于不支持gzip编码的客户，该模块用于为客户解压缩预压缩内容。</td></tr><tr><td>- -with-http_gzip_static_module</td><td>当被调用的资源是没有.gz结尾格式的文件时，如果想支持发送预压缩版本的静态文件，可以使用该模块。</td></tr><tr><td>- -with-http_random_index_module</td><td>启用这个模块可以提供从一个目录中随机选择文件的索引文件。</td></tr><tr><td>- -with-http_secure_link_module</td><td>该模块提供了一种机制，会将一个散列值链接到一个URL中，只有使用正确的密码才能计算出链接。</td></tr><tr><td>- -with-http_degradation_module</td><td>可以构建ngx_http_degradation_module模块，默认情况下，此模块是不构建的。</td></tr><tr><td>- -with-http_slice_module</td><td>构建将请求拆分为子请求的ngx_http_slice_module模块，每个子请求可以返回一定范围的响应，该模块为大的响应提供了更有效的缓存，默认情况下，此模块是不构建的。</td></tr><tr><td>- -with-http_stub_status_module</td><td>启用这个模块后会收集Nginx自身的状态信息</td></tr><tr><td>- -with-http_perl_module=dynamic</td><td>构建嵌入式Perl模块，该模块默认不生成。</td></tr></tbody></table><h4 id="邮件代理配置选项"><a href="#邮件代理配置选项" class="headerlink" title="邮件代理配置选项"></a>邮件代理配置选项</h4><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>- -with-mail=dynamic</td><td>动态启用POP3/IMAP4/SMTP代理模块</td></tr><tr><td>- -with-mail_ssl_module</td><td>构建一个支持SSL/TLS协议的邮件代理服务模块，该模块默认不生成，构建和运行需要依赖OpenSSL库。</td></tr></tbody></table><h4 id="反向代理配置选项"><a href="#反向代理配置选项" class="headerlink" title="反向代理配置选项"></a>反向代理配置选项</h4><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>- -with-stream=dynamic</td><td>动态启用构建stream module模块，作为通用的TCP/UDP代理和负载均衡流模块，该模块默认不构建。</td></tr><tr><td>- -with-stream_ssl_module</td><td>构建一个支持SSL/TLS协议的stream模块，该模块默认不生成，构建和运行需要依赖OpenSSL库。</td></tr></tbody></table><h4 id="其它配置选项"><a href="#其它配置选项" class="headerlink" title="其它配置选项"></a>其它配置选项</h4><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>- -with-ipv6</td><td>启用IPv6支持，在1.11.x后的版本编译时，已经不需要该编译选项</td></tr><tr><td>- -with-pcre</td><td>强制使用PCRE库</td></tr><tr><td>- -with-pcre-jit</td><td>使用即时编译构建PCRE库，支持1.1.12 pcre_jit指令</td></tr><tr><td>- -with-google_perftools_module</td><td>启用构建ngx_google_perftools_module模块，该模块可使用Google Performance Tools对nginx工作进程进行分析，该模块专供nginx开发人员使用，默认不会生成。</td></tr></tbody></table><h3 id="编译安装Nginx"><a href="#编译安装Nginx" class="headerlink" title="编译安装Nginx"></a>编译安装Nginx</h3><p>编译Nginx的最大好处是有很大的灵活性，安装位置和需要启用的功能模块都可以根据你的需求进行自定义，一些优化相关的功能是否启用，以及启用后使用的参数也是可以人为指定的。</p><p>源码编译Nginx对系统环境是有要求的，需要系统满足某些必要的编译条件，从最基本的gcc编译器到Nginx编译要启用的功能依赖到的开发库等，这些开发环境是编译的前提，缺一不可。</p><p>Nginx源码包可以到Nginx官网下载：<a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a></p><h4 id="准备编译环境"><a href="#准备编译环境" class="headerlink" title="准备编译环境"></a>准备编译环境</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//安装编译过程中需要依赖到的软件包</span><br><span class="line"><span class="meta">#</span><span class="bash"> yum -y groupinstall <span class="string">"Development Tools"</span> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum -y install pcre-devel openssl-devel zlib-devel libxslt-devel gd-devel perl-ExtUtils-Embed  perl-devel GeoIP-devel GeoIP-data gperftools-devel</span></span><br><span class="line">//创建运行Nginx worker进程的用户和组</span><br><span class="line"><span class="meta">#</span><span class="bash"> useradd -r  -s /sbin/nologin nginx</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> id nginx</span></span><br><span class="line">//将Nginx的源码包文件下载并解压到指定目录</span><br><span class="line"><span class="meta">#</span><span class="bash"> wget http://nginx.org/download/nginx-1.12.2.tar.gz <span class="comment">#通过wget将源码包下载到本地</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tar xvf nginx-1.12.2.tar.gz -C /usr/<span class="built_in">local</span>/src/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.12.2    <span class="comment">#编译过程需要在解压后生成的目录中进行</span></span></span><br></pre></td></tr></table></figure><h4 id="开始源代码编译"><a href="#开始源代码编译" class="headerlink" title="开始源代码编译"></a>开始源代码编译</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//编译过程中可以使用--with-&lt;module-name&gt;_module选项启用默认没有被安装的模块，也可以使用--without-&lt;module-name&gt;_module选项禁用默认安装的模块；</span></span><br><span class="line"><span class="comment">//下面是参考RPM包的安装选项进行的编译安装</span></span><br><span class="line"># ./configure --prefix=/usr/share/nginx \</span><br><span class="line">-<span class="ruby">-sbin-path=<span class="regexp">/usr/sbin</span><span class="regexp">/nginx \</span></span></span><br><span class="line"><span class="ruby">--modules-path=<span class="regexp">/usr/lib</span>64/nginx/modules \</span></span><br><span class="line"><span class="ruby">--conf-path=<span class="regexp">/etc/nginx</span><span class="regexp">/nginx.conf \</span></span></span><br><span class="line"><span class="ruby">--error-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/error</span>.log \</span></span><br><span class="line"><span class="ruby">--http-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/access</span>.log \</span></span><br><span class="line"><span class="ruby">--http-client-body-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/client_body \</span></span></span><br><span class="line"><span class="ruby">--http-proxy-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/proxy \</span></span></span><br><span class="line"><span class="ruby">--http-fastcgi-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/fastcgi \</span></span></span><br><span class="line"><span class="ruby">--http-uwsgi-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/uwsgi \</span></span></span><br><span class="line"><span class="ruby">--http-scgi-temp-path=<span class="regexp">/var/lib</span><span class="regexp">/nginx/tmp</span><span class="regexp">/scgi \</span></span></span><br><span class="line"><span class="ruby">--pid-path=<span class="regexp">/run/nginx</span>.pid \</span></span><br><span class="line"><span class="ruby">--lock-path=<span class="regexp">/run/lock</span><span class="regexp">/subsys/nginx</span> \</span></span><br><span class="line"><span class="ruby">--user=nginx \</span></span><br><span class="line"><span class="ruby">--group=nginx \</span></span><br><span class="line"><span class="ruby">--with-file-aio \</span></span><br><span class="line"><span class="ruby">--with-ipv6 \</span></span><br><span class="line"><span class="ruby">--with-http_auth_request_module \</span></span><br><span class="line"><span class="ruby">--with-http_ssl_module \</span></span><br><span class="line"><span class="ruby">--with-http_v2_module \</span></span><br><span class="line"><span class="ruby">--with-http_realip_module \</span></span><br><span class="line"><span class="ruby">--with-http_addition_module \</span></span><br><span class="line"><span class="ruby">--with-http_xslt_module=dynamic \</span></span><br><span class="line"><span class="ruby">--with-http_image_filter_module=dynamic \</span></span><br><span class="line"><span class="ruby">--with-http_geoip_module=dynamic \</span></span><br><span class="line"><span class="ruby">--with-http_sub_module \</span></span><br><span class="line"><span class="ruby">--with-http_dav_module \</span></span><br><span class="line"><span class="ruby">--with-http_flv_module \</span></span><br><span class="line"><span class="ruby">--with-http_mp4_module \</span></span><br><span class="line"><span class="ruby">--with-http_gunzip_module \</span></span><br><span class="line"><span class="ruby">--with-http_gzip_static_module \</span></span><br><span class="line"><span class="ruby">--with-http_random_index_module \</span></span><br><span class="line"><span class="ruby">--with-http_secure_link_module \</span></span><br><span class="line"><span class="ruby">--with-http_degradation_module \</span></span><br><span class="line"><span class="ruby">--with-http_slice_module \</span></span><br><span class="line"><span class="ruby">--with-http_stub_status_module \</span></span><br><span class="line"><span class="ruby">--with-http_perl_module=dynamic \</span></span><br><span class="line"><span class="ruby">--with-mail=dynamic \</span></span><br><span class="line"><span class="ruby">--with-mail_ssl_module \</span></span><br><span class="line"><span class="ruby">--with-pcre \</span></span><br><span class="line"><span class="ruby">--with-pcre-jit \</span></span><br><span class="line"><span class="ruby">--with-stream=dynamic \</span></span><br><span class="line"><span class="ruby">--with-stream_ssl_module \</span></span><br><span class="line"><span class="ruby">--with-google_perftools_module \</span></span><br><span class="line"><span class="ruby">--with-debug \</span></span><br><span class="line"><span class="ruby">--with-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic'</span> \</span></span><br><span class="line"><span class="ruby">--with-ld-opt=<span class="string">'-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment"># make &amp;&amp; make install</span></span></span><br></pre></td></tr></table></figure><h4 id="将编译好的Nginx设置为系统服务"><a href="#将编译好的Nginx设置为系统服务" class="headerlink" title="将编译好的Nginx设置为系统服务"></a>将编译好的Nginx设置为系统服务</h4><h5 id="CentOS-6"><a href="#CentOS-6" class="headerlink" title="CentOS 6"></a>CentOS 6</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">//准备服务脚本</span><br><span class="line"><span class="comment"># vim /etc/rc.d/init.d/nginx</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># nginx - this script starts and stops the nginx daemon</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig:   - 85 15</span></span><br><span class="line"><span class="comment"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \</span></span><br><span class="line"><span class="comment">#               proxy and IMAP/POP3 proxy server</span></span><br><span class="line"><span class="comment"># processname: nginx</span></span><br><span class="line"><span class="comment"># config:      /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># config:      /etc/sysconfig/nginx</span></span><br><span class="line"><span class="comment"># pidfile:     /var/run/nginx.pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source function library.</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source networking configuration.</span></span><br><span class="line">. /etc/sysconfig/network</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check that networking is up.</span></span><br><span class="line">[ <span class="string">"<span class="variable">$NETWORKING</span>"</span> = <span class="string">"no"</span> ] &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line">nginx=<span class="string">"/usr/sbin/nginx"</span></span><br><span class="line">prog=$(basename <span class="variable">$nginx</span>)</span><br><span class="line"></span><br><span class="line">sysconfig=<span class="string">"/etc/sysconfig/<span class="variable">$prog</span>"</span></span><br><span class="line">lockfile=<span class="string">"/var/lock/subsys/nginx"</span></span><br><span class="line">pidfile=<span class="string">"/var/run/<span class="variable">$&#123;prog&#125;</span>.pid"</span></span><br><span class="line"></span><br><span class="line">NGINX_CONF_FILE=<span class="string">"/etc/nginx/nginx.conf"</span></span><br><span class="line"></span><br><span class="line">[ -f <span class="variable">$sysconfig</span> ] &amp;&amp; . <span class="variable">$sysconfig</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">    [ -x <span class="variable">$nginx</span> ] || <span class="built_in">exit</span> 5</span><br><span class="line">    [ -f <span class="variable">$NGINX_CONF_FILE</span> ] || <span class="built_in">exit</span> 6</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$prog</span>: "</span></span><br><span class="line">    daemon <span class="variable">$nginx</span> -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; touch <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$prog</span>: "</span></span><br><span class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$prog</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; rm -f <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">    configtest_q || <span class="built_in">return</span> 6</span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">reload</span></span>() &#123;</span><br><span class="line">    configtest_q || <span class="built_in">return</span> 6</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Reloading <span class="variable">$prog</span>: "</span></span><br><span class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$prog</span> -HUP</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">configtest</span></span>() &#123;</span><br><span class="line">    <span class="variable">$nginx</span> -t -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">configtest_q</span></span>() &#123;</span><br><span class="line">    <span class="variable">$nginx</span> -t -q -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rh_status</span></span>() &#123;</span><br><span class="line">    status <span class="variable">$prog</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rh_status_q</span></span>() &#123;</span><br><span class="line">    rh_status &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Upgrade the binary with no downtime.</span></span><br><span class="line"><span class="function"><span class="title">upgrade</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> oldbin_pidfile=<span class="string">"<span class="variable">$&#123;pidfile&#125;</span>.oldbin"</span></span><br><span class="line"></span><br><span class="line">    configtest_q || <span class="built_in">return</span> 6</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Upgrading <span class="variable">$prog</span>: "</span></span><br><span class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$prog</span> -USR2</span><br><span class="line">    retval=$?</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="keyword">if</span> [[ -f <span class="variable">$&#123;oldbin_pidfile&#125;</span> &amp;&amp; -f <span class="variable">$&#123;pidfile&#125;</span> ]];  <span class="keyword">then</span></span><br><span class="line">        killproc -p <span class="variable">$oldbin_pidfile</span> <span class="variable">$prog</span> -QUIT</span><br><span class="line">        success $<span class="string">"<span class="variable">$prog</span> online upgrade"</span></span><br><span class="line">        <span class="built_in">echo</span> </span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        failure $<span class="string">"<span class="variable">$prog</span> online upgrade"</span></span><br><span class="line">        <span class="built_in">echo</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tell nginx to reopen logs</span></span><br><span class="line"><span class="function"><span class="title">reopen_logs</span></span>() &#123;</span><br><span class="line">    configtest_q || <span class="built_in">return</span> 6</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Reopening <span class="variable">$prog</span> logs: "</span></span><br><span class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$prog</span> -USR1</span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        rh_status_q &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    restart|configtest|reopen_logs)</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    force-reload|upgrade) </span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 7</span><br><span class="line">        upgrade</span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 7</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    status|status_q)</span><br><span class="line">        rh_<span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    condrestart|try-restart)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 7</span><br><span class="line">        restart</span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|reload|configtest|status|force-reload|upgrade|restart|reopen_logs&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">//将Nginx添加为系统服务，如果安装的位置不在PATH路径之下，需要进行一下添加；</span><br><span class="line"><span class="comment"># chmod +x /etc/rc.d/init.d/nginx </span></span><br><span class="line"><span class="comment"># chkconfig --add nginx</span></span><br><span class="line"><span class="comment"># chkconfig nginx on</span></span><br><span class="line"><span class="comment"># service nginx start</span></span><br></pre></td></tr></table></figure><h5 id="CentOS-7"><a href="#CentOS-7" class="headerlink" title="CentOS 7"></a>CentOS 7</h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//准备Nginx服务的unit文件</span><br><span class="line"><span class="comment"># vim /usr/lib/systemd/system/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line"><span class="comment"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span></span><br><span class="line"><span class="comment"># SELinux context. This might happen when running `nginx -t` from the cmdline.</span></span><br><span class="line"><span class="comment"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span></span><br><span class="line">ExecStartPre=/usr/bin/rm -f /run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">KillMode=process</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">//将Nginx设置为系统服务</span><br><span class="line"><span class="comment"># systemctl daemon-reload#重载系统管理配置</span></span><br><span class="line"><span class="comment"># systemctl enable nginx</span></span><br><span class="line"><span class="comment"># systemctl start nginx</span></span><br></pre></td></tr></table></figure><h3 id="编译Nginx支持第三方模块"><a href="#编译Nginx支持第三方模块" class="headerlink" title="编译Nginx支持第三方模块"></a>编译Nginx支持第三方模块</h3><p>安装第三模块的一般流程:</p><ol><li>找到您要使用的第三方模块</li><li>将源码包下载到本地</li><li>准备编译环境</li><li>解压源码包</li><li>阅读README文件</li><li>使用<code>./configure --add-module=&lt;path&gt;</code>选项配置使用此模块</li><li>make &amp;&amp; make install</li></ol><h4 id="添加对Lua的支持"><a href="#添加对Lua的支持" class="headerlink" title="添加对Lua的支持"></a>添加对Lua的支持</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># wget http://nginx.org/download/nginx-1.12.2.tar.gz</span><br><span class="line"># wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span><br><span class="line"># wget https://github.com/simplresty/ngx_devel_kit/archive/v0.3.0.tar.gz</span><br><span class="line"># wget https://github.com/openresty/lua-nginx-module/archive/v0.10.12.tar.gz</span><br><span class="line"></span><br><span class="line"># yum -y groupinstall "Development Tools"</span><br><span class="line"># yum -y install pcre-devel openssl-devel</span><br><span class="line"></span><br><span class="line"># tar xvf  nginx-1.12.2.tar.gz -C /usr/local/src/</span><br><span class="line"># tar xvf LuaJIT-2.0.5.tar.gz -C /usr/local/src/</span><br><span class="line"># tar xvf v0.3.0.tar.gz -C /usr/local/src/nginx-1.12.2/</span><br><span class="line"># tar xvf v0.10.12.tar.gz -C /usr/local/src/nginx-1.12.2/</span><br><span class="line"></span><br><span class="line"># cd /usr/local/src/LuaJIT-2.0.5/</span><br><span class="line"># make PREFIX=/usr/luajit</span><br><span class="line"># make install PREFIX=/usr/luajit</span><br><span class="line"># vim /etc/profile.d/path.sh</span><br><span class="line">export LUAJIT_LIB=/usr/luajit/lib</span><br><span class="line">export LUAJIT_INC=/usr/luajit/include/luajit-2.0</span><br><span class="line"># . /etc/profile.d/path.sh</span><br><span class="line"></span><br><span class="line"># cd /usr/local/src/nginx-1.12.2/</span><br><span class="line"># useradd -r  -s /sbin/nologin nginx</span><br><span class="line"># ./configure \</span><br><span class="line">-<span class="ruby">-prefix=<span class="regexp">/usr \</span></span></span><br><span class="line"><span class="ruby">--sbin-path=<span class="regexp">/usr/sbin</span><span class="regexp">/nginx \</span></span></span><br><span class="line"><span class="ruby">--conf-path=<span class="regexp">/etc/nginx</span><span class="regexp">/nginx.conf \</span></span></span><br><span class="line"><span class="ruby">--error-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/error</span>.log \</span></span><br><span class="line"><span class="ruby">--http-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/access</span>.log \</span></span><br><span class="line"><span class="ruby">--pid-path=<span class="regexp">/var/run</span><span class="regexp">/nginx/nginx</span>.pid  \</span></span><br><span class="line"><span class="ruby">--lock-path=<span class="regexp">/var/lock</span><span class="regexp">/nginx.lock \</span></span></span><br><span class="line"><span class="ruby">--user=nginx \</span></span><br><span class="line"><span class="ruby">--group=nginx \</span></span><br><span class="line"><span class="ruby">--with-http_ssl_module \</span></span><br><span class="line"><span class="ruby">--with-http_flv_module \</span></span><br><span class="line"><span class="ruby">--with-http_stub_status_module \</span></span><br><span class="line"><span class="ruby">--with-http_gzip_static_module \</span></span><br><span class="line"><span class="ruby">--http-client-body-temp-path=<span class="regexp">/var/tmp</span><span class="regexp">/nginx/client</span><span class="regexp">/ \</span></span></span><br><span class="line"><span class="ruby">--http-proxy-temp-path=<span class="regexp">/var/tmp</span><span class="regexp">/nginx/proxy</span><span class="regexp">/ \</span></span></span><br><span class="line"><span class="ruby">--http-fastcgi-temp-path=<span class="regexp">/var/tmp</span><span class="regexp">/nginx/fcgi</span><span class="regexp">/ \</span></span></span><br><span class="line"><span class="ruby">--http-uwsgi-temp-path=<span class="regexp">/var/tmp</span><span class="regexp">/nginx/uwsgi</span> \</span></span><br><span class="line"><span class="ruby">--http-scgi-temp-path=<span class="regexp">/var/tmp</span><span class="regexp">/nginx/scgi</span> \</span></span><br><span class="line"><span class="ruby">--with-pcre \</span></span><br><span class="line"><span class="ruby">--with-debug \</span></span><br><span class="line"><span class="ruby">--with-ld-opt=<span class="string">"-Wl,-rpath,/usr/luajit/lib"</span> \</span></span><br><span class="line"><span class="ruby">--add-<span class="class"><span class="keyword">module</span>=/<span class="title">usr</span>/<span class="title">local</span>/<span class="title">src</span>/<span class="title">nginx</span>-1.12.2/<span class="title">ngx_devel_kit</span>-0.3.0 \</span></span></span><br><span class="line"><span class="ruby">--add-<span class="class"><span class="keyword">module</span>=/<span class="title">usr</span>/<span class="title">local</span>/<span class="title">src</span>/<span class="title">nginx</span>-1.12.2/<span class="title">lua</span>-<span class="title">nginx</span>-<span class="title">module</span>-0.10.12</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment"># make -j 2 &amp;&amp; make install</span></span></span><br></pre></td></tr></table></figure><hr><p>[Building nginx from Sources]:<a href="http://nginx.org/en/docs/configure.html" target="_blank" rel="noopener">http://nginx.org/en/docs/configure.html</a></p><p>[Installing nginx]:<a href="http://nginx.org/en/docs/install.html" target="_blank" rel="noopener">http://nginx.org/en/docs/install.html</a></p><p>[fastdfs-nginx-module/INSTALL]:<a href="https://github.com/happyfish100/fastdfs-nginx-module/blob/master/INSTALL" target="_blank" rel="noopener">https://github.com/happyfish100/fastdfs-nginx-module/blob/master/INSTALL</a></p><p>[openresty/lua-nginx-module]:<a href="https://github.com/openresty/lua-nginx-module" target="_blank" rel="noopener">https://github.com/openresty/lua-nginx-module</a></p><hr>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;Nginx是一个免费、开源、高性能的HTTP服务和反向代理软件，也是一个IMAP/POP3代理服务，是为数不多解决了C10K问题的HTTP服务器之一。Nginx以其高性能、高并发、高度模块化、低内存消耗等特点闻名，具有多种Web服务器功能特性，如：负载均衡、缓存、访问控制、反向代理以及高效整合各种应用的能力，这些特性使得Nginx很适合于现代互联网架构。&lt;/p&gt;
    
    </summary>
    
      <category term="WEB" scheme="http://subtraction.tech/categories/WEB/"/>
    
    
      <category term="Nginx" scheme="http://subtraction.tech/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 7启动流程和启动排错</title>
    <link href="http://subtraction.tech/Linux/CentOS-7%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%92%8C%E5%90%AF%E5%8A%A8%E6%8E%92%E9%94%99/"/>
    <id>http://subtraction.tech/Linux/CentOS-7启动流程和启动排错/</id>
    <published>2018-05-18T13:48:07.000Z</published>
    <updated>2018-06-13T15:17:48.057Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="CentOS-7启动流程简述"><a href="#CentOS-7启动流程简述" class="headerlink" title="CentOS 7启动流程简述"></a>CentOS 7启动流程简述</h3><ol><li>UEFi或BIOS执行硬件初始化，运行POST加电自检，获取第一个可启动的设备；</li></ol><ol start="2"><li><p>读取并执行第一个启动设备内MBR中的boot Loader，进行引导装载，通过GRUB 1.5 stage中的内容进入boot分区，读取/boot/grub2/grub.cfg文件；</p><a id="more"></a></li></ol><ol start="3"><li>通过grub.cfg文件载入kernel和initramfs到内存中，在内存中kernel通过initramfs解压后生成的根目录，加载内核选项，完成内核初始化。启动第一个进程systemd，执行initrd.target下所有单元，启用核心功能，载入所需驱动程序，重新侦测周边硬件。最后，卸载initramfs的小型文件系统，挂载系统真正的根目录，开始后续的开机流程；</li><li>成功切换到根分区后，kernel会调用启动的第一个程序systemd，根据配置文件/etc/systemd/system/default.target，链接到默认运行的操作环境，一般是/usr/lib/systemd/system/目录下，multi-user.target 或 graphical.target 二者之一；</li><li><p>假定这里选择的默认运行环境是multi-user.target，接着下来systemd会去激活启动multi-usre.target所依赖到的服务；</p><ul><li>Systemd执行local-fs.target和swap.target，挂载本机/etc/fstab文件中定义的文件系统和相关的内存交换空间；</li><li>Systemd执行sysinit.target，侦测加载硬件，载入所需核心模块，进行系统环境初始化；</li><li>Systemd执行basic.target，载入周边硬件驱动程序，设置防火墙和SELinux等相关任务，准备系统环境；</li></ul></li><li>Systemd启动multi-user.target下的服务，主要是启动下面两个目录下的服务；<ul><li>/usr/lib/systemd/system/multi-user.target.wants/</li><li>/etc/systemd/system/multi-user.target.wants/</li></ul></li><li>Systemd执行multi-user.target下的/etc/rc.d/rc.local</li><li>Systemd执行multi-user.target下的getty.target及相关的登陆服务；</li></ol><hr><h3 id="CentOS-7破解root口令方法一"><a href="#CentOS-7破解root口令方法一" class="headerlink" title="CentOS 7破解root口令方法一"></a>CentOS 7破解root口令方法一</h3><ol><li>启动时在下图界面按任意键暂停启动，然后按<code>e</code>键进入编辑模式；</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180519/JejLjdmCDH.png?imageslim" alt="mark"></p><ol start="2"><li>将光标移动到linux16开始的行，在行尾添加内核参数rd.break，然后按<code>Ctrl+x</code>启动系统；</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180519/gIAAj8JFAh.png?imageslim" alt="mark"></p><ol start="3"><li><p>以读写的方式重新挂载一下根分区，然后切根修改密码，在根目录下创建.autorelabel文件，exit退出后使用reboot重启正常登录。</p><p><strong>Note:</strong> 如果系统没有禁用SELinux，<code>touch /.autorelabel</code>这一步是必不可少的，如果缺少了这个文件会导致系统黑屏无法启动。</p></li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180519/45c7ebH75F.png?imageslim" alt="mark"></p><hr><h3 id="CentOS-7破解root口令方法二"><a href="#CentOS-7破解root口令方法二" class="headerlink" title="CentOS 7破解root口令方法二"></a>CentOS 7破解root口令方法二</h3><ol><li>启动时在下图界面按任意键暂停启动，然后按<code>e</code>键进入编辑模式；</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180519/JejLjdmCDH.png?imageslim" alt="mark"></p><ol start="2"><li>将光标移动到linux16开始的行，在行尾添加内核参数rw init=/sysroot/bin/bash，然后按<code>Ctrl+x</code>启动系统；</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180519/hL23ihi1iJ.png?imageslim" alt="mark"></p><ol start="3"><li>启动后会进入一个如下图的字符界面，切根后更改密码，根目录下创建.autorelabel文件，exit退出后使用reboot重启正常登录。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180519/eh9l7CeIia.png?imageslim" alt="mark"></p><hr><h3 id="CentOS-7进入救援模式"><a href="#CentOS-7进入救援模式" class="headerlink" title="CentOS 7进入救援模式"></a>CentOS 7进入救援模式</h3><ol><li>选择Troubleshooting排错，进入后选择Rescue救援模式启动。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/9JDl7hhm5E.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/316l4E82im.png?imageslim" alt="mark"></p><ol start="2"><li>输入<code>1</code>选择Continue，两下回车进入救援模式的shell界面；</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/50ij7G7b2k.png?imageslim" alt="mark"></p><hr><h3 id="修复删除GRUB2-stage-1-2导致的系统无法启动"><a href="#修复删除GRUB2-stage-1-2导致的系统无法启动" class="headerlink" title="修复删除GRUB2 stage 1-2导致的系统无法启动"></a>修复删除GRUB2 stage 1-2导致的系统无法启动</h3><h4 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//破坏stage 1-2的命令</span></span><br><span class="line"># dd <span class="keyword">if</span>=<span class="regexp">/dev/</span>zero of=<span class="regexp">/dev/</span>sda bs=<span class="number">1</span> <span class="keyword">count</span>=<span class="number">446</span></span><br><span class="line"># dd <span class="keyword">if</span>=<span class="regexp">/dev/</span>zero of=<span class="regexp">/dev/</span>sda bs=<span class="number">1</span> <span class="keyword">count</span>=<span class="number">10240</span> skip=<span class="number">512</span> seek=<span class="number">512</span></span><br><span class="line"># rm -rf <span class="regexp">/boot/g</span>rub*</span><br><span class="line"># reboot</span><br></pre></td></tr></table></figure><p>找不到可引导的启动设备，报错如下图：</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/AmcL3eKkIc.png?imageslim" alt="mark"></p><h4 id="修复方法"><a href="#修复方法" class="headerlink" title="修复方法"></a>修复方法</h4><ol><li><p>使用<code>grub2-install</code>重新安装GRUB2 stage 1-2的内容，需要注意这是在没有切根的情况下进行安装的，需要使用<code>--root-directory</code>选项指定根分区路径；<code>grub2-install</code>命令执行过程中会依赖/usr/lib/grub/目录中的文件，若救援的光盘系统中/usr/lib/grub/目录下没有自带，则需要chroot后使用<code>grub2-install /dev/sda</code>进行修复。</p><ul><li><p>BIOS环境下修复grub2</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> grub2-install /dev/sda</span></span><br></pre></td></tr></table></figure></li><li><p>UEFI环境下修复grub2</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> grub2-install</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>使用<code>grub2-mkconfig</code>命令生成grub.cfg配置文件，修复完成退出重启；</p></li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/glLFa03gcH.png?imageslim" alt="mark"></p><hr><h3 id="修复删除-boot-grub2-grub-cfg文件导致的系统无法启动"><a href="#修复删除-boot-grub2-grub-cfg文件导致的系统无法启动" class="headerlink" title="修复删除/boot/grub2/grub.cfg文件导致的系统无法启动"></a>修复删除/boot/grub2/grub.cfg文件导致的系统无法启动</h3><h4 id="问题现象-1"><a href="#问题现象-1" class="headerlink" title="问题现象"></a>问题现象</h4><p>无法通过grub.cfg文件加载内核进行启动，报错如下图：</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/LiG3adG87A.png?imageslim" alt="mark"></p><h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><ol><li><p>加载xfs文件系统模块；</p></li><li><p>设置根分区对应磁盘的位置，这里的根分区指的是boot分区，而非真正的根分区，(hd0,1)表示第一块磁盘的第一个分区；</p></li><li><p>指明内核文件的路径，指明真正根分区对应的磁盘分区名称，启动时禁用SELinux，防止SELinux打标签影响启动速度；</p></li><li><p>指明initramfs文件的路径，输入<code>boot</code>回车启动；</p></li><li><p>系统正常启动后，进入系统重新生成grub.cfg文件，否则下次重启还会出现这个故障。</p></li></ol><p><strong>补充：</strong>grub.cfg文件可以通过命令直接生成，不需要再手工进行编写，<code>grub2-mkconfig</code>命令会利用/etc/grub.d/目录中的模板和/etc/default/grub文件中的设置自动生成。</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/Kgmf9eGj0F.png?imageslim" alt="mark"></p><hr><h3 id="修复删除-boot目录导致的系统启动故障"><a href="#修复删除-boot目录导致的系统启动故障" class="headerlink" title="修复删除/boot目录导致的系统启动故障"></a>修复删除/boot目录导致的系统启动故障</h3><h4 id="问题现象-2"><a href="#问题现象-2" class="headerlink" title="问题现象"></a>问题现象</h4><p>缺少启动的相关文件，报错见下图；</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/82Ic23F189.png?imageslim" alt="mark"></p><h4 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h4><ol><li>进入救援模式，chroot切根，挂载光盘强制安装kernel软件包；</li><li>使用<code>grub2-install</code>命令生成grub2目录；</li><li>使用<code>grub2-mkconfig</code>命令生成/boot/grub2/grub.cfg配置文件；</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180520/l4ALlI4ci5.png?imageslim" alt="mark"></p><hr><h3 id="etc-fstab文件错误导致的系统启动异常"><a href="#etc-fstab文件错误导致的系统启动异常" class="headerlink" title="/etc/fstab文件错误导致的系统启动异常"></a>/etc/fstab文件错误导致的系统启动异常</h3><h4 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h4><p>在/etc/fstab文件有以下三种情况的错误时，系统会先尝试自动修复，若修复失败则进入emergency shell模式，提示用户修复。</p><ul><li>文件中设备的UUID错误或者不存在；</li><li>文件中的挂载点不存在(systemd会先尝试创建，不成功则进入emergency shell)；</li></ul><ul><li>文件中的挂载选项不正确；</li></ul><p><strong>emergency shell模式：</strong></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180528/kI3G3E1hl9.png?imageslim" alt="mark"></p><h4 id="修复方法-1"><a href="#修复方法-1" class="headerlink" title="修复方法"></a>修复方法</h4><p>输入root口令，进入系统修复/etc/fstab文件，此时的系统是没有网络的，修复完成后重启即可；</p><hr><h3 id="补充：设置内核参数"><a href="#补充：设置内核参数" class="headerlink" title="补充：设置内核参数"></a>补充：设置内核参数</h3><h4 id="调整启动时默认使用的内核"><a href="#调整启动时默认使用的内核" class="headerlink" title="调整启动时默认使用的内核"></a>调整启动时默认使用的内核</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//方法一，根据grub.cfg配置文件中内核的顺序设置默认启动内核</span><br><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/default/grub  </span></span><br><span class="line">GRUB_DEFAULT=1#设置默认的启动内核为第2个内核</span><br><span class="line"><span class="meta">#</span><span class="bash"> grub2-mkconfig -o /boot/grub2/grub.cfg<span class="comment">#重新生成grub.cfg配置文件</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> reboot</span></span><br><span class="line">//方法二，通过指定title名称的方式设定默认启动内核</span><br><span class="line"><span class="meta">#</span><span class="bash"> grep <span class="string">"^menuentry"</span> /boot/grub2/grub.cfg<span class="comment">#查看系统内部有多少个内核</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> grub2-set-default <span class="string">"CentOS Linux (3.10.0-693.el7.x86_64) 7 (Core)"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> grub2-editenv list <span class="comment">#验证是否配置成功</span></span></span><br></pre></td></tr></table></figure><h4 id="设置CentOS-7系统使用传统网卡名称"><a href="#设置CentOS-7系统使用传统网卡名称" class="headerlink" title="设置CentOS 7系统使用传统网卡名称"></a>设置CentOS 7系统使用传统网卡名称</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//Note: 在设置完成网卡名称后，需要修改相应的ifcfg-ens32配置文件中的设备名称，否则网络服务无法正常使用。</span><br><span class="line"><span class="meta">#</span><span class="bash"> sed -ri <span class="string">'/GRUB_CMDLINE_LINUX=/s/"$/ net.ifnames=0"/'</span> /etc/default/grub</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> reboot</span></span><br></pre></td></tr></table></figure><hr><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> man 7 BOOTUP</span></span><br></pre></td></tr></table></figure><p>[Linux的开机流程分析]:<a href="https://wizardforcel.gitbooks.io/vbird-linux-basic-4e/content/166.html" target="_blank" rel="noopener">https://wizardforcel.gitbooks.io/vbird-linux-basic-4e/content/166.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;CentOS-7启动流程简述&quot;&gt;&lt;a href=&quot;#CentOS-7启动流程简述&quot; class=&quot;headerlink&quot; title=&quot;CentOS 7启动流程简述&quot;&gt;&lt;/a&gt;CentOS 7启动流程简述&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;UEFi或BIOS执行硬件初始化，运行POST加电自检，获取第一个可启动的设备；&lt;/li&gt;
&lt;/ol&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;&lt;p&gt;读取并执行第一个启动设备内MBR中的boot Loader，进行引导装载，通过GRUB 1.5 stage中的内容进入boot分区，读取/boot/grub2/grub.cfg文件；&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://subtraction.tech/categories/Linux/"/>
    
    
      <category term="启动流程" scheme="http://subtraction.tech/tags/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    
      <category term="CentOS" scheme="http://subtraction.tech/tags/CentOS/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 6常见启动故障及排错</title>
    <link href="http://subtraction.tech/Linux/CentOS-6%E5%B8%B8%E8%A7%81%E5%90%AF%E5%8A%A8%E6%95%85%E9%9A%9C%E5%8F%8A%E6%8E%92%E9%94%99/"/>
    <id>http://subtraction.tech/Linux/CentOS-6常见启动故障及排错/</id>
    <published>2018-05-15T13:43:46.000Z</published>
    <updated>2018-06-13T15:24:48.373Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="单用户模式破解root口令"><a href="#单用户模式破解root口令" class="headerlink" title="单用户模式破解root口令"></a>单用户模式破解root口令</h3><ol><li>启动时在此界面按任意键进入启动菜单界面。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180613/cm9FmL4mF7.png?imageslim" alt="mark"></p><ol start="2"><li>GRUB的启动菜单页面，在此界面可以看到内核的启动选项，并提供了交互式接口，有e、a、c 三个选项可以使用，分别代表不同的作用。</li></ol><a id="more"></a><ul><li>a：修改内核参数 </li><li>e：编辑启动项<ul><li>d：删除</li><li>o：打开一个新行</li><li>e：编辑行内容</li><li>b：启动</li></ul></li><li>c：命令模式，提供交互式接口</li></ul><p>键盘敲a键，进入内核参数的编辑界面</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180613/gafiedk7GA.png?imageslim" alt="mark"></p><ol start="3"><li>在此界面输入1，而后回车进入单用户模式。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180613/75g5bkgi97.png?imageslim" alt="mark"></p><ol start="4"><li>下图就是单用户的界面，不需要输入密码，直接以root身份登录，可以直接使用<code>passwd</code>命令修改口令，然后使用<code>init</code>命令切换运行级别进行正常登录，看到登录页面后输入修改过的口令就可以直接登录。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180510/maHm425F9E.png?imageslim" alt="mark"></p><hr><h3 id="进入救援模式的方法"><a href="#进入救援模式的方法" class="headerlink" title="进入救援模式的方法"></a>进入救援模式的方法</h3><ol><li>使用光盘引导启动，光盘的系统版本要和需要修复的系统的版本对应。选中 <code>Rescue installd system</code> 回车进入。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/2BHjCHeEeG.png?imageslim" alt="mark"></p><ol><li>选择使用的语言，直接回车，使用默认选项就可以。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/i602BlfCFk.png?imageslim" alt="mark"></p><ol><li>选择使用的键盘类型，使用默认值，直接回车。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/mhlBEG9a30.png?imageslim" alt="mark"></p><ol><li>根据需求来选择是否设置网络，这里选择NO不进行设置。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/j8dH5LcF66.png?imageslim" alt="mark"></p><ol><li>接下来的几个页面是介绍救援模式的，选择<code>Continue</code>和<code>OK</code>跳过即可；</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/L57K7iDFl1.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/3gJ40H2dK8.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/Kb3gg8Fm5H.png?imageslim" alt="mark"></p><ol><li>选择第一项开启一个shell，进入命令行模式进行修复，修复完成后执行<code>exit</code>命令退出后选择第三项进行重启。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/ICJ3Ca7J5b.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/18G48gD4FJ.png?imageslim" alt="mark"></p><hr><h3 id="GRUB-stage-1故障导致的系统无法启动"><a href="#GRUB-stage-1故障导致的系统无法启动" class="headerlink" title="GRUB stage 1故障导致的系统无法启动"></a>GRUB stage 1故障导致的系统无法启动</h3><h4 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h4><p>GRUB 1阶段出现故障，导致无法通过硬盘引导启动，默认会尝试通过其它引导方式启动，下图就是尝试通过网络启动，但未能成功引导，报错操作系统没有发现。</p><p><em>破坏stage 1的方法：</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> dd <span class="keyword">if</span>=/dev/zero of=/dev/sda bs=1 count=446</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> hexdump -C -n 512 /dev/sda<span class="comment">#可以看到82 20之前的内容已经全部清零</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> reboot</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/dF1b75ABmj.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/8ElA1bC85L.png?imageslim" alt="mark"></p><h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><p>挂载光盘进入救援模式，通过<code>chroot /mnt/sysimage/</code>命令完成切根操作，通过<code>grub-install</code>命令修复系统所在硬盘stage 1中的内容，通过<code>hexdump</code>命令可以检测修复的结果，使用<code>sync</code>同步磁盘写入，执行两次<code>exit</code>命令退出后重新启动系统。</p><p><code>grub-install</code>命令不仅可以修复stage 1，同时还可以修复 stage 1.5和stage 2，此命令的执行过程中可能会出现一次执行不能修复的情况，重新执行一次便可以了。</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/iji5hbDFj9.png?imageslim" alt="mark"></p><hr><h3 id="GRUB-stage-1-5故障导致的系统无法启动"><a href="#GRUB-stage-1-5故障导致的系统无法启动" class="headerlink" title="GRUB stage 1.5故障导致的系统无法启动"></a>GRUB stage 1.5故障导致的系统无法启动</h3><h4 id="问题现象-1"><a href="#问题现象-1" class="headerlink" title="问题现象"></a>问题现象</h4><p>GRUB stage 1没有问题，所以系统可以读取硬盘启动，但又到不了stage 2 所以看不到启动菜单，便会出现下图的故障现象，会有一个黑屏界面。</p><p><em>破坏stage 1.5的方法：</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> dd <span class="keyword">if</span>=/dev/zero of=/dev/sda bs=1 count=10240 skip=512 seek=512</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> hexdump -C -n 10240 /dev/sda<span class="comment">#可以看到55 aa之后的内容已经全部清零</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> reboot</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/1e2Ei6h80f.png?imageslim" alt="mark"></p><h4 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h4><p>挂载光盘进入救援模式，通过<code>chroot /mnt/sysimage/</code>命令完成切根操作，使用<code>grub-install</code>命令或<code>grub</code>命令以交互的方式进行修复，使用<code>sync</code>同步磁盘写入，执行两次<code>exit</code>命令退出后重新启动系统。</p><p>使用可交互的grub命令安装1.5阶段，此方法作为<code>grub-install</code>修复方式的补充，这种方式的缺点是依赖于/boot/grub/目录下的1.5阶段备份文件，如果没有备份文件，则此方法不可用。</p><ul><li>root (hd0,0)：根分区在第一个硬盘的第一个分区</li><li>setup (hd0)：表示要把grub装在那块硬盘上。</li></ul><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/3fcGK0g5K0.png?imageslim" alt="mark"></p><hr><h3 id="重装grub之后，-boot-grub-stage2文件被删除的报错"><a href="#重装grub之后，-boot-grub-stage2文件被删除的报错" class="headerlink" title="重装grub之后，/boot/grub/stage2文件被删除的报错"></a>重装grub之后，/boot/grub/stage2文件被删除的报错</h3><p>重装grub之后/boot/grub/stage2文件不再只是备份作用，而会变成启动时会被依赖的文件，丢失会影响启动，需要进入救援模式修复后才能正常启动。</p><p>删除/boot/grub/stage2文件的报错：</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/lK0e02Fgi0.png?imageslim" alt="mark"></p><hr><h3 id="删除-boot-grub-目录导致的系统无法启动"><a href="#删除-boot-grub-目录导致的系统无法启动" class="headerlink" title="删除/boot/grub/目录导致的系统无法启动"></a>删除/boot/grub/目录导致的系统无法启动</h3><h4 id="问题现象-2"><a href="#问题现象-2" class="headerlink" title="问题现象"></a>问题现象</h4><p>GRUB stage 2故障，1和1.5 stage的启动没有问题，启动到2 stage时由于没有grub.conf文件，会无法加载启动菜单和启动项，导致启动中止，会有<code>grub&gt;_</code>字样的报错。</p><p>执行<code>rm -rf /boot/grub</code>命令后重启服务器，便会出现下图中的报错；    </p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180514/63Halgljlj.png?imageslim" alt="mark"></p><h4 id="解决方法-2"><a href="#解决方法-2" class="headerlink" title="解决方法"></a>解决方法</h4><p>修复的命令参考下图，在<code>grub&gt;</code>后输入grub.conf文件中<code>title</code>字段及下面的两行，这个过程可以使用Tab键补全,实例启动后记得恢复丢失的/boot/grub/grub.conf文件，否则下次重启还会无法启动。</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180514/EHgKGm1DBm.png?imageslim" alt="mark"></p><hr><h3 id="删除-boot-目录导致的系统无法启动"><a href="#删除-boot-目录导致的系统无法启动" class="headerlink" title="删除/boot/目录导致的系统无法启动"></a>删除/boot/目录导致的系统无法启动</h3><h4 id="问题现象-3"><a href="#问题现象-3" class="headerlink" title="问题现象"></a>问题现象</h4><p>报错的界面和删除grub.conf文件的报错相同，会有<code>grub&gt;_</code>字样的报错。但由于删除的是/boot目录，导致后续启动所依赖到的kernel文件和ramdisk文件也被一并删除，这种情况下，即使参考上面的方法进行修复也是无济于事。</p><p>执行<code>rm -rf /boot</code>命令后重启服务器，便会出现下图中的报错；</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180514/63Halgljlj.png?imageslim" alt="mark"></p><h4 id="解决方法-3"><a href="#解决方法-3" class="headerlink" title="解决方法"></a>解决方法</h4><p>解决这个问题的思路是挂载光盘进入救援模式，切根后重新挂载光盘，复制光盘中的内核文件到boot目录中，再使用<code>mkinitrd</code>命令生成initramfs文件，使用<code>grub-install</code>命令生成/boot/grub目录，临时在grub目录下编辑一个用于引导启动的grub.conf文件，最后使用sync命令向磁盘同步一下数据，exit退出后重启。    </p><p><em>具体操作方法参考下面截图：</em></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180514/EFkID88017.png?imageslim" alt="mark"></p><p>临时创建/boot/grub/grub.conf文件，格式参考下图：</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180514/bF7aG8mh8L.png?imageslim" alt="mark"></p><p><em>补充：</em>initrd字段的参数比较长，比较容易输入错误，建议参考下图，通过vim的扩展命令模式直接将文件名读取到文件中，输入过程中支持tab键补全，避免因为文件名书写错误导致的修复失败。</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180514/6Im4Kb834G.png?imageslim" alt="mark"></p><hr><h3 id="删除-sbin-init程序导致的系统无法启动"><a href="#删除-sbin-init程序导致的系统无法启动" class="headerlink" title="删除/sbin/init程序导致的系统无法启动"></a>删除/sbin/init程序导致的系统无法启动</h3><h4 id="问题现象-4"><a href="#问题现象-4" class="headerlink" title="问题现象"></a>问题现象</h4><p>可以看到启动菜单和启动过程，启动会卡在<code>sh-4.1#</code>字样的命令提示符处，无法进行输入，无法启动。</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/eG730d6Kh2.png?imageslim" alt="mark"></p><h4 id="解决方法-4"><a href="#解决方法-4" class="headerlink" title="解决方法"></a>解决方法</h4><p>强制重启后按任意键进入启动菜单页面，在启动菜单页面按<code>a</code>键更改内核启动参数，将系统默认首个启动进程由/sbin/init改为/bin/bash。成功进入系统后，查询init程序的来源软件包，之后挂载光盘强制重新安装即可修复。这种修复方式可以用于某些特殊文件被破坏时，不需要进入救援模式就可以直接修复。</p><p><strong>Note：</strong></p><ul><li>使用/bin/bash引导系统启动，进入系统后磁盘会是只读的，需要重新以读写方式挂载一下。</li><li>由于之前系统中已经安装过upstart软件包，所以安装时需要使用<code>--force</code>选项进行强制安装。</li></ul><p><em>具体操作步骤请参考以下截图：</em></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/jAC51HmG8l.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/AL4g4iejgH.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/bG2fCh90k6.png?imageslim" alt="mark"></p><hr><h3 id="删除-etc-fstab文件和-boot目录导致的系统无法启动"><a href="#删除-etc-fstab文件和-boot目录导致的系统无法启动" class="headerlink" title="删除/etc/fstab文件和/boot目录导致的系统无法启动"></a>删除/etc/fstab文件和/boot目录导致的系统无法启动</h3><h4 id="问题现象-5"><a href="#问题现象-5" class="headerlink" title="问题现象"></a>问题现象</h4><p>无法通过GRUB 2 stage的引导，报错与删除/boot目录的报错相同。</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180514/63Halgljlj.png?imageslim" alt="mark"></p><h4 id="解决方法-5"><a href="#解决方法-5" class="headerlink" title="解决方法"></a>解决方法</h4><p>修复方法和删除/boot分区的修复方法类似，比较麻烦的是进入救援模式后，由于/etc/fstab文件被被删除，导致之前系统中的分区无法被自动识别和挂载，不能直接进行切根修复。</p><ol><li>挂载光盘进入救援模式，使用<code>fdisk -l</code>命令查看当前系统中的所有磁盘和每个磁盘的分区情况，找出每个设备所对应的挂载点，如果不清楚各个设备和挂载点的对应情况，可以将设备临时挂载一下，查看设备中的文件内容，推导出这个设备名之前所对应的挂载点名称。</li><li>清楚了设备和挂载点的对应挂载关系之后，便可以临时挂载根分区，重新创建/etc/fstab文件。挂载根分区时不要直接挂载到/mnt目录下，使用<code>df -h</code>命令可以看到/mnt/runtime目录下挂载的是loop0设备，对应的是光盘，直接向/mnt目录进行挂载会使之前的挂载被覆盖掉，导致救援模式不能正常使用。</li><li>重新创建好/etc/fstab文件后，退出重新进入救援模式，根分区会自动被挂载，通过切根的方式进入根分区。</li><li>挂载光盘通过安装kernel软件包，生成/boot分区下的vmlinuz和initramfs文件，通过grub-install命令生成grub目录，重新创建/boot/grub/grub.conf文件，编辑完成后退出重启主机正常登录。</li></ol><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/2G2i8KBbmf.png?imageslim" alt="mark"></p><p>观察<code>fdisk -l</code>命令的显示结果，在boot字段下有<code>*</code>标记的是boot分区，System字段下有swap字样的是swap分区，剩余的分区如果还有不清楚和挂载点对应关系的，可以通过临时挂载的方式，看下目录中的内容，根据目录中的内容和分区的大小来推导一下。根分区通过挂载是比较好识别的，看下里面的目录结构就清楚了。</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/di4GB2abCl.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/C5DF3CKI3F.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/6m5a21C2GH.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180515/ldbLKI0021.png?imageslim" alt="mark"></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;单用户模式破解root口令&quot;&gt;&lt;a href=&quot;#单用户模式破解root口令&quot; class=&quot;headerlink&quot; title=&quot;单用户模式破解root口令&quot;&gt;&lt;/a&gt;单用户模式破解root口令&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;启动时在此界面按任意键进入启动菜单界面。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;http://p7ds7yr9p.bkt.clouddn.com/blog/180613/cm9FmL4mF7.png?imageslim&quot; alt=&quot;mark&quot;&gt;&lt;/p&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;GRUB的启动菜单页面，在此界面可以看到内核的启动选项，并提供了交互式接口，有e、a、c 三个选项可以使用，分别代表不同的作用。&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://subtraction.tech/categories/Linux/"/>
    
    
      <category term="启动流程" scheme="http://subtraction.tech/tags/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    
      <category term="CentOS" scheme="http://subtraction.tech/tags/CentOS/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 6启动流程</title>
    <link href="http://subtraction.tech/Linux/CentOS-6%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    <id>http://subtraction.tech/Linux/CentOS-6启动流程/</id>
    <published>2018-05-12T13:33:02.000Z</published>
    <updated>2018-06-13T15:44:55.210Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="启动流程简述"><a href="#启动流程简述" class="headerlink" title="启动流程简述"></a>启动流程简述</h3><ol><li><p>POST加电自检，加载BIOS的硬件信息，检查各种硬件的情况，如CPU，内存和硬盘等硬件是否都插好，是否存在损坏等 。自检完成后会选择启动顺序，获取第一个启动设备。如：硬盘引导启动、网络引导启动、光盘引导启动等，一般选择使用硬盘引导启动，若硬盘无法引导启动则会自动选择后续的可用设备启动引导。启动引导设备也可以通过设置BISO程序的方式进行人为指定。</p><a id="more"></a></li><li><p>MBR引导或GPT引导，具体使用哪种引导方式取决于硬盘使用的分区类型，但不管使用的是哪种引导方式原理都是相同的。这里以传统的MBR分区类型进行简单的举例说明，MBR引导主要依靠磁盘第一个扇区的前446个字节中的引导加载器boot loader来实现，通过boot loader查找并加载次引导加载程序。</p></li><li><p>GRUB引导阶段， 此阶段通过GRUB 1.5 stage加载/boot所在分区的文件系统驱动，将/boot所在分区作为根分区来进行挂载。当GRUB 1.5 stage的引导加载程序被加载并运行时，GRUB 2 stage的引导加载程序就可以进行加载了，GRUB 2 stage会通过grub.conf文件将内核文件和initramfs文件加载至内存中，进行内核自身的解压和初始化。</p></li><li><p>内核引导过程，内核会在这一过程中借助于ramdisk(initramfs)完成自身的初始化，initramfs是一个辅助的伪根系统，放置了和启动相关的一些核心文件和驱动，在内核引导过程中会将其模拟为一块磁盘进行临时挂载，获取其中的文件，将其当做一个临时的根文件系统使用，实现内核引导。此过程中内核会探测可识别到的所有硬件设备，并加载硬件驱动程序，如：挂载真正根分区需要的ext4文件系统的驱动，就是通过initramfs获得的。而后，内核通过chroot的方式以只读形式挂载真正的根文件系统，运行用户空间的第一个应用程序/sbin/init。</p></li><li><p>Init初始化过程，启动init进程，读取/etc/inittab文件和/etc/init/目录下的文件，执行/etc/rc.d/目录下的脚本文件初始化系统环境，启动需要开机自启的服务，执行/bin/login程序，进入登录状态。</p></li></ol><p>Linux引导过程在20,000英尺处的视图:</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180510/akCC9JBACK.gif" alt="mrk"></p><p>Init初始化过程：</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/6jL3a4gDi5.png?imageslim" alt="mark"></p><hr><h3 id="启动相关的重要概念"><a href="#启动相关的重要概念" class="headerlink" title="启动相关的重要概念"></a>启动相关的重要概念</h3><h4 id="POST相关概念"><a href="#POST相关概念" class="headerlink" title="POST相关概念"></a>POST相关概念</h4><p><strong>POST</strong>：Power-On-Self-Test，加电自检，是BIOS功能的一个主要部分。负责完成对CPU、主板、内存、硬盘子系统、显示子系统、串并行接口、键盘、CD-ROM光驱等硬件情况的检测。</p><p><strong>BIOS</strong> ：Basic Input and Output System，基本输入输出系统，保存着有关计算机系统最重要的基本输入输出程序，系统信息设置、开机加电自检程序和系统启动自举程序等。</p><p><strong>CMOS</strong>：Complementary Metal Oxide Semiconductor，互补金属氧化物半导体，保存各项参数的设定，按次序查找引导设备，第一个有引导程序的设备为本次启动设备。</p><blockquote><p><strong>BIOS与CMOS的关系</strong><br>CMOS是计算机上另一个重要的存储器。之所以提到它，是因为BIOS程序的设置结果就保存在CMOS中。而且，在BIOS程序引导计算机启动后，计算机需要载入CMOS中的用户信息和常规设置后才能正常使用。UEFI系统则多用NVRAM存储设置。</p><p><strong>BIOS与CMOS的区别</strong><br>二者的区别是，BIOS是存储在只读记忆体（EEPROM），而CMOS为随机存储器（RAM）；BIOS中存储的是程序，而CMOS中存储的是普通信息。</p><p>EEPROM即是我们常用的U盘和各类存储卡，因此我们可以更新BIOS，其内容亦能在断电后保存。</p><p>CMOS RAM的内容在断电会消失。所以，把主板的电池拆出，便可重置其内容。另外，拆出电池也会重置时间。</p></blockquote><h4 id="主引导记录MBR"><a href="#主引导记录MBR" class="headerlink" title="主引导记录MBR"></a>主引导记录MBR</h4><p><strong>主引导记录</strong>（Master Boot Record，缩写：MBR），又叫做<strong>主引导扇区</strong>，是计算机开机后访问硬盘时所必须要读取的首个扇区。MBR总共有512个字节，其中前446个字节主要用来放置和启动相关的一段程序boot loader，是GRUB的1 stage。其后是4个16字节的“磁盘分区表”（DPT），以及2字节的结束标志位<code>55aa</code>。</p><p>通过hexdump命令可以查看到MBR的内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> hexdump -C -n 512 /dev/sda<span class="comment">#通过十六进制+ASCII码的形式显示磁盘的前512字节</span></span></span><br></pre></td></tr></table></figure><p>MBR剖析图：</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180510/31LcKLe141.gif" alt="mark"></p><h4 id="GRUB简介"><a href="#GRUB简介" class="headerlink" title="GRUB简介"></a>GRUB简介</h4><p><strong>GRUB</strong> (GRand Unified Bootloader 简称<code>GRUB</code>)是一个来自GUN项目的多操作系统启动程序，能够启动大多数免费操作系统 Linux、FreeBSD、NetBSD、GNU Mach和其它大多数的商业操作系统。在Linux系统的启动过程中GRUB程序是分为三个阶段在发挥它的作用，分别是1 stage、1.5 stage和2  stage。</p><ul><li>1 stage：MBR前446字节中的boot loader，主要用于初始化硬件，进行引导加载。</li></ul><ul><li>1.5 stage：存放于MBR 512字节后续的空间之中，这段空间不属于任何分区，可以直接读取，主要用来加载进入boot分区所需的文件系统驱动，默认是ext4文件系统的驱动。</li><li>2 stage：/boot/grub/目录中的文件，需要进入boot分区后才能进行读取，包含了挂载根分区的重要信息。</li></ul><p>使用<code>rpm -qi grub</code>命令可以查看到CentOS 6系统中安装的GRUB程序的软件信息，可以看到Version是0.97。</p><hr><h3 id="启动相关的重要文件"><a href="#启动相关的重要文件" class="headerlink" title="启动相关的重要文件"></a>启动相关的重要文件</h3><h4 id="initramfs-uname-r-img"><a href="#initramfs-uname-r-img" class="headerlink" title="initramfs-\$(uname -r).img"></a>initramfs-\$(uname -r).img</h4><p>ramdisk是一个伪根文件系统，主要用于帮助内核完成自身初始化、加载驱动程序挂载根分区，到此便可以被卸载掉了。而ramdisk便是boot目录中initramfs-\$(uname -r).img文件，这是一个gzip的压缩文件，存放了一些和启动相关的文件和驱动，是系统启动过程中的核心文件之一。</p><h5 id="查看initramfs-uname-r-img文件的内容："><a href="#查看initramfs-uname-r-img文件的内容：" class="headerlink" title="查看initramfs-\$(uname -r).img文件的内容："></a>查看initramfs-\$(uname -r).img文件的内容：</h5><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法一</span></span><br><span class="line"># lsinitrd /boot/initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img </span><br><span class="line"></span><br><span class="line"><span class="comment">//方法二</span></span><br><span class="line"># cp /boot/initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img /tmp/</span><br><span class="line"># file /boot/initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img #可以看下此文件的类型是GZIP的</span><br><span class="line"># mv initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img.gz#压缩工具一般都挑后缀，要改一下文件名</span><br><span class="line"># gzip -d initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img.gz </span><br><span class="line"># ll -h ./initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img /boot/initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img#解压之后文件是变大了的</span><br><span class="line"># file ./initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img #此时再来观察一下文件类型的变化，会发现文件类型变为了cpio;</span><br><span class="line"># cpio -id &lt; initramfs<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.</span>el6.x86_64.img#解压cpio文件的方法</span><br><span class="line"># tree -L <span class="number">1</span> #查看解压后生成的文件</span><br><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">├── dev</span><br><span class="line">├── etc</span><br><span class="line">├── init</span><br><span class="line">├── lib</span><br><span class="line">...此处省略部分内容...</span><br><span class="line">├── lib64</span><br><span class="line">├── sbin</span><br><span class="line">├── sys</span><br><span class="line">├── sysroot</span><br><span class="line">├── tmp</span><br><span class="line">├── usr</span><br><span class="line">└── var</span><br></pre></td></tr></table></figure><h5 id="生成initramfs-uname-r-img文件的方法"><a href="#生成initramfs-uname-r-img文件的方法" class="headerlink" title="生成initramfs-\$(uname -r).img文件的方法"></a>生成initramfs-\$(uname -r).img文件的方法</h5><p>生成ramdisk文件的命令有两个可以选择，mkinitrd和dracut，mkinitrd命令是一个脚本，调用了dracut命令。</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#为当前正在使用的内核重新制作ramdisk文件</span><br><span class="line"># mkinitrd /boot/initramfs-`uname -r`.img `uname -r`</span><br><span class="line">或</span><br><span class="line"># dracut /boot/initramfs-$(uname-r).img $(uname-r)</span><br></pre></td></tr></table></figure><h4 id="vmlinuz-uname-r"><a href="#vmlinuz-uname-r" class="headerlink" title="vmlinuz-\$(uname -r)"></a>vmlinuz-\$(uname -r)</h4><p>vmlinuz文件是一个可引导的，压缩的Linux内核，包含了Linux kernel的核心功能模块。内核在编译的时候为了实现精简，只将必要的功能模块打包到了内核文件之中，所以这个文件看起来并不是很大，一些非核心模块一般放置在/lib/modules/目录下。</p><h4 id="etc-inittab"><a href="#etc-inittab" class="headerlink" title="/etc/inittab"></a>/etc/inittab</h4><p>此文件用于设置系统的运行级别，共0-6七个级别，默认级别一般设置为3或5，0或6不建议设置为默认运行级别，会循环重启或者关机。</p><ul><li>0：关机</li><li>1：单用户模式(root自动登录)，single，维护模式</li><li>2：多用户模式，启动网络功能，但不会启动NFS，维护模式</li><li>3：多用户模式，正常模式，字符界面</li><li>4：预留级别，同3级别类似</li><li>5：多用户模式，正常模式，图形界面</li><li>6：重启</li></ul><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/inittab </span><br><span class="line">...此处省去部分内容...</span><br><span class="line">id:<span class="number">3</span>:initdefault:</span><br></pre></td></tr></table></figure><h4 id="etc-rc-d-rc-sysinit"><a href="#etc-rc-d-rc-sysinit" class="headerlink" title="/etc/rc.d/rc.sysinit"></a>/etc/rc.d/rc.sysinit</h4><p>这是启动过程中一个初始化的脚本，主要作用如下：</p><ol><li>设置主机名</li><li>设置欢迎信息</li><li>激活udev和selinux</li><li>挂载/etc/fstab文件中定义的文件系统</li><li>检测根文件系统，并以读写方式重新挂载根文件系统</li><li>设置系统时钟</li><li>激活swap设备</li><li>根据/etc/sysctl.conf文件设置内核参数</li><li>激活lvm及software raid设备</li><li>加载额外设备的驱动程序</li><li>清理操作</li></ol><h4 id="etc-rc-d-目录"><a href="#etc-rc-d-目录" class="headerlink" title="/etc/rc.d/目录"></a>/etc/rc.d/目录</h4><h5 id="etc-rc-d-rc"><a href="#etc-rc-d-rc" class="headerlink" title="/etc/rc.d/rc"></a>/etc/rc.d/rc</h5><p>这是一个脚本文件，负责在运行级别发生更改时启动/停止服务。</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/0cHdijEkal.png?imageslim" alt="mark"></p><h5 id="etc-rc-d-rc-d"><a href="#etc-rc-d-rc-d" class="headerlink" title="/etc/rc.d/rc#.d/"></a>/etc/rc.d/rc#.d/</h5><p><code>/etc/rc.d/rc#.d/</code>目录中包含了启动过程中需要启动的服务，#代表运行级别，以<strong>K</strong>开头的服务，数字越小，越先关闭；数字越小的服务，通常会依赖到别的服务；以<strong>S</strong>开头的服务，数字越小，越先运行；数字越小的服务，通常会被其它服务所依赖到；</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/6BmLFAmmi4.png?imageslim" alt="mark"></p><h4 id="grub-conf"><a href="#grub-conf" class="headerlink" title="grub.conf"></a>grub.conf</h4><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180513/gi6JK0HJEk.png?imageslim" alt="mark"></p><h5 id="配置文件中各项的含义："><a href="#配置文件中各项的含义：" class="headerlink" title="配置文件中各项的含义："></a>配置文件中各项的含义：</h5><p><code>default=0</code></p><p>如果安装了多个操作系统，这一项的值可以定义启动时默认引导的操作系统，0对应的是下文中的第一个<code>title</code>定义的启动项。</p><p><code>timeout=5</code><br>启动等待时间。</p><p><code>splashimage=(hd0,0)/grub/splash.xpm.gz</code><br>启动菜单背景图片的位置</p><p><code>password</code></p><p>在配置文件中没有明确写明，但可以通过在文件中两处不同位置添加<code>password</code>字段实现不同的加密效果。示例：<code>password centos</code></p><p>1.password字段添加在title字段之上，设置编辑grub启动菜单的口令，若想编辑启动菜单需要先输入<code>p</code>字母后，输入正确的口令才能进行编辑。</p><p>2.password字段添加在配置文件尾部，设置启动操作系统的口令，只有输入正确的口令系统才会正常启动。</p><p>补充：为启动菜单设置密码，明文密码并不安全，建议使用加密算法加密。</p><p>示例：</p><ul><li>password –md5 $1$xxxxxxxxxxxxxx        #MD5密文使用grub-md5-crypt生成<br>   password –encrypted $6$xxxxxxxxxxxxxx       #sha512密文使用grub-crypt生成    </li></ul><p>加密算法的设置方法：<br>打开vim编辑器的扩展命令模式，<code>:</code>后输入<code>r!grub-md5-crypt</code>,回车，输入口令，再回车，再次输入口令，回车后密码会自动写入到编辑器光标的所在位置。    </p><p><code>hiddenmenu</code><br>作用是隐藏启动选项菜单，默认是不显示启动选项菜单的，只有在开机时敲任意键才会显示。<br><code>title CentOS 6 (2.6.32-696.el6.x86_64)</code><br>定义启动菜单启动项的名称。</p><p><code>root (hd0,0)</code></p><p>定义启动时根分区所在硬盘和分区对应磁盘的位置，这里的根指的是/boot，是由grub的独特语法决定的。hd是hard disk的缩写，这段的含义是根分区在第一块硬盘的第一个分区。hd0,0的位置对应的是磁盘boot分区的位置，所以在启动的时候是先将boot分区来做为根分区进行挂载的。</p><p><code>kernel /vmlinuz-2.6.32-696.el6.x86_64</code></p><p>定义了内核文件相对于根分区的绝对路径，如果在安装操作系统时没有给/boot划分独立分区，则需写成<code>/boot/vmlinuz-2.6.32-696.el6.x86_64 ro root=/dev/sda2</code>。</p><p><code>ro root=UUID=58991581-5bce-43b0-8ffa-4cb3dd70574c rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</code> </p><p>这一段内容定义的是内核的参数信息，可以使用<code>cat /proc/cmdline</code>命令查看。</p><p><code>ro</code>以只读方式进行挂载，但进入操作系统之后并不是只读的状态，所以后续还会重新挂载一次，选择以只读的方式进行挂载完全是出于安全的考虑。</p><p><code>root=UUID=58991581-5bce-43b0-8ffa-4cb3dd70574c</code>，真正根分区对应磁盘分区的UUID，通过这一行去找要挂载的根分区位置，也可以写成绝对路径/dev/sda2。</p><p><code>rhgb</code>这个字段的作用是启动时产生转圈圈的动画，虽然看着好看，但会隐藏服务的启动流程。建议删除掉，删除后可以看到服务的启动过程，系统出问题有助于排错。不删除的话，只有按Esc键，才会露出这个界面。<br><code>quiet</code>这个字段的作用是默认隐藏内核的启动过程，删除此字符可以看到内核的加载过程信息。</p><p><code>initrd /initramfs-2.6.32-696.el6.x86_64.img</code></p><p>定义ramdisk文件相对于根分区的绝对路径，如果在安装操作系统时没有给/boot划分独立分区，则需写成/boot/initramfs-2.6.32-696.el6.x86_64.img</p><p>Note：因为只有在加载内核后才能知道谁是操作系统的根，才能知道该加载那种文件系统，所以initrd /initramfs-2.6.32-696.el6.x86_64.img 和kernel /vmlinuz-2.6.32-696.el6.x86_64的顺序不能对调，对调会导致无法启动。</p><hr><h4 id="相关文档连接"><a href="#相关文档连接" class="headerlink" title="相关文档连接"></a>相关文档连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> man 7 boot</span></span><br></pre></td></tr></table></figure><p>[Linux 引导过程内幕]: <a href="https://www.ibm.com/developerworks/cn/linux/l-linuxboot/" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/linux/l-linuxboot/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;启动流程简述&quot;&gt;&lt;a href=&quot;#启动流程简述&quot; class=&quot;headerlink&quot; title=&quot;启动流程简述&quot;&gt;&lt;/a&gt;启动流程简述&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;POST加电自检，加载BIOS的硬件信息，检查各种硬件的情况，如CPU，内存和硬盘等硬件是否都插好，是否存在损坏等 。自检完成后会选择启动顺序，获取第一个启动设备。如：硬盘引导启动、网络引导启动、光盘引导启动等，一般选择使用硬盘引导启动，若硬盘无法引导启动则会自动选择后续的可用设备启动引导。启动引导设备也可以通过设置BISO程序的方式进行人为指定。&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://subtraction.tech/categories/Linux/"/>
    
    
      <category term="启动流程" scheme="http://subtraction.tech/tags/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    
      <category term="CentOS" scheme="http://subtraction.tech/tags/CentOS/"/>
    
  </entry>
  
  <entry>
    <title>Keepalived实现Nginx反代的高可用</title>
    <link href="http://subtraction.tech/WEB/Keepalived%E5%AE%9E%E7%8E%B0Nginx%E5%8F%8D%E4%BB%A3%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    <id>http://subtraction.tech/WEB/Keepalived实现Nginx反代的高可用/</id>
    <published>2018-01-21T15:16:04.000Z</published>
    <updated>2018-04-24T03:41:13.335Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="实验前的准备工作"><a href="#实验前的准备工作" class="headerlink" title="实验前的准备工作"></a>实验前的准备工作</h3><p>本次实验使用四台centos7主机来搭建实验环境，实现Nginx的高可用解决方案。由于集群环境对时间要求严格，所以在实验开始前请务必先在四台主机上完成以下四项准备工作，特别是时间的同步。</p><p><strong>具体的网络拓扑结构请看下图：</strong></p><a id="more"></a><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/fFlEiF35Bf.png?imageslim" alt="mark"></p><h4 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root&amp;proxy1: ~#yum -y install ntpdate ntp</span><br><span class="line">root&amp;proxy1: ~#ntpdate 172.18.0.1#和时钟服务器同步时间</span><br><span class="line">30 Oct 10:10:10 ntpdate[2148]: <span class="keyword">step</span> time<span class="built_in"> server </span>172.18.0.1 offset -28792.799544 sec</span><br><span class="line"><span class="comment">#只有时间同步完成后，才能进行此步骤；</span></span><br><span class="line">root&amp;proxy1: ~#vim /etc/chrony.conf</span><br><span class="line"><span class="comment"># These servers were defined in the installation:</span></span><br><span class="line">server 172.18.0.1 iburst#绑定时钟服务器，时钟服务器也可以来自网络，谷歌就可查到；</span><br><span class="line">server 0.centos.pool.ntp.org iburst</span><br><span class="line">server 1.centos.pool.ntp.org iburst</span><br><span class="line">…………此处省略部分显示内容…………</span><br><span class="line">root&amp;proxy1: ~#systemctl <span class="builtin-name">enable</span> chronyd</span><br><span class="line">root&amp;proxy1: ~#systemctl start chronyd</span><br></pre></td></tr></table></figure><h4 id="关闭防火墙和SELinux"><a href="#关闭防火墙和SELinux" class="headerlink" title="关闭防火墙和SELinux"></a>关闭防火墙和SELinux</h4><p><strong>CentOS 7关闭防火墙的方法</strong><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;proxy1: ~<span class="selector-id">#systemctl</span> disable firewalld.service</span><br><span class="line">root&amp;proxy1: ~<span class="selector-id">#systemctl</span> stop firewalld.service</span><br><span class="line">root&amp;proxy1: ~<span class="selector-id">#iptables</span> -F</span><br></pre></td></tr></table></figure></p><p><strong>关闭SElinux策略</strong><br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;proxy1: ~# sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config</span></span><br><span class="line"><span class="section">root&amp;proxy1: ~# grep SELINUX=disabled /etc/selinux/config</span></span><br><span class="line"><span class="comment">#确定SELINUX=disabled，已经将SElinux策略禁用</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line"><span class="section">root&amp;proxy1: ~# setenforce 0</span></span><br><span class="line"><span class="comment">#设置SELinux当前状态为Permissive</span></span><br><span class="line"><span class="section">root&amp;proxy1: ~# getenforce</span></span><br><span class="line"><span class="comment">#获取SELinux当前状态</span></span><br><span class="line">Permissive</span><br></pre></td></tr></table></figure></p><h4 id="做名称解析"><a href="#做名称解析" class="headerlink" title="做名称解析"></a>做名称解析</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root&amp;proxy1: ~<span class="selector-id">#hostnamectl</span> set-hostname proxy1#设置主机名的命令，执行exit命令后再进入生效</span><br><span class="line">root&amp;proxy1: ~<span class="selector-id">#vim</span> /etc/hosts</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>   localhost localhost<span class="selector-class">.localdomain</span> localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost<span class="selector-class">.localdomain</span> localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">172.18</span>.<span class="number">255.254</span>  proxy1</span><br><span class="line"><span class="number">172.18</span>.<span class="number">172.18</span>   proxy2</span><br><span class="line"><span class="number">172.18</span>.<span class="number">73.33</span>    web1</span><br><span class="line"><span class="number">172.18</span>.<span class="number">73.11</span>    web2</span><br><span class="line"></span><br><span class="line">root&amp;proxy1: ~<span class="selector-id">#ping</span> proxy2#完成名称解析后可以直接通过主机名ping通对方</span><br><span class="line">root&amp;proxy1: ~<span class="selector-id">#ping</span> web1</span><br><span class="line">root&amp;proxy1: ~<span class="selector-id">#ping</span> web2</span><br></pre></td></tr></table></figure><h4 id="实现基于key的认证"><a href="#实现基于key的认证" class="headerlink" title="实现基于key的认证"></a>实现基于key的认证</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">proxy1</span>: ~<span class="selector-id">#cd</span> ~</span><br><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">proxy1</span>: ~<span class="selector-id">#ssh-keygen</span>#生成秘钥的命令。</span><br><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">proxy1</span>: ~<span class="selector-id">#cd</span> <span class="selector-class">.ssh</span></span><br><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">proxy1</span>: <span class="selector-class">.ssh</span><span class="selector-id">#ssh-copy-id</span> <span class="selector-tag">-i</span> <span class="selector-tag">id_rsa</span><span class="selector-class">.pub</span> <span class="selector-tag">proxy2</span>:#将公钥文件发送给<span class="selector-tag">proxy2</span>；</span><br><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">proxy1</span>: <span class="selector-class">.ssh</span><span class="selector-id">#ssh</span> <span class="selector-tag">proxy2</span></span><br><span class="line"><span class="selector-tag">Last</span> <span class="selector-tag">login</span>: <span class="selector-tag">Mon</span> <span class="selector-tag">Oct</span> 30 18<span class="selector-pseudo">:07</span><span class="selector-pseudo">:57</span> 2017 <span class="selector-tag">from</span> 172<span class="selector-class">.18</span><span class="selector-class">.10</span><span class="selector-class">.43</span></span><br><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">proxy2</span>: ~##完成基于<span class="selector-tag">key</span>的认证后可以不需要输入密码，直接连接对方主机</span><br></pre></td></tr></table></figure><hr><h3 id="主代理proxy1的配置"><a href="#主代理proxy1的配置" class="headerlink" title="主代理proxy1的配置"></a>主代理proxy1的配置</h3><p><strong>Note：运行Keepalived服务需要网卡支持多播；ip a 会有MULTICAST字样</strong></p><h4 id="安装所需的软件包"><a href="#安装所需的软件包" class="headerlink" title="安装所需的软件包"></a>安装所需的软件包</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;proxy1</span>: ~<span class="meta">#yum -y install keepalived nginx psmisc mailx</span></span><br></pre></td></tr></table></figure><h4 id="定义通知脚本"><a href="#定义通知脚本" class="headerlink" title="定义通知脚本"></a>定义通知脚本</h4><p>此脚本的作用是在Keepalived服务发生故障时，以邮件的方式通知管理员。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">root&amp;proxy1</span>: ~#vim /etc/keepalived/notify.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">contact='root@localhost'</span><br><span class="line">notify() &#123;</span><br><span class="line">        mailsubject="$(hostname) to be $1, vip floating"</span><br><span class="line">        mailbody="$(date +'%F %T'): vrrp transition, $(hostname) changed to be $1"</span><br><span class="line">        echo "$mailbody" | mail -s "$mailsubject" $contact</span><br><span class="line">&#125;</span><br><span class="line">case $1 in</span><br><span class="line"><span class="attribute">master)</span></span><br><span class="line">        notify master</span><br><span class="line">        ;;</span><br><span class="line"><span class="attribute">backup)</span></span><br><span class="line">        notify backup</span><br><span class="line">        ;;</span><br><span class="line"><span class="attribute">fault)</span></span><br><span class="line">        notify fault</span><br><span class="line">        ;;</span><br><span class="line">*)</span><br><span class="line">        echo "Usage: $(basename $0) &#123;master|backup|fault&#125;"</span><br><span class="line">        exit 1</span><br><span class="line">        ;;</span><br><span class="line"><span class="attribute">esac</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">root&amp;proxy1</span>: ~#chmod +x /etc/keepalived/notify.sh</span><br><span class="line"><span class="attribute">root&amp;proxy1</span>: ~#scp /etc/keepalived/notify.sh proxy2:/etc/keepalived/</span><br></pre></td></tr></table></figure><h4 id="定义Keepalived的日志存储"><a href="#定义Keepalived的日志存储" class="headerlink" title="定义Keepalived的日志存储"></a>定义Keepalived的日志存储</h4><p>定义Keepalived的日志存储，有利于在发生故障后为排错提供参考数据；</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;proxy1</span>: ~<span class="meta">#vim /etc/sysconfig/keepalived</span></span><br><span class="line">KEEPALIVED_OPTIONS=<span class="string">"-D -S 2"</span></span><br><span class="line">root<span class="variable">&amp;proxy1</span>: ~<span class="meta">#vim /etc/rsyslog.conf</span></span><br><span class="line">local2.*                                             <span class="meta-keyword">/var/</span>log/keepalived.log</span><br><span class="line">root<span class="variable">&amp;proxy1</span>: ~<span class="meta">#systemctl restart rsyslog</span></span><br><span class="line">root<span class="variable">&amp;proxy1</span>: ~<span class="meta">#systemctl restart keepalived</span></span><br></pre></td></tr></table></figure><h4 id="配置Keepalived服务"><a href="#配置Keepalived服务" class="headerlink" title="配置Keepalived服务"></a>配置Keepalived服务</h4><p>Keepalived服务是一个基于vrrp协议的服务，主要用于实现集群的高可用性，更多关于vrrp协议的知识可以查看《vrrp技术白皮书》。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">root&amp;proxy1</span>: ~#vim /etc/keepalived/keepalived.conf</span><br><span class="line"></span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;#全局配置</span><br><span class="line">   notification_email &#123;#定义收邮件的邮箱</span><br><span class="line"> <span class="attribute">root@localhost</span></span><br><span class="line"> sxy2475@gmail.com</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   notification_email_from proxy1@localhost#定义发邮件的邮箱</span><br><span class="line">   smtp_server 127.0.0.1#定义邮件服务器的地址</span><br><span class="line">   smtp_connect_timeout 30#邮件的超时时长</span><br><span class="line">   router_id proxy1#ID对应主机名</span><br><span class="line">   vrrp_mcast_group4224.111.111.111#定义vrrp协议使用的多播地址</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_down &#123;#用于控制Keepalived优先级的脚本</span><br><span class="line">script "[[ -f /etc/keepalived/down ]] &amp;&amp; exit 1 || exit 0"</span><br><span class="line">interval 1    #通过每秒检测一次/etc/keepalived/down文件是否存在，来控制服务优先级。</span><br><span class="line">weight -20    #文件存在优先级-20，主要用于服务调试。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;#检查Nginx反代存活状态的脚本</span><br><span class="line">script "killall -0 nginx &amp;&gt; /dev/null &amp;&amp; exit 0 || exit 1"#yum install psmisc -y</span><br><span class="line">interval 1</span><br><span class="line">weight -20   #定时通过killall命令发送0信号检测Nginx服务是否还存活。</span><br><span class="line">fall 3   #检测到三次服务不存活就主动下调优先级</span><br><span class="line">rise 3   #检测到三次服务存活就主动恢复优先级</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;#虚拟路由器的配置</span><br><span class="line">state MASTER   #此处定义了设备的主备关系，此处为MASTER，另一台主机的此处就需设为BACKUP。</span><br><span class="line">interface ens32  #对外接口的网卡名</span><br><span class="line">virtual_router_id 88#定义虚拟路由器的编号，同一组设备需要编号一致。</span><br><span class="line">priority 100#优先级编号，主设备的优先级要高于从设备；</span><br><span class="line">advert_int 1#发送公告的间隔时间；1秒</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass 8poTWQ==#主备通信的加密口令；八位以内随机数；</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;#定义VIP的地址，此地址会自动绑定在优先级高的设备上，接收用户的请求；</span><br><span class="line"><span class="attribute">172.18.22.22/16</span></span><br><span class="line">&#125;</span><br><span class="line">#以下几项是对上面脚本的调用；</span><br><span class="line">notify_master"/etc/keepalived/notify.sh master"</span><br><span class="line">notify_backup"/etc/keepalived/notify.sh backup"</span><br><span class="line">notify_fault"/etc/keepalived/notify.sh fault"</span><br><span class="line">track_script &#123;</span><br><span class="line">chk_down#调用chk_down脚本</span><br><span class="line">chk_nginx   #调用chk_nginx脚本</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">root&amp;proxy1</span>: ~#systemctl start keepalived#启动Keepalived服务</span><br></pre></td></tr></table></figure><h4 id="配置Nginx的反向代理"><a href="#配置Nginx的反向代理" class="headerlink" title="配置Nginx的反向代理"></a>配置Nginx的反向代理</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;proxy1</span>: ~<span class="meta">#vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="class">http </span>&#123;</span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">upstream <span class="class">websrvs </span>&#123;              <span class="meta">#需定义于http字段</span></span><br><span class="line">    server <span class="number">172.18</span><span class="number">.73</span><span class="number">.33</span>:<span class="number">80</span> weight=<span class="number">1</span>;   <span class="meta">#后端的被代理服务器地址，以及调度的权重。</span></span><br><span class="line">        server <span class="number">172.18</span><span class="number">.73</span><span class="number">.11</span>:<span class="number">80</span> weight=<span class="number">1</span>;</span><br><span class="line">        server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span> backup;   <span class="meta">#sorry_server的地址，用于后端服务器都挂掉时。</span></span><br><span class="line">     &#125;</span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">&#125;</span><br><span class="line"><span class="class">server </span>&#123;</span><br><span class="line">        listen <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span> ;    <span class="meta">#定义sorry_server监听的端口以及主目录所在路径；</span></span><br><span class="line">        root         <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/nginx/</span>html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class">server </span>&#123;</span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">location <span class="class">/ &#123;#需要定义于server字段</span></span><br><span class="line"><span class="class">proxy_pass http:<span class="comment">//websrvs;     #访问本机web服务的"/"时向后调度的组</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class">……此处省略部分显示内容……</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">root<span class="variable">&amp;proxy1</span>: ~#nginx -t</span></span><br><span class="line"><span class="class">root<span class="variable">&amp;proxy1</span>: ~#echo sorry_server1 &gt; <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/nginx/</span>html/index.html</span></span><br><span class="line"><span class="class">root<span class="variable">&amp;proxy1</span>: ~#nginx</span></span><br></pre></td></tr></table></figure><hr><h3 id="备用代理proxy2的配置"><a href="#备用代理proxy2的配置" class="headerlink" title="备用代理proxy2的配置"></a>备用代理proxy2的配置</h3><h4 id="安装所需的软件包-1"><a href="#安装所需的软件包-1" class="headerlink" title="安装所需的软件包"></a>安装所需的软件包</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;proxy2</span>: ~<span class="meta">#yum -y install keepalived nginx psmisc mailx</span></span><br></pre></td></tr></table></figure><h4 id="定义Keepalived的日志存储-1"><a href="#定义Keepalived的日志存储-1" class="headerlink" title="定义Keepalived的日志存储"></a>定义Keepalived的日志存储</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;proxy2</span>: ~<span class="meta">#vim /etc/sysconfig/keepalived</span></span><br><span class="line">KEEPALIVED_OPTIONS=<span class="string">"-D -S 2"</span></span><br><span class="line">root<span class="variable">&amp;proxy2</span>: ~<span class="meta">#vim /etc/rsyslog.conf</span></span><br><span class="line">local2.*                                           <span class="meta-keyword">/var/</span>log/keepalived.log</span><br><span class="line">root<span class="variable">&amp;proxy2</span>: ~<span class="meta">#systemctl restart rsyslog</span></span><br><span class="line">root<span class="variable">&amp;proxy2</span>: ~<span class="meta">#systemctl restart keepalived</span></span><br></pre></td></tr></table></figure><h4 id="配置Keepalived服务-1"><a href="#配置Keepalived服务-1" class="headerlink" title="配置Keepalived服务"></a>配置Keepalived服务</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">root&amp;proxy1: ~#vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line"> root@localhost</span><br><span class="line"> sxy2475@gmail.com</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   notification_email_from proxy2@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id proxy2#ID对应主机名</span><br><span class="line">   vrrp_mcast_group4224.111.111.111#两个设备多播地址要相同；</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_down &#123;</span><br><span class="line"><span class="built_in">script </span><span class="string">"[[ -f /etc/keepalived/down ]] &amp;&amp; exit 1 || exit 0"</span></span><br><span class="line">interval 1</span><br><span class="line">weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line"><span class="built_in">script </span><span class="string">"killall -0 nginx &amp;&gt; /dev/null &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">interval 1</span><br><span class="line">weight -20</span><br><span class="line">fall 3</span><br><span class="line">rise 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state BACKUP      #此设备为BACKUP </span><br><span class="line"><span class="built_in">interface </span>ens32   </span><br><span class="line">virtual_router_id 88#定义虚拟路由器的编号</span><br><span class="line">priority 90    #优先级编号，要低于MASTERT设备；</span><br><span class="line">advert_int 1</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass <span class="attribute">8poTWQ</span>==#两个设备要口令相同</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;#定义VIP的地址</span><br><span class="line">172.18.22.22/16</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notify_master<span class="string">"/etc/keepalived/notify.sh master"</span></span><br><span class="line">notify_backup<span class="string">"/etc/keepalived/notify.sh backup"</span></span><br><span class="line">notify_fault<span class="string">"/etc/keepalived/notify.sh fault"</span></span><br><span class="line">track_script &#123;</span><br><span class="line">chk_down</span><br><span class="line">chk_nginx</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root&amp;proxy2: ~#systemctl start keepalived</span><br></pre></td></tr></table></figure><h4 id="配置备用的Nginx反向代理"><a href="#配置备用的Nginx反向代理" class="headerlink" title="配置备用的Nginx反向代理"></a>配置备用的Nginx反向代理</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;proxy2</span>: ~<span class="meta">#vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="class">http </span>&#123;</span><br><span class="line">…………</span><br><span class="line">upstream <span class="class">websrvs </span>&#123;</span><br><span class="line">server <span class="number">172.18</span><span class="number">.73</span><span class="number">.33</span>:<span class="number">80</span> weight=<span class="number">1</span>;</span><br><span class="line">        server <span class="number">172.18</span><span class="number">.73</span><span class="number">.11</span>:<span class="number">80</span> weight=<span class="number">1</span>;</span><br><span class="line">        server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span> backup;</span><br><span class="line">&#125;</span><br><span class="line">…………</span><br><span class="line">&#125;</span><br><span class="line"><span class="class">server </span>&#123;</span><br><span class="line">        listen <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span> ;</span><br><span class="line">        root         <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/nginx/</span>html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class">server </span>&#123;</span><br><span class="line">…………</span><br><span class="line">location <span class="class">/ &#123;</span></span><br><span class="line"><span class="class">proxy_pass http:<span class="comment">//websrvs;</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class">…………</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">root<span class="variable">&amp;proxy2</span>: ~#nginx -t</span></span><br><span class="line"><span class="class">root<span class="variable">&amp;proxy2</span>: ~#echo sorry_server2 &gt; <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/nginx/</span>html/index.html</span></span><br><span class="line"><span class="class">root<span class="variable">&amp;proxy2</span>: ~#nginx</span></span><br></pre></td></tr></table></figure><hr><h3 id="后端被代理服务器web1的配置"><a href="#后端被代理服务器web1的配置" class="headerlink" title="后端被代理服务器web1的配置"></a>后端被代理服务器web1的配置</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;web1</span>: ~<span class="meta">#yum -y install nginx</span></span><br><span class="line">root<span class="variable">&amp;web1</span>: ~<span class="meta">#echo nginx web1 &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root<span class="variable">&amp;web1</span>: ~<span class="meta">#nginx</span></span><br></pre></td></tr></table></figure><h3 id="后端被代理服务器web2的配置"><a href="#后端被代理服务器web2的配置" class="headerlink" title="后端被代理服务器web2的配置"></a>后端被代理服务器web2的配置</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;web2</span>: ~<span class="meta">#yum -y install nginx</span></span><br><span class="line">root<span class="variable">&amp;web2</span>: ~<span class="meta">#echo nginx web2 &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root<span class="variable">&amp;web2</span>: ~<span class="meta">#nginx</span></span><br></pre></td></tr></table></figure><hr><h3 id="测试高可用性"><a href="#测试高可用性" class="headerlink" title="测试高可用性"></a>测试高可用性</h3><h4 id="后端web服务器单点失败"><a href="#后端web服务器单点失败" class="headerlink" title="后端web服务器单点失败"></a>后端web服务器单点失败</h4><p>停掉web1的Nginx服务，代理服务器可以自动检测到web1宕掉，不再向坏掉的web1调度数据包。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;web1</span>: ~<span class="meta">#nginx -s stop</span></span><br></pre></td></tr></table></figure><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root&amp;client: ~#<span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">1.</span><span class="number">.1000</span>&#125; ; <span class="keyword">do</span> sleep <span class="number">0.5</span> ;curl <span class="number">172.18</span><span class="number">.22</span><span class="number">.22</span> ; <span class="keyword">done</span></span><br><span class="line">nginx web2</span><br><span class="line">nginx web2</span><br><span class="line">nginx web2</span><br><span class="line">nginx web2</span><br></pre></td></tr></table></figure><h4 id="后端web服务器全部失败"><a href="#后端web服务器全部失败" class="headerlink" title="后端web服务器全部失败"></a>后端web服务器全部失败</h4><p>停掉web1和web2两台主机的Nginx服务，前端代理服务器会自动响应sorry server；</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;web1</span>: ~<span class="meta">#nginx -s stop</span></span><br></pre></td></tr></table></figure><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;web2</span>: ~<span class="meta">#nginx -s stop</span></span><br></pre></td></tr></table></figure><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root&amp;client: ~#<span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">1.</span><span class="number">.1000</span>&#125; ; <span class="keyword">do</span> sleep <span class="number">0.5</span> ;curl <span class="number">172.18</span><span class="number">.22</span><span class="number">.22</span> ; <span class="keyword">done</span></span><br><span class="line">sorry_server1</span><br><span class="line">sorry_server1</span><br><span class="line">sorry_server1</span><br></pre></td></tr></table></figure><h4 id="Nginx代理导致的前端代理单点失败"><a href="#Nginx代理导致的前端代理单点失败" class="headerlink" title="Nginx代理导致的前端代理单点失败"></a>Nginx代理导致的前端代理单点失败</h4><p>宕掉前端主代理服务器的Nginx服务，备用代理服务器会主动接过VIP响应客户端的请求，但会有几秒钟不能响应客户端请求。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;proxy1</span>: ~<span class="meta">#nginx -s stop</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/g5lhbbFhBb.png?imageslim" alt="mark"></p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root&amp;client: ~#<span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">1.</span><span class="number">.1000</span>&#125; ; <span class="keyword">do</span> sleep <span class="number">0.5</span> ;curl <span class="number">172.18</span><span class="number">.22</span><span class="number">.22</span> ; <span class="keyword">done</span></span><br><span class="line">nginx web2</span><br><span class="line">nginx web1</span><br><span class="line">nginx web2</span><br><span class="line">nginx web1</span><br><span class="line">curl: (<span class="number">7</span>) couldn't connect <span class="keyword">to</span> host</span><br><span class="line">curl: (<span class="number">7</span>) couldn't connect <span class="keyword">to</span> host</span><br><span class="line">curl: (<span class="number">7</span>) couldn't connect <span class="keyword">to</span> host</span><br><span class="line">curl: (<span class="number">7</span>) couldn't connect <span class="keyword">to</span> host</span><br><span class="line">curl: (<span class="number">7</span>) couldn't connect <span class="keyword">to</span> host</span><br><span class="line">curl: (<span class="number">7</span>) couldn't connect <span class="keyword">to</span> host</span><br><span class="line">curl: (<span class="number">7</span>) couldn't connect <span class="keyword">to</span> host</span><br><span class="line">nginx web2</span><br><span class="line">nginx web2</span><br><span class="line">nginx web1</span><br></pre></td></tr></table></figure><h4 id="Keepalived导致的前端代理单点失败"><a href="#Keepalived导致的前端代理单点失败" class="headerlink" title="Keepalived导致的前端代理单点失败"></a>Keepalived导致的前端代理单点失败</h4><p>宕掉前端主代理服务器的Keepalived服务，备用代理服务器会主动接过VIP响应客户端的请求，请求不会中断。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;proxy1</span>: ~<span class="meta">#systemctl stop keepalived</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/LA25aiddhd.png?imageslim" alt="mark"></p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root&amp;client: ~#<span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">1.</span><span class="number">.1000</span>&#125; ; <span class="keyword">do</span> sleep <span class="number">0.5</span> ;curl <span class="number">172.18</span><span class="number">.22</span><span class="number">.22</span> ; <span class="keyword">done</span></span><br><span class="line">nginx web1</span><br><span class="line">nginx web2</span><br><span class="line">nginx web1</span><br><span class="line">nginx web2</span><br><span class="line">nginx web1</span><br><span class="line">nginx web2</span><br><span class="line">nginx web1</span><br></pre></td></tr></table></figure><p><strong>观察VIP的迁移</strong><br><em>服务宕掉前</em></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/6CbEb1b3A1.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/a7mhfm9BEh.png?imageslim" alt="mark"></p><p><em>服务宕掉后</em></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/KFHgfhdijK.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/8dGH723gc4.png?imageslim" alt="mark"></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;实验前的准备工作&quot;&gt;&lt;a href=&quot;#实验前的准备工作&quot; class=&quot;headerlink&quot; title=&quot;实验前的准备工作&quot;&gt;&lt;/a&gt;实验前的准备工作&lt;/h3&gt;&lt;p&gt;本次实验使用四台centos7主机来搭建实验环境，实现Nginx的高可用解决方案。由于集群环境对时间要求严格，所以在实验开始前请务必先在四台主机上完成以下四项准备工作，特别是时间的同步。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;具体的网络拓扑结构请看下图：&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="WEB" scheme="http://subtraction.tech/categories/WEB/"/>
    
    
      <category term="HA" scheme="http://subtraction.tech/tags/HA/"/>
    
      <category term="Nginx" scheme="http://subtraction.tech/tags/Nginx/"/>
    
      <category term="Keepalived" scheme="http://subtraction.tech/tags/Keepalived/"/>
    
  </entry>
  
  <entry>
    <title>Iptables使用方法</title>
    <link href="http://subtraction.tech/Command/Iptables%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/"/>
    <id>http://subtraction.tech/Command/Iptables使用方法/</id>
    <published>2018-01-03T07:51:17.000Z</published>
    <updated>2018-04-23T13:10:47.485Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="Iptables的组成"><a href="#Iptables的组成" class="headerlink" title="Iptables的组成"></a>Iptables的组成</h3><p>Iptables由四个表和五个链以及一些规则组成</p><a id="more"></a><h4 id="四张表"><a href="#四张表" class="headerlink" title="四张表"></a>四张表</h4><p><strong>四张表及其功能简介</strong></p><table><thead><tr><th>表名</th><th>功能</th></tr></thead><tbody><tr><td>filter表</td><td>过滤规则表，根据预定义的规则过滤符合条件的数据包</td></tr><tr><td>nat表</td><td>地址转换规则表</td></tr><tr><td>mangle表</td><td>修改数据标记位规则表</td></tr><tr><td>raw表</td><td>关闭nat表上启用的连接追踪功能，加快封包穿越防火墙的速度</td></tr></tbody></table><p><strong>四张表按优先级由高到低的顺序为: raw–&gt;mangle–&gt;nat–&gt;filter</strong></p><h4 id="五个链"><a href="#五个链" class="headerlink" title="五个链"></a>五个链</h4><p><strong>五个内置链（chain）及其所在位置</strong></p><table><thead><tr><th>链名</th><th>位置</th></tr></thead><tbody><tr><td>PREROUTING</td><td>报文进入本机的路由前的位置</td></tr><tr><td>INPUT</td><td>到达本机内部的报文的位置</td></tr><tr><td>FORWARD</td><td>由本机转发的报文的位置</td></tr><tr><td>OUTPUT</td><td>由本机内部发出的报文的位置</td></tr><tr><td>POSTROUTING</td><td>报文路由后流出本机的位置</td></tr></tbody></table><p><strong>数据报文流向</strong></p><ul><li><p>跟本机内部进程通信：</p><ul><li>流入 ：   –&gt; PREROUTING –&gt; INPUT</li><li>流出 ：   –&gt; OUTPUT –&gt; POSTROUTING</li></ul></li><li>经由本机转发：<ul><li>请求： –&gt; PREROUTING –&gt; FORWARD –&gt; POSTROUTING</li><li>响应： –&gt; PREROUTING –&gt; FORWARD –&gt; POSTROUIING</li></ul></li></ul><p><strong>表和链的对应关系</strong></p><table><thead><tr><th>表名</th><th>链</th></tr></thead><tbody><tr><td>filter</td><td>INPUT, FORWARD, OUTPUT</td></tr><tr><td>nat</td><td>PREROUTING（SNAT），POSTROUTING（DNAT），OUTPUT</td></tr><tr><td>mangle</td><td>PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING</td></tr><tr><td>raw</td><td>PREROUTING, OUTPUT</td></tr></tbody></table><h4 id="添加规则的要点"><a href="#添加规则的要点" class="headerlink" title="添加规则的要点"></a>添加规则的要点</h4><p><strong>iptables添加规则时的考量点</strong></p><ol><li>要实现哪种功能：判断添加在哪张表上</li><li>报文流经的路径：判断添加在哪个链上</li><li>报文的流向：判断源和目的地</li><li>匹配规则：根据业务需要</li><li>客户端端口是随机的，因此大多数场景下无须限定</li></ol><p><strong>链上规则的次序，即为检查的次序</strong></p><ol><li>切记：先添加放行自己的规则</li><li>同类规则(访问同一应用)，匹配范围小的放上面</li><li>不同类规则(访问不同应用)，匹配到报文频率较大的放上面</li><li>将那些可由一条规则描述的多个规则合并为一个</li><li>设置默认策略，允许所有或拒绝所有</li></ol><hr><h3 id="Iptables的使用"><a href="#Iptables的使用" class="headerlink" title="Iptables的使用"></a>Iptables的使用</h3><p><strong>基本语法：</strong></p><blockquote><p>iptables [-t 表名] &lt;-A|-I|-D|-R&gt; 链名 [规则编号][-i|-o 网卡名称] [-p 协议类型][-s 源IP地址|源子网] [-sport 源端口号][-d 目标IP地址|目标子网] [-dport 目标端口号][-m 模式 [模式选项]]  -j  动作 [动作选项]</p></blockquote><h4 id="对表进行的操作"><a href="#对表进行的操作" class="headerlink" title="对表进行的操作"></a>对表进行的操作</h4><ul><li><strong>-t TABLE</strong>      <ul><li>nat </li><li>mangle</li><li>raw</li><li>filter</li></ul></li></ul><p><strong>默认为filter表</strong><br><strong>示例：</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]#iptables -t<span class="built_in"> filter </span>-A INPUT -s 172.18.255.254 -j DROP</span><br><span class="line">~]#iptables -t<span class="built_in"> nat </span>-A POSTROUTING -s 192.168.10.0/24 -j SNAT --to-source 172.18.255.254</span><br></pre></td></tr></table></figure><h4 id="对链进行的操作"><a href="#对链进行的操作" class="headerlink" title="对链进行的操作"></a>对链进行的操作</h4><ul><li>-N：new，新建一条链</li><li>-X：delete，删除一条用户自定义链（空链）</li><li>-F：lush，清空一条链，默认清空表中所有链</li><li>-P：policy，定义链的默认处理策略<ul><li>ACCEPT        接受</li><li>DROP           丢弃</li><li>REJECT         拒绝</li></ul></li><li>-E：rename，重命名自定义的未被引用的（计数器为0）链</li></ul><h4 id="对规则进行的操作"><a href="#对规则进行的操作" class="headerlink" title="对规则进行的操作"></a>对规则进行的操作</h4><ul><li>-L: list，列出规则<ul><li>-n：numeric，以数字格式显示地址和端口</li><li>-v：verbose，详细信息，-vv, -vvv</li><li>-x：exactly，显示计数器的精确值</li><li>–line-numbers：显示链上规则的编号</li></ul></li><li>-A：append，追加，在链的最后加一条规则</li><li>-I： Insert，插入一条规则，默认第一个，一般使用 -I CHAIN NUM 给规则加一个编号</li><li>-D：delete，删除一条规则，可以输入完整规则，或者直接指定标号加以删除<ul><li>rule speclfication</li><li>rule number</li></ul></li><li>-R：replace,替换某条规则，规则被替换并不会改变顺序，必须要指定替换的规则编号。-R CHAIN NUM</li><li>-Z： zero，清空计数器，iptables中每条规则默认有两个计数器</li><li>-S：selected，以iptables-save 命令的格式显示链上的规则</li></ul><p><strong>示例：</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-A</span> <span class="selector-tag">INPUT</span> <span class="selector-tag">-s</span> 172<span class="selector-class">.18</span><span class="selector-class">.255</span><span class="selector-class">.254</span> <span class="selector-tag">-j</span> <span class="selector-tag">DROP</span></span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-A</span> <span class="selector-tag">INPUT</span> <span class="selector-tag">-s</span> 172<span class="selector-class">.18</span><span class="selector-class">.10</span><span class="selector-class">.0</span> <span class="selector-tag">-j</span> <span class="selector-tag">REJECT</span></span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-I</span> <span class="selector-tag">INPUT</span> <span class="selector-tag">-s</span> 172<span class="selector-class">.18</span><span class="selector-class">.0</span><span class="selector-class">.2</span> <span class="selector-tag">-j</span> <span class="selector-tag">ACCEPT</span>#默认插入到的是第一条</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-I</span> <span class="selector-tag">INPUT</span> 2 <span class="selector-tag">-s</span> 172<span class="selector-class">.18</span><span class="selector-class">.22</span><span class="selector-class">.100</span> <span class="selector-tag">-j</span> <span class="selector-tag">ACCEPT</span>#指定插入位置</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-D</span> <span class="selector-tag">INPUT</span> 2#删除规则</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-R</span> <span class="selector-tag">INPUT</span> 2 <span class="selector-tag">-s</span> 172<span class="selector-class">.18</span><span class="selector-class">.255</span><span class="selector-class">.254</span> <span class="selector-tag">-j</span> <span class="selector-tag">ACCEPT</span>#替换指定规则</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-F</span>#清空所有规则</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-Z</span>#清空计数器</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-nvL</span>#查看规则</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-nvL</span> <span class="selector-tag">--line-numbers</span>#显示规则编号</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-S</span>#命令格式显示链上规则</span><br><span class="line">~]<span class="selector-id">#iptables</span> <span class="selector-tag">-nvL</span> <span class="selector-tag">-t</span> <span class="selector-tag">nat</span>#查看指定的表</span><br></pre></td></tr></table></figure><h4 id="匹配条件"><a href="#匹配条件" class="headerlink" title="匹配条件"></a>匹配条件</h4><h5 id="基本匹配"><a href="#基本匹配" class="headerlink" title="基本匹配"></a>基本匹配</h5><blockquote><p>基本匹配：netfilter自带的匹配规则</p></blockquote><ul><li>-s：指定匹配数据包的源地址</li><li>-d：指定匹配数据包的目标地址</li><li>-i：指定数据包的流入接口（逻辑接口），只能用于PREROUTING 、INPUT及FORWARD </li><li>-o：指定数据包的流出接口，只能用于OUTPUT、FORWARD及POSTROUTING</li></ul><p><strong>示例：</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~]#iptables -A INPUT -s <span class="number">172.18</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -j REJECT#拒绝整个网段</span><br><span class="line">~]#iptables -A INPUT -s <span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span>,<span class="number">172.18</span><span class="number">.10</span><span class="number">.0</span> -j REJECT#同时定义多个IP</span><br><span class="line">~]#iptables -A INPUT -s <span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span>,<span class="number">172.18</span><span class="number">.10</span><span class="number">.0</span> -d <span class="number">192.168</span><span class="number">.10</span><span class="number">.129</span> -j REJECT</span><br><span class="line">~]#iptables -A INPUT -d <span class="number">192.168</span><span class="number">.10</span><span class="number">.129</span> -j REJECT#拒绝访问特定目标ip</span><br><span class="line">~]#iptables -A INPUT ! -d <span class="number">192.168</span><span class="number">.10</span><span class="number">.129</span> -j REJECT#取反，除访问特定地址外的数据包都拒绝</span><br><span class="line">~]#iptables -A INPUT ! -s <span class="number">172.18</span><span class="number">.10</span><span class="number">.0</span> -j REJECT</span><br><span class="line">~]#iptables -A INPUT -p icmp -j REJECT#只拒绝指定协议</span><br><span class="line">~]#iptables -A INPUT -i ens32 -p icmp -j REJECT#拒绝指定接口的流量</span><br></pre></td></tr></table></figure><h5 id="扩展匹配"><a href="#扩展匹配" class="headerlink" title="扩展匹配"></a>扩展匹配</h5><blockquote><p>扩展匹配：对某一种功能的扩展，经由扩展模块引入的匹配机制</p></blockquote><p><strong>语法：</strong><code>-m macth_name \- -spec_options</code><br><strong>示例：</strong> <code>-m tcp \- -dport 22</code></p><p><strong>隐式扩展：对某一种协议扩展</strong></p><ul><li>-p (tcp|udp|icmp|icmpv6|ah|esp|sctp|mh|all)：做协议匹配<ul><li>tcp：隐藏了”-m tcp”的专用选项<ul><li>[!] - -source-port, –sport port [:port] 匹配报文中TCP首部源端口，可以是端口范围；</li><li>[!] - -dport port [:port]：目标端口，可以是单个端口或连续多个端口；</li><li>[!] - -tcp-flags (SYN, ACK, FIN, RST, PSH, URG,RST,ALL,NONE)指定TCP的标志位，需要跟两个标志位列表，如：SYN,ACK,FIN,RST,SYN 第一个列表表示要检查的位，第二个列表表示第一个列表中所有标记位必须为1，而余下的必须为0；没有LIST1中指明的，不作检查；  </li><li>[!] - -syn: 只允许新连接，相当于‘ - -tcp-flags SYN,ACK,FIN,RST,SYN’</li></ul></li><li>udp：隐藏了”-m udp”的专用选项<ul><li>[!]  - -sport port[:port]：指定匹配报文的源端口；可以是端口范围</li><li>[!]  - -dport port[:port]：指定匹配报文的目标端口；可以是端口范围</li></ul></li><li>icmp：隐藏了”-m icmpd”的专用选项<ul><li>[!]  - -icmp-type<ul><li>0：echo-reply，icmp应答</li><li>8 : echo-request，icmp请求</li></ul></li></ul></li></ul></li></ul><p><strong>示例：</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -<span class="selector-tag">p</span> tcp --dport <span class="number">80</span> -j REJECT#拒绝指定协议的指定端口</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -<span class="selector-tag">p</span> tcp --dport <span class="number">23</span> -j REJECT</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -s <span class="number">172.18</span>.<span class="number">255.254</span> -<span class="selector-tag">p</span> tcp -m multiport --dports <span class="number">23</span>:<span class="number">25</span>,<span class="number">80</span> -j REJECT#显式扩展，定义多端口匹配。</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -m iprange --src-range <span class="number">172.18</span>.<span class="number">1.0</span>-<span class="number">172.18</span>.<span class="number">255.255</span> -<span class="selector-tag">p</span> tcp -m multiport --dports <span class="number">23</span>:<span class="number">25</span>,<span class="number">80</span> -j REJECT</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -m mac --mac-source <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:<span class="number">2</span>c:<span class="number">74</span>:<span class="number">64</span> -<span class="selector-tag">p</span> tcp -m multiport --dports <span class="number">23</span>,<span class="number">80</span> -j REJECT#基于MAC的控制</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A OUTPUT -m string --algo bm --string <span class="string">"abc"</span> -j REJECT#拦截带有特定字符串的数据包</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -s <span class="number">172.18</span>.<span class="number">0.0</span>/<span class="number">16</span> -d <span class="number">172.18</span>.<span class="number">172.18</span> -<span class="selector-tag">p</span> tcp --dport <span class="number">80</span> -m <span class="selector-tag">time</span> --timestart <span class="number">00</span>:<span class="number">00</span> --timestop <span class="number">10</span>:<span class="number">00</span> --weekdays Wed,Sun -j DROP#基于时间的控制</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -<span class="selector-tag">p</span> tcp --dport <span class="number">22</span> -m connlimit --connlimit-above <span class="number">2</span> -j REJECT#限制单台主机的ssh连接数量</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -<span class="selector-tag">p</span> icmp --icmp-type <span class="number">8</span> -m limit --limit <span class="number">10</span>/minute --limit-burst <span class="number">10</span> -j ACCEPT</span><br><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -<span class="selector-tag">p</span> icmp -j REJECT#基于收发报文的速率做匹配</span><br></pre></td></tr></table></figure><p><strong>显示扩展：额外附加的更多匹配规则，功能性的扩展</strong></p><ul><li>-m multiport ：以离散方式定义多端口匹配,最多指定15个端口<ul><li>[!] –source-ports,–sports port[,port|,port:port]…      指定多个源端口</li><li>[!] –destination-ports,–dportsport[,port|,port:port]…       指定多个目标端口</li><li>[!] –ports port[,port|,port:port]…     多个源或目标端口</li></ul></li></ul><p><strong>示例：</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# iptables -I INPUT -s <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -d <span class="number">172.16</span><span class="number">.100</span><span class="number">.9</span> -p tcp -m multiport --dports <span class="number">22</span>,<span class="number">80</span> -j ACCEPT</span><br><span class="line">~]# iptables -I OUTPUT -d <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> -s <span class="number">172.16</span><span class="number">.100</span><span class="number">.9</span> -p tcp -m multiport --sports <span class="number">22</span>,<span class="number">80</span> -j ACCEPT</span><br></pre></td></tr></table></figure><ul><li>-m iprange :  指明连续的（但一般是不能扩展为整个网络）ip地址范围时使用；<ul><li>[!] - -src-range from[-to]：指明连续的源IP地址范围；</li><li>[!] - -dst-range from[-to]：指明连续的目标IP地址范围；</li></ul></li></ul><p><strong>示例：</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# <span class="selector-tag">iptables</span> <span class="selector-tag">-I</span> <span class="selector-tag">INPUT</span> <span class="selector-tag">-d</span> 172<span class="selector-class">.16</span><span class="selector-class">.100</span><span class="selector-class">.9</span> <span class="selector-tag">-p</span> <span class="selector-tag">tcp</span> <span class="selector-tag">-m</span> <span class="selector-tag">multiport</span> <span class="selector-tag">--dports</span> 22<span class="selector-pseudo">:23</span>,80 <span class="selector-tag">-m</span> <span class="selector-tag">iprange</span> <span class="selector-tag">--src-range</span> 172<span class="selector-class">.16</span><span class="selector-class">.100</span><span class="selector-class">.1-172</span><span class="selector-class">.16</span><span class="selector-class">.100</span><span class="selector-class">.120</span> <span class="selector-tag">-j</span> <span class="selector-tag">ACCEPT</span></span><br><span class="line">~]# <span class="selector-tag">iptables</span> <span class="selector-tag">-I</span> <span class="selector-tag">OUTPUT</span> <span class="selector-tag">-s</span> 172<span class="selector-class">.16</span><span class="selector-class">.100</span><span class="selector-class">.9</span> <span class="selector-tag">-p</span> <span class="selector-tag">tcp</span> <span class="selector-tag">-m</span> <span class="selector-tag">multiport</span> <span class="selector-tag">--sports</span> 22<span class="selector-pseudo">:23</span>,80 <span class="selector-tag">-m</span> <span class="selector-tag">iprange</span> <span class="selector-tag">--dst-range</span> 172<span class="selector-class">.16</span><span class="selector-class">.100</span><span class="selector-class">.1-172</span><span class="selector-class">.16</span><span class="selector-class">.100</span><span class="selector-class">.120</span> <span class="selector-tag">-j</span> <span class="selector-tag">ACCEPT</span></span><br></pre></td></tr></table></figure><ul><li>-m string : 检查报文中出现的字符串；<ul><li>–algo {bm|kmp}<ul><li>bm = Boyer-Moore</li><li>kmp = Knuth-Pratt-Morris</li></ul></li><li>[!] - -string pattern ：给定要检查的字符串模式</li></ul></li></ul><p><strong>示例：</strong></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# iptables -I OUTPUT -<span class="keyword">m</span> <span class="built_in">string</span> --algo <span class="keyword">bm</span> --<span class="built_in">string</span> <span class="string">'movie'</span> -<span class="keyword">j</span> REJECT</span><br></pre></td></tr></table></figure><ul><li>-m time :根据报文到达的时间与指定的时间范围进行匹配；<ul><li>–datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]] 日期</li><li>–datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</li><li>–timestart hh:mm[:ss] 时间</li><li>–timestop hh:mm[:ss]</li><li>[!] –monthdays day[,day…] 每个月的几号</li><li>[!] –weekdays day[,day…] 星期几</li><li>–kerneltz：内核时区，不建议使用，CentOS7系统默认为UTC<br><strong>注意：centos6 不支持kerneltz ，–localtz指定本地时区(默认)</strong></li></ul></li></ul><p><strong>示例：</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="selector-id">#iptables</span> -A INPUT -s <span class="number">172.16</span>.<span class="number">0.0</span>/<span class="number">16</span> -d <span class="number">172.16</span>.<span class="number">100.10</span> -<span class="selector-tag">p</span> tcp --dport <span class="number">80</span> -m <span class="selector-tag">time</span> --timestart <span class="number">14</span>:<span class="number">30</span> --timestop <span class="number">18</span>:<span class="number">30</span> --weekdays Sat,Sun --kerneltz -j DROP</span><br></pre></td></tr></table></figure><ul><li>-m connlimit  : 根据每客户端IP（也可以是地址块）做并发连接数数量匹配；<br>可防止CC(Challenge Collapsar挑战黑洞)攻击</li><li>–connlimit-upton：连接的数量小于等于n时匹配</li><li>–connlimit-above n：连接的数量大于n时匹配<br>通常分别与默认的拒绝或允许策略配合使用</li></ul><p><strong>示例：</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="selector-id">#iptables-A</span> <span class="selector-tag">INPUT</span> <span class="selector-tag">-d</span> 172<span class="selector-class">.16</span><span class="selector-class">.100</span><span class="selector-class">.10</span> <span class="selector-tag">-p</span> <span class="selector-tag">tcp--dport22</span> <span class="selector-tag">-m</span> <span class="selector-tag">connlimit--connlimit-above</span> 2 <span class="selector-tag">-j</span> <span class="selector-tag">REJECT</span></span><br></pre></td></tr></table></figure><ul><li>-m limit  : 基于收发报文的速率做检查；<br>令牌桶过滤器<ul><li>–limit rate[/second|/minute|/hour|/day]</li><li>–limit-burst number</li></ul></li></ul><p><strong>示例：</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="selector-id">#iptables</span> -I INPUT -d <span class="number">172.16</span>.<span class="number">100.10</span> -<span class="selector-tag">p</span> icmp --icmp-type <span class="number">8</span> -m limit --limit <span class="number">3</span>/minute --limit-burst <span class="number">5</span> -j ACCEPT</span><br><span class="line">~]<span class="selector-id">#iptables</span> -I INPUT <span class="number">2</span> -<span class="selector-tag">p</span> icmp -j REJECT</span><br></pre></td></tr></table></figure><ul><li>-m state  : 根据连接追踪机制检查连接的状态；<br>conntrack机制：追踪本机上的请求和响应之间的关系<ul><li>NEW：新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求</li><li>ESTABLISHED：NEW状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通信状态</li><li>RELATED：新发起的但与已有连接相关联的连接，如：ftp协议中的数据连接与命令连接之间的关系</li><li>INVALID：无效的连接，如flag标记不正确</li><li>UNTRACKED：未进行追踪的连接，如raw表中关闭追踪</li><li>[!] –state state</li></ul></li></ul><p><strong>示例：</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]#iptables -A INPUT -d <span class="number">172.16</span><span class="number">.100</span><span class="number">.10</span> -p tcp-m multiport --dport <span class="number">22</span>,<span class="number">80</span> -m <span class="section">state</span> --<span class="section">state</span> NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">~]#iptables -A OUTPUT -s <span class="number">172.16</span><span class="number">.100</span><span class="number">.10</span> -p tcp-m multiport --sport <span class="number">22</span>,<span class="number">80</span> -m <span class="section">state</span> --<span class="section">state</span> ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure><p>调整连接追踪功能所能够容纳的最大连接数量：<br>        /proc/sys/net/nf_conntrack_max</p><p>已经追踪到并记录下的连接：<br>        /proc/net/nf_conntrack</p><p>不同协议或连接类型追的时长：<br>        /proc/sys/net/netfilter/</p><h4 id="处理动作"><a href="#处理动作" class="headerlink" title="处理动作"></a>处理动作</h4><ul><li>-j TARGET：跳至指定的TARGET<ul><li>ACCEPT: 接受</li><li>DROP: 丢弃</li><li>REJECT: 拒绝</li><li>RETURN: 返回调用链</li><li>REDIRECT：端口重定向</li><li>LOG: 记录日志</li><li>MARK：做防火墙标记</li><li>DNAT：目标地址转换</li><li>SNAT：源地址转换</li><li>MASQUERADE：地址伪装</li></ul></li></ul><h3 id="保存规则的方法"><a href="#保存规则的方法" class="headerlink" title="保存规则的方法"></a>保存规则的方法</h3><ul><li>如何保存及重载规则：</li><li>保存规则至指定文件：<br>iptables-save &gt; /PATH/TO/SOMEFILE<ul><li>从指定文件重载规则：<br>iptables-restore &lt; /PATH/FROM/SOMEFILE</li></ul></li></ul><p><strong>centos 6</strong></p><p>定义好策略后执行此命令，定义的策略会在每次服务启动时自动加载</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="selector-id">#service</span> iptables save</span><br><span class="line">或：</span><br><span class="line">~]<span class="selector-id">#iptables-save</span> &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure><p><strong>centos 7</strong><br>将定义好的规则导出到文件中</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="selector-id">#iptables-save</span> &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure><p>将保存于文件中的策略恢复,此方法适用于多套规则之间相互切换</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="selector-id">#iptables-restore</span> &lt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure><p>若要每次服务启动时自动加载策略，需要将此命令写于/etc/rc.d/rc.local文件中，注意给文件加执行权限</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;Iptables的组成&quot;&gt;&lt;a href=&quot;#Iptables的组成&quot; class=&quot;headerlink&quot; title=&quot;Iptables的组成&quot;&gt;&lt;/a&gt;Iptables的组成&lt;/h3&gt;&lt;p&gt;Iptables由四个表和五个链以及一些规则组成&lt;/p&gt;
    
    </summary>
    
      <category term="Command" scheme="http://subtraction.tech/categories/Command/"/>
    
    
      <category term="Iptables" scheme="http://subtraction.tech/tags/Iptables/"/>
    
  </entry>
  
  <entry>
    <title>使用WordPress搭建基于LAMP架构的博客平台</title>
    <link href="http://subtraction.tech/WEB/%E4%BD%BF%E7%94%A8WordPress%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8ELAMP%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8D%9A%E5%AE%A2%E5%B9%B3%E5%8F%B0/"/>
    <id>http://subtraction.tech/WEB/使用WordPress搭建基于LAMP架构的博客平台/</id>
    <published>2017-12-21T17:23:55.000Z</published>
    <updated>2018-04-23T12:50:49.879Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>作为一名IT工作者，拥有自己的技术博客是展示自己的最佳方式，作为一名博客作者，可以在自己搭建的个人博客上书写博客，无疑也是件大快人心之事。那么，应该如何方便高效的搭建一个属于自己的个人博客呢，我将在下面的内容里为你细细道来。</p><a id="more"></a><p>本次搭建博客使用的是世界上目前最先进的 weblog 程序WordPress，WordPress 是一个功能非常强大的博客系统，插件众多，易于扩充功能，安装和使用都非常方便。目前 WordPress 已经成为主流的 Blog 搭建平台。WordPress是使用 PHP 语言开发的Blog引擎，用户可以在支持 PHP 和MySQL数据库的服务器上架设自己的 Blog，也可以把 WordPress 当做一个个人信息发布平台，或者当作一个内容管理系统（CMS）来使用。</p><p>WordPress平台是运行在LAMP架构之上的，LAMP是一组常用来搭建动态网站或者服务器的开源软件，本身都是各自独立的程序，但是因为常被放在一起使用，拥有了越来越高的兼容度，共同组成了一个强大的Web应用程序平台。</p><p>本此搭建使用的LAMP架构是CentOS、Apache、Mariadb和PHP。CentOS是一个基于Red Hat Linux 提供的可自由使用源代码的企业级Linux发行版本，Apache是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。MariaDB数据库管理系统是MySQL的一个分支，是目前最流行的开源数据库，PHP 是一种被广泛使用的开源的HTML 内嵌式脚本语言。</p><h3 id="需要准备的软件包"><a href="#需要准备的软件包" class="headerlink" title="需要准备的软件包"></a>需要准备的软件包</h3><p><strong>本次编译安装LAMP搭建blog使用的皆是最新版的软件包，需要下载的同学可以利用我下面提供的下载链接进行下载</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: ~<span class="selector-id">#ls</span> /usr/local/src/</span><br><span class="line">apr-<span class="number">1.6</span>.<span class="number">2</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span>       httpd-<span class="number">2.4</span>.<span class="number">27</span><span class="selector-class">.tar</span><span class="selector-class">.bz2</span>                php-<span class="number">7.1</span>.<span class="number">10</span><span class="selector-class">.tar</span><span class="selector-class">.bz2</span></span><br><span class="line">apr-util-<span class="number">1.6</span>.<span class="number">0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span>  mariadb-<span class="number">10.2</span>.<span class="number">8</span>-linux-x86_64<span class="selector-class">.tar</span><span class="selector-class">.gz</span>  wordpress-<span class="number">4.8</span>.<span class="number">1</span>-zh_CN<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure><h3 id="所需软件包的下载链接"><a href="#所需软件包的下载链接" class="headerlink" title="所需软件包的下载链接"></a>所需软件包的下载链接</h3><p>CentOS7.3下载链接： <a href="http://mirrors.aliyun.com/centos/7.3.1611/isos/x86_64/" target="_blank" rel="noopener">http://mirrors.aliyun.com/centos/7.3.1611/isos/x86_64/</a><br>Apache软件下载链接：<a href="http://httpd.apache.org/download.cgi#apache24" target="_blank" rel="noopener">http://httpd.apache.org/download.cgi#apache24</a><br>APR下载链接：<a href="http://apr.apache.org/download.cgi" target="_blank" rel="noopener">http://apr.apache.org/download.cgi</a><br>APR-util下载链接：<a href="http://apr.apache.org/download.cgi" target="_blank" rel="noopener">http://apr.apache.org/download.cgi</a><br>PHP下载链接：<a href="https://secure.php.net/downloads.php" target="_blank" rel="noopener">https://secure.php.net/downloads.php</a><br>Mariadb下载链接：<a href="https://downloads.mariadb.org/" target="_blank" rel="noopener">https://downloads.mariadb.org/</a><br>Wordpress下载链接：<a href="https://wordpress.org/download/" target="_blank" rel="noopener">https://wordpress.org/download/</a></p><h3 id="编译安装httpd"><a href="#编译安装httpd" class="headerlink" title="编译安装httpd"></a>编译安装httpd</h3><h4 id="安装开发包组及必要的软件包"><a href="#安装开发包组及必要的软件包" class="headerlink" title="安装开发包组及必要的软件包"></a>安装开发包组及必要的软件包</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;centos7</span>: ~<span class="meta">#yum -y groupinstall <span class="string">"development tools"</span></span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: ~<span class="meta">#yum -y install expat-devel pcre-devel openssl-devel</span></span><br></pre></td></tr></table></figure><h4 id="解压httpd、arp、apr-util软件包"><a href="#解压httpd、arp、apr-util软件包" class="headerlink" title="解压httpd、arp、apr-util软件包"></a>解压httpd、arp、apr-util软件包</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: ~<span class="selector-id">#cd</span> /usr/local/src/</span><br><span class="line">root&amp;centos7: src<span class="selector-id">#tar</span> vxf apr-<span class="number">1.6</span>.<span class="number">2</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">root&amp;centos7: src<span class="selector-id">#tar</span> vxf apr-util-<span class="number">1.6</span>.<span class="number">0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">root&amp;centos7: src<span class="selector-id">#tar</span> vxf httpd-<span class="number">2.4</span>.<span class="number">27</span><span class="selector-class">.tar</span><span class="selector-class">.bz2</span></span><br></pre></td></tr></table></figure><h4 id="将解压后的apr和apr-util移动到httpd解压后的srclib目录下"><a href="#将解压后的apr和apr-util移动到httpd解压后的srclib目录下" class="headerlink" title="将解压后的apr和apr-util移动到httpd解压后的srclib目录下"></a>将解压后的apr和apr-util移动到httpd解压后的srclib目录下</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;centos7</span>: src<span class="meta">#mv apr-1.6.2 httpd-2.4.27/srclib/apr</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: src<span class="meta">#mv apr-util-1.6.0 httpd-2.4.27/srclib/apr-util</span></span><br></pre></td></tr></table></figure><h4 id="编译安装httpd-1"><a href="#编译安装httpd-1" class="headerlink" title="编译安装httpd"></a>编译安装httpd</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;centos7</span>: src<span class="meta">#cd httpd-2.4.27/</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: httpd<span class="number">-2.4</span><span class="number">.27</span><span class="meta">#./configure --prefix=/app/httpd24 --sysconfdir=/etc/httpd24 --enable-so --enable-ssl --enable-cgi --enable-rewrite --with-zlib--with-pcre --with-included-apr --enable-modules=most --enable-mpms-shared=all --with-mpm=prefork</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: httpd<span class="number">-2.4</span><span class="number">.27</span><span class="meta">#echo $?</span></span><br><span class="line"><span class="number">0</span><span class="meta">#只有显示的结果为0时，才代表上一步操作执行成功，才能进行后续操作。</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: httpd<span class="number">-2.4</span><span class="number">.27</span><span class="meta">#make &amp;&amp; make install</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: httpd<span class="number">-2.4</span><span class="number">.27</span><span class="meta">#echo $?</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: httpd<span class="number">-2.4</span><span class="number">.27</span><span class="meta">#ls /app/</span></span><br><span class="line">httpd24<span class="meta">#编译成功后会在/app目录下生成httpd24目录，/app/目录需自己在编译前先创建好</span></span><br></pre></td></tr></table></figure><h4 id="创建用户、定义环境变量，并启动Apache服务"><a href="#创建用户、定义环境变量，并启动Apache服务" class="headerlink" title="创建用户、定义环境变量，并启动Apache服务"></a>创建用户、定义环境变量，并启动Apache服务</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root&amp;<span class="symbol">centos7:</span> httpd-<span class="number">2.4</span>.<span class="number">27</span><span class="comment">#useradd -r -d /usr/share/httpd24 -s /sbin/nologin apache</span></span><br><span class="line">root&amp;<span class="symbol">centos7:</span> httpd-<span class="number">2.4</span>.<span class="number">27</span><span class="comment">#vim /etc/profile.d/app.sh</span></span><br><span class="line">export PATH=<span class="regexp">/app/httpd</span>24/bin/<span class="symbol">:/usr/local/mysql/bin/</span><span class="symbol">:</span><span class="variable">$PATH</span></span><br><span class="line">root&amp;<span class="symbol">centos7:</span> httpd-<span class="number">2.4</span>.<span class="number">27</span><span class="comment">#. /etc/profile.d/app.sh</span></span><br><span class="line">root&amp;<span class="symbol">centos7:</span> httpd-<span class="number">2.4</span>.<span class="number">27</span><span class="comment">#apachectl</span></span><br><span class="line">root&amp;<span class="symbol">centos7:</span> httpd-<span class="number">2.4</span>.<span class="number">27</span><span class="comment">#ss -ntl |grep 80</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>         <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:</span><span class="number">80</span>                      <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:*</span></span><br></pre></td></tr></table></figure><h3 id="二进制安装mariadb"><a href="#二进制安装mariadb" class="headerlink" title="二进制安装mariadb"></a>二进制安装mariadb</h3><h4 id="安装必要的软件包"><a href="#安装必要的软件包" class="headerlink" title="安装必要的软件包"></a>安装必要的软件包</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">centos7</span>: <span class="selector-tag">httpd-2</span><span class="selector-class">.4</span><span class="selector-class">.27</span><span class="selector-id">#yum</span> <span class="selector-tag">-y</span> <span class="selector-tag">remove</span> <span class="selector-tag">mariadb</span>*</span><br><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">centos7</span>: <span class="selector-tag">httpd-2</span><span class="selector-class">.4</span><span class="selector-class">.27</span><span class="selector-id">#yum</span> <span class="selector-tag">-y</span> <span class="selector-tag">install</span> <span class="selector-tag">libaio-devel</span></span><br></pre></td></tr></table></figure><h4 id="解压mariadb软件包到指定目录，并创建程序软链接"><a href="#解压mariadb软件包到指定目录，并创建程序软链接" class="headerlink" title="解压mariadb软件包到指定目录，并创建程序软链接"></a>解压mariadb软件包到指定目录，并创建程序软链接</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: httpd-<span class="number">2.4</span>.<span class="number">27</span><span class="selector-id">#cd</span> /usr/local/src/</span><br><span class="line">root&amp;centos7: src<span class="selector-id">#tar</span> vxf mariadb-<span class="number">10.2</span>.<span class="number">8</span>-linux-x86_64<span class="selector-class">.tar</span><span class="selector-class">.gz</span> -C /usr/local/</span><br><span class="line">root&amp;centos7: src<span class="selector-id">#cd</span> /usr/local/</span><br><span class="line">root&amp;centos7: local<span class="selector-id">#ln</span> -sv mariadb-<span class="number">10.2</span>.<span class="number">8</span>-linux-x86_64/ mysql</span><br></pre></td></tr></table></figure><h4 id="创建mysql用户账号"><a href="#创建mysql用户账号" class="headerlink" title="创建mysql用户账号"></a>创建mysql用户账号</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: <span class="keyword">local</span><span class="comment">#useradd -r -m -d /app/mysqldb -s /sbin/nologin mysql</span></span><br></pre></td></tr></table></figure><h4 id="制作并修改mariadb配置文件-etc-mysql-my-cnf"><a href="#制作并修改mariadb配置文件-etc-mysql-my-cnf" class="headerlink" title="制作并修改mariadb配置文件/etc/mysql/my.cnf"></a>制作并修改mariadb配置文件/etc/mysql/my.cnf</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: local<span class="selector-id">#mkdir</span> /etc/mysql/</span><br><span class="line">root&amp;centos7: local<span class="selector-id">#cp</span> /usr/local/mysql/support-files/my-huge<span class="selector-class">.cnf</span> /etc/mysql/my.cnf</span><br><span class="line">root&amp;centos7: local<span class="selector-id">#vim</span> /etc/mysql/my.cnf</span><br><span class="line">[mysqld]   #[mysqld]下面写入以下三行</span><br><span class="line">datadir = /app/mysqldb</span><br><span class="line">innodb_file_per_table = on</span><br><span class="line">skip_name_resolve = on</span><br></pre></td></tr></table></figure><h4 id="运行mysql-install-db脚本生成系统数据库"><a href="#运行mysql-install-db脚本生成系统数据库" class="headerlink" title="运行mysql_install_db脚本生成系统数据库"></a>运行mysql_install_db脚本生成系统数据库</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: local<span class="comment">#cd /usr/local/mysql/</span></span><br><span class="line">root&amp;centos7: mysql<span class="comment">#scripts/mysql_install_db --datadir=/app/mysqldb --user=mysql</span></span><br><span class="line">root&amp;centos7: mysql<span class="comment">#ls /app/mysqldb/#脚本执行成功后会在指定目录下生成下列文件</span></span><br><span class="line">aria_log.<span class="number">00000001</span>  ib_buffer_pool  ib_logfile0  mysql             mysql-bin.index  performance_schema</span><br><span class="line">aria_log_control   ibdata1         ib_logfile1  mysql-bin.<span class="number">000001</span>  mysql-bin.<span class="keyword">state</span>  test</span><br></pre></td></tr></table></figure><h4 id="制作启动脚本，并启动mysqld服务"><a href="#制作启动脚本，并启动mysqld服务" class="headerlink" title="制作启动脚本，并启动mysqld服务"></a>制作启动脚本，并启动mysqld服务</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#chkconfig --add mysqld</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#chkconfig mysqld on</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#mkdir /var/log/mariadb/</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#touch /var/log/mariadb/mariadb.log</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#chown mysql /var/log/mariadb/</span></span><br><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#service mysqld start</span></span><br><span class="line">Starting mysqld (via systemctl):                           [  OK  ]</span><br><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#ss -ntl|grep 3306</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">80</span>          :::<span class="number">3306</span>                    :::*</span><br></pre></td></tr></table></figure><h4 id="运行数据库安全初始化脚本"><a href="#运行数据库安全初始化脚本" class="headerlink" title="运行数据库安全初始化脚本"></a>运行数据库安全初始化脚本</h4><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: mysql<span class="meta">#mysql_secure_installation</span></span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):  <span class="meta">#此处有回车</span></span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line"><span class="keyword">Set</span> root password? [Y/n] y</span><br><span class="line"><span class="keyword">New</span> password:  <span class="meta">#输入你的数据库密码</span></span><br><span class="line">Re-enter <span class="keyword">new</span> password:   <span class="meta">#确认密码</span></span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">Remove anonymous users? [Y/n] y</span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">Disallow root login remotely? [Y/n] n</span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">Remove test database <span class="keyword">and</span> access <span class="keyword">to</span> it? [Y/n] y</span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">Reload privilege tables now? [Y/n] y</span><br><span class="line">……此处省略部分显示内容……</span><br></pre></td></tr></table></figure><h4 id="创建blog的数据库，并授权管理用户"><a href="#创建blog的数据库，并授权管理用户" class="headerlink" title="创建blog的数据库，并授权管理用户"></a>创建blog的数据库，并授权管理用户</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">centos7</span>: <span class="selector-tag">mysql</span><span class="selector-id">#mysql</span> <span class="selector-tag">-uroot</span> <span class="selector-tag">-p</span></span><br><span class="line"><span class="selector-tag">Enter</span> <span class="selector-tag">password</span>:   #输入登录数据库的密码</span><br><span class="line"><span class="selector-tag">MariaDB</span> <span class="selector-attr">[(none)]</span>&gt; <span class="selector-tag">CREATE</span> <span class="selector-tag">DATABASE</span> <span class="selector-tag">blogdb</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, 1 <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (0<span class="selector-class">.01</span> <span class="selector-tag">sec</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MariaDB</span> <span class="selector-attr">[(none)]</span>&gt; <span class="selector-tag">GRANT</span> <span class="selector-tag">ALL</span> <span class="selector-tag">ON</span> <span class="selector-tag">blogdb</span>.* <span class="selector-tag">TO</span> <span class="selector-tag">bguser</span>@'<span class="keyword">172</span>.<span class="keyword">18</span>.%.%' IDENTIFIED BY <span class="string">"centos"</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, 0 <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (0<span class="selector-class">.00</span> <span class="selector-tag">sec</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MariaDB</span> <span class="selector-attr">[(none)]</span>&gt; <span class="selector-tag">GRANT</span> <span class="selector-tag">ALL</span> <span class="selector-tag">ON</span> <span class="selector-tag">blogdb</span>.* <span class="selector-tag">TO</span> <span class="selector-tag">bguser</span>@'<span class="keyword">localhost</span>' IDENTIFIED BY <span class="string">"centos"</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, 0 <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (0<span class="selector-class">.00</span> <span class="selector-tag">sec</span>)</span><br><span class="line"><span class="selector-tag">MariaDB</span> <span class="selector-attr">[(none)]</span>&gt; <span class="selector-tag">quit</span></span><br></pre></td></tr></table></figure><h3 id="编译安装php"><a href="#编译安装php" class="headerlink" title="编译安装php"></a>编译安装php</h3><h4 id="安装必要的软将包"><a href="#安装必要的软将包" class="headerlink" title="安装必要的软将包"></a>安装必要的软将包</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;centos7</span>: mysql<span class="meta">#yum -y install libxml2-devel bzip2-devel libmcrypt-devel</span></span><br></pre></td></tr></table></figure><h4 id="解压并编译安装PHP"><a href="#解压并编译安装PHP" class="headerlink" title="解压并编译安装PHP"></a>解压并编译安装PHP</h4><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">root&amp;centos7:</span> <span class="comment">mysql#cd</span> <span class="comment">/usr/local/src/</span></span><br><span class="line"><span class="comment">root&amp;centos7:</span> <span class="comment">src#tar</span> <span class="comment">vxf</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">7</span><span class="string">.</span><span class="comment">1</span><span class="string">.</span><span class="comment">10</span><span class="string">.</span><span class="comment">tar</span><span class="string">.</span><span class="comment">bz2</span></span><br><span class="line"><span class="comment">root&amp;centos7:</span> <span class="comment">src#cd</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">7</span><span class="string">.</span><span class="comment">1</span><span class="string">.</span><span class="comment">10/</span></span><br><span class="line"><span class="comment">root&amp;centos7:</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">7</span><span class="string">.</span><span class="comment">1</span><span class="string">.</span><span class="comment">10#</span><span class="string">.</span><span class="comment">/configure</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">prefix=/app/php</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">mysqlnd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mysqli=mysqlnd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">openssl</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">pdo</span><span class="literal">-</span><span class="comment">mysql=mysqlnd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">mbstring</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">freetype</span><span class="literal">-</span><span class="comment">dir</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">jpeg</span><span class="literal">-</span><span class="comment">dir</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">png</span><span class="literal">-</span><span class="comment">dir</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">zlib</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">libxml</span><span class="literal">-</span><span class="comment">dir=/usr</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">xml</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">sockets</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">apxs2=/app/httpd24/bin/apxs</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mcrypt</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">config</span><span class="literal">-</span><span class="comment">file</span><span class="literal">-</span><span class="comment">path=/etc</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">config</span><span class="literal">-</span><span class="comment">file</span><span class="literal">-</span><span class="comment">scan</span><span class="literal">-</span><span class="comment">dir=/etc/php</span><span class="string">.</span><span class="comment">d</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">maintainer</span><span class="literal">-</span><span class="comment">zts</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">disable</span><span class="literal">-</span><span class="comment">fileinfo</span></span><br><span class="line"><span class="comment">root&amp;centos7:</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">7</span><span class="string">.</span><span class="comment">1</span><span class="string">.</span><span class="comment">10#echo</span> <span class="comment">$?</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">root&amp;centos7:</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">7</span><span class="string">.</span><span class="comment">1</span><span class="string">.</span><span class="comment">10#make</span> <span class="comment">&amp;&amp;</span> <span class="comment">make</span> <span class="comment">install</span></span><br><span class="line"><span class="comment">root&amp;centos7:</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">7</span><span class="string">.</span><span class="comment">1</span><span class="string">.</span><span class="comment">10#echo</span> <span class="comment">$?</span></span><br><span class="line"><span class="comment">0</span></span><br></pre></td></tr></table></figure><h4 id="制作并修改相关配置文件，重新启动httpd服务加载PHP模块"><a href="#制作并修改相关配置文件，重新启动httpd服务加载PHP模块" class="headerlink" title="制作并修改相关配置文件，重新启动httpd服务加载PHP模块"></a>制作并修改相关配置文件，重新启动httpd服务加载PHP模块</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: php-<span class="number">7.1</span>.<span class="number">10</span><span class="selector-id">#cp</span> php<span class="selector-class">.ini-production</span> /etc/php.ini</span><br><span class="line">root&amp;centos7: php-<span class="number">7.1</span>.<span class="number">10</span><span class="selector-id">#vim</span> /etc/httpd24/httpd.conf</span><br><span class="line">#文件底加以下两行</span><br><span class="line">AddType application/x-httpd-php .php</span><br><span class="line">AddType application/x-httpd-php-source .phps</span><br><span class="line">#在文件中找到下面字段，在DirectoryIndex后写入index.php</span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">DirectoryIndex index<span class="selector-class">.php</span> index.html</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">root&amp;centos7: php-<span class="number">7.1</span>.<span class="number">10</span><span class="selector-id">#apachectl</span> stop</span><br><span class="line">root&amp;centos7: php-<span class="number">7.1</span>.<span class="number">10</span><span class="selector-id">#apachectl</span> start</span><br><span class="line">#重新启动Apache服务</span><br></pre></td></tr></table></figure><h3 id="测试数据库连接"><a href="#测试数据库连接" class="headerlink" title="测试数据库连接"></a>测试数据库连接</h3><h4 id="编辑测试文件"><a href="#编辑测试文件" class="headerlink" title="编辑测试文件"></a>编辑测试文件</h4><p><strong>在/app/httpd24/htdocs/index.php文件中写入下面的测试代码，看能否成功连接数据库</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: php-<span class="number">7.1</span>.<span class="number">10</span><span class="comment">#vim /app/httpd24/htdocs/index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$mysqli</span>=new mysqli(<span class="string">"172.18.172.18"</span>,<span class="string">"bguser"</span>,<span class="string">"centos"</span>);</span><br><span class="line"><span class="comment">#注意这段代码中的数据库地址、连接数据库的用户和密码一定要写正确</span></span><br><span class="line"><span class="keyword">if</span>(mysqli_connect_errno())&#123;</span><br><span class="line">echo <span class="string">"连接数据库失败!"</span>;</span><br><span class="line"><span class="variable">$mysqli</span>=null;</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">echo <span class="string">"连接数据库成功!"</span>;</span><br><span class="line"><span class="variable">$mysqli</span>-&gt;close();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h4 id="使用浏览器测试连接"><a href="#使用浏览器测试连接" class="headerlink" title="使用浏览器测试连接"></a>使用浏览器测试连接</h4><p><strong>用浏览器访问此主机,会看到如下图的提示，则证明连接成功</strong><br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/34LjKd68Hf.png?imageslim" alt="mark"></p><h4 id="删除测试文件"><a href="#删除测试文件" class="headerlink" title="删除测试文件"></a>删除测试文件</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;centos7</span>: php<span class="number">-7.1</span><span class="number">.10</span><span class="meta">#rm -rf /app/httpd24/htdocs/index.php</span></span><br></pre></td></tr></table></figure><h3 id="配置Wordpress"><a href="#配置Wordpress" class="headerlink" title="配置Wordpress"></a>配置Wordpress</h3><h4 id="解压Wordpress软件包，并将生成的文件移动到httpd的根目录下"><a href="#解压Wordpress软件包，并将生成的文件移动到httpd的根目录下" class="headerlink" title="解压Wordpress软件包，并将生成的文件移动到httpd的根目录下"></a>解压Wordpress软件包，并将生成的文件移动到httpd的根目录下</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;centos7: php-<span class="number">7.1</span>.<span class="number">10</span><span class="selector-id">#cd</span> /usr/local/src/</span><br><span class="line">root&amp;centos7: src<span class="selector-id">#tar</span> vxf wordpress-<span class="number">4.8</span>.<span class="number">1</span>-zh_CN<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">root&amp;centos7: src<span class="selector-id">#mv</span> wordpress<span class="comment">/* /app/httpd24/htdocs/</span></span><br></pre></td></tr></table></figure><h4 id="制作和编辑wordpress的配置文件"><a href="#制作和编辑wordpress的配置文件" class="headerlink" title="制作和编辑wordpress的配置文件"></a>制作和编辑wordpress的配置文件</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">root</span><span class="selector-tag">&amp;</span><span class="selector-tag">centos7</span>: <span class="selector-tag">src</span><span class="selector-id">#cd</span> /<span class="selector-tag">app</span>/<span class="selector-tag">httpd24</span>/<span class="selector-tag">htdocs</span></span><br><span class="line"><span class="selector-tag">root</span><span class="selector-tag">&amp;</span><span class="selector-tag">centos7</span>: <span class="selector-tag">htdocs</span><span class="selector-id">#cp</span> <span class="selector-tag">wp-config-sample</span><span class="selector-class">.php</span> <span class="selector-tag">wp-config</span><span class="selector-class">.php</span></span><br><span class="line"><span class="selector-tag">root</span><span class="selector-tag">&amp;</span><span class="selector-tag">centos7</span>: <span class="selector-tag">htdocs</span><span class="selector-id">#vim</span> <span class="selector-tag">wp-config</span><span class="selector-class">.php</span></span><br><span class="line"><span class="comment">// ** MySQL 设置 - 具体信息来自您正在使用的主机 ** //</span></span><br><span class="line"><span class="comment">/** WordPress数据库的名称 */</span></span><br><span class="line"><span class="selector-tag">define</span>(<span class="string">'DB_NAME'</span>, <span class="string">'blogdb'</span>);</span><br><span class="line">#此处填写数据库名称，如：<span class="selector-tag">blogdb</span></span><br><span class="line"><span class="comment">/** MySQL数据库用户名 */</span></span><br><span class="line"><span class="selector-tag">define</span>(<span class="string">'DB_USER'</span>, <span class="string">'bguser'</span>);</span><br><span class="line">#此处填写连接数据库的用户名，如<span class="selector-pseudo">:bguser</span></span><br><span class="line"><span class="comment">/** MySQL数据库密码 */</span></span><br><span class="line"><span class="selector-tag">define</span>(<span class="string">'DB_PASSWORD'</span>, <span class="string">'centos'</span>);</span><br><span class="line">#连接数据库的用户密码,如<span class="selector-pseudo">:centos</span></span><br><span class="line"><span class="comment">/** MySQL主机 */</span></span><br><span class="line"><span class="selector-tag">define</span>(<span class="string">'DB_HOST'</span>, <span class="string">'localhost'</span>);</span><br><span class="line">#以上填写的信息对应的是先前创建数据库时的信息</span><br></pre></td></tr></table></figure><h4 id="浏览器访问此主机，完成最后设置"><a href="#浏览器访问此主机，完成最后设置" class="headerlink" title="浏览器访问此主机，完成最后设置"></a>浏览器访问此主机，完成最后设置</h4><p><strong>填写完下图中的用户信息后，点击安装WordPress</strong><br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/7B5aDc1Fh6.png?imageslim" alt="mark"><br><strong>点击登录</strong><br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/IieJC2JmDe.png?imageslim" alt="mark"><br><strong>输入用户和密码</strong><br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/c96i6fDHc6.png?imageslim" alt="mark"><br><strong>进入到下列主页面</strong><br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/5Lhf0kIK7c.png?imageslim" alt="mark"><br><strong>到此安装就完成了，Wordpress后面的使用就交由朋友们去自行发掘了，在此就不多做介绍了。</strong><br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/DEELg38ljd.png?imageslim" alt="mark"></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;作为一名IT工作者，拥有自己的技术博客是展示自己的最佳方式，作为一名博客作者，可以在自己搭建的个人博客上书写博客，无疑也是件大快人心之事。那么，应该如何方便高效的搭建一个属于自己的个人博客呢，我将在下面的内容里为你细细道来。&lt;/p&gt;
    
    </summary>
    
      <category term="WEB" scheme="http://subtraction.tech/categories/WEB/"/>
    
    
      <category term="MariaDB" scheme="http://subtraction.tech/tags/MariaDB/"/>
    
      <category term="PHP" scheme="http://subtraction.tech/tags/PHP/"/>
    
      <category term="Apache" scheme="http://subtraction.tech/tags/Apache/"/>
    
  </entry>
  
  <entry>
    <title>验证跨网段通信中，目标主机的网关配置对数据包接收的影响</title>
    <link href="http://subtraction.tech/Network/%E9%AA%8C%E8%AF%81%E8%B7%A8%E7%BD%91%E6%AE%B5%E9%80%9A%E4%BF%A1%E4%B8%AD%EF%BC%8C%E7%9B%AE%E6%A0%87%E4%B8%BB%E6%9C%BA%E7%9A%84%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%8C%85%E6%8E%A5%E6%94%B6%E7%9A%84%E5%BD%B1%E5%93%8D/"/>
    <id>http://subtraction.tech/Network/验证跨网段通信中，目标主机的网关配置对数据包接收的影响/</id>
    <published>2017-11-23T06:26:50.000Z</published>
    <updated>2018-04-23T12:50:13.712Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>通过搭建网络环境，验证两种不同的跨网段通信模式下，目标主机不同的网关配置，对目标主机接收来自其它网段数据包的影响。</p><a id="more"></a><hr><h3 id="准备实验环境"><a href="#准备实验环境" class="headerlink" title="准备实验环境"></a>准备实验环境</h3><p>首先来说明一下本次实验的实验环境，此实验环境由四台Linux主机组成，一台做路由器，其余三台用于跨网段通信，其中192.168.10.0/24网段中的两台主机一台配置了网关，另一台则未配置网关。具体拓扑结构请看下图。<br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/e1k4b9hf56.png?imageslim" alt="mark"></p><h4 id="将Linux主机配置为路由器"><a href="#将Linux主机配置为路由器" class="headerlink" title="将Linux主机配置为路由器"></a>将Linux主机配置为路由器</h4><p><strong>网卡ens32的配置，此网卡作为路由器的eth0接口</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;route: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens32</span></span><br><span class="line">DEVICE=<span class="string">"ens32"</span></span><br><span class="line">NAME=<span class="string">"ens32"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=192.168.10.1</span><br><span class="line">PREFIX=24</span><br></pre></td></tr></table></figure><p><strong>网卡ens34的配置，此网卡作为路由器的eth1接口</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;route: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens34</span></span><br><span class="line">DEVICE=<span class="string">"ens34"</span></span><br><span class="line">NAME=<span class="string">"ens34"</span></span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=172.18.0.2</span><br><span class="line">PREFIX=16</span><br></pre></td></tr></table></figure><p><strong>启用CentOS的路由转发功能</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;route: ~<span class="selector-id">#vim</span> /etc/sysctl.conf</span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">1</span></span><br><span class="line">root&amp;route: ~<span class="selector-id">#sysctl</span> -p</span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">1</span></span><br><span class="line">root&amp;route: ~<span class="selector-id">#cat</span> /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="hostA主机的网络配置"><a href="#hostA主机的网络配置" class="headerlink" title="hostA主机的网络配置"></a>hostA主机的网络配置</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;hosta: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens32</span></span><br><span class="line">DEVICE=<span class="string">"ens32"</span></span><br><span class="line">NAME=<span class="string">"ens32"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=192.168.10.100</span><br><span class="line">PREFIX=24</span><br></pre></td></tr></table></figure><h4 id="hostB主机的网络配置"><a href="#hostB主机的网络配置" class="headerlink" title="hostB主机的网络配置"></a>hostB主机的网络配置</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;hostb: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens33</span></span><br><span class="line">DEVICE=<span class="string">"ens33"</span></span><br><span class="line">NAME=<span class="string">"ens33"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=192.169.10.200</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=192.169.10.1</span><br></pre></td></tr></table></figure><h4 id="hostC主机的网络配置"><a href="#hostC主机的网络配置" class="headerlink" title="hostC主机的网络配置"></a>hostC主机的网络配置</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;hostc: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens32</span></span><br><span class="line">DEVICE=<span class="string">"ens32"</span></span><br><span class="line">NAME=<span class="string">"ens32"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=172.18.0.100</span><br><span class="line">PREFIX=16</span><br><span class="line">GATEWAY=172.18.0.2</span><br></pre></td></tr></table></figure><hr><h3 id="不在同一物理网段内的跨网段通信"><a href="#不在同一物理网段内的跨网段通信" class="headerlink" title="不在同一物理网段内的跨网段通信"></a>不在同一物理网段内的跨网段通信</h3><h4 id="目标主机正确配置了网关，数据包的接收情况"><a href="#目标主机正确配置了网关，数据包的接收情况" class="headerlink" title="目标主机正确配置了网关，数据包的接收情况"></a>目标主机正确配置了网关，数据包的接收情况</h4><p><strong>hostC主机</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hostc: ~#ping -w 4 192.168.10.200</span><br><span class="line">PING 192.168.10.200 (192.168.10.200) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.200: <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=63 <span class="attribute">time</span>=1.15 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.200: <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=63 <span class="attribute">time</span>=0.740 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.200: <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=63 <span class="attribute">time</span>=1.68 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.200: <span class="attribute">icmp_seq</span>=4 <span class="attribute">ttl</span>=63 <span class="attribute">time</span>=4.99 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.10.200<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3005ms</span><br><span class="line">rtt min/avg/max/mdev = 0.740/2.142/4.996/1.681 ms</span><br></pre></td></tr></table></figure><p><strong>hostB主机</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hostb: ~#tcpdump icmp -n -i ens33</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens33, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">03:44:40.315679<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.200: ICMP echo request, id 2059, seq 1, length 64</span><br><span class="line">03:44:40.315711<span class="built_in"> IP </span>192.168.10.200 &gt; 172.18.0.100: ICMP echo reply, id 2059, seq 1, length 64</span><br><span class="line">03:44:41.316467<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.200: ICMP echo request, id 2059, seq 2, length 64</span><br><span class="line">03:44:41.316505<span class="built_in"> IP </span>192.168.10.200 &gt; 172.18.0.100: ICMP echo reply, id 2059, seq 2, length 64</span><br><span class="line">03:44:42.318339<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.200: ICMP echo request, id 2059, seq 3, length 64</span><br><span class="line">03:44:42.318573<span class="built_in"> IP </span>192.168.10.200 &gt; 172.18.0.100: ICMP echo reply, id 2059, seq 3, length 64</span><br><span class="line">03:44:43.324261<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.200: ICMP echo request, id 2059, seq 4, length 64</span><br><span class="line">03:44:43.324332<span class="built_in"> IP </span>192.168.10.200 &gt; 172.18.0.100: ICMP echo reply, id 2059, seq 4, length 64</span><br></pre></td></tr></table></figure><hr><h4 id="目标主机没有配置网关，数据包的接收情况"><a href="#目标主机没有配置网关，数据包的接收情况" class="headerlink" title="目标主机没有配置网关，数据包的接收情况"></a>目标主机没有配置网关，数据包的接收情况</h4><p><strong>hostC主机</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hostc: ~#ping -w 4 192.168.10.100</span><br><span class="line">PING 192.168.10.100 (192.168.10.100) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.10.100<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 0 received, 100% packet loss, time 3001ms</span><br></pre></td></tr></table></figure><p><strong>hostA主机</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hosta: ~#tcpdump icmp -n -i ens32</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens32, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">03:54:19.622283<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.100: ICMP echo request, id 2066, seq 1, length 64</span><br><span class="line">03:54:20.621368<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.100: ICMP echo request, id 2066, seq 2, length 64</span><br><span class="line">03:54:21.621701<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.100: ICMP echo request, id 2066, seq 3, length 64</span><br><span class="line">03:54:22.622374<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.100: ICMP echo request, id 2066, seq 4, length 64</span><br></pre></td></tr></table></figure><hr><h4 id="目标主机随意配置网关，数据包的接收情况"><a href="#目标主机随意配置网关，数据包的接收情况" class="headerlink" title="目标主机随意配置网关，数据包的接收情况"></a>目标主机随意配置网关，数据包的接收情况</h4><p><strong>hostC主机</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hostc: ~#ping -w 4 192.168.10.100</span><br><span class="line">PING 192.168.10.100 (192.168.10.100) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.10.100<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 0 received, 100% packet loss, time 3000ms</span><br></pre></td></tr></table></figure><p><strong>hostA主机</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;hosta: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens32</span></span><br><span class="line">BOOTPROTO=none</span><br><span class="line">NAME=<span class="string">"ens32"</span></span><br><span class="line">DEVICE=<span class="string">"ens32"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=192.168.10.100</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=1.1.1.1</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hosta: ~#tcpdump icmp -n -i ens32</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens32, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">05:31:26.557215<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.100: ICMP echo request, id 2928, seq 1, length 64</span><br><span class="line">05:31:27.556578<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.100: ICMP echo request, id 2928, seq 2, length 64</span><br><span class="line">05:31:28.557039<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.100: ICMP echo request, id 2928, seq 3, length 64</span><br><span class="line">05:31:29.556779<span class="built_in"> IP </span>172.18.0.100 &gt; 192.168.10.100: ICMP echo request, id 2928, seq 4, length 64</span><br></pre></td></tr></table></figure><hr><h3 id="在同一物理网段内的跨网段通信"><a href="#在同一物理网段内的跨网段通信" class="headerlink" title="在同一物理网段内的跨网段通信"></a>在同一物理网段内的跨网段通信</h3><p><strong>更改hostB主机的网络配置，将hostB主机的IP地址设为与hostA主机不在一个网段，并将网关指向hostA主机</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;hostb: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens33</span></span><br><span class="line">NAME=<span class="string">"ens33"</span></span><br><span class="line">DEVICE=<span class="string">"ens33"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=192.168.20.200</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=192.168.10.100</span><br></pre></td></tr></table></figure><hr><h4 id="目标主机没有配置网关，数据包的接收情况-1"><a href="#目标主机没有配置网关，数据包的接收情况-1" class="headerlink" title="目标主机没有配置网关，数据包的接收情况"></a>目标主机没有配置网关，数据包的接收情况</h4><p><strong>hostB主机</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hostb: ~#ping -w 4 192.168.10.100</span><br><span class="line">PING 192.168.10.100 (192.168.10.100) 56(84) bytes of data.</span><br><span class="line"><span class="keyword">From</span> 192.168.20.200 <span class="attribute">icmp_seq</span>=1 Destination Host Unreachable</span><br><span class="line"><span class="keyword">From</span> 192.168.20.200 <span class="attribute">icmp_seq</span>=2 Destination Host Unreachable</span><br><span class="line"><span class="keyword">From</span> 192.168.20.200 <span class="attribute">icmp_seq</span>=3 Destination Host Unreachable</span><br><span class="line"><span class="keyword">From</span> 192.168.20.200 <span class="attribute">icmp_seq</span>=4 Destination Host Unreachable</span><br><span class="line"></span><br><span class="line">--- 192.168.10.100<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 0 received, +4 errors, 100% packet loss, time 3000ms</span><br><span class="line">pipe 4</span><br></pre></td></tr></table></figure><p><strong>hostA主机</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;hosta: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens32</span></span><br><span class="line">BOOTPROTO=none</span><br><span class="line">NAME=<span class="string">"ens32"</span></span><br><span class="line">DEVICE=<span class="string">"ens32"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=192.168.10.100</span><br><span class="line">PREFIX=24</span><br></pre></td></tr></table></figure><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hosta: ~<span class="meta">#tcpdump icmp -n -i ens32</span></span><br><span class="line">tcpdump: verbose <span class="keyword">output</span> suppressed, <span class="keyword">use</span> -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens32, link-<span class="built_in">type</span> EN10MB (Ethernet), capture size <span class="number">65535</span> byt</span><br></pre></td></tr></table></figure><hr><h4 id="目标主机随意配置网关，数据包的接收情况-1"><a href="#目标主机随意配置网关，数据包的接收情况-1" class="headerlink" title="目标主机随意配置网关，数据包的接收情况"></a>目标主机随意配置网关，数据包的接收情况</h4><p><strong>hostB主机</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hostb: ~#ping -w 4 192.168.10.100</span><br><span class="line">PING 192.168.10.100 (192.168.10.100) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.10.100<span class="built_in"> ping </span>statistics ---</span><br><span class="line">5 packets transmitted, 0 received, 100% packet loss, time 3999ms</span><br></pre></td></tr></table></figure><p><strong>hostA主机</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;hosta: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens32</span></span><br><span class="line">BOOTPROTO=none</span><br><span class="line">NAME=<span class="string">"ens32"</span></span><br><span class="line">DEVICE=<span class="string">"ens32"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=192.168.10.100</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=1.1.1.</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hosta: ~#tcpdump icmp -n -i ens32</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens32, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">05:09:56.029371<span class="built_in"> IP </span>192.168.20.200 &gt; 192.168.10.100: ICMP echo request, id 3201, seq 1, length 64</span><br><span class="line">05:09:57.030732<span class="built_in"> IP </span>192.168.20.200 &gt; 192.168.10.100: ICMP echo request, id 3201, seq 2, length 64</span><br><span class="line">05:09:58.029916<span class="built_in"> IP </span>192.168.20.200 &gt; 192.168.10.100: ICMP echo request, id 3201, seq 3, length 64</span><br><span class="line">05:09:59.030256<span class="built_in"> IP </span>192.168.20.200 &gt; 192.168.10.100: ICMP echo request, id 3201, seq 4, length 64</span><br></pre></td></tr></table></figure><hr><h4 id="目标主机配置了正确IP地址做网关，数据包的接收情况"><a href="#目标主机配置了正确IP地址做网关，数据包的接收情况" class="headerlink" title="目标主机配置了正确IP地址做网关，数据包的接收情况"></a>目标主机配置了正确IP地址做网关，数据包的接收情况</h4><p><strong>hostB主机</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hostb: ~#ping -w 4 192.168.10.100</span><br><span class="line">PING 192.168.10.100 (192.168.10.100) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.100: <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.651 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.100: <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=2.85 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.100: <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=2.40 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.100: <span class="attribute">icmp_seq</span>=4 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=2.15 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.10.100<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3005ms</span><br><span class="line">rtt min/avg/max/mdev = 0.651/2.015/2.856/0.829 ms</span><br></pre></td></tr></table></figure><p><strong>hostA主机</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;hosta: ~#cat /etc/sysconfig/network-scripts/ifcfg-ens32</span></span><br><span class="line">BOOTPROTO=none</span><br><span class="line">NAME=<span class="string">"ens32"</span></span><br><span class="line">DEVICE=<span class="string">"ens32"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=192.168.10.100</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=192.168.20.200</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root&amp;hosta: ~#tcpdump icmp -n -i ens32</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens32, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">04:58:12.209344<span class="built_in"> IP </span>192.168.20.200 &gt; 192.168.10.100: ICMP echo request, id 5578, seq 1, length 64</span><br><span class="line">04:58:12.209577<span class="built_in"> IP </span>192.168.10.100 &gt; 192.168.20.200: ICMP echo reply, id 5578, seq 1, length 64</span><br><span class="line">04:58:13.212023<span class="built_in"> IP </span>192.168.20.200 &gt; 192.168.10.100: ICMP echo request, id 5578, seq 2, length 64</span><br><span class="line">04:58:13.212039<span class="built_in"> IP </span>192.168.10.100 &gt; 192.168.20.200: ICMP echo reply, id 5578, seq 2, length 64</span><br><span class="line">04:58:14.214720<span class="built_in"> IP </span>192.168.20.200 &gt; 192.168.10.100: ICMP echo request, id 5578, seq 3, length 64</span><br><span class="line">04:58:14.214736<span class="built_in"> IP </span>192.168.10.100 &gt; 192.168.20.200: ICMP echo reply, id 5578, seq 3, length 64</span><br><span class="line">04:58:15.216449<span class="built_in"> IP </span>192.168.20.200 &gt; 192.168.10.100: ICMP echo request, id 5578, seq 4, length 64</span><br><span class="line">04:58:15.216481<span class="built_in"> IP </span>192.168.10.100 &gt; 192.168.20.200: ICMP echo reply, id 5578, seq 4, length 64</span><br></pre></td></tr></table></figure><hr><h3 id="对实验结果的总结"><a href="#对实验结果的总结" class="headerlink" title="对实验结果的总结"></a>对实验结果的总结</h3><p><strong>两种不同的跨网段通信模式下，目标主机进行不同的网关配置，目标主机接收数据包的结果。</strong></p><table><thead><tr><th>目标主机</th><th>不在同一物理网段内的跨网段通信</th><th>在同一物理网段内的跨网段通信</th></tr></thead><tbody><tr><td>正确配置网关</td><td>接收并回应</td><td>接收并回应</td></tr><tr><td>没有配置网关</td><td>接收不回应</td><td>不接收</td></tr><tr><td>随意配置网关</td><td>接收不回应</td><td>接收不回应</td></tr></tbody></table><ul><li>不在同一物理网段内的跨网段通信，网卡通过检查MAC地址接收数据包</li><li>在同一物理网段内的跨网段通信，网卡通过检查数据包的IP地址接收数据包</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;通过搭建网络环境，验证两种不同的跨网段通信模式下，目标主机不同的网关配置，对目标主机接收来自其它网段数据包的影响。&lt;/p&gt;
    
    </summary>
    
      <category term="Network" scheme="http://subtraction.tech/categories/Network/"/>
    
    
      <category term="Gateway" scheme="http://subtraction.tech/tags/Gateway/"/>
    
  </entry>
  
  <entry>
    <title>SQL语句基础指令语法</title>
    <link href="http://subtraction.tech/DataBase/SQL%E8%AF%AD%E5%8F%A5%E5%9F%BA%E7%A1%80%E6%8C%87%E4%BB%A4%E8%AF%AD%E6%B3%95/"/>
    <id>http://subtraction.tech/DataBase/SQL语句基础指令语法/</id>
    <published>2017-10-22T07:01:02.000Z</published>
    <updated>2018-04-23T12:49:41.293Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="显示命令"><a href="#显示命令" class="headerlink" title="显示命令"></a>显示命令</h3><p><strong>显示当前数据库服务器中的数据库列表</strong></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SHOW </span>DATABASES<span class="comment">;</span></span><br></pre></td></tr></table></figure><a id="more"></a><p><strong>显示数据库中的数据表</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> USE 数据库名<span class="comment">#切换数据库</span></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW TABLES;</span></span><br></pre></td></tr></table></figure><p><strong>显示数据表的结构</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> DESCRIBE 表名;</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> DESC 表名;</span></span><br></pre></td></tr></table></figure><p><strong>查看支持的字符集</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW CHARACTER <span class="keyword">SET</span>;</span><br></pre></td></tr></table></figure><p><strong>查看支持的排序规则</strong></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SHOW </span>COLLATION<span class="comment">;</span></span><br></pre></td></tr></table></figure><p><strong>查看支持的引擎</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW ENGINES\G;<span class="comment">#\G以行的形式显示</span></span></span><br></pre></td></tr></table></figure><p><strong>查看表中的索引</strong></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SHOW </span>INDEXES FROM 表名\G<span class="comment">;</span></span><br></pre></td></tr></table></figure><p><strong>查看表状态</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW <span class="keyword">TABLE</span> STATUS <span class="comment">LIKE</span> <span class="comment">'表名'</span><span class="comment">\G</span>;</span><br></pre></td></tr></table></figure><h3 id="DDL语句"><a href="#DDL语句" class="headerlink" title="DDL语句"></a>DDL语句</h3><p><strong>DDL：数据的定义语言（Data Defination Language）</strong></p><h4 id="CREATE"><a href="#CREATE" class="headerlink" title="CREATE"></a>CREATE</h4><p><strong>创建用户</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql</span>&gt; <span class="selector-tag">CREATE</span> <span class="selector-tag">USER</span> <span class="selector-tag">root</span>@'<span class="keyword">172</span>.<span class="keyword">18</span>.%.%' IDENTIFIED BY <span class="string">'password'</span>;</span><br></pre></td></tr></table></figure><p><strong>创建数据库</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> 数据库名<span class="number">1</span>;</span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> <span class="keyword">SCHEMA</span> 数据库名<span class="number">2</span>;</span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> 数据库名<span class="number">3</span>;</span><br></pre></td></tr></table></figure><p><strong>创建一个同表1相同的表2</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">CREATE</span> TABLE 表<span class="number">2</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p><strong>创建表</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE 表名 (id tinyint unsigned PRIMARY KEY,name varchar(20) <span class="keyword">NOT</span> <span class="literal">NULL</span>, age tinyint UNSIGNED, sex char(1)<span class="built_in"> DEFAULT </span><span class="string">"m"</span> );</span><br></pre></td></tr></table></figure><p><strong>创建带有复合主键的表</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE 表名 (id int unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span>, name varchar (20) <span class="keyword">NOT</span> <span class="literal">NULL</span>, age tinyint unsigned, sex char(1)<span class="built_in"> DEFAULT </span><span class="string">"m"</span>, PRIMARY KEY(id,name));</span><br></pre></td></tr></table></figure><p><strong>创建索引</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">CREATE</span> <span class="keyword">INDEX</span> 索引名 <span class="keyword">ON</span> 表名(索引字段);</span><br></pre></td></tr></table></figure><h4 id="DROP"><a href="#DROP" class="headerlink" title="DROP"></a>DROP</h4><p><strong>删除用户</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; DROP <span class="keyword">USER</span> <span class="title">root</span>@'<span class="number">172.18</span>.%.%;</span><br></pre></td></tr></table></figure><p><strong>删除数据库</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">DROP</span> <span class="keyword">DATABASE</span> 数据库名;</span><br><span class="line">mysql&gt; <span class="keyword">DROP</span> <span class="keyword">SCHEMA</span> 数据库名;</span><br><span class="line">mysql&gt; <span class="keyword">DROP</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> 数据库名;</span><br></pre></td></tr></table></figure><p><strong>删除表</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">DROP</span> TABLES 表名;</span><br></pre></td></tr></table></figure><p><strong>删除索引</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">DROP</span> <span class="keyword">INDEX</span> 索引名 <span class="keyword">ON</span> 表名;</span><br></pre></td></tr></table></figure><h4 id="ALTER"><a href="#ALTER" class="headerlink" title="ALTER"></a>ALTER</h4><p><strong>修改表名</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER  <span class="keyword">TABLE</span> 旧表名 RENAME 新表名;</span><br></pre></td></tr></table></figure><p><strong>表中插入字段</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER <span class="keyword">TABLE</span> 表名 ADD 字段名<span class="comment"> char(11) AFTER</span> 插入位置的前一个字段名;</span><br></pre></td></tr></table></figure><p><strong>修改字段数据类型</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER <span class="keyword">TABLE</span> 表名 MODIFY 字段名 新数据类型;</span><br></pre></td></tr></table></figure><p><strong>修改字段名称</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER <span class="keyword">TABLE</span> 表名 CHANGE <span class="comment">COLUMN</span> 旧字段 新字段<span class="comment"> char(11)</span>;</span><br></pre></td></tr></table></figure><p><strong>添加唯一键</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER <span class="keyword">TABLE</span> 表名 ADD <span class="comment">UNIQUE KEY(</span>字段名<span class="comment">)</span>;</span><br></pre></td></tr></table></figure><p><strong>添加指定枚举值的字段</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER <span class="keyword">TABLE</span> 表名 ADD 字段名<span class="comment"> ENUM(</span><span class="comment">'值1'</span><span class="comment">,</span><span class="comment">'值2'</span><span class="comment">)</span>;</span><br></pre></td></tr></table></figure><p><strong>添加索引</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER <span class="keyword">TABLE</span> 表名 ADD <span class="comment">INDEX(</span>字段名<span class="comment">)</span>;</span><br></pre></td></tr></table></figure><p><strong>删除字段</strong></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER <span class="keyword">TABLE</span> 表名 DROP <span class="comment">COLUMN</span> 字段名;</span><br></pre></td></tr></table></figure><h3 id="DML语句"><a href="#DML语句" class="headerlink" title="DML语句"></a>DML语句</h3><p><strong>DML：数据的处理语言(Data Manipulation Language )</strong></p><h4 id="INSERT"><a href="#INSERT" class="headerlink" title="INSERT"></a>INSERT</h4><p><strong>赋值表中全部字段</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO 表名 (字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3</span>,字段<span class="number">4</span>)VALUES(值<span class="number">1</span>,'值<span class="number">2</span>',值<span class="number">3</span>,'值<span class="number">4</span>');</span><br></pre></td></tr></table></figure><p><strong>赋值表中指定字段</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO 表名 (字段<span class="number">1</span>,字段<span class="number">2</span>)VALUES(值<span class="number">1</span>,'值<span class="number">2</span>');</span><br></pre></td></tr></table></figure><p><strong>省略字段名称赋值</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO 表名 VALUES (值<span class="number">1</span>,'值<span class="number">2</span>',值<span class="number">3</span>,'值<span class="number">4</span>');</span><br></pre></td></tr></table></figure><p><strong>同时为多条记录赋值</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO 表名 VALUES (值<span class="number">1</span>,'值<span class="number">2</span>',值<span class="number">3</span>,'值<span class="number">4</span>'),(值<span class="number">1</span>,'值<span class="number">2</span>',值<span class="number">3</span>,'值<span class="number">4</span>');</span><br></pre></td></tr></table></figure><p><strong>向表2中追加表1字段的值，前提表2已经存在，且与表1表结构相同</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">INSERT</span> <span class="keyword">INTO</span> 表<span class="number">2</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表<span class="number">1</span>;</span><br></pre></td></tr></table></figure><h4 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h4><p><strong>清空表的内容</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> TRUNCATE TABLE 表名;<span class="comment">#速度快，但不记录日志</span></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> DELETE FROM 表名;<span class="comment">#速度稍慢，但会记录日志</span></span></span><br></pre></td></tr></table></figure><p><strong>删除记录</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">DELETE</span> <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> id=<span class="number">4</span>;</span><br></pre></td></tr></table></figure><h4 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h4><p><strong>注意：更改时不要忘记敲WHERE子句，不然会改掉全部记录对应字段的值</strong><br><strong>更改指定记录某字段的值</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE 表名 <span class="builtin-name">SET</span> <span class="attribute">age</span>=21 WHERE <span class="attribute">name</span>=<span class="string">'li'</span>;</span><br></pre></td></tr></table></figure><p><strong>同时更改一条记录多个字段的值</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE 表名 <span class="builtin-name">SET</span> <span class="attribute">age</span>=19,sex='m' WHERE <span class="attribute">id</span>=5;</span><br></pre></td></tr></table></figure><h3 id="DCL语句"><a href="#DCL语句" class="headerlink" title="DCL语句"></a>DCL语句</h3><p>DCL：数据授权语言(Data Control Language)</p><h4 id="GRANT"><a href="#GRANT" class="headerlink" title="GRANT"></a>GRANT</h4><p><strong>授权用户指定权限</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT <span class="keyword">SELECT</span>,<span class="keyword">INSERT</span> <span class="keyword">ON</span> 数据库名.表名 <span class="keyword">TO</span> root@<span class="string">'172.18.%.%'</span>;</span><br><span class="line">mysql&gt; GRANT <span class="keyword">SELECT</span>,<span class="keyword">INSERT</span>,<span class="keyword">UPDATE</span>,<span class="keyword">DELETE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="keyword">user</span>@<span class="string">'localhost'</span>;</span><br></pre></td></tr></table></figure><p><strong>授权用户全部权限</strong></p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT <span class="literal">ALL</span> <span class="keyword">ON</span> 数据库名.* <span class="keyword">TO</span> root@<span class="string">'172.18.%.%'</span>;</span><br></pre></td></tr></table></figure><p><strong>授权并创建用户</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT ALL ON *.* TO wang@'172.18.%.%' IDENTIFIED BY "password";</span><br><span class="line">mysql&gt; GRANT <span class="keyword">SELECT</span>,<span class="keyword">INSERT</span>,<span class="keyword">UPDATE</span>,<span class="keyword">DELETE</span> <span class="keyword">ON</span> mydb.* <span class="keyword">TO</span> <span class="keyword">user</span>@localhost IDENTIFIED <span class="keyword">BY</span> <span class="string">""</span>; #设置空口令</span><br></pre></td></tr></table></figure><h4 id="REVOKE"><a href="#REVOKE" class="headerlink" title="REVOKE"></a>REVOKE</h4><p><strong>取消指定授权</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; REVOKE <span class="keyword">SELECT</span>,<span class="keyword">INSERT</span> <span class="keyword">ON</span> 数据库名.* <span class="keyword">FROM</span> root@<span class="string">'172.18.%.%'</span>;</span><br></pre></td></tr></table></figure><p><strong>取消授权</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql</span>&gt; <span class="selector-tag">REVOKE</span> <span class="selector-tag">ALL</span> <span class="selector-tag">ON</span> 数据库名.* <span class="selector-tag">FROM</span> <span class="selector-tag">root</span>@'<span class="keyword">172</span>.<span class="keyword">18</span>.%.%';</span><br></pre></td></tr></table></figure><h3 id="DQL语句"><a href="#DQL语句" class="headerlink" title="DQL语句"></a>DQL语句</h3><p>DQL：数据查询语言(Data Query Language)</p><h4 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h4><p><strong>查询数据库名</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> <span class="keyword">DATABASE</span>();</span><br></pre></td></tr></table></figure><p><strong>查询当前数据库版本</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> VERSION();</span><br></pre></td></tr></table></figure><p><strong>查看当前登录的用户</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> <span class="keyword">USER</span>();</span><br></pre></td></tr></table></figure><p><strong>查询表中全部字段</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名;</span><br></pre></td></tr></table></figure><p><strong>查询表中指定字段</strong></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3</span> FROM 表名;</span><br></pre></td></tr></table></figure><p><strong>为搜索字段添加别名</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> id <span class="keyword">AS</span> 员工编号,name <span class="keyword">AS</span> 姓名 <span class="keyword">FROM</span> 表名;</span><br></pre></td></tr></table></figure><p><strong>为表名添加别名</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> 字段<span class="number">1</span>,字段<span class="number">2</span> <span class="keyword">FROM</span> 表名 <span class="keyword">AS</span> 表别名;</span><br></pre></td></tr></table></figure><p><strong>查寻指定区间内的字段</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> 字段 &gt;=<span class="number">18</span> <span class="keyword">and</span> 字段 &lt;=<span class="number">20</span>;</span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> 字段 <span class="keyword">BETWEEN</span> <span class="number">18</span> 字段 <span class="number">20</span>;</span><br></pre></td></tr></table></figure><p><strong>对查询的指定字段进行排序</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> 字段<span class="number">1</span> <span class="keyword">BETWEEN</span> <span class="number">16</span> 字段<span class="number">1</span> <span class="number">22</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> 字段<span class="number">1</span>;</span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> 字段<span class="number">1</span> <span class="keyword">BETWEEN</span> <span class="number">16</span> 字段<span class="number">1</span> <span class="number">22</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> 字段<span class="number">1</span> <span class="keyword">DESC</span>;#倒序排</span><br></pre></td></tr></table></figure><p><strong>跳过一个显示两个</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> 字段<span class="number">1</span> <span class="keyword">BETWEEN</span> <span class="number">16</span> 字段<span class="number">1</span> <span class="number">22</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> 字段<span class="number">1</span> <span class="keyword">LIMIT</span> <span class="number">1</span>,<span class="number">2</span>;</span><br></pre></td></tr></table></figure><p><strong>通配符的模糊查询</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">"l%"</span> ;</span><br></pre></td></tr></table></figure><p><strong>正则表达式的模糊查询</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> name RLIKE <span class="string">"l.*"</span> ;</span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> name RLIKE <span class="string">"^l.$"</span> ;</span><br></pre></td></tr></table></figure><p><strong>查询空值</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> age <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><p><strong>查询非空值</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> age <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><p><strong>查询某字段的特定值</strong></p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> 字段名 <span class="keyword">IN</span> (<span class="string">'值1'</span>,<span class="string">'值2'</span>);</span><br></pre></td></tr></table></figure><p><strong>多表查询</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">SELECT</span> s.id,<span class="built_in">e</span>.name <span class="keyword">FROM</span> 表名<span class="number">1</span> <span class="keyword">AS</span> s,表名<span class="number">2</span> <span class="keyword">AS</span> <span class="built_in">e</span> <span class="keyword">WHERE</span> s.id=<span class="built_in">e</span>.id;</span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> s.id,<span class="built_in">e</span>.name <span class="keyword">FROM</span> 表名<span class="number">1</span> <span class="keyword">AS</span> s,表名<span class="number">2</span> <span class="keyword">AS</span> <span class="built_in">e</span> <span class="keyword">WHERE</span> s.id=<span class="built_in">e</span>.id <span class="keyword">and</span> s.name RLIKE <span class="string">'.*[no].*'</span>;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;显示命令&quot;&gt;&lt;a href=&quot;#显示命令&quot; class=&quot;headerlink&quot; title=&quot;显示命令&quot;&gt;&lt;/a&gt;显示命令&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;显示当前数据库服务器中的数据库列表&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight mipsasm&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;mysql&amp;gt; &lt;span class=&quot;keyword&quot;&gt;SHOW &lt;/span&gt;DATABASES&lt;span class=&quot;comment&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="DataBase" scheme="http://subtraction.tech/categories/DataBase/"/>
    
    
      <category term="MariaDB" scheme="http://subtraction.tech/tags/MariaDB/"/>
    
      <category term="SQL" scheme="http://subtraction.tech/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>PXE自动化安装centos6和centos7</title>
    <link href="http://subtraction.tech/Automate/PXE%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AE%89%E8%A3%85centos6%E5%92%8Ccentos7/"/>
    <id>http://subtraction.tech/Automate/PXE自动化安装centos6和centos7/</id>
    <published>2017-09-30T19:11:22.000Z</published>
    <updated>2018-04-23T12:48:33.264Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="PXE介绍"><a href="#PXE介绍" class="headerlink" title="PXE介绍"></a>PXE介绍</h3><p><strong>PXE</strong>（Preboot Excution Environment）： 预启动执行环境，Intel公司研发，基于Client/Server的网络模式，支持远程主机通过网络从远端服务器下载映像，并由此支持通过网络启动操作系统。此外，PXE还可以引导和安装Windows,linux等多种操作系统</p><a id="more"></a><h3 id="PXE工作原理"><a href="#PXE工作原理" class="headerlink" title="PXE工作原理"></a>PXE工作原理</h3><ol><li>客户端向PXE服务器上的dhcp服务发送IP地址请求消息，dhcp服务检测客户端请求是否合法，主要是检测客户机的网卡MAC地址，如果合法则分配给客户端IP地址，同时将启动文件名pxelinux.0和启动文件位置信息一并传送给客户端。</li><li>客户端向PXE 服务器上的tftp服务发送获取启动文件pxelinux.0请求消息，tftp服务在接收到消息之后向客户端发送pxelinux.0大小信息，询问客户端是否同意使用，当tftp服务收到客户端发回的同意使用信息之后，正式向客户端发送pxelinux.0文件。</li><li>客户端执行接收到的pxelinux.0文件。</li><li>客户端向tftp服务器发送针对本机的配置信息文件（在tftp 服务器的pxelinux.cfg目录下），tftp服务器将配置文件发回客户端，继而客户端根据配置文件执行后续操作。</li><li>客户端向tftp服务器发送Linux内核请求信息，tftp服务器在接收到消息之后将内核文件发送给客户端</li><li>客户端向tftp服务器发送根文件请求信息，tftp服务器接收到消息之后返回Linux根文件系统给客户端。</li><li>客户端启动Linux内核</li><li>客户端下载安装源文件，读取自动化安装脚本</li></ol><hr><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>准备一台主机作为网络环境内的dhcp服务器、tftp服务器、http服务器，在此主机上配置PXE环境，为网络中的其它主机提供自动化系统安装服务。</p><h4 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="selector-id">#systemctl</span> disable firewalld.service</span><br><span class="line">#禁止防火墙开机自启动</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#systemctl</span> stop firewalld.service</span><br><span class="line">#关闭防火墙</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#iptables</span> -vnL</span><br></pre></td></tr></table></figure><h4 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="meta">#sed -i <span class="string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/selinux/config</span></span><br><span class="line"><span class="meta">#禁用SElinux策略</span></span><br><span class="line">root&amp;Centos7: ~<span class="meta"># grep SELINUX=disabled /etc/selinux/config</span></span><br><span class="line"><span class="meta">#确定SELINUX=disabled，已经将SElinux策略禁用</span></span><br><span class="line">root&amp;Centos7: ~<span class="meta">#setenforce 0</span></span><br><span class="line"><span class="meta">#设置SELinux当前状态为Permissive</span></span><br><span class="line">root&amp;Centos7: ~<span class="meta"># getenforce</span></span><br><span class="line"><span class="meta">#获取SELinux当前状态</span></span><br></pre></td></tr></table></figure><h4 id="将做DHCP服务器的主机设置为静态IP"><a href="#将做DHCP服务器的主机设置为静态IP" class="headerlink" title="将做DHCP服务器的主机设置为静态IP"></a>将做DHCP服务器的主机设置为静态IP</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~# nmcli<span class="built_in"> connection </span>show</span><br><span class="line"><span class="comment">#查看网卡名</span></span><br><span class="line">NAME                UUID                                 <span class="built_in"> TYPE </span>           DEVICE</span><br><span class="line">ens32               af3fea87-cb81-4a24-8ae4-afb54afa551c  802-3-ethernet  ens32</span><br><span class="line">root&amp;Centos7: ~#nmcli<span class="built_in"> connection </span>modify <span class="string">"ens32"</span> ipv4.addresses 192.168.10.43/24 ipv4.gateway 192.168.10.1</span><br><span class="line"><span class="comment">#设置ens32网卡的IP地址为静态地址</span></span><br></pre></td></tr></table></figure><hr><h3 id="安装相关软件包"><a href="#安装相关软件包" class="headerlink" title="安装相关软件包"></a>安装相关软件包</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">&amp;Centos7: ~#yum install -y dhcp tftp-server httpd syslinux</span></span><br><span class="line"><span class="meta">#一次性安装完成dhcp tftp-server httpd syslinux四个软件包</span></span><br></pre></td></tr></table></figure><hr><h3 id="配置文件共享服务和yum源"><a href="#配置文件共享服务和yum源" class="headerlink" title="配置文件共享服务和yum源"></a>配置文件共享服务和yum源</h3><h4 id="启动httpd服务"><a href="#启动httpd服务" class="headerlink" title="启动httpd服务"></a>启动httpd服务</h4><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Ce<span class="symbol">ntos7</span>: ~<span class="attr">#systemctl enable httpd.service</span></span><br><span class="line"><span class="attr">root&amp;Centos7</span>: ~<span class="attr">#systemctl start httpd.service</span></span><br><span class="line"><span class="attr">root&amp;Centos7</span>: ~<span class="attr">#ss -ntl |grep 80</span></span><br></pre></td></tr></table></figure><h4 id="制作centos7和centos6的yum源"><a href="#制作centos7和centos6的yum源" class="headerlink" title="制作centos7和centos6的yum源"></a>制作centos7和centos6的yum源</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~#mkdir <span class="params">-pv</span>  /<span class="built_in">var</span>/www/html/centos/&#123;<span class="number">6</span>,<span class="number">7</span>&#125;</span><br><span class="line">root&amp;Centos7: ~#mount /dev/sr0 /<span class="built_in">var</span>/www/html/centos/<span class="number">6</span>/</span><br><span class="line">root&amp;Centos7: ~#mount /dev/sr1 /<span class="built_in">var</span>/www/html/centos/<span class="number">7</span>/</span><br><span class="line">root&amp;Centos7: ~#ls /<span class="built_in">var</span>/www/html/centos/&#123;<span class="number">6</span>,<span class="number">7</span>&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="制作centos6和centos7的kickstart文件"><a href="#制作centos6和centos7的kickstart文件" class="headerlink" title="制作centos6和centos7的kickstart文件"></a>制作centos6和centos7的kickstart文件</h3><p><strong>生成kickstart文件的两种方法:</strong></p><ul><li>修改anaconda.cfg文件,此文件会在每次装完系统后生成于/root/目录下.</li><li>使用system-config-kickstart命令生成.</li></ul><h4 id="复制应答文件到共享目录下的-ksdir-目录下"><a href="#复制应答文件到共享目录下的-ksdir-目录下" class="headerlink" title="复制应答文件到共享目录下的/ksdir/目录下"></a>复制应答文件到共享目录下的/ksdir/目录下</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="selector-id">#mkdir</span> /var/www/html/ksdir/</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#cp</span> -<span class="selector-tag">p</span> /root/anaconda7-ks<span class="selector-class">.cfg</span> /var/www/html/ksdir/ks7-<span class="number">1</span>.cfg</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#cp</span> -<span class="selector-tag">p</span> /root/anaconda6-ks<span class="selector-class">.cfg</span> /var/www/html/ksdir/ks6-<span class="number">1</span>.cfg</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#ls</span> /var/www/html/ksdir/</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#chmod</span> +r /var/www/html/ksdir<span class="comment">/*.cfg</span></span><br><span class="line"><span class="comment">#为应答文件增加读权限，此步骤很重要，请确保执行。</span></span><br></pre></td></tr></table></figure><h4 id="编辑centos7的应答文件"><a href="#编辑centos7的应答文件" class="headerlink" title="编辑centos7的应答文件"></a>编辑centos7的应答文件</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="comment">#vim /var/www/html/ksdir/ks7-1.cfg</span></span><br><span class="line"><span class="comment">#version=DEVEL</span></span><br><span class="line"><span class="comment"># System authorization information</span></span><br><span class="line">auth <span class="params">--enableshadow</span> <span class="params">--passalgo=sha512</span></span><br><span class="line"><span class="comment"># Use CDROM installation media</span></span><br><span class="line"><span class="comment">#cdrom</span></span><br><span class="line">url <span class="params">--url=http</span>:<span class="string">//192.168.10.43/centos/7</span><span class="comment">#指定安装使用的yum源路径</span></span><br><span class="line"><span class="comment"># Use graphical install</span></span><br><span class="line"><span class="comment">#graphical</span></span><br><span class="line">text<span class="comment">#使用text文本安装方式</span></span><br><span class="line"><span class="comment"># Run the Setup Agent on first boot</span></span><br><span class="line">firstboot <span class="params">--enable</span></span><br><span class="line">ignoredisk <span class="params">--only-use=sda</span></span><br><span class="line"><span class="comment"># Keyboard layouts</span></span><br><span class="line">keyboard <span class="params">--vckeymap=us</span> <span class="params">--xlayouts=</span>'us'</span><br><span class="line"><span class="comment"># System language</span></span><br><span class="line">lang en_US.UTF-8</span><br><span class="line"></span><br><span class="line"><span class="comment"># Network information</span></span><br><span class="line">network  <span class="params">--bootproto=dhcp</span> <span class="params">--device=ens32</span> <span class="params">--onboot=on</span> <span class="params">--ipv6=auto</span> <span class="params">--activate</span></span><br><span class="line">network  <span class="params">--hostname=localhost</span>.localdomain</span><br><span class="line"></span><br><span class="line"><span class="comment"># Root password#设置root密码</span></span><br><span class="line">rootpw <span class="params">--iscrypted</span> $6$KvKpJji3uieQkGBS$5s1fuvxc0WcOW77438w.bLZJwTxV8afFC.NL6X0zCfRj8pfrldm37lKgR5iSsY.z9pNd7Q9rxvqfIU0O1CUnX.</span><br><span class="line"><span class="comment"># System services</span></span><br><span class="line">services <span class="params">--enabled=</span><span class="string">"chronyd"</span></span><br><span class="line"><span class="comment"># System timezone</span></span><br><span class="line">timezone Asia/Shanghai <span class="params">--isUtc</span> <span class="params">--ntpservers=0</span>.centos.pool.ntp.org,1.centos.pool.ntp.org,2.centos.pool.ntp.org,3.centos.pool.ntp.org</span><br><span class="line"><span class="comment"># System bootloader configuration</span></span><br><span class="line">bootloader <span class="params">--append=</span><span class="string">" crashkernel=auto"</span> <span class="params">--location=mbr</span> <span class="params">--boot-drive=sda</span></span><br><span class="line"><span class="comment"># Partition clearing information</span></span><br><span class="line"><span class="comment">#clearpart --none --initlabel</span></span><br><span class="line">zerombr<span class="comment">#安装时自动清空MBR</span></span><br><span class="line">clearpart <span class="params">--all</span><span class="comment">#清空全部分区</span></span><br><span class="line">reboot<span class="comment">#安装完成后自动重启</span></span><br><span class="line"><span class="comment"># Disk partitioning information#分区信息</span></span><br><span class="line">part swap <span class="params">--fstype=</span><span class="string">"swap"</span> <span class="params">--ondisk=sda</span> <span class="params">--size=2048</span></span><br><span class="line">part <span class="string">/app</span> <span class="params">--fstype=</span><span class="string">"xfs"</span> <span class="params">--ondisk=sda</span> <span class="params">--size=51200</span></span><br><span class="line">part / <span class="params">--fstype=</span><span class="string">"xfs"</span> <span class="params">--ondisk=sda</span> <span class="params">--size=51200</span></span><br><span class="line">part <span class="string">/boot</span> <span class="params">--fstype=</span><span class="string">"xfs"</span> <span class="params">--ondisk=sda</span> <span class="params">--size=1024</span></span><br><span class="line"></span><br><span class="line">%packages<span class="comment">#要安装的软件包</span></span><br><span class="line">@^minimal</span><br><span class="line">@core</span><br><span class="line">chrony</span><br><span class="line">kexec-tools</span><br><span class="line">autofs</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%addon com_redhat_kdump <span class="params">--enable</span> <span class="params">--reserve-mb=</span>'auto'</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%anaconda</span><br><span class="line">pwpolicy root <span class="params">--minlen=6</span> <span class="params">--minquality=50</span> <span class="params">--notstrict</span> <span class="params">--nochanges</span> <span class="params">--notempty</span></span><br><span class="line">pwpolicy user <span class="params">--minlen=6</span> <span class="params">--minquality=50</span> <span class="params">--notstrict</span> <span class="params">--nochanges</span> <span class="params">--notempty</span></span><br><span class="line">pwpolicy luks <span class="params">--minlen=6</span> <span class="params">--minquality=50</span> <span class="params">--notstrict</span> <span class="params">--nochanges</span> <span class="params">--notempty</span></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post<span class="comment">#安装完成后要执行的脚本</span></span><br><span class="line">systemctl enable autofs</span><br><span class="line">rm -rf <span class="string">/etc/yum.repos.d/</span>*</span><br><span class="line">cat &gt; <span class="string">/etc/yum.repos.d/base.repo</span> &lt;&lt;eof</span><br><span class="line">[base]</span><br><span class="line">name=base</span><br><span class="line">baseurl=file:<span class="string">///misc/cd</span></span><br><span class="line">gpgcheck=0</span><br><span class="line">eof</span><br><span class="line">%end</span><br></pre></td></tr></table></figure><h4 id="编辑centos6的应答文件"><a href="#编辑centos6的应答文件" class="headerlink" title="编辑centos6的应答文件"></a>编辑centos6的应答文件</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="comment">#vim /var/www/html/ksdir/ks6-1.cfg</span></span><br><span class="line"><span class="comment"># Kickstart file automatically generated by anaconda.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#version=DEVEL</span></span><br><span class="line">install</span><br><span class="line"><span class="comment">#cdrom</span></span><br><span class="line">url <span class="params">--url=http</span>:<span class="string">//192.168.10.43/centos/6</span></span><br><span class="line">text</span><br><span class="line">reboot</span><br><span class="line">zerombr</span><br><span class="line">lang en_US.UTF-8</span><br><span class="line">keyboard us</span><br><span class="line">network <span class="params">--onboot</span> yes <span class="params">--device</span> eth0 <span class="params">--bootproto</span> dhcp <span class="params">--noipv6</span></span><br><span class="line">rootpw  <span class="params">--iscrypted</span> $6$fo5PVsYpQzE2RC..$vZ2FT3sHNJBR2aopg8uzWWM2.59BykYcelOD7rBryYUuYpeNKpqAneREqaaO4x3btGdBJGbc4vHvjwaGLBGVG1</span><br><span class="line">firewall <span class="params">--service=ssh</span></span><br><span class="line">authconfig <span class="params">--enableshadow</span> <span class="params">--passalgo=sha512</span></span><br><span class="line">selinux <span class="params">--enforcing</span></span><br><span class="line">timezone <span class="params">--utc</span> Asia/Shanghai</span><br><span class="line">bootloader <span class="params">--location=mbr</span> <span class="params">--driveorder=sda</span> <span class="params">--append=</span><span class="string">"crashkernel=auto rhgb quiet"</span></span><br><span class="line"><span class="comment"># The following is the partition information you requested</span></span><br><span class="line"><span class="comment"># Note that any partitions you deleted are not expressed</span></span><br><span class="line"><span class="comment"># here so unless you clear all partitions first, this is</span></span><br><span class="line"><span class="comment"># not guaranteed to work</span></span><br><span class="line"><span class="comment">#clearpart --none</span></span><br><span class="line">clearpart <span class="params">--all</span></span><br><span class="line">part <span class="string">/boot</span> <span class="params">--fstype=ext4</span> <span class="params">--size=1000</span></span><br><span class="line">part / <span class="params">--fstype=ext4</span> <span class="params">--size=50000</span></span><br><span class="line">part <span class="string">/app</span> <span class="params">--fstype=ext4</span> <span class="params">--size=50000</span></span><br><span class="line">part swap <span class="params">--size=2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#repo --name="CentOS"  --baseurl=cdrom:sr0 --cost=100</span></span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">@core</span><br><span class="line">@server-policy</span><br><span class="line">@workstation-policy</span><br><span class="line">%end</span><br></pre></td></tr></table></figure><h4 id="检查应答文件格式"><a href="#检查应答文件格式" class="headerlink" title="检查应答文件格式"></a>检查应答文件格式</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="selector-id">#yum</span> install system-config-kickstart -y</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#ksvalidator</span> /var/www/html/ksdir/ks7-<span class="number">1</span>.cfg</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#ksvalidator</span> /var/www/html/ksdir/ks6-<span class="number">1</span>.cfg</span><br></pre></td></tr></table></figure><hr><h3 id="配置tftp服务"><a href="#配置tftp服务" class="headerlink" title="配置tftp服务"></a>配置tftp服务</h3><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Ce<span class="symbol">ntos7</span>: ~<span class="attr">#systemctl enable tftp.socket</span></span><br><span class="line"><span class="attr">root&amp;Centos7</span>: ~<span class="attr">#systemctl start tftp.socket</span></span><br><span class="line"><span class="attr">root&amp;Centos7</span>: ~<span class="attr">#ss -nul|grep 69</span></span><br></pre></td></tr></table></figure><hr><h3 id="配置DHCP服务"><a href="#配置DHCP服务" class="headerlink" title="配置DHCP服务"></a>配置DHCP服务</h3><blockquote><p>默认dhcp配置文件内没有配置信息，可以使用配置示例文件将配置文件覆盖后进行修改，dhcp服务必须在更改配置文件后才能启动。dhcp配置文件必须要dhcp服务器所在网段的地址池。</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="comment">#cp /usr/share/doc/dhcp*/dhcpd.conf.example /etc/dhcp/dhcpd.conf</span></span><br><span class="line"><span class="comment">#制作配置文件</span></span><br><span class="line">root&amp;Centos7: ~<span class="comment">#vim /etc/dhcp/dhcpd.conf</span></span><br><span class="line"><span class="comment">#编辑配置文件</span></span><br><span class="line"><span class="comment"># DHCP server to understand the network topology.</span></span><br><span class="line">subnet <span class="number">192.168</span>.<span class="number">10.0</span> netmask <span class="number">255.255</span>.<span class="number">255.0</span> &#123;  <span class="comment">#设置地址段</span></span><br><span class="line">range <span class="number">192.168</span>.<span class="number">10.50</span> <span class="number">192.168</span>.<span class="number">10.100</span>; <span class="comment">#设置地址池</span></span><br><span class="line">option routers <span class="number">192.168</span>.<span class="number">10.1</span>;<span class="comment">#设置网关</span></span><br><span class="line"><span class="keyword">next</span>-server <span class="number">192.168</span>.<span class="number">10.43</span>;      <span class="comment">#提供引导文件的服务器ip ，用于网络安装操作系统时</span></span><br><span class="line">filename <span class="string">"pxelinux.0"</span>;    <span class="comment">#指明引导文件名称</span></span><br><span class="line">&#125;</span><br><span class="line">root&amp;Centos7: ~<span class="comment">#systemctl enable dhcpd</span></span><br><span class="line"><span class="comment">#将dhcp服务设置为开机自启动</span></span><br><span class="line">root&amp;Centos7: ~<span class="comment">#systemctl start dhcpd</span></span><br><span class="line"><span class="comment">#启动dhcp服务</span></span><br><span class="line">root&amp;Centos7: ~<span class="comment">#ss -nul|grep 67</span></span><br><span class="line"><span class="comment">#检查确认dhcp服务已经启动</span></span><br></pre></td></tr></table></figure><hr><h3 id="制作PXE相关文件"><a href="#制作PXE相关文件" class="headerlink" title="制作PXE相关文件"></a>制作PXE相关文件</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="selector-id">#mkdir</span> /var/lib/tftpboot/pxelinux.cfg/</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#mkdir</span> /var/lib/tftpboot/centos&#123;<span class="number">6</span>,<span class="number">7</span>&#125;</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#cp</span> /usr/share/syslinux/&#123;pxelinux.<span class="number">0</span>,<span class="selector-tag">menu</span>.c32&#125; /var/lib/tftpboot/</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#cp</span> /var/www/html/centos/<span class="number">7</span>/isolinux/&#123;initrd<span class="selector-class">.img</span>,vmlinuz&#125;  /var/lib/tftpboot/centos7</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#cp</span> /var/www/html/centos/<span class="number">6</span>/isolinux/&#123;initrd<span class="selector-class">.img</span>,vmlinuz&#125;  /var/lib/tftpboot/centos6</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#cp</span> /misc/cd/isolinux/isolinux<span class="selector-class">.cfg</span> /var/lib/tftpboot/pxelinux.cfg/default</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#tree</span> /var/lib/tftpboot/</span><br><span class="line">/var/lib/tftpboot/</span><br><span class="line">├── centos6</span><br><span class="line">│   ├── initrd.img</span><br><span class="line">│   └── vmlinuz</span><br><span class="line">├── centos7</span><br><span class="line">│   ├── initrd<span class="selector-class">.img</span>    #伪文件系统文件</span><br><span class="line">│   └── vmlinuz     #内核文件</span><br><span class="line">├── <span class="selector-tag">menu</span><span class="selector-class">.c32</span>#纯文本菜单</span><br><span class="line">├── pxelinux.<span class="number">0</span>#引导文件，相当于grub。</span><br><span class="line">└── pxelinux.cfg</span><br><span class="line">└── default       #启动菜单文件</span><br></pre></td></tr></table></figure><hr><h3 id="制作启动菜单"><a href="#制作启动菜单" class="headerlink" title="制作启动菜单"></a>制作启动菜单</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~#vim /var/lib/tftpboot/pxelinux.cfg/default</span><br><span class="line">default menu.c32</span><br><span class="line">timeout 600</span><br><span class="line">menu title CentOS Linux  PXE Install</span><br><span class="line"></span><br><span class="line">label centos7     #自动安装centos7</span><br><span class="line">  menu label Auto Install CentOS Linux ^7</span><br><span class="line">  kernel centos7/vmlinuz</span><br><span class="line">  append <span class="attribute">initrd</span>=centos7/initrd.img <span class="attribute">ks</span>=http://192.168.10.43/ksdir/ks7-1.cfg  #应答文件所在路径</span><br><span class="line"></span><br><span class="line">label centos6      #自动安装centos6</span><br><span class="line">  menu label Auto Install CentOS Linux ^6</span><br><span class="line">  kernel centos6/vmlinuz</span><br><span class="line">  append <span class="attribute">initrd</span>=centos6/initrd.img <span class="attribute">ks</span>=http://192.168.10.43/ksdir/ks6-1.cfg</span><br><span class="line"></span><br><span class="line">label manual7     #手动安装centos7</span><br><span class="line">  menu label ^Manual Install CentOS Linux 7</span><br><span class="line">  kernel centos7/vmlinuz</span><br><span class="line">  append <span class="attribute">initrd</span>=centos7/initrd.img inst.<span class="attribute">repo</span>=http://192.168.10.43/centos/7</span><br><span class="line"></span><br><span class="line">label manual6      #手动安装centos6</span><br><span class="line">  menu label<span class="built_in"> Manual </span>^Install CentOS Linux 6</span><br><span class="line">  kernel centos6/vmlinuz</span><br><span class="line">  append <span class="attribute">initrd</span>=centos6/initrd.img inst.<span class="attribute">repo</span>=http://192.168.10.43/centos/6</span><br><span class="line">  </span><br><span class="line">label local     #本地硬盘启动</span><br><span class="line"> menu<span class="built_in"> default </span>   #默认启动项</span><br><span class="line"> menu label Boot <span class="keyword">from</span> ^local drive</span><br><span class="line"> localboot 0xffff</span><br><span class="line">menu end</span><br></pre></td></tr></table></figure><hr><h3 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h3><p><strong>Note：</strong>使用虚拟机安装时，centos7内存要大于1024M，否则无法成功安装。</p><p><strong>使用网络引导启动,下图是启动后的安装界面：</strong></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/13H6mJ85gD.png?imageslim" alt="mark"></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;PXE介绍&quot;&gt;&lt;a href=&quot;#PXE介绍&quot; class=&quot;headerlink&quot; title=&quot;PXE介绍&quot;&gt;&lt;/a&gt;PXE介绍&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;PXE&lt;/strong&gt;（Preboot Excution Environment）： 预启动执行环境，Intel公司研发，基于Client/Server的网络模式，支持远程主机通过网络从远端服务器下载映像，并由此支持通过网络启动操作系统。此外，PXE还可以引导和安装Windows,linux等多种操作系统&lt;/p&gt;
    
    </summary>
    
      <category term="Automate" scheme="http://subtraction.tech/categories/Automate/"/>
    
    
      <category term="PXE" scheme="http://subtraction.tech/tags/PXE/"/>
    
  </entry>
  
  <entry>
    <title>SSH端口转发</title>
    <link href="http://subtraction.tech/Network/SSH%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/"/>
    <id>http://subtraction.tech/Network/SSH端口转发/</id>
    <published>2017-09-28T07:29:11.000Z</published>
    <updated>2018-04-23T12:47:57.417Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="关于SSH端口转发"><a href="#关于SSH端口转发" class="headerlink" title="关于SSH端口转发"></a>关于SSH端口转发</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>SSH 会自动加密和解密所有SSH 客户端与服务端之间的网络数据。但是，SSH 还能够将其他TCP 端口的网络数据通过SSH 链接来转发，并且自动提供了相应的加密及解密服务。这一过程也被叫做“隧道”（tunneling），这是因为SSH 为其他TCP 链接提供了一个安全的通道来进行传输而得名。例如，Telnet，SMTP，LDAP 这些TCP 应用均能够从中得益，避免了用户名，密码以及隐私信息的明文传输。而与此同时，如果工作环境中的防火墙限制了一些网络端口的使用，但是允许SSH 的连接，也能够通过将TCP 端口转发来使用SSH 进行通讯。</p><a id="more"></a><h4 id="两大应用"><a href="#两大应用" class="headerlink" title="两大应用"></a>两大应用</h4><ul><li>加密SSH Client 端至SSH Server 端之间的通讯数据</li><li>突破防火墙的限制完成一些之前无法建立的TCP 连接</li></ul><hr><h3 id="实验前准备"><a href="#实验前准备" class="headerlink" title="实验前准备"></a>实验前准备</h3><p><strong>实验前的准备工作非常重要,关乎实验能否顺利的进行,请务必在每台主机上完成准备工作</strong></p><h4 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h4><p><strong>CentOS 7关闭防火墙的方法</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="selector-id">#systemctl</span> disable firewalld.service</span><br><span class="line">Removed symlink /etc/systemd/system/basic<span class="selector-class">.target</span><span class="selector-class">.wants</span>/firewalld<span class="selector-class">.service</span>.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-</span><br><span class="line">org<span class="selector-class">.fedoraproject</span><span class="selector-class">.FirewallD1</span><span class="selector-class">.service</span>.</span><br><span class="line">#禁止防火墙自启动</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#systemctl</span> stop firewalld.service</span><br><span class="line">#关闭防火墙</span><br><span class="line">root&amp;Centos7: ~<span class="selector-id">#iptables</span> -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT <span class="number">4044</span> packets, <span class="number">482</span>K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT <span class="number">0</span> packets, <span class="number">0</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT <span class="number">77</span> packets, <span class="number">7544</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     source               destination</span><br><span class="line"> #确认防火墙已经关闭</span><br></pre></td></tr></table></figure><p><strong>CentOS 6关闭防火墙的方法</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chkconfig iptables off</span><br><span class="line"><span class="comment">#禁止防火墙自启动</span></span><br><span class="line">[root@localhost ~]#<span class="built_in"> service </span>iptables stop</span><br><span class="line"><span class="comment">#关闭防火墙</span></span><br><span class="line">iptables: Setting chains <span class="keyword">to</span><span class="built_in"> policy </span>ACCEPT:<span class="built_in"> filter </span>         [  OK  ]</span><br><span class="line">iptables: Flushing<span class="built_in"> firewall </span>rules:                         [  OK  ]</span><br><span class="line">iptables: Unloading modules:                               [  OK  ]</span><br><span class="line">[root@localhost ~]# iptables -vnL</span><br><span class="line">……此处省略部分显示内容……</span><br></pre></td></tr></table></figure><h4 id="关闭SElinux策略"><a href="#关闭SElinux策略" class="headerlink" title="关闭SElinux策略"></a>关闭SElinux策略</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># sed -i <span class="string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/selinux/config</span></span><br><span class="line"><span class="meta">#禁用SElinux策略</span></span><br><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># grep SELINUX=disabled /etc/selinux/config</span></span><br><span class="line"><span class="meta">#确定SELINUX=disabled，已经将SElinux策略禁用</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># setenforce 0</span></span><br><span class="line"><span class="meta">#设置SELinux当前状态为Permissive</span></span><br><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># getenforce</span></span><br><span class="line"><span class="meta">#获取SELinux当前状态</span></span><br><span class="line">Permissive</span><br></pre></td></tr></table></figure><h4 id="检查是否已安装Telnet服务"><a href="#检查是否已安装Telnet服务" class="headerlink" title="检查是否已安装Telnet服务"></a>检查是否已安装Telnet服务</h4><p>Telnet服务有两个软件包，请确认都已经安装。</p><ul><li>telnet-server：此软件包为server包，用于接收Telnet client的连接</li><li>telnet：此软件包是client包，用于连接Telnet service</li></ul><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rpm -qa telnet-server</span></span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -ql telnet</span></span><br><span class="line">package telnet <span class="keyword">is</span> <span class="keyword">not</span> installed</span><br><span class="line"><span class="comment">#使用rpm -ql 或rpm -qa查看软件包是否已经安装。上面是没有安装的显示。</span></span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -qa telnet-server</span></span><br><span class="line">telnet-server<span class="number">-0.17</span><span class="number">-48.</span>el6.x86_64</span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -ql telnet</span></span><br><span class="line">/usr/bin/telnet</span><br><span class="line">/usr/share/man/man1/telnet<span class="number">.1</span>.gz</span><br><span class="line"><span class="comment">#使用rpm -qa可以查看到软件包或使用rpm -ql 查看到软件包安装目录，则说明包已经安装。</span></span><br></pre></td></tr></table></figure><h4 id="安装Telnet服务"><a href="#安装Telnet服务" class="headerlink" title="安装Telnet服务"></a>安装Telnet服务</h4><p>若没有安装Telnet服务的这两个软件包，则使用yum安装。</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># yum list |grep telnet</span></span><br><span class="line">telnet-server.x86_64                     <span class="number">1</span>:<span class="number">0.17</span><span class="number">-48.</span>el6                    cdrom</span><br><span class="line">telnet.x86_64                            <span class="number">1</span>:<span class="number">0.17</span><span class="number">-48.</span>el6                    cdrom</span><br><span class="line"><span class="meta">#确认要安装的软件包都在yum源中。</span></span><br><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># yum install -y telnet-server telnet</span></span><br><span class="line"><span class="meta">#使用yum同时安装缺少的两个软件包，如果只缺少一个，则只安装对应缺少的那个软件包。</span></span><br><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># rpm -ql telnet-server</span></span><br><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># rpm -ql telnet</span></span><br><span class="line"><span class="meta">#确认两个软件包都已经安装全。</span></span><br></pre></td></tr></table></figure><h4 id="启动Telnet服务"><a href="#启动Telnet服务" class="headerlink" title="启动Telnet服务"></a>启动Telnet服务</h4><p><strong>CentOS 6启动Telnet服务的方法</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chkconfig telnet on</span><br><span class="line"><span class="comment">#设置telnet service状态为on</span></span><br><span class="line">[root@localhost ~]# chkconfig --list telnet</span><br><span class="line">telnet         on</span><br><span class="line"><span class="comment">#检查上一步的设置已生效</span></span><br><span class="line">[root@localhost ~]#<span class="built_in"> service </span>xinetd start</span><br><span class="line">Starting xinetd:                                           [  OK  ]</span><br><span class="line"><span class="comment">#启动xinetd服务</span></span><br><span class="line">[root@localhost ~]# ss -ntl|grep :23</span><br><span class="line">LISTEN     0      64                       :::23                      :::*</span><br><span class="line"><span class="comment">#确定TCP的23端口已经打开，Telnet服务已可以接受访问。</span></span><br></pre></td></tr></table></figure><p><strong>CentOS 7启动Telnet服务的方法</strong></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root&amp;<span class="symbol">Centos7:</span> ~<span class="comment"># systemctl enable telnet.socket</span></span><br><span class="line">Created symlink from /etc/systemd/system/sockets.target.wants/telnet.socket to /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">telnet</span>.<span class="title">socket</span>.</span></span><br><span class="line"><span class="comment">#设置telnet服务为开机自启动</span></span><br><span class="line">root&amp;<span class="symbol">Centos7:</span> ~<span class="comment"># systemctl start telnet.socket</span></span><br><span class="line"><span class="comment">#启动telnet服务</span></span><br><span class="line">root&amp;<span class="symbol">Centos7:</span> ~<span class="comment"># systemctl is-active telnet.socket</span></span><br><span class="line">active</span><br><span class="line"><span class="comment">#验证Telnet服务当前是否为活动状态</span></span><br><span class="line">root&amp;<span class="symbol">Centos7:</span> ~<span class="comment">#ss -ntl|grep :23</span></span><br><span class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>         :::<span class="number">23</span>                      :::*</span><br></pre></td></tr></table></figure><hr><h3 id="本地端口转发"><a href="#本地端口转发" class="headerlink" title="本地端口转发"></a>本地端口转发</h3><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/CfhAh08J0E.png?imageslim" alt="mark"></p><p>A需要与C建立Telnet连接，但出于安全考虑A不能直接连接C，需要通过B做跳板机来连接C。Telnet是不加密传输的，为了保证A和B之间传输数据的安全，需要在A上建立本地端口转发，建立ssh安全隧道，实现加密传输。A到B走的是ssh协议，通信的数据经过封装，不用担心被截获，在内网可以走Telnet协议，实现安全通信。</p><h4 id="建立本地端口转发"><a href="#建立本地端口转发" class="headerlink" title="建立本地端口转发"></a>建立本地端口转发</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="comment">#ss -nlt|grep 9527</span></span><br><span class="line"><span class="comment">#检查要使用的9527端口是否被占有，被占有则更换其他端口。</span></span><br><span class="line">root&amp;Centos6: ~<span class="comment">#ssh -L 9527:172.18.22.200:23 -Nf 172.18.0.2</span></span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added '<span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span>' (RSA) <span class="keyword">to</span> <span class="keyword">the</span> <span class="built_in">list</span> <span class="keyword">of</span> known hosts.</span><br><span class="line">root@<span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span>'s password:  <span class="comment">#此处输入B主机的登录密码</span></span><br><span class="line"><span class="comment">#ssh -L 本地转发端口:要访问的目标主机:目标服务的端口 -Nf 跳板机地址</span></span><br><span class="line"><span class="comment">#-L 建立本地端口转发</span></span><br><span class="line"><span class="comment">#-f 后台启用</span></span><br><span class="line"><span class="comment">#-N 不打开远程shell，处于等待状态</span></span><br></pre></td></tr></table></figure><h4 id="确认本地端口转发已经建立"><a href="#确认本地端口转发已经建立" class="headerlink" title="确认本地端口转发已经建立"></a>确认本地端口转发已经建立</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#ss -nt</span><br><span class="line">State      Recv-Q Send-Q                                   Local Address:Port                                    <span class="built_in"> Peer </span>Address:Port</span><br><span class="line">ESTAB      0      0                                        172.18.22.100:42368                                      172.18.0.2:22</span><br><span class="line"><span class="comment">#172.18.22.100与172.18.0.2已经建立连接，说明加密通信的隧道已经搭好。</span></span><br><span class="line">root&amp;Centos6: ~#ss -nlt|grep 9527</span><br><span class="line">LISTEN     0      128               127.0.0.1:9527                     *:*</span><br><span class="line">LISTEN     0      128                     ::1:9527                    :::*</span><br><span class="line"><span class="comment">#本地的9527端口已经打开并处于监听状态</span></span><br></pre></td></tr></table></figure><h4 id="使用创建好的加密隧道进行通信"><a href="#使用创建好的加密隧道进行通信" class="headerlink" title="使用创建好的加密隧道进行通信"></a>使用创建好的加密隧道进行通信</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root&amp;<span class="symbol">Centos6:</span> ~<span class="comment">#telnet 127.0.0.1 9527</span></span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">Centos7 <span class="symbol">login:</span> sun  <span class="comment">#输入C主机的非root账户。</span></span><br><span class="line"><span class="symbol">Password:</span>   <span class="comment">#输入密码</span></span><br><span class="line">Last <span class="symbol">login:</span> Tue Sep <span class="number">12</span> <span class="number">22</span><span class="symbol">:</span><span class="number">30</span><span class="symbol">:</span><span class="number">37</span> from <span class="symbol">:</span><span class="symbol">:ffff</span><span class="symbol">:</span><span class="number">172.18</span>.<span class="number">22.100</span></span><br><span class="line">[sun<span class="variable">@Centos7</span> ~]$</span><br><span class="line"><span class="comment">#已经看到了C主机的命令提示符说明远程连接成功。</span></span><br></pre></td></tr></table></figure><h4 id="查看A主机连接状态"><a href="#查看A主机连接状态" class="headerlink" title="查看A主机连接状态"></a>查看A主机连接状态</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">root</span>&amp;<span class="selector-tag">Centos6</span>: ~<span class="selector-id">#ss</span> <span class="selector-tag">-nt</span></span><br><span class="line"><span class="selector-tag">State</span>      <span class="selector-tag">Recv-Q</span> <span class="selector-tag">Send-Q</span>                                   <span class="selector-tag">Local</span> <span class="selector-tag">Address</span><span class="selector-pseudo">:Port</span>                                     <span class="selector-tag">Peer</span> <span class="selector-tag">Address</span><span class="selector-pseudo">:Port</span></span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line"><span class="selector-tag">ESTAB</span>      0      0                                            127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:46686</span>                                       127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:9527</span></span><br><span class="line"><span class="selector-tag">ESTAB</span>      0      0                                        172<span class="selector-class">.18</span><span class="selector-class">.22</span><span class="selector-class">.100</span><span class="selector-pseudo">:42368</span>                                      172<span class="selector-class">.18</span><span class="selector-class">.0</span><span class="selector-class">.2</span><span class="selector-pseudo">:22</span></span><br><span class="line">#本机的9527端口连接了本机的46686端口，本机既是<span class="selector-tag">Telnet</span> <span class="selector-tag">client</span>也是<span class="selector-tag">Telnet</span> <span class="selector-tag">service</span>。</span><br><span class="line">#本机的42368端口连接了<span class="selector-tag">B</span>主机的22端口，建立了<span class="selector-tag">ssh</span>通讯。</span><br></pre></td></tr></table></figure><h4 id="查看B主机连接状态"><a href="#查看B主机连接状态" class="headerlink" title="查看B主机连接状态"></a>查看B主机连接状态</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@localhost ~]</span># <span class="selector-tag">ss</span> <span class="selector-tag">-nt</span></span><br><span class="line"><span class="selector-tag">State</span>      <span class="selector-tag">Recv-Q</span> <span class="selector-tag">Send-Q</span>                                   <span class="selector-tag">Local</span> <span class="selector-tag">Address</span><span class="selector-pseudo">:Port</span>                                     <span class="selector-tag">Peer</span> <span class="selector-tag">Address</span><span class="selector-pseudo">:Port</span></span><br><span class="line"><span class="selector-tag">ESTAB</span>      0      0                                           172<span class="selector-class">.18</span><span class="selector-class">.0</span><span class="selector-class">.2</span><span class="selector-pseudo">:39298</span>                                   172<span class="selector-class">.18</span><span class="selector-class">.22</span><span class="selector-class">.200</span><span class="selector-pseudo">:23</span></span><br><span class="line"><span class="selector-tag">ESTAB</span>      0      0                                           172<span class="selector-class">.18</span><span class="selector-class">.0</span><span class="selector-class">.2</span><span class="selector-pseudo">:22</span>                                      172<span class="selector-class">.18</span><span class="selector-class">.22</span><span class="selector-class">.100</span><span class="selector-pseudo">:42368</span></span><br><span class="line"><span class="selector-id">#B</span>主机同时连接这<span class="selector-tag">A</span>和<span class="selector-tag">C</span>主机，<span class="selector-tag">B</span>主机连接的是<span class="selector-tag">C</span>主机的23端口，也就是<span class="selector-tag">C</span>主机<span class="selector-tag">Telnet</span>服务的监听端口。</span><br></pre></td></tr></table></figure><h4 id="查看C主机连接状态"><a href="#查看C主机连接状态" class="headerlink" title="查看C主机连接状态"></a>查看C主机连接状态</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~#ss -nt</span><br><span class="line">State      Recv-Q Send-Q                      Local Address:Port                                    <span class="built_in"> Peer </span>Address:Port</span><br><span class="line">ESTAB      0      0                    ::ffff:172.18.22.200:23                                  ::ffff:172.18.0.2:39298</span><br><span class="line"><span class="comment">#已经建立了Telnet连接，不是和A主机建立的而是和B主机建立的。</span></span><br></pre></td></tr></table></figure><h4 id="结束本地端口转发"><a href="#结束本地端口转发" class="headerlink" title="结束本地端口转发"></a>结束本地端口转发</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sun@Centos7 ~]$ <span class="keyword">exit</span></span><br><span class="line">logout</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line">root&amp;Centos6: ~<span class="comment">#</span></span><br><span class="line"><span class="comment">#退出登录的远程主机</span></span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#ss -nt</span><br><span class="line">State      Recv-Q Send-Q                                   Local Address:Port                                    <span class="built_in"> Peer </span>Address:Port</span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">ESTAB      0      0                                        172.18.22.100:42368                                      172.18.0.2:22</span><br><span class="line"><span class="comment">#A和B的连接还在，说明安全隧道还在搭着。</span></span><br><span class="line">root&amp;Centos6: ~#ps aux|grep <span class="string">"ssh -L"</span></span><br><span class="line">root      18619  0.0  0.0  61932  1284 ?        Ss   22:57   0:00 ssh -L 9527:172.18.22.200:23 -Nf 172.18.0.2</span><br><span class="line">root      18889  0.0  0.0 103332   844 pts/0    S+   23:27   0:00 grep ssh -L</span><br><span class="line"><span class="comment">#本地端口转发的进程还在。</span></span><br></pre></td></tr></table></figure><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="comment">#killall ssh</span></span><br><span class="line"><span class="comment">#杀掉本地端口转发的进程</span></span><br><span class="line">root&amp;Centos6: ~<span class="comment">#ps aux|grep "ssh -L"</span></span><br><span class="line">root     <span class="number"> 18892 </span> 0.0  0.0<span class="number"> 103332 </span> <span class="number"> 848 </span>pts/0    S+   23:28   0:00 grep ssh -L</span><br><span class="line">root&amp;Centos6: ~<span class="comment">#ss -nlt|grep 9527</span></span><br><span class="line"><span class="comment">#负责本地端口转发的9527端口已经关闭了，以结束本地端口转发。</span></span><br></pre></td></tr></table></figure><hr><h3 id="远程端口转发"><a href="#远程端口转发" class="headerlink" title="远程端口转发"></a>远程端口转发</h3><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/0IIi78aGf7.png?imageslim" alt="mark"></p><p>A主机需要给C主机发送邮件，但是C主机和B主机都在内网，A主机不能主动连接。B主机可以连接外网，需要B主机去主动访问A主机，并建立远程端口转发，接收A主机发来的邮件交给C主机。通过B主机做跳板机来实现A主机与C主机之间的TCP连接。</p><h4 id="配置C主机的邮件服务"><a href="#配置C主机的邮件服务" class="headerlink" title="配置C主机的邮件服务"></a>配置C主机的邮件服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~#ss -nlt|grep 25</span><br><span class="line">LISTEN     0      100    127.0.0.1:25                       *:*</span><br><span class="line">LISTEN     0      100        ::1:25                      :::*</span><br><span class="line"><span class="meta">#</span><span class="bash">正在监听25端口的是本地环回地址，会导致不能接收其它ip地址接收到的邮件。</span></span><br><span class="line">root&amp;Centos7: /#grep "inet_interfaces = " /etc/postfix/main.cf</span><br><span class="line"><span class="meta">#</span><span class="bash">inet_interfaces = all</span></span><br><span class="line"><span class="meta">#</span><span class="bash">inet_interfaces = <span class="variable">$myhostname</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">inet_interfaces = <span class="variable">$myhostname</span>, localhost</span></span><br><span class="line">inet_interfaces = localhost</span><br><span class="line"><span class="meta">#</span><span class="bash">localhost指的是127.0.0.1地址，all指本机所有地址。需要让inet_interfaces = all生效。</span></span><br><span class="line">root&amp;Centos7: /#sed -ri.bak 's/#(inet_interfaces = all)/\1/' /etc/postfix/main.cf</span><br><span class="line"><span class="meta">#</span><span class="bash">将/etc/postfix/main.cf文件中inet_interfaces = all前的注释去掉。</span></span><br><span class="line">root&amp;Centos7: /#sed -ri.bak 's/inet_interfaces = localhost/#&amp;/' /etc/postfix/main.cf</span><br><span class="line"><span class="meta">#</span><span class="bash">将/etc/postfix/main.cf文件中inet_interfaces = localhost前加上注释。</span></span><br><span class="line">root&amp;Centos7: /#grep "inet_interfaces = " /etc/postfix/main.cf</span><br><span class="line">inet_interfaces = all</span><br><span class="line"><span class="meta">#</span><span class="bash">inet_interfaces = <span class="variable">$myhostname</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">inet_interfaces = <span class="variable">$myhostname</span>, localhost</span></span><br><span class="line"><span class="meta">#</span><span class="bash">inet_interfaces = localhost</span></span><br><span class="line"><span class="meta">#</span><span class="bash">检验配置文件更改结果</span></span><br><span class="line">root&amp;Centos7: /#systemctl restart postfix</span><br><span class="line"><span class="meta">#</span><span class="bash">重启邮件服务，生效配置文件。</span></span><br><span class="line">root&amp;Centos7: /#ss -nlt|grep 25</span><br><span class="line">LISTEN     0      100          *:25                       *:*</span><br><span class="line">LISTEN     0      100         :::25                      :::*</span><br><span class="line"><span class="meta">#</span><span class="bash">再次检查邮件服务器端口，留意端口监听地址的变化。</span></span><br></pre></td></tr></table></figure><h4 id="建立远程端口转发"><a href="#建立远程端口转发" class="headerlink" title="建立远程端口转发"></a>建立远程端口转发</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ssh -R 9527:172.18.22.200:25 -fN 172.18.22.100</span></span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added '<span class="number">172.18</span><span class="number">.22</span><span class="number">.100</span>' (RSA) <span class="keyword">to</span> <span class="keyword">the</span> <span class="built_in">list</span> <span class="keyword">of</span> known hosts.</span><br><span class="line">root@<span class="number">172.18</span><span class="number">.22</span><span class="number">.100</span>'s password:</span><br><span class="line"><span class="comment">#ssh -R 远程转发端口:要访问的目标主机:目标服务的端口 -fN 进行远程转发的主机</span></span><br><span class="line"><span class="comment">#-R 建立远程端口转发</span></span><br><span class="line"><span class="comment">#-f 后台启用</span></span><br><span class="line"><span class="comment">#-N 不打开远程shell，处于等待状态</span></span><br></pre></td></tr></table></figure><h4 id="确认远程端口转发已经建立"><a href="#确认远程端口转发已经建立" class="headerlink" title="确认远程端口转发已经建立"></a>确认远程端口转发已经建立</h4><p>B主机的连接状态</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@localhost ~]</span># <span class="selector-tag">ss</span> <span class="selector-tag">-nt</span></span><br><span class="line"><span class="selector-tag">State</span>      <span class="selector-tag">Recv-Q</span> <span class="selector-tag">Send-Q</span>                                   <span class="selector-tag">Local</span> <span class="selector-tag">Address</span><span class="selector-pseudo">:Port</span>                                     <span class="selector-tag">Peer</span> <span class="selector-tag">Address</span><span class="selector-pseudo">:Port</span></span><br><span class="line"><span class="selector-tag">ESTAB</span>      0      0                                           172<span class="selector-class">.18</span><span class="selector-class">.0</span><span class="selector-class">.2</span><span class="selector-pseudo">:48008</span>                                   172<span class="selector-class">.18</span><span class="selector-class">.22</span><span class="selector-class">.100</span><span class="selector-pseudo">:22</span></span><br><span class="line"><span class="selector-id">#B</span>主机作为<span class="selector-tag">ssh</span> <span class="selector-tag">client</span>已与<span class="selector-tag">A</span>主机建立了<span class="selector-tag">ssh</span>连接。</span><br></pre></td></tr></table></figure><p>A主机的连接状态</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#ss -nlt|grep 9527</span><br><span class="line">LISTEN     0      128               127.0.0.1:9527                     *:*</span><br><span class="line">LISTEN     0      128                     ::1:9527                    :::*</span><br><span class="line"><span class="comment">#确定A主机的9527端口已处于监听状态</span></span><br><span class="line">root&amp;Centos6: ~#ss -nt</span><br><span class="line">State      Recv-Q Send-Q                                   Local Address:Port                                    <span class="built_in"> Peer </span>Address:Port</span><br><span class="line">ESTAB      0      0                                        172.18.22.100:22                                         172.18.0.2:48008</span><br><span class="line"><span class="comment">#已与B主机建立了ssh连接</span></span><br></pre></td></tr></table></figure><h4 id="使用创建好的加密隧道发送邮件"><a href="#使用创建好的加密隧道发送邮件" class="headerlink" title="使用创建好的加密隧道发送邮件"></a>使用创建好的加密隧道发送邮件</h4><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="meta">#telnet 127.0.0.1 9527</span></span><br><span class="line">Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...</span><br><span class="line">Connected <span class="keyword">to</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>.</span><br><span class="line">Escape character <span class="keyword">is</span> <span class="comment">'^]'.</span></span><br><span class="line"><span class="number">220</span> Centos7.xiaoyu ESMTP Postfix</span><br><span class="line">helo siwei,link</span><br><span class="line"><span class="number">250</span> Centos7.xiaoyu</span><br><span class="line">mail <span class="keyword">from</span>:sun@siwei.link</span><br><span class="line"><span class="number">250</span> <span class="number">2.1</span><span class="number">.0</span> Ok</span><br><span class="line">rcpt <span class="keyword">to</span>:root</span><br><span class="line"><span class="number">250</span> <span class="number">2.1</span><span class="number">.5</span> Ok</span><br><span class="line">data</span><br><span class="line"><span class="number">354</span> <span class="keyword">End</span> data <span class="keyword">with</span> &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class="line">subject:hello,ssh</span><br><span class="line">ssh remote link</span><br><span class="line">.<span class="meta">#.表示邮件已经完成</span></span><br><span class="line"><span class="number">250</span> <span class="number">2.0</span><span class="number">.0</span> Ok: queued <span class="keyword">as</span> <span class="number">4822</span>D412B44F</span><br><span class="line">quit <span class="meta">#退出</span></span><br><span class="line"><span class="number">221</span> <span class="number">2.0</span><span class="number">.0</span> Bye</span><br><span class="line">Connection closed <span class="keyword">by</span> foreign host.</span><br></pre></td></tr></table></figure><h4 id="查看C主机的连接状态"><a href="#查看C主机的连接状态" class="headerlink" title="查看C主机的连接状态"></a>查看C主机的连接状态</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: /#ss -nt</span><br><span class="line">State      Recv-Q Send-Q                      Local Address:Port                                    <span class="built_in"> Peer </span>Address:Port</span><br><span class="line">ESTAB      0      0                           172.18.22.200:25                                         172.18.0.2:59490</span><br><span class="line"><span class="comment">#本机的25端口接收到B主机的访问，并建立SMTP连接。</span></span><br></pre></td></tr></table></figure><h4 id="在C主机查看A主机发来的邮件"><a href="#在C主机查看A主机发来的邮件" class="headerlink" title="在C主机查看A主机发来的邮件"></a>在C主机查看A主机发来的邮件</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: /<span class="meta">#mail</span></span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line"> N  <span class="number">8</span> sun<span class="symbol">@siwei</span>.link        Wed Sep <span class="number">13</span> <span class="number">10</span>:<span class="number">48</span>  <span class="number">11</span>/<span class="number">321</span>   <span class="string">"hello,s"</span></span><br><span class="line">&amp; <span class="number">8</span>    <span class="meta">#输入数字8，查看第8封邮件</span></span><br><span class="line">Message  <span class="number">8</span>:</span><br><span class="line">From sun<span class="symbol">@siwei</span>.link  Wed Sep <span class="number">13</span> <span class="number">10</span>:<span class="number">48</span>:<span class="number">13</span> <span class="number">2017</span></span><br><span class="line"><span class="keyword">Return</span>-Path: &lt;sun<span class="symbol">@siwei</span>.link&gt;</span><br><span class="line">X-Original-<span class="keyword">To</span>: root</span><br><span class="line">Delivered-<span class="keyword">To</span>: root<span class="symbol">@Centos7</span>.xiaoyu</span><br><span class="line">subject:hello,ssh</span><br><span class="line">Status: R</span><br><span class="line"></span><br><span class="line">ssh remote link</span><br><span class="line"></span><br><span class="line">&amp; q<span class="meta">#退出邮箱</span></span><br><span class="line"><span class="meta">#接收到A主机发送来的邮件</span></span><br></pre></td></tr></table></figure><h4 id="在B主机关闭远程端口转发"><a href="#在B主机关闭远程端口转发" class="headerlink" title="在B主机关闭远程端口转发"></a>在B主机关闭远程端口转发</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta">#killall ssh</span></span><br></pre></td></tr></table></figure><hr><h3 id="动态端口转发"><a href="#动态端口转发" class="headerlink" title="动态端口转发"></a>动态端口转发</h3><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/a00a90bEKA.png?imageslim" alt="mark"></p><p>C是一台web服务器，A主机被防火墙隔离，不能直接访问C主机的web服务 ，通过在A主机上建立动态端口转发，利用代理服务器B来访问A的web服务。</p><h4 id="在C主机安装并配置httpd服务"><a href="#在C主机安装并配置httpd服务" class="headerlink" title="在C主机安装并配置httpd服务"></a>在C主机安装并配置httpd服务</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: /<span class="comment">#yum install -y httpd</span></span><br><span class="line">root&amp;Centos7: /<span class="comment">#systemctl start httpd</span></span><br><span class="line">root&amp;Centos7: /<span class="comment">#ss -ntl|grep 80</span></span><br><span class="line">LISTEN     0      128         :::80                      :::<span class="symbol">*</span></span><br><span class="line">root&amp;Centos7: /<span class="comment">#echo "&lt;h1&gt;www.siwei.link&lt;/h1&gt;" &gt;/var/www/html/index.html</span></span><br><span class="line"><span class="comment">#设置web网站首页内容</span></span><br><span class="line">root&amp;Centos7: /<span class="comment">#cat /var/www/html/index.html</span></span><br><span class="line"><span class="variable">&lt;h1&gt;</span>www.siwei.link<span class="variable">&lt;/h1&gt;</span></span><br><span class="line"><span class="comment">#验证首页内容写入成功</span></span><br><span class="line">root&amp;Centos7: /<span class="comment">#iptables -A INPUT -s 172.18.22.100 -j REJECT</span></span><br><span class="line"><span class="comment">#在C主机设置防火墙策略禁止A主机访问。</span></span><br></pre></td></tr></table></figure><h4 id="在A主机访问C主机的web服务"><a href="#在A主机访问C主机的web服务" class="headerlink" title="在A主机访问C主机的web服务"></a>在A主机访问C主机的web服务</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="comment">#curl http://172.18.22.200</span></span><br><span class="line">curl: (<span class="number">7</span>) couldn't connect <span class="keyword">to</span> host</span><br><span class="line"><span class="comment">#访问被拒绝</span></span><br></pre></td></tr></table></figure><h4 id="在A主机建立动态端口转发"><a href="#在A主机建立动态端口转发" class="headerlink" title="在A主机建立动态端口转发"></a>在A主机建立动态端口转发</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="selector-id">#ssh</span> -D <span class="number">1080</span> <span class="number">172.18</span>.<span class="number">0.2</span> -Nf</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#curl</span> --socks5 <span class="number">127.0</span>.<span class="number">0.1</span> http:<span class="comment">//172.18.22.200</span></span><br><span class="line">&lt;h1&gt;www<span class="selector-class">.siwei</span><span class="selector-class">.link</span>&lt;/h1&gt;</span><br><span class="line">#使用本地环回地址做代理，使用curl命令访问C主机的web网站</span><br><span class="line">#看到C主机设置的首页内容，说明访问成功。</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#killall</span> ssh</span><br><span class="line">#关闭动态端口转发</span><br></pre></td></tr></table></figure><hr><h3 id="附：误删除配置文件解决办法"><a href="#附：误删除配置文件解决办法" class="headerlink" title="附：误删除配置文件解决办法"></a>附：误删除配置文件解决办法</h3><p>无论在工作还是实验中，对待配置文件一定要慎重，改动前先做好备份，删除前先做好确认。不然就呵呵了o(<em>￣︶￣</em>)o<br>下面是以postfix服务的/etc/postfix/main.cf配置文件为例，实现文件误删除后的恢复。</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~#rpm -ql <span class="built_in">postfix</span>|grep main.<span class="built_in">cf</span></span><br><span class="line">#找出此文件来自于那个数据包</span><br><span class="line">root&amp;Centos7: ~#cd /</span><br><span class="line">root&amp;Centos7: /#rpm2cpio /mnt/cdrom/Packages/<span class="built_in">postfix</span>-<span class="number">2.10</span>.1-<span class="number">6.</span>el7.x86_64.rpm |cpio -itv|grep /etc/<span class="built_in">postfix</span>/main.<span class="built_in">cf</span></span><br><span class="line">-rw-r--r--   <span class="number">1</span> root     root        <span class="number">27176</span> Jun <span class="number">10</span>  <span class="number">2014</span> ./etc/<span class="built_in">postfix</span>/main.<span class="built_in">cf</span></span><br><span class="line"><span class="number">25016</span> blocks</span><br><span class="line">root&amp;Centos7: /#rpm2cpio /mnt/cdrom/Packages/<span class="built_in">postfix</span>-<span class="number">2.10</span>.1-<span class="number">6.</span>el7.x86_64.rpm |cpio -idv  ./etc/<span class="built_in">postfix</span>/main.<span class="built_in">cf</span></span><br><span class="line">./etc/<span class="built_in">postfix</span>/main.<span class="built_in">cf</span></span><br><span class="line">#这一步需要在根目录下进行，将光盘里软件包内的文件恢复出来。</span><br><span class="line">root&amp;Centos7: /#ls /etc/<span class="built_in">postfix</span>/main.<span class="built_in">cf</span></span><br><span class="line">/etc/<span class="built_in">postfix</span>/main.<span class="built_in">cf</span></span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;关于SSH端口转发&quot;&gt;&lt;a href=&quot;#关于SSH端口转发&quot; class=&quot;headerlink&quot; title=&quot;关于SSH端口转发&quot;&gt;&lt;/a&gt;关于SSH端口转发&lt;/h3&gt;&lt;h4 id=&quot;原理&quot;&gt;&lt;a href=&quot;#原理&quot; class=&quot;headerlink&quot; title=&quot;原理&quot;&gt;&lt;/a&gt;原理&lt;/h4&gt;&lt;p&gt;SSH 会自动加密和解密所有SSH 客户端与服务端之间的网络数据。但是，SSH 还能够将其他TCP 端口的网络数据通过SSH 链接来转发，并且自动提供了相应的加密及解密服务。这一过程也被叫做“隧道”（tunneling），这是因为SSH 为其他TCP 链接提供了一个安全的通道来进行传输而得名。例如，Telnet，SMTP，LDAP 这些TCP 应用均能够从中得益，避免了用户名，密码以及隐私信息的明文传输。而与此同时，如果工作环境中的防火墙限制了一些网络端口的使用，但是允许SSH 的连接，也能够通过将TCP 端口转发来使用SSH 进行通讯。&lt;/p&gt;
    
    </summary>
    
      <category term="Network" scheme="http://subtraction.tech/categories/Network/"/>
    
    
      <category term="SSH" scheme="http://subtraction.tech/tags/SSH/"/>
    
  </entry>
  
  <entry>
    <title>搭建私有CA</title>
    <link href="http://subtraction.tech/Security/%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89CA/"/>
    <id>http://subtraction.tech/Security/搭建私有CA/</id>
    <published>2017-09-23T06:43:38.000Z</published>
    <updated>2018-04-23T12:47:01.180Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><h4 id="什么是CA"><a href="#什么是CA" class="headerlink" title="什么是CA"></a>什么是CA</h4><p>CA是Certificate Authority的缩写，也叫“证书授权中心”。在web访问中为了保证web内容在网络中的安全传输，就需要用到SSL证书。而想要获得SSL证书就需要得到公认证书签发机构的签发，这些签发机构统称CA。CA主要负责签发证书、认证证书、管理已颁发证书的第三方机构，是PKI的核心。它要制定政策和具体步骤来验证、识别用户身份，并对用户证书进行签名，以确保证书持有者的身份和公钥的拥有权。一般来说，CA必须是所有行业和所有公众都信任的、认可的。因此它必须具有足够的权威性。</p><a id="more"></a><h4 id="什么是CA证书"><a href="#什么是CA证书" class="headerlink" title="什么是CA证书"></a>什么是CA证书</h4><p>CA证书，顾名思义，就是CA颁发的证书。CA证书也是数字证书的一种，是通过数字签名实现的数字化证书， 具有不能被伪造的特点。是实现web安全通信中必不可少的一环。<br>如果用户想得到一份属于自己的证书，他应先向 CA 提出申请。在 CA 判明申请者的身份后，便为他分配一个公钥，并且 CA 将该公钥与申请者的身份信息绑在一起，并为之签字后，便形成证书发给申请者。 </p><h4 id="获取CA证书两种方法"><a href="#获取CA证书两种方法" class="headerlink" title="获取CA证书两种方法"></a>获取CA证书两种方法</h4><ol><li><p>证书授权机构的颁发</p><ul><li>生成签名请求（csr）</li><li>将csr发送给CA</li><li>从CA处接收签名</li></ul></li><li><p>自签名的证书颁发</p><ul><li><p>自已签发自己的公钥</p><p>  ​    </p></li></ul></li></ol><p>现在在互联网上大行其道的https协议，就是通过CA证书的认证实现的。但证书虽好却价格昂贵，CA证书的使用者每年都需要向证书颁发机构缴纳一笔不菲的费用，如果搭建的网站只是供自己或局域网内使用，通过证书机构颁发证书就很不划算了。像这种情况，我们就可以通过搭建自己的私有CA来解决，实现局域网内web安全通信。接下来，我会详细介绍如何搭建私有CA，并实现证书的签发和管理。</p><hr><h3 id="openssl-cnf文件"><a href="#openssl-cnf文件" class="headerlink" title="openssl.cnf文件"></a>openssl.cnf文件</h3><p>想要搭建私有CA，/etc/pki/tls/目录下的openssl.cnf文件是你必须要了解的，文件内有关于CA的重要配置信息。</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: ~&gt;# cat /etc/pki/tls/openssl.cnf</span><br><span class="line">……此处省略部分显示内容……</span><br><span class="line">####################################################################</span><br><span class="line">[ ca ]</span><br><span class="line">default_ca= CA_default#指定默认使用的CA</span><br><span class="line">####################################################################</span><br><span class="line">[ CA_default ]</span><br><span class="line"></span><br><span class="line">dir= /etc/pki/CA#CA的工作目录，所有与CA相关的信息都在此目录下</span><br><span class="line">certs= $dir/certs#证书的存放路径，需人为指定才会将证书存放在此目录下。</span><br><span class="line">crl_dir= $dir/crl#证书吊销列表的存放路径</span><br><span class="line">database= $dir/index.txt#指定证书数据库文件所在的路径，index.txt文件用于存放证书数据，此文件默认没有，需手工创建。</span><br><span class="line">#unique_subject= no# Set to <span class="string">'no'</span> to allow creation <span class="keyword">of</span></span><br><span class="line"># several ctificates <span class="keyword">with</span> same subject.</span><br><span class="line">new_certs_dir= $dir/newcerts#新证书的存放目录，新生成的证书默认存放于此目录下。</span><br><span class="line"></span><br><span class="line">certificate= $dir/cacert.pem #CA自身证书的所在路径</span><br><span class="line">serial= $dir/serial #要颁发的下一个证书的编号，编号要求是<span class="number">16</span>进制数，该文件需手工创建并写入编号。</span><br><span class="line">crlnumber= $dir/crlnumber#下一个要被吊销的证书编号</span><br><span class="line"># must be commented out to leave a V1 CRL</span><br><span class="line">crl= $dir/crl.pem # The current CRL</span><br><span class="line">private_key= $dir/private/cakey.pem#CA私钥存放的路径</span><br><span class="line">RANDFILE= $dir/private/.rand# private random number file</span><br><span class="line"></span><br><span class="line">x509_extensions= usr_cert# The extentions to add to the cert</span><br><span class="line"></span><br><span class="line"># Comment out the following two lines for the <span class="string">"traditional"</span></span><br><span class="line"># (and highly broken) format.</span><br><span class="line">name_opt = ca_default# Subject Name options</span><br><span class="line">cert_opt = ca_default# Certificate field options</span><br><span class="line"></span><br><span class="line"># Extension copying option: use <span class="keyword">with</span> caution.</span><br><span class="line"># copy_extensions = copy</span><br><span class="line"></span><br><span class="line"># Extensions to add to a CRL. Note: Netscape communicator chokes on V2 CRLs</span><br><span class="line"># so this is commented out by default to leave a V1 CRL.</span><br><span class="line"># crlnumber must also be commented out to leave a V1 CRL.</span><br><span class="line"># crl_extensions= crl_ext</span><br><span class="line"></span><br><span class="line">default_days= <span class="number">365</span>#指定证书有效期，默认<span class="number">365</span>天。</span><br><span class="line">default_crl_days= <span class="number">30</span># how long before next CRL</span><br><span class="line">default_md= sha256# use SHA<span class="number">-256</span> by default</span><br><span class="line">preserve= no# keep passed DN ordering</span><br><span class="line"></span><br><span class="line"># A few difference way <span class="keyword">of</span> specifying how similar the request should look</span><br><span class="line"># For type CA, the listed attributes must be the same, and the optional</span><br><span class="line"># and supplied fields are just that :-)</span><br><span class="line">policy= policy_match#指定默认使用的CA策略</span><br><span class="line"></span><br><span class="line"># For the CA policy</span><br><span class="line">[ policy_match ]     #记录了CA搭建时和客户端向你申请证书时，提交信息的匹配策略。</span><br><span class="line">countryName= match#省或州的名字</span><br><span class="line">stateOrProvinceName= match#城市名</span><br><span class="line">organizationName= match#公司或组织名</span><br><span class="line">organizationalUnitName= optional#公司或组织下的单位名</span><br><span class="line">commonName= supplied#通用名，一般指定为网站的服务器域名，www.xxxx.com</span><br><span class="line">emailAddress= optional #邮件地址</span><br><span class="line">#match、optional、supplied分别代表三种不同的匹配策略，匹配、支持和可选。匹配指要求申请填写的信息跟CA设置信息必须一致，支持指必须填写这项申请信息，可选指可有可无。</span><br><span class="line"># For the <span class="string">'anything'</span> policy</span><br><span class="line"># At this point <span class="keyword">in</span> time, you must list all acceptable <span class="string">'object'</span></span><br><span class="line"># types.</span><br><span class="line">[ policy_anything ]#policy_anything策略，对提交的申请信息要求比 policy_match策略更加宽松。填写申请文件时国家，省，公司名称三项可以和CA不一致。</span><br><span class="line">countryName= optional</span><br><span class="line">stateOrProvinceName= optional</span><br><span class="line">localityName= optional</span><br><span class="line">organizationName= optional</span><br><span class="line">organizationalUnitName= optional</span><br><span class="line">commonName= supplied</span><br><span class="line">emailAddress= optional</span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">……此处省略部分显示内容……</span><br></pre></td></tr></table></figure><h3 id="搭建CA认证中心"><a href="#搭建CA认证中心" class="headerlink" title="搭建CA认证中心"></a>搭建CA认证中心</h3><h4 id="创建所需要的目录及文件"><a href="#创建所需要的目录及文件" class="headerlink" title="创建所需要的目录及文件"></a>创建所需要的目录及文件</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;localhost</span>: ~&gt;<span class="meta">#touch /etc/pki/CA/index.txt</span></span><br><span class="line"><span class="meta">#创建生成证书索引数据库文件</span></span><br><span class="line">root<span class="variable">&amp;localhost</span>: ~&gt;<span class="meta">#echo 01 &gt;/etc/pki/CA/serial</span></span><br><span class="line"><span class="meta">#创建serial文件并指定第一个颁发证书的序列号</span></span><br><span class="line">root<span class="variable">&amp;localhost</span>: ~&gt;<span class="meta">#tree /etc/pki/CA/</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>pki/CA/</span><br><span class="line">├── certs</span><br><span class="line">├── crl</span><br><span class="line">├── index.txt</span><br><span class="line">├── newcerts</span><br><span class="line">├── private</span><br><span class="line">└── serial</span><br><span class="line"><span class="meta">#验证上面的两个文件是否创建成功。</span></span><br><span class="line"><span class="number">4</span> directories, <span class="number">2</span> files</span><br><span class="line">root<span class="variable">&amp;localhost</span>: ~&gt;<span class="meta">#cat /etc/pki/CA/serial</span></span><br><span class="line"><span class="number">01</span></span><br><span class="line"><span class="meta">#验证序列号是否写入到serial文件中。</span></span><br></pre></td></tr></table></figure><h4 id="生成私钥"><a href="#生成私钥" class="headerlink" title="生成私钥"></a>生成私钥</h4><p>由于要搭建的这个CA是网络中的第一个CA，没有根CA为其授权，所以这个CA需要自签证书，自己证明自己的身份。要自签证书须先生成私钥，下面是生成私钥的方法。<br>在上面的openssl.cnf文件中已经写出了CA私钥的存放路径：private_key    = $dir/private/cakey.pem，<strong>CA私钥必须放于private目录下</strong>。</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: ~&gt;#cd <span class="regexp">/etc/</span>pki<span class="regexp">/CA/</span></span><br><span class="line">#进入<span class="regexp">/etc/</span>pki<span class="regexp">/CA/</span>目录</span><br></pre></td></tr></table></figure><p>生成私钥文件</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;#(umask <span class="number">066</span>;openssl genrsa -out private/cakey.pem -des3 <span class="number">2048</span>)</span><br><span class="line">#在private目录下生成以des3算法加密的私钥文件，私钥长度为<span class="number">2048</span>位，并设定私钥文件的权限为属主读写。</span><br><span class="line">Generating RSA private key, <span class="number">2048</span> bit long modulus</span><br><span class="line">.........................+++</span><br><span class="line">...............+++</span><br><span class="line">e is <span class="number">65537</span> (<span class="number">0x10001</span>)</span><br><span class="line">Enter pass phrase for private/cakey.pem:#输入私钥加密口令，输入不会回显。</span><br><span class="line">Verifying - Enter pass phrase for private/cakey.pem: #确认加密口令</span><br></pre></td></tr></table></figure><p>确认文件生成并且符合要求。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#ll</span> private/cakey.pem</span><br><span class="line">-rw-------. <span class="number">1</span> root root <span class="number">1743</span> Sep <span class="number">10</span> <span class="number">10</span>:<span class="number">45</span> private/cakey.pem</span><br><span class="line">#确认文件生成并且权限符合要求。</span><br><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#cat</span> private/cakey.pem</span><br><span class="line">#查看生成的加密过的私钥文件</span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">Proc-Type: <span class="number">4</span>,ENCRYPTED</span><br><span class="line">DEK-Info: DES-EDE3-CBC,AECFA1468969CFF6</span><br><span class="line"></span><br><span class="line">keWwxPfapo/VWX90/MQVrrYgkrBmd+falU+QbgP26NsaUvyBdEahDUNB1lla0HIN</span><br><span class="line">hixPXCyN4G0mgrgx0AkKHSDNWLqKIOjZIkyxcoFcrnHcKSbP2hA+E8K5+hLp7nnk</span><br><span class="line">……此处省略部分显示内容……</span><br></pre></td></tr></table></figure><h4 id="生成自签名证书"><a href="#生成自签名证书" class="headerlink" title="生成自签名证书"></a>生成自签名证书</h4><p><strong>使用openssl命令生成自签名证书：</strong></p><p><code>openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 7300</code></p><table><thead><tr><th>命令选项</th><th>含义</th></tr></thead><tbody><tr><td>-new</td><td>生成新证书签署请求</td></tr><tr><td>-x509</td><td>专用于CA生成自签证书</td></tr><tr><td>-key</td><td>生成请求时用到的私钥文件</td></tr><tr><td>-days n</td><td>证书的有效期限</td></tr><tr><td>-out /PATH/TO/SOMECERTFILE</td><td>生成证书的保存路径</td></tr></tbody></table><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="comment">#openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 7300</span></span><br><span class="line"><span class="comment">#使用openssl命令生成自签名证书，有效期设为20年。</span></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> private/cakey.pem:<span class="comment">#生成证书需要调用上一步生成的加密后的私钥文件，所有需要输入密码。此处输入密码不回显。</span></span><br><span class="line">You are <span class="keyword">about</span> <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information <span class="keyword">that</span> will be incorporated</span><br><span class="line"><span class="keyword">into</span> your certificate request.</span><br><span class="line">What you are <span class="keyword">about</span> <span class="keyword">to</span> enter <span class="keyword">is</span> what <span class="keyword">is</span> called a Distinguished Name <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields <span class="keyword">but</span> you can leave <span class="keyword">some</span> blank</span><br><span class="line">For <span class="keyword">some</span> fields there will be a default value,</span><br><span class="line">If you enter '.', <span class="keyword">the</span> field will be left blank.</span><br><span class="line"><span class="comment">-----</span></span><br><span class="line">Country Name (<span class="number">2</span> letter code) [XX]:CN<span class="comment">#国家名，只能输两位字母。</span></span><br><span class="line">State <span class="keyword">or</span> Province Name (full <span class="built_in">name</span>) []:shandong<span class="comment">#省份名</span></span><br><span class="line">Locality Name (eg, city) [Default City]:dezhou<span class="comment">#城市名</span></span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:siwei.com<span class="comment">#组织或公司名</span></span><br><span class="line">Organizational Unit Name (eg, section) []:opt<span class="comment">#组织下的部门名称</span></span><br><span class="line">Common Name (eg, your <span class="built_in">name</span> <span class="keyword">or</span> your server's hostname) []:ca.siwei.com  <span class="comment">#此CA的域名</span></span><br><span class="line">Email Address []:<span class="comment">#邮箱地址，可以选填，不填直接回车即可。</span></span><br></pre></td></tr></table></figure><p>查看有没有在当前目录下生成自签名证书文件cacert.pem</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#ls</span></span><br><span class="line">cacert<span class="selector-class">.pem</span>  certs  crl  index<span class="selector-class">.txt</span>  newcerts  private  serial</span><br></pre></td></tr></table></figure><h3 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h3><p>选择一台客户端主机向搭建好的CA服务器申请证书</p><h4 id="在客户端主机生成私钥"><a href="#在客户端主机生成私钥" class="headerlink" title="在客户端主机生成私钥"></a>在客户端主机生成私钥</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#cd <span class="regexp">/etc/</span>pki<span class="regexp">/tls/</span></span><br><span class="line">#进入客户端主机的<span class="regexp">/etc/</span>pki<span class="regexp">/tls/</span>目录内</span><br></pre></td></tr></table></figure><p>使用openssl命令在请求客户端生成私钥文件，可以根据需要选择是否加密，如要加密可在秘钥长度前加<code>-des3</code>选项。</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: tls#(umask <span class="number">066</span>;openssl genrsa -out private/app.key <span class="number">2048</span>)</span><br><span class="line">Generating RSA private key, <span class="number">2048</span> bit long modulus</span><br><span class="line">..........................................+++</span><br><span class="line">..................................................................................................................+++</span><br><span class="line">e is <span class="number">65537</span> (<span class="number">0x10001</span>)</span><br></pre></td></tr></table></figure><p>查看app.key文件是否生成且权限符合设置。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: tls<span class="comment">#ll private/</span></span><br><span class="line">total 4</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 1675 </span>Sep<span class="number"> 10 </span>11:35 app.key</span><br></pre></td></tr></table></figure><h4 id="生成证书申请文件"><a href="#生成证书申请文件" class="headerlink" title="生成证书申请文件"></a>生成证书申请文件</h4><p><strong>注意：填写申请文件时默认国家，省，公司名称三项必须和CA一致</strong></p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: tls<span class="meta">#openssl req -new -key private/app.key -out app.csr</span></span><br><span class="line"><span class="meta">#生成证书申请文件app.csr</span></span><br><span class="line">You are about <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information that will be incorporated</span><br><span class="line"><span class="keyword">into</span> your certificate request.</span><br><span class="line">What you are about <span class="keyword">to</span> enter <span class="keyword">is</span> what <span class="keyword">is</span> called a Distinguished Name <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a <span class="keyword">default</span> value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="comment">'.', the field will be left blank.</span></span><br><span class="line">-----</span><br><span class="line">Country Name (<span class="number">2</span> letter code) [XX]:CN   <span class="meta">#国家名，需要与CA一致</span></span><br><span class="line">State <span class="keyword">or</span> Province Name (full name) []:shandong<span class="meta">#省名，需要与CA一致</span></span><br><span class="line">Locality Name (eg, city) [<span class="keyword">Default</span> City]:qingdao</span><br><span class="line">Organization Name (eg, company) [<span class="keyword">Default</span> Company Ltd]:siwei.com<span class="meta">#公司名，需要与CA一致</span></span><br><span class="line">Organizational Unit Name (eg, section) []:dev</span><br><span class="line">Common Name (eg, your name <span class="keyword">or</span> your server<span class="comment">'s hostname) []:app.siwei.com</span></span><br><span class="line">Email Address []:admin@siwei.com</span><br><span class="line"></span><br><span class="line">Please enter the following <span class="comment">'extra' attributes</span></span><br><span class="line"><span class="keyword">to</span> be sent <span class="keyword">with</span> your certificate request</span><br><span class="line"><span class="meta">#为发送的证书创建一个密码，可以填写，也可以不填写</span></span><br><span class="line">A challenge password []:<span class="meta">#此处未填写密码，直接回车跳过。</span></span><br><span class="line">An <span class="keyword">optional</span> company name []:</span><br></pre></td></tr></table></figure><p>查看生成的证书请求文件</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: tls#ls</span><br><span class="line">app<span class="selector-class">.csr</span>  cert<span class="selector-class">.pem</span>  certs  misc  openssl<span class="selector-class">.cnf</span>  private</span><br></pre></td></tr></table></figure><h4 id="将证书请求文件传输给CA"><a href="#将证书请求文件传输给CA" class="headerlink" title="将证书请求文件传输给CA"></a>将证书请求文件传输给CA</h4><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: tls<span class="meta">#scp app.csr 172.18.22.22:/etc/pki/CA</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'172.18.22.22 (172.18.22.22)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> a8:a0:<span class="number">56</span>:<span class="number">46</span>:bb:f2:<span class="number">8</span>b:<span class="number">1</span>b:<span class="number">07</span>:<span class="number">29</span>:e3:<span class="number">7</span>e:<span class="number">9</span>b:ee:<span class="number">32</span>:<span class="number">66.</span></span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'172.18.22.22' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">172.18</span><span class="number">.22</span><span class="number">.22</span><span class="comment">'s password: #目标主机的登录密码</span></span><br><span class="line">app.csr                         <span class="number">100</span>% <span class="number">1054</span>     <span class="number">1.0</span>KB/s   <span class="number">00</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure><h3 id="颁发证书"><a href="#颁发证书" class="headerlink" title="颁发证书"></a>颁发证书</h3><h4 id="CA签署证书"><a href="#CA签署证书" class="headerlink" title="CA签署证书"></a>CA签署证书</h4><p>查看/etc/pki/CA/目录下的证书认证请求文件app.csr是否存在</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;#ls</span><br><span class="line">app<span class="selector-class">.csr</span>     certs  index<span class="selector-class">.txt</span>  private</span><br><span class="line">cacert<span class="selector-class">.pem</span>  crl    newcerts   serial</span><br></pre></td></tr></table></figure><p>使用CA的私钥对来申请的证书进行签署，签署的有效期指定为365天。</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="meta">#openssl ca -in app.csr -out certs/app.crt -days 365</span></span><br><span class="line"><span class="meta">#使用CA的私钥对申请证书进行签署，签署的有效期指定为365天。</span></span><br><span class="line"><span class="keyword">Using</span> configuration <span class="keyword">from</span> /etc/pki/tls/openssl.cnf</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /etc/pki/CA/<span class="keyword">private</span>/cakey.pem:<span class="meta">#在此输入CA的私钥密码</span></span><br><span class="line">Check that the request matches the signature</span><br><span class="line"><span class="meta">#检查申请信息是否匹配，下面列出的是请求证书的申请信息。</span></span><br><span class="line"><span class="meta">#注意：默认国家，省，公司名称三项必须和CA一致</span></span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: <span class="number">1</span> (<span class="number">0x1</span>)</span><br><span class="line">        Validity</span><br><span class="line">            <span class="keyword">Not</span> Before: Sep <span class="number">10</span> <span class="number">03</span>:<span class="number">52</span>:<span class="number">02</span> <span class="number">2017</span> GMT</span><br><span class="line">            <span class="keyword">Not</span> After : Sep <span class="number">10</span> <span class="number">03</span>:<span class="number">52</span>:<span class="number">02</span> <span class="number">2018</span> GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = shandong</span><br><span class="line">            organizationName          = siwei.com</span><br><span class="line">            organizationalUnitName    = dev</span><br><span class="line">            commonName                = app.siwei.com</span><br><span class="line">            emailAddress              = admin@siwei.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints:</span><br><span class="line">                CA:<span class="literal">FALSE</span></span><br><span class="line">            Netscape Comment:</span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject <span class="keyword">Key</span> Identifier:</span><br><span class="line">                <span class="number">71</span>:BF:<span class="number">68</span>:FA:<span class="number">9</span>A:<span class="number">60</span>:E5:<span class="number">53</span>:<span class="number">5</span>A:<span class="number">90</span>:<span class="number">94</span>:<span class="number">03</span>:<span class="number">3</span>A:<span class="number">0</span>C:E9:<span class="number">17</span>:E2:<span class="number">8</span>A:C4:<span class="number">99</span></span><br><span class="line">            X509v3 Authority <span class="keyword">Key</span> Identifier:</span><br><span class="line">                keyid:<span class="number">8</span>C:<span class="number">45</span>:<span class="number">0</span>F:<span class="number">92</span>:<span class="number">30</span>:<span class="number">3</span>C:<span class="number">7</span>D:<span class="number">8</span>E:A6:<span class="number">42</span>:F8:B4:E0:<span class="number">30</span>:AD:<span class="number">17</span>:<span class="number">3</span>C:DF:<span class="number">01</span>:C1</span><br><span class="line"></span><br><span class="line">Certificate <span class="keyword">is</span> <span class="keyword">to</span> be certified <span class="keyword">until</span> Sep <span class="number">10</span> <span class="number">03</span>:<span class="number">52</span>:<span class="number">02</span> <span class="number">2018</span> GMT (<span class="number">365</span> days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"><span class="meta">#问你是否要签署此证书，选择y就签署了。</span></span><br><span class="line"><span class="number">1</span> out <span class="keyword">of</span> <span class="number">1</span> certificate requests certified, commit? [y/n]y<span class="meta">#选择y确认颁发</span></span><br><span class="line">Write out database <span class="keyword">with</span> <span class="number">1</span> <span class="keyword">new</span> entries<span class="meta">#将有一个条目写入数据库，也就是index.txt文件</span></span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure><p>查看新生成的证书数据</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#cat</span> index.txt</span><br><span class="line">V<span class="number">180910035202</span>Z<span class="number">01</span>unknown/C=CN/ST=shandong/O=siwei.com/OU=dev/CN=app<span class="selector-class">.siwei</span><span class="selector-class">.com</span>/emailAddress=admin@siwei.com</span><br></pre></td></tr></table></figure><h4 id="将证书颁发给请求者"><a href="#将证书颁发给请求者" class="headerlink" title="将证书颁发给请求者"></a>将证书颁发给请求者</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scp certs/app.crt <span class="number">172.18</span>.<span class="number">22.100</span><span class="symbol">:/etc/pki/tls/certs</span></span><br><span class="line">The authenticity of host <span class="string">'172.18.22.100 (172.18.22.100)'</span> can<span class="string">'t beestablished.</span></span><br><span class="line"><span class="string">RSA key fingerprint is 65:57:31:4a:f2:14:24:04:58:6c:29:d8:4b:cc:8f:c2.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added '</span><span class="number">172.18</span>.<span class="number">22.100</span><span class="string">' (RSA) to the list of known hosts.</span></span><br><span class="line"><span class="string">root@172.18.22.100'</span>s <span class="symbol">password:</span></span><br><span class="line">app.crt                         <span class="number">100</span>% <span class="number">4541</span>     <span class="number">4.4</span>KB/s   <span class="number">00</span><span class="symbol">:</span><span class="number">00</span></span><br></pre></td></tr></table></figure><h4 id="查看已颁发证书的信息"><a href="#查看已颁发证书的信息" class="headerlink" title="查看已颁发证书的信息"></a>查看已颁发证书的信息</h4><p>在证书通过审核颁发后，系统会自动将颁发的证书保存一份到/etc/pki/CA/certs/和/etc/pki/CA/newcerts/目录下。CA服务器可以通过查看这两个目录下的文件，来查看已颁发证书的信息。<br><strong>常用命令如下：</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat certs/app.crt</span><br><span class="line">cat newcerts/<span class="number">01</span>.pem</span><br><span class="line">#直接查看证书文件</span><br><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#openssl</span> x509 -<span class="keyword">in</span> certs/app<span class="selector-class">.crt</span> -noout -text</span><br><span class="line">#查看证书所有内容</span><br><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#openssl</span> x509 -<span class="keyword">in</span> certs/app<span class="selector-class">.crt</span> -noout -issuer</span><br><span class="line">#查看使用者</span><br><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#openssl</span> x509 -<span class="keyword">in</span> certs/app<span class="selector-class">.crt</span> -noout -subject</span><br><span class="line">#查看颁发者</span><br><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#openssl</span> x509 -<span class="keyword">in</span> certs/app<span class="selector-class">.crt</span> -noout -dates</span><br><span class="line">#查看证书有效期</span><br><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#openssl</span> x509 -<span class="keyword">in</span> certs/app<span class="selector-class">.crt</span> -noout -serial</span><br><span class="line">#查看指定证书的编号</span><br><span class="line">opensslca -status SERIAL</span><br><span class="line">#查看指定编号的证书状态</span><br></pre></td></tr></table></figure><h3 id="吊销证书"><a href="#吊销证书" class="headerlink" title="吊销证书"></a>吊销证书</h3><h4 id="在客户端获取要吊销的证书的serial"><a href="#在客户端获取要吊销的证书的serial" class="headerlink" title="在客户端获取要吊销的证书的serial"></a>在客户端获取要吊销的证书的serial</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#openssl</span> x509 -<span class="keyword">in</span> certs/app<span class="selector-class">.crt</span> -noout -serial-subject</span><br><span class="line">serial=<span class="number">01</span></span><br><span class="line">subject= /C=CN/ST=shandong/O=siwei.com/OU=dev/CN=app<span class="selector-class">.siwei</span><span class="selector-class">.com</span>/emailAddress=admin@siwei.com</span><br></pre></td></tr></table></figure><h4 id="使用openssl吊销证书"><a href="#使用openssl吊销证书" class="headerlink" title="使用openssl吊销证书"></a>使用openssl吊销证书</h4><p>在CA上，根据客户提交的serial与subject信息，对比检验是否与index.txt文件中的信息一致，然后吊销证书。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#openssl</span> ca -revoke /etc/pki/CA/newcerts/<span class="number">01</span>.pem</span><br><span class="line">#吊销/etc/pki/CA/newcerts/目录下的<span class="number">01</span>.pem证书</span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /etc/pki/CA/private/cakey<span class="selector-class">.pem</span>:#输入私钥密码</span><br><span class="line">Revoking Certificate <span class="number">01</span>.</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure><p>查看index.txt文件，第一行的大写字母V变成了R说明吊销成功</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#cat</span> index.txt</span><br><span class="line">R<span class="number">180910035202</span>Z<span class="number">170910071803</span>Z<span class="number">01</span>unknown/C=CN/ST=shandong/O=siwei.com/OU=dev/CN=app<span class="selector-class">.siwei</span><span class="selector-class">.com</span>/emailAddress=admin@siwei.com</span><br></pre></td></tr></table></figure><h4 id="指定第一个吊销证书的编号"><a href="#指定第一个吊销证书的编号" class="headerlink" title="指定第一个吊销证书的编号"></a>指定第一个吊销证书的编号</h4><p><strong>注意：只第一次更新证书吊销列表前，才需要执行</strong></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">&amp;localhost</span>: CA&gt;<span class="meta">#echo 01 &gt; /etc/pki/CA/crlnumber</span></span><br><span class="line"><span class="meta">#指定第一个吊销证书的编号，编号为16进制数</span></span><br><span class="line">root<span class="variable">&amp;localhost</span>: CA&gt;<span class="meta">#cat /etc/pki/CA/crlnumber</span></span><br><span class="line"><span class="meta">#确定编号生成</span></span><br></pre></td></tr></table></figure><h4 id="更新证书吊销列表"><a href="#更新证书吊销列表" class="headerlink" title="更新证书吊销列表"></a>更新证书吊销列表</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;localhost: CA&gt;<span class="selector-id">#openssl</span> ca -gencrl -out /etc/pki/CA/crl/crl.pem</span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /etc/pki/CA/private/cakey<span class="selector-class">.pem</span>: #输入私钥密码</span><br></pre></td></tr></table></figure><h4 id="查看被吊销的证书文件"><a href="#查看被吊销的证书文件" class="headerlink" title="查看被吊销的证书文件"></a>查看被吊销的证书文件</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl crl -<span class="keyword">in</span> <span class="regexp">/etc/</span>pki<span class="regexp">/CA/</span>crl<span class="regexp">/crl.pem -noout -text</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;h4 id=&quot;什么是CA&quot;&gt;&lt;a href=&quot;#什么是CA&quot; class=&quot;headerlink&quot; title=&quot;什么是CA&quot;&gt;&lt;/a&gt;什么是CA&lt;/h4&gt;&lt;p&gt;CA是Certificate Authority的缩写，也叫“证书授权中心”。在web访问中为了保证web内容在网络中的安全传输，就需要用到SSL证书。而想要获得SSL证书就需要得到公认证书签发机构的签发，这些签发机构统称CA。CA主要负责签发证书、认证证书、管理已颁发证书的第三方机构，是PKI的核心。它要制定政策和具体步骤来验证、识别用户身份，并对用户证书进行签名，以确保证书持有者的身份和公钥的拥有权。一般来说，CA必须是所有行业和所有公众都信任的、认可的。因此它必须具有足够的权威性。&lt;/p&gt;
    
    </summary>
    
      <category term="Security" scheme="http://subtraction.tech/categories/Security/"/>
    
    
      <category term="CA" scheme="http://subtraction.tech/tags/CA/"/>
    
  </entry>
  
  <entry>
    <title>制作一个简单的小Linux系统</title>
    <link href="http://subtraction.tech/Linux/%E5%88%B6%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E5%B0%8FLinux%E7%B3%BB%E7%BB%9F/"/>
    <id>http://subtraction.tech/Linux/制作一个简单的小Linux系统/</id>
    <published>2017-08-23T06:17:01.000Z</published>
    <updated>2018-04-23T12:45:21.994Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本篇博文主要通过裁剪现有Linux系统，打造出一个属于你自己的小Linux系统，并让其能够装载网卡驱动，配置IP地址后可以实现网络功能。但在开始制作之前需要先向你说明本次制作前的一些准备工作，以及制作的思路。</p><a id="more"></a><hr><h3 id="制作前的准备"><a href="#制作前的准备" class="headerlink" title="制作前的准备"></a>制作前的准备</h3><p>凡事预则立，不预则废，无论工作学习皆是如此。所以在开启本次自制小Linux的实验之前，你需要先做好两大项准备，分别是看的见的物理设备和看不见的制作思路。</p><h4 id="物理设备"><a href="#物理设备" class="headerlink" title="物理设备"></a>物理设备</h4><p>首先，你要准备一台linux主机和一块磁盘，这块磁盘用于安装和启动我们自制的小Linux，可以是块硬盘，也可以是U盘。对于磁盘空间没过多要求，大于2G就可以。<br>将准备好的磁盘连接到Linux主机，使用lsblk命令查看连接到主机的设备，确定你的磁盘被加载到了系统中。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="comment">#lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sr0     11:0   <span class="number"> 1 </span> 3.7G <span class="number"> 0 </span>rom  /media/CentOS_6.9_Final</span><br><span class="line">sdb      8:16  <span class="number"> 0 </span>  16G <span class="number"> 0 </span>disk</span><br><span class="line"><span class="comment">#这块sdb磁盘就是我为本次实验准备的磁盘。</span></span><br><span class="line">sda      8:0   <span class="number"> 0 </span> 200G <span class="number"> 0 </span>disk</span><br><span class="line">├─sda1   8:1   <span class="number"> 0 </span>1000M <span class="number"> 0 </span>part /boot</span><br><span class="line">├─sda2   8:2   <span class="number"> 0 </span>48.8G <span class="number"> 0 </span>part /</span><br><span class="line">├─sda3   8:3   <span class="number"> 0 </span>47.9G <span class="number"> 0 </span>part /app</span><br><span class="line">├─sda4   8:4   <span class="number"> 0 </span>   1K <span class="number"> 0 </span>part</span><br><span class="line">└─sda5   8:5   <span class="number"> 0 </span>   2G <span class="number"> 0 </span>part [SWAP]</span><br></pre></td></tr></table></figure><h4 id="制作思路"><a href="#制作思路" class="headerlink" title="制作思路"></a>制作思路</h4><p>有一个清晰且准确的实验流程思路，对于成功完成实验至关重要。下面是我以清单的方式向你说明的大致制作流程，请在实验过程中务必按照此流程操作，以确保实验成功。</p><ol><li>创建分区和文件系统</li><li>挂载boot分区</li><li>安装grub</li><li>复制内核和initramfs文件</li><li>建立grub.conf配置文件</li><li>挂载根分区</li><li>复制bash和相关命令及相关库文件</li><li>创建根分区下的一级目录</li><li>测试定制的小Linux是否制作成功</li></ol><hr><h3 id="创建分区和文件系统"><a href="#创建分区和文件系统" class="headerlink" title="创建分区和文件系统"></a>创建分区和文件系统</h3><p>使用fdisk命令创建分区，需要至少划分两个分区，用于后面boot和根的挂载。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#fdisk /dev/sdb</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">Command (m <span class="keyword">for</span> help): n#n:新建分区</span><br><span class="line">Command action</span><br><span class="line">   e   extended</span><br><span class="line">   p   primary partition (1-4)</span><br><span class="line">p#p:创建主分区</span><br><span class="line">Partition number (1-4): 1  #1：创建第一个主分区</span><br><span class="line">First cylinder (1-2088,<span class="built_in"> default </span>1): #此处回车默认就可</span><br><span class="line">Using<span class="built_in"> default </span>value 1</span><br><span class="line">Last cylinder, +cylinders <span class="keyword">or</span> +size&#123;K,M,G&#125; (1-2088,<span class="built_in"> default </span>2088): +100M</span><br><span class="line"><span class="comment">#此处输入+100M,代表第一分区的大小是100M，此分区之后会后用来挂载/boot分区。</span></span><br><span class="line">Command (m <span class="keyword">for</span> help): n</span><br><span class="line">Command action</span><br><span class="line">   e   extended</span><br><span class="line">   p   primary partition (1-4)</span><br><span class="line">p</span><br><span class="line">Partition number (1-4): 2</span><br><span class="line">First cylinder (15-2088,<span class="built_in"> default </span>15): #此处回车键</span><br><span class="line">Using<span class="built_in"> default </span>value 15</span><br><span class="line">Last cylinder, +cylinders <span class="keyword">or</span> +size&#123;K,M,G&#125; (15-2088,<span class="built_in"> default </span>2088):#此处回车键</span><br><span class="line">Using<span class="built_in"> default </span>value 2088</span><br><span class="line"><span class="comment">#这是创建的第二个分区，这里没有指定大小，而是直接回车使用默认值，将所有剩余空间全部分给第二分区，之后会用来挂载根分区。</span></span><br><span class="line">Command (m <span class="keyword">for</span> help): w  </span><br><span class="line"><span class="comment">#w：保存退出</span></span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() <span class="keyword">to</span> re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure><p>使用lsblk命令查看创建好的分区，我们可以看到分区sdb1和sdb2,以及这两个分区的大小。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="comment">#lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sr0     11:0   <span class="number"> 1 </span>  3.7G <span class="number"> 0 </span>rom  /media/CentOS_6.9_Final</span><br><span class="line">sdb      8:16  <span class="number"> 0 </span>   16G <span class="number"> 0 </span>disk</span><br><span class="line">├─sdb1   8:17  <span class="number"> 0 </span>109.8M <span class="number"> 0 </span>part</span><br><span class="line">└─sdb2   8:18  <span class="number"> 0 </span> 15.9G <span class="number"> 0 </span>part</span><br><span class="line">sda      8:0   <span class="number"> 0 </span>  200G <span class="number"> 0 </span>disk</span><br><span class="line">├─sda1   8:1   <span class="number"> 0 </span> 1000M <span class="number"> 0 </span>part /boot</span><br><span class="line">├─sda2   8:2   <span class="number"> 0 </span> 48.8G <span class="number"> 0 </span>part /</span><br><span class="line">├─sda3   8:3   <span class="number"> 0 </span> 47.9G <span class="number"> 0 </span>part /app</span><br><span class="line">├─sda4   8:4   <span class="number"> 0 </span>    1K <span class="number"> 0 </span>part</span><br><span class="line">└─sda5   8:5   <span class="number"> 0 </span>    2G <span class="number"> 0 </span>part [SWAP]</span><br></pre></td></tr></table></figure><p>使用mkfs.ext4命令为/dev/sdb1和/dev/sdb2分区创建文件系统</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="selector-id">#mkfs</span><span class="selector-class">.ext4</span> /dev/sdb1</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#mkfs</span><span class="selector-class">.ext4</span> /dev/sdb2</span><br></pre></td></tr></table></figure><p>使用blkid命令检查文件系统是否成功创建。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#blkid</span><br><span class="line">*/dev/sdb1: <span class="attribute">UUID</span>=<span class="string">"daf86143-9f02-479b-8023-e83491b075c8"</span> <span class="attribute">TYPE</span>=<span class="string">"ext4"</span></span><br><span class="line">*/dev/sdb2: <span class="attribute">UUID</span>=<span class="string">"ac76751f-4796-4a70-9bfa-7a1d7eaf6b78"</span> <span class="attribute">TYPE</span>=<span class="string">"ext4"</span></span><br><span class="line"><span class="comment">#可以查到/dev/sdb2和/dev/sdb1，并且有TYPE="ext4"字样，说明分区创建成功。</span></span><br><span class="line">/dev/sda1: <span class="attribute">UUID</span>=<span class="string">"fe3eec64-c3e4-49e8-ad00-5932afbfbc4e"</span> <span class="attribute">TYPE</span>=<span class="string">"ext4"</span></span><br><span class="line">/dev/sda2: <span class="attribute">UUID</span>=<span class="string">"8c0a2fd8-99c2-4ee1-b7c9-05f51fcf4f7a"</span> <span class="attribute">TYPE</span>=<span class="string">"ext4"</span></span><br><span class="line">/dev/sda3: <span class="attribute">UUID</span>=<span class="string">"99735fe4-96f0-4c2b-8ca8-7235d3857359"</span> <span class="attribute">TYPE</span>=<span class="string">"ext4"</span></span><br><span class="line">/dev/sda5: <span class="attribute">UUID</span>=<span class="string">"a70aa239-9377-4aeb-9d3c-1aa73216d60e"</span> <span class="attribute">TYPE</span>=<span class="string">"swap"</span></span><br></pre></td></tr></table></figure><hr><h3 id="挂载boot分区"><a href="#挂载boot分区" class="headerlink" title="挂载boot分区"></a>挂载boot分区</h3><p><strong>注意：挂载点的子目录必须为boot</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#<span class="keyword">mkdir</span> /mnt/<span class="keyword">boot</span></span><br><span class="line">#创建挂载点</span><br><span class="line">root&amp;Centos6: ~#mount /dev/sdb1 /mnt/<span class="keyword">boot</span>/</span><br><span class="line">#将/dev/sdb1挂载到/mnt/<span class="keyword">boot</span>/目录下</span><br><span class="line">root&amp;Centos6: ~#<span class="keyword">ls</span> /mnt/<span class="keyword">boot</span>/</span><br><span class="line">lost+found</span><br></pre></td></tr></table></figure><hr><h3 id="安装grub"><a href="#安装grub" class="headerlink" title="安装grub"></a>安装grub</h3><p>安装grub是关乎启动的重要一步，利用grub-install命令可以生成引导启动流程的第1-2阶段。grub安装的时候会默认以boot为根，会自动安装到boot目录下。但当前系统有两个boot目录，/boot和/mnt/boot。所以需要以- -root-directory=/mnt/选项来指定要以/mnt/目录为根安装grub，这样在grub-install命令安装grub时，会自动找到/mnt/下的boot目录进行安装。这也是为什么上一步挂载boot目录时，必须挂载点的子目录为boot的原因。</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#grub-install <span class="comment">--root-directory=/mnt/ /dev/sdb</span></span><br><span class="line">#将grub安装到/dev/sdb设备上，以/mnt/为根目录。</span><br><span class="line">Probing devices <span class="keyword">to</span> guess BIOS drives. This may take a long <span class="built_in">time</span>.</span><br><span class="line">Installation finished. No <span class="literal">error</span> reported.</span><br><span class="line">This <span class="keyword">is</span> the contents <span class="keyword">of</span> the device <span class="keyword">map</span> /mnt//boot/grub/device.<span class="keyword">map</span>.</span><br><span class="line">Check <span class="keyword">if</span> this <span class="keyword">is</span> correct <span class="keyword">or</span> <span class="keyword">not</span>. <span class="keyword">If</span> any <span class="keyword">of</span> the lines <span class="keyword">is</span> incorrect,</span><br><span class="line">fix it <span class="keyword">and</span> re-run the script `grub-install'.</span><br><span class="line"></span><br><span class="line">(fd0)/dev/fd0</span><br><span class="line">(hd0)/dev/sda</span><br><span class="line">(hd1)/dev/sdb</span><br></pre></td></tr></table></figure><p>确定grub安装成功</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="comment">#ls /mnt/boot/</span></span><br><span class="line"><span class="comment">#查看生成的grub目录</span></span><br><span class="line">grub  lost+found</span><br><span class="line">root&amp;Centos6: ~<span class="comment">#ls /mnt/boot/grub/</span></span><br><span class="line"><span class="comment">#查看安装完grub后在grub目录下生成的文件</span></span><br><span class="line">device.map     fat_stage1_5  iso9660_stage1_5  minix_stage1_5     stage1  ufs2_stage1_5    xfs_stage1_5</span><br><span class="line">e2fs_stage1_5  ffs_stage1_5  jfs_stage1_5      reiserfs_stage1_5  stage2  vstafs_stage1_5</span><br><span class="line">root&amp;Centos6: ~<span class="comment">#hexdump -C -n 512 /dev/sdb</span></span><br><span class="line"><span class="comment">#确定grub的第一阶段写入到了磁盘的前446字节。如果没有成功安装第一阶段，你看到前446字节都会是0，并且没有GRUB字样。</span></span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">00000170 <span class="number"> 00 </span>be<span class="number"> 93 </span>7d e8 2a<span class="number"> 00 </span>eb  fe<span class="number"> 47 </span>52<span class="number"> 55 </span>42<span class="number"> 20 </span>00<span class="number"> 47 </span> |...&#125;.*...GRUB .G|</span><br><span class="line">00000180 <span class="number"> 65 </span>6f 6d<span class="number"> 00 </span>48<span class="number"> 61 </span>72<span class="number"> 64 </span><span class="number"> 20 </span>44<span class="number"> 69 </span>73 6b<span class="number"> 00 </span>52<span class="number"> 65 </span> |eom.Hard Disk.Re|</span><br><span class="line">00000190 <span class="number"> 61 </span>64<span class="number"> 00 </span>20<span class="number"> 45 </span>72<span class="number"> 72 </span>6f <span class="number"> 72 </span>00 bb<span class="number"> 01 </span>00 b4 0e cd  |ad. Error.......|</span><br><span class="line">000001a0 <span class="number"> 10 </span>ac 3c<span class="number"> 00 </span>75 f4 c3<span class="number"> 00 </span><span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00  |..&lt;.u...........|</span><br><span class="line">000001b0 <span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00  9a<span class="number"> 38 </span>28 d2<span class="number"> 00 </span>00<span class="number"> 00 </span>01  |.........8(.....|</span><br><span class="line">000001c0 <span class="number"> 01 </span>00<span class="number"> 83 </span>fe 3f 0d 3f<span class="number"> 00 </span><span class="number"> 00 </span>00 4f 6e<span class="number"> 03 </span>00<span class="number"> 00 </span>00  |....?.?...On....|</span><br><span class="line">000001d0 <span class="number"> 01 </span>0e<span class="number"> 83 </span>fe ff ff 8e 6e <span class="number"> 03 </span>00 9a<span class="number"> 67 </span>fc<span class="number"> 01 </span>00<span class="number"> 00 </span> |.......n...g....|</span><br><span class="line">000001e0 <span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00 <span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00  |................|</span><br><span class="line">000001f0 <span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00 <span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 55 </span>aa  |..............U.|</span><br><span class="line">00000200</span><br></pre></td></tr></table></figure><h3 id="复制内核和initramfs文件"><a href="#复制内核和initramfs文件" class="headerlink" title="复制内核和initramfs文件"></a>复制内核和initramfs文件</h3><p>在系统的/boot目录下有关乎启动的三大文件，系统若想启动，这三个文件缺一不可。这三个文件分别是我们这一步要复制到/mnt/boot目录下的vmlinuz-2.6.32-696.el6.x86_64 和 initramfs-2.6.32-696.el6.x86_64.img文件。以及下一步要创建的grub.conf文件。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="selector-id">#cp</span> /boot/vmlinuz-<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">696</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span>   /mnt/boot/</span><br><span class="line">#这个文件就是大名鼎鼎的Linux内核文件，要将它复制到/mnt/boot/下。</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#cp</span> /boot/initramfs-<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">696</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span><span class="selector-class">.img</span> /mnt/boot/</span><br><span class="line">#此文件是在系统启动后用于挂载根的，也很重要，要将它复制到/mnt/boot/下。</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#ls</span> /mnt/boot/</span><br><span class="line">grub  initramfs-<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">696</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span><span class="selector-class">.img</span>  lost+found  vmlinuz-<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">696</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure><hr><h3 id="建立grub-conf配置文件"><a href="#建立grub-conf配置文件" class="headerlink" title="建立grub.conf配置文件"></a>建立grub.conf配置文件</h3><p>grub.conf配置文件要创建在/mnt/boot/grub/目录下，并要在文件里写入基本的启动配置，以确保系统可以有序启动。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~# vim /mnt/boot/grub/grub.conf</span><br><span class="line">   <span class="attribute">default</span>=0    #指定默认启动菜单</span><br><span class="line">   <span class="attribute">timeout</span>=5    #启动菜单出现后5秒进入系统</span><br><span class="line">   title custom linux   #启动项名称</span><br><span class="line">   root (hd0,0)   #以第一块硬盘的第一个分取，作为启动的根分区</span><br><span class="line">   kernel /vmlinuz-2.6.32-696.el6.x86_64 <span class="attribute">root</span>=/dev/sda2 <span class="attribute">selinux</span>=0 <span class="attribute">init</span>=/bin/bash</span><br><span class="line">   #kernel /vmlinuz-2.6.32-696.el6.x86_64 ：把boot作为根，加载根下的内核文件</span><br><span class="line">   #<span class="attribute">root</span>=/dev/sda2 ：真正根所在的分区</span><br><span class="line">   #<span class="attribute">selinux</span>=0 ：关闭SELinux</span><br><span class="line">   #<span class="attribute">init</span>=/bin/bash ：以/bin/bash作为启动后运行的第一个程序</span><br><span class="line">   initrd /initramfs-2.6.32-696.el6.x86_64.img</span><br><span class="line">   加载伪文件系统ramdisk</span><br></pre></td></tr></table></figure><h3 id="挂载根分区"><a href="#挂载根分区" class="headerlink" title="挂载根分区"></a>挂载根分区</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="selector-id">#mkdir</span> /mnt/root</span><br><span class="line">#创建挂载点</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#mount</span> /dev/sdb2 /mnt/root</span><br><span class="line">#挂载/dev/sdb2 到/mnt/root目录下</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#ls</span> /mnt/root/</span><br><span class="line">lost+found</span><br></pre></td></tr></table></figure><h3 id="复制bash和相关命令及相关库文件"><a href="#复制bash和相关命令及相关库文件" class="headerlink" title="复制bash和相关命令及相关库文件"></a>复制bash和相关命令及相关库文件</h3><p>经过了前面的操作后自制小Linux的框架就已经基本搭建好了，接下来要做的就是丰富它的功能了。Linux的哲学思想是一切皆文件，所以只要把现有系统相应功能的二进制文件和库文件复制到/mnt/root目录下，自制的Linux就可以使用了。<br>要实现这个功能比较复杂繁琐，这就要用到我们Linux的shell脚本了，这个脚本已经写好，作用是拷贝命令，你可以直接复制编辑后使用。<br>下面是脚本的内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="comment">#cat copycmd.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="function"><span class="title">copy_cmd</span></span>()&#123;</span><br><span class="line">        <span class="built_in">local</span> cmd_destdir=<span class="variable">$destdir</span>$(dirname $(<span class="built_in">which</span> <span class="variable">$1</span>))</span><br><span class="line">        <span class="keyword">if</span> [ ! -d <span class="variable">$cmd_destdir</span> ] ;<span class="keyword">then</span></span><br><span class="line">           mkdir -pv <span class="variable">$cmd_destdir</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">         cp -v $(<span class="built_in">which</span> <span class="variable">$1</span>) <span class="variable">$cmd_destdir</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">copy_libfile</span></span>()&#123;</span><br><span class="line">       ldd $(<span class="built_in">which</span> <span class="variable">$1</span>)|grep -oE <span class="string">"/.* "</span> | <span class="keyword">while</span> <span class="built_in">read</span> libfile</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">local</span> lib_destdir=<span class="variable">$destdir</span>$(dirname <span class="variable">$libfile</span>)</span><br><span class="line">            <span class="built_in">local</span> lib_destfile=<span class="variable">$destdir</span><span class="variable">$libfile</span></span><br><span class="line">            <span class="keyword">if</span> [ -e <span class="variable">$lib_destfile</span> ];<span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">continue</span></span><br><span class="line">            <span class="keyword">elif</span> [ -d <span class="variable">$lib_destdir</span> ] ;<span class="keyword">then</span></span><br><span class="line">                 cp -v <span class="variable">$libfile</span> <span class="variable">$lib_destdir</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                 mkdir -pv <span class="variable">$lib_destdir</span></span><br><span class="line">                 cp -v <span class="variable">$libfile</span> <span class="variable">$lib_destdir</span></span><br><span class="line">           <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">destdir=/mnt/root</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$destdir</span> ];<span class="keyword">then</span></span><br><span class="line">    mkdir <span class="variable">$destdir</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> ;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> -ne <span class="string">"\033[34mPlease input a execute command:\033[0m"</span></span><br><span class="line">    <span class="built_in">read</span> cmd</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$cmd</span>"</span> == quit ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">which</span> <span class="variable">$cmd</span> &amp;&gt;/dev/null ||&#123; <span class="built_in">echo</span> <span class="variable">$cmd</span> not exist;<span class="built_in">continue</span>; &#125;</span><br><span class="line">    copy_cmd <span class="variable">$cmd</span></span><br><span class="line">    copy_libfile <span class="variable">$cmd</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>使用bash命令执行上边贴出的 copycmd.sh脚本，将你需要在自制Linux中使用的命令复制到/mnt/root目录下，复制完成后敲quit退出脚本。需要复制的命令根据你的需求决定，但bash是必须要复制的，因为在编辑grub.conf文件时，已将它写为系统要启动运行的第一个程序，所以没这个程序系统将无法启动。其它命令便可根据需要自行复制了，下边是执行脚本的过程。</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="comment">#bash copycmd.sh</span></span><br><span class="line">Please input a<span class="built_in"> execute </span>command:bash</span><br><span class="line"><span class="comment">#bash复制成功后的显示应当是下面这样的，如果不同请检查脚本。</span></span><br><span class="line">mkdir: created directory `/mnt/root/bin'</span><br><span class="line">`/bin/bash' -&gt; `/mnt/root/bin/bash'</span><br><span class="line">mkdir: created directory `/mnt/root/lib64'</span><br><span class="line">`/lib64/libtinfo.so.5' -&gt; `/mnt/root/lib64/libtinfo.so.5'</span><br><span class="line">`/lib64/libdl.so.2' -&gt; `/mnt/root/lib64/libdl.so.2'</span><br><span class="line">`/lib64/libc.so.6' -&gt; `/mnt/root/lib64/libc.so.6'</span><br><span class="line">`/lib64/ld-linux-x86-64.so.2' -&gt; `/mnt/root/lib64/ld-linux-x86-64.so.2'</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:ls</span><br><span class="line">`/bin/ls' -&gt; `/mnt/root/bin/ls'</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:ifconfig</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:ping</span><br><span class="line">`/bin/ping' -&gt; `/mnt/root/bin/ping'</span><br><span class="line">`/lib64/libidn.so.11' -&gt; `/mnt/root/lib64/libidn.so.11'</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:hostname</span><br><span class="line">`/bin/hostname' -&gt; `/mnt/root/bin/hostname'</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:cat</span><br><span class="line">`/bin/cat' -&gt; `/mnt/root/bin/cat'</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:vi</span><br><span class="line">`/bin/vi' -&gt; `/mnt/root/bin/vi'</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:vim</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:mount</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:umount</span><br><span class="line">`/bin/umount' -&gt; `/mnt/root/bin/umount'</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:reboot</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:shutdown</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">Please input a<span class="built_in"> execute </span>command:quit</span><br></pre></td></tr></table></figure><p>查看目录树，确定命令都已复制成功</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="selector-id">#tree</span> /mnt/</span><br><span class="line">/mnt/</span><br><span class="line">├── boot</span><br><span class="line">│   ├── grub</span><br><span class="line">│   │   ├── device.map</span><br><span class="line">│   │   ├── e2fs_stage1_5</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">│   │   ├── vstafs_stage1_5</span><br><span class="line">│   │   └── xfs_stage1_5</span><br><span class="line">│   ├── initramfs-<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">696</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span><span class="selector-class">.img</span></span><br><span class="line">│   ├── lost+found</span><br><span class="line">│   └── vmlinuz-<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">696</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span></span><br><span class="line">└── root</span><br><span class="line">    ├── bin</span><br><span class="line">    │   ├── bash</span><br><span class="line">    │   ├── cat</span><br><span class="line">   ……此处省略部分显示内容</span><br><span class="line">    │   ├── umount</span><br><span class="line">    │   └── vi</span><br><span class="line">    ├── lib64</span><br><span class="line">    │   ├── ld-linux-x86-<span class="number">64</span><span class="selector-class">.so</span>.<span class="number">2</span></span><br><span class="line">    │   ├── libacl<span class="selector-class">.so</span>.<span class="number">1</span></span><br><span class="line">   ……此处省略部分显示内容</span><br><span class="line">    │   ├── libutil<span class="selector-class">.so</span>.<span class="number">1</span></span><br><span class="line">    │   └── libuuid<span class="selector-class">.so</span>.<span class="number">1</span></span><br><span class="line">    ├── sbin</span><br><span class="line">……此处省略部分显示内容</span><br><span class="line">            ├── libgpm<span class="selector-class">.so</span>.<span class="number">2</span></span><br><span class="line">            └── perl5</span><br><span class="line">                └── CORE</span><br><span class="line">                    └── libperl.so</span><br><span class="line"><span class="number">12</span> directories, <span class="number">55</span> files</span><br></pre></td></tr></table></figure><h3 id="装载网络模块，用于实现网络功能"><a href="#装载网络模块，用于实现网络功能" class="headerlink" title="装载网络模块，用于实现网络功能"></a>装载网络模块，用于实现网络功能</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="selector-id">#bash</span> copycmd.sh</span><br><span class="line">#复制加载网卡模块的命令</span><br><span class="line">Please <span class="selector-tag">input</span> <span class="selector-tag">a</span> execute command:insmod</span><br><span class="line">Please <span class="selector-tag">input</span> <span class="selector-tag">a</span> execute command:quit</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#ethtool</span> -<span class="selector-tag">i</span> eth0</span><br><span class="line">#查看eth0网卡对应的驱动模块名</span><br><span class="line">driver: e1000</span><br><span class="line">version: <span class="number">7.3</span>.<span class="number">21</span>-k8-NAPI</span><br><span class="line"> ……此处省略部分显示内容</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#modinfo</span> -n e1000</span><br><span class="line">#显示模块对应路径，找出对应的模块文件</span><br><span class="line">/lib/modules/<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">696</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span>/kernel/drivers/net/e1000/e1000.ko</span><br></pre></td></tr></table></figure><p>复制网卡模块文件到/mnt/root/lib64/目录下</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~<span class="selector-id">#cp</span> /lib/modules/<span class="number">2.6</span>.<span class="number">32</span>-<span class="number">696</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span>/kernel/drivers/net/e1000/e1000<span class="selector-class">.ko</span> /mnt/root/lib64/</span><br><span class="line">root&amp;Centos6: ~<span class="selector-id">#ls</span> /mnt/root/lib64/e1000.ko</span><br><span class="line">/mnt/root/lib64/e1000.ko</span><br></pre></td></tr></table></figure><h3 id="创建根分区下的一级目录"><a href="#创建根分区下的一级目录" class="headerlink" title="创建根分区下的一级目录"></a>创建根分区下的一级目录</h3><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: ~#ls /mnt/root/</span><br><span class="line">bin  lib64  lost+found  sbin  usr</span><br><span class="line">root&amp;Centos6: ~#<span class="keyword">cd</span> /mnt/root/</span><br><span class="line">root&amp;Centos6: root#mkdir &#123;etc,dev,<span class="keyword">proc</span>,sys,boot,home,var,mnt,media,root,tmp,lib&#125;</span><br><span class="line">root&amp;Centos6:<span class="title"> root#ls</span></span><br><span class="line"><span class="title">bin</span> <span class="title"> boot</span> <span class="title"> dev</span> <span class="title"> etc</span> <span class="title"> home</span> <span class="title"> lib</span> <span class="title"> lib64</span> <span class="title"> lost+found</span> <span class="title"> media</span> <span class="title"> mnt</span> <span class="title"> proc</span> <span class="title"> root</span> <span class="title"> sbin</span> <span class="title"> sys</span> <span class="title"> tmp</span> <span class="title"> usr</span> <span class="title"> var</span></span><br></pre></td></tr></table></figure><h3 id="测试定制的小Linux是否制作成功"><a href="#测试定制的小Linux是否制作成功" class="headerlink" title="测试定制的小Linux是否制作成功"></a>测试定制的小Linux是否制作成功</h3><p>使用chroot命令切根，成功则这个定制的小Linux制作成功，如果不成功请检查脚本，排除问题后删除/mnt/root/下文件，重新复制一遍命令。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos6: root<span class="comment">#chroot /mnt/root/</span></span><br><span class="line">bash-<span class="number">4.1</span><span class="comment">#  #成功切根后的命令提示符bash-4.1#</span></span><br><span class="line">bash-<span class="number">4.1</span><span class="comment"># exit</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line"><span class="comment">#退出切根后的当前进程</span></span><br><span class="line">root&amp;Centos6: root<span class="comment">#sync</span></span><br><span class="line">root&amp;Centos6: root<span class="comment">#sync</span></span><br><span class="line"><span class="comment">#将内存中的文件写入硬盘，同步文件</span></span><br></pre></td></tr></table></figure><h3 id="挂载新机器并启用网络功能"><a href="#挂载新机器并启用网络功能" class="headerlink" title="挂载新机器并启用网络功能"></a>挂载新机器并启用网络功能</h3><p>将磁盘挂载到新主机上，使用带有自制Linux的磁盘进行启动，实现网络功能。</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bash<span class="number">-4.1</span><span class="comment"># insmod /liib64/e1000.ko</span></span><br><span class="line"><span class="comment">#加载网卡模块</span></span><br><span class="line">bash<span class="number">-4.1</span><span class="comment"># ifconfig -a</span></span><br><span class="line"><span class="comment">#查看是否成功加载网卡模块</span></span><br><span class="line">bash<span class="number">-4.1</span><span class="comment"># ifcongig eth0 172.18.22.22</span></span><br><span class="line"><span class="comment">#设置临时IP地址</span></span><br></pre></td></tr></table></figure><p>具体操作过程请看下图：</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/CgC1G2E1l9.png?imageslim" alt="mark"></p><p><em>到此，制作简单小Linux系统的实验就完成了！虽然功能比较简单，但通过这个实验确实可以提高对内核和启动流程的认识。</em></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;本篇博文主要通过裁剪现有Linux系统，打造出一个属于你自己的小Linux系统，并让其能够装载网卡驱动，配置IP地址后可以实现网络功能。但在开始制作之前需要先向你说明本次制作前的一些准备工作，以及制作的思路。&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://subtraction.tech/categories/Linux/"/>
    
    
      <category term="启动流程" scheme="http://subtraction.tech/tags/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    
      <category term="CentOS" scheme="http://subtraction.tech/tags/CentOS/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 7 配置网络组</title>
    <link href="http://subtraction.tech/Network/CentOS-7-%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E7%BB%84/"/>
    <id>http://subtraction.tech/Network/CentOS-7-配置网络组/</id>
    <published>2017-08-22T06:44:57.000Z</published>
    <updated>2018-04-23T12:44:53.376Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="网络组简介"><a href="#网络组简介" class="headerlink" title="网络组简介"></a>网络组简介</h3><p>网络组（Network Teaming）是在RHEL 7和CentOS 7中新出现的一种网络技术应用，是将多个网卡聚合在一起方法，从而实现冗错和提高吞吐量。是实现bonding功能的一种最新技术应用。网络组由内核驱动和teamd守护进程实现，旨在通过提供小内核驱动程序，实现数据包流的快速处理，以便提供更好性能。简单来说就是，网络组可以在牺牲更少系统资源的情况下，实现比bonding更优的性能，提供更好的性能和扩展性。bonding所具有的网络负载均衡、网络冗余高可用等优点，网络组同样拥有。</p><a id="more"></a><p>要介绍网络组咱们还要再介绍一下bonding，所谓bonding就是将多块网卡绑定同一IP地址对外提供服务。可以实现网卡的带宽扩容、高可用或者负载均衡，具体的功能取决于采用的哪种bonding模式。更多关于bonding的介绍可以看我前面关于如何在CentOS 6配置bonding的文章，在这里就不多做介绍了。今天要谈的网络组则bonding功能的全新实现方案。<br>本人在查看红帽官方提供的网络组相关文档时，看到里面提到bonding和网络组的功能对比，网络组可以说是完胜bonding。但这也只是官方的一面之词，由于是新技术，生产中的实际应用还没有普及，孰优孰劣还有待实践的检验，但这并不妨碍我们去尝试和了解它，接下来我会说明一下网络组的配置及使用过程中的注意事项。<br><strong>补充说明：</strong>网络组在RHEL 7和CentOS 7中是作为bonding的备选方案提供的，并不会影响现有的bonding驱动程序，不会替换 RHEL 7 和CentOS 7中原有的bonding功能。所以你也没必要担心在CentOS 7不能使用bonding功能。</p><hr><h3 id="选择网络组的配置方法"><a href="#选择网络组的配置方法" class="headerlink" title="选择网络组的配置方法"></a>选择网络组的配置方法</h3><p>在CentOS 7中对于网络组的配置提供了多种方法，下面列出的多种方法都可以实现网络组的配置。由于篇幅原因无法挨个演示如何配置，所以我挑选了相对简单，较为常用的命令行工具 nmcli，来演示如何创建网络组。<br><strong>网络组的常见配置方法：</strong></p><ul><li>使用 NetworkManager 的文本用户界面工具 nmtui 配置网络组</li><li>使用命令行工具 nmcli 创建网络组</li><li>使用网络组守护进程 teamd 创建网络组</li><li>使用配置文件创建网络组</li><li>使用图形用户界面配置网络组</li></ul><h3 id="网络组主接口及从属接口的默认行为"><a href="#网络组主接口及从属接口的默认行为" class="headerlink" title="网络组主接口及从属接口的默认行为"></a>网络组主接口及从属接口的默认行为</h3><p><strong>在配置和使用网络组的过程中，特别是发现错误时，请记住以下要点：</strong></p><ul><li>启动主接口不会自动启动端口接口。</li><li>启动端口接口总是会启动主接口。</li><li>停止主接口总是会停止端口接口。</li><li>没有端口的主机可启动静态 IP 连接。</li><li>没有端口的主机在启动 DHCP 连接时会等待端口。</li><li>添加附带载波的端口后，使用 DHCP 连接的主机会等待端口完成连接</li><li>添加不附带载波的端口后，使用 DHCP 连接的主机会让端口继续等待。</li></ul><hr><h3 id="创建网络组"><a href="#创建网络组" class="headerlink" title="创建网络组"></a>创建网络组</h3><p><strong>实现网络组至少需要两块网卡，这是最低配置要求，请在配置前做好准备工作。</strong><br><strong>由于不同主机的网卡名可能会有不同，所以实验前请先用ifconfig命令确认好自己的网卡名，以避免因在命令里敲错网卡名导致实验不能成功。</strong><br><strong>实验中需要注意的地方我会在命令行前以“*”标注</strong><br>接下来网络组的配置过程中还会用到在CentOS 7中功能非常强大的nmcli工具，nmcli命令几乎可以完成CentOS 7中所有的网络配置，本次是使用命令行工具 nmcli来创建网络组的，所以我在创建网络组的过程中会简单介绍几个nmcli命令的常见用法。</p><h4 id="实验前准备"><a href="#实验前准备" class="headerlink" title="实验前准备"></a>实验前准备</h4><p>注意自己的网卡名，配置时不要写错，参与网络组的网卡现在都应该能看到，并且是正常工作的。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: ~<span class="comment">#ifconfig </span></span><br><span class="line">*ens32: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.18.22.200  netmask 255.255.0.0  broadcast 172.18.255.255</span><br><span class="line">        inet6 fe80::20c:29ff:fe17:4da  prefixlen<span class="number"> 64 </span> scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:17:04:da  txqueuelen<span class="number"> 1000 </span> (Ethernet)</span><br><span class="line">        RX packets<span class="number"> 512010 </span> bytes<span class="number"> 43078494 </span>(41.0 MiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 35884 </span> bytes<span class="number"> 54323115 </span>(51.8 MiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br><span class="line"></span><br><span class="line">*ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.18.22.20  netmask 255.255.0.0  broadcast 172.18.255.255</span><br><span class="line">        inet6 fe80::d257:f022:b22e:6c8e  prefixlen<span class="number"> 64 </span> scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:17:04:e4  txqueuelen<span class="number"> 1000 </span> (Ethernet)</span><br><span class="line">        RX packets<span class="number"> 482288 </span> bytes<span class="number"> 37695537 </span>(35.9 MiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 414 </span> bytes<span class="number"> 41817 </span>(40.8 KiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br></pre></td></tr></table></figure><h4 id="创建主设备team0"><a href="#创建主设备team0" class="headerlink" title="创建主设备team0"></a>创建主设备team0</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">root&amp;Centos7: ~# cd /etc/sysconfig/network-scripts/</span></span><br><span class="line"><span class="comment">#建议创建活动在/etc/sysconfig/network-scripts/目录下进行，方便使用ls或cat命令查看生成的配置文件。</span></span><br><span class="line"><span class="section">root&amp;Centos7: network-scripts# nmcli connection add con-name team0 type team ifname team0 </span></span><br><span class="line">config '&#123;<span class="string">"runner"</span>:&#123;<span class="string">"name"</span>:<span class="string">"loadbalance"</span>&#125;&#125;'</span><br><span class="line"><span class="comment">#这条nmcli命令的作用是创建一个名为team0的设备，设备类型是team（team类型设备是专用于网络组的设备类型），接口名称是team0，config后面指定的是网络组的工作模式，需要按特定格式来写。'&#123;"runner":&#123;"name":"模式名"&#125;&#125;'</span></span><br><span class="line">Connection 'team0' (75dbdd85-c78d-4617-9ece-0f3c69dd6616) successfully added.</span><br><span class="line"><span class="comment">#team0主设备创建成功的提示</span></span><br><span class="line"><span class="section">root&amp;Centos7: network-scripts# cat ifcfg-team0 </span></span><br><span class="line"><span class="comment">#使用cat命令查看创建生成的ifcfg-team0配置文件。使用ls命令在当前目录下如果找不到ifcfg-team0这个配置文件，这说明刚才的创建活动失败。下面是创建成功后，配置文件里的内容。</span></span><br><span class="line">DEVICE=team0</span><br><span class="line"><span class="comment">#设备名team0，是由我们上面的nmcli命令指定生成的</span></span><br><span class="line"><span class="section">*TEAM_CONFIG="&#123;\"runner\":&#123;\"name\":\"loadbalance\"&#125;&#125;"</span></span><br><span class="line"><span class="comment">#网络组的工作模式loadbalance，轮询模式。</span></span><br><span class="line">*BOOTPROTO=dhcp</span><br><span class="line"><span class="comment">#这里写的是dhcp，说明我们的team0设备是使用dhcp自动获取ip的</span></span><br><span class="line">DEFROUTE=yes</span><br><span class="line">PEERDNS=yes</span><br><span class="line">PEERROUTES=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_PEERDNS=yes</span><br><span class="line">IPV6_PEERROUTES=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=team0</span><br><span class="line">UUID=75dbdd85-c78d-4617-9ece-0f3c69dd6616</span><br><span class="line">ONBOOT=yes</span><br><span class="line">DEVICETYPE=Team</span><br><span class="line"><span class="comment">#在这可以看到刚才指定的设备类型team</span></span><br></pre></td></tr></table></figure><h4 id="创建team0从属设备"><a href="#创建team0从属设备" class="headerlink" title="创建team0从属设备"></a>创建team0从属设备</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: network-scripts#nmcli connection add type team-slave ifname ens32 master team0</span><br><span class="line">#这一步的作用是将ens32网卡的设备类型改为team-slave，指定此网卡从属于team0设备</span><br><span class="line">Connection 'team-slave-ens32' (0de582b1<span class="string">-6818</span><span class="string">-43</span>e5-a7f0-e66e6e656227) successfully added.</span><br><span class="line">#添加从属设备成功的提示，成功后会生成一个名为ifcfg-team-slave-ens32的配置文件</span><br><span class="line">root&amp;Centos7: network-scripts#nmcli connection add type team-slave ifname ens34 master team0</span><br><span class="line">#对第二块网卡的设置，</span><br><span class="line">Connection 'team-slave-ens34' (4cf10d5e<span class="string">-7542</span><span class="string">-4</span>d16<span class="string">-9</span>b7c-e1b914048177) successfully added.</span><br><span class="line">root&amp;Centos7: network-scripts#nmcli connection show</span><br><span class="line">#这条命令可以查看本机的网络设备，包括名称、UUID、类型、设备名。如果DEVICE这一列下没有设备名，只有两道杠，则说明设备，没有生效。显然这里我们创建的从属设备是没有生效的。</span><br><span class="line">NAME              UUID                                  TYPE            DEVICE </span><br><span class="line">ens32             152beb06<span class="string">-47</span>c5-c5e8<span class="string">-95</span>a9<span class="string">-385590654382</span>  802<span class="string">-3</span>-ethernet  ens32  </span><br><span class="line">ens34             94aea789-efb3-ef4c<span class="string">-81</span>b0-e8b18ecc9797  802<span class="string">-3</span>-ethernet  ens34  </span><br><span class="line">*team0             75dbdd85-c78d<span class="string">-4617</span><span class="string">-9</span>ece<span class="string">-0</span>f3c69dd6616  team            team0  </span><br><span class="line">*team-slave-ens32  0de582b1<span class="string">-6818</span><span class="string">-43</span>e5-a7f0-e66e6e656227  802<span class="string">-3</span>-ethernet  -- </span><br><span class="line">*team-slave-ens34  4cf10d5e<span class="string">-7542</span><span class="string">-4</span>d16<span class="string">-9</span>b7c-e1b914048177  802<span class="string">-3</span>-ethernet  --</span><br></pre></td></tr></table></figure><h4 id="生效team0主从设备接口"><a href="#生效team0主从设备接口" class="headerlink" title="生效team0主从设备接口"></a>生效team0主从设备接口</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: network-scripts#nmcli<span class="built_in"> connection </span>up team0</span><br><span class="line"><span class="comment">#生效team0的设备接口</span></span><br><span class="line">Connection successfully activated (master waiting <span class="keyword">for</span> slaves) (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/5)</span><br><span class="line">root&amp;Centos7: network-scripts#nmcli<span class="built_in"> connection </span>up team-slave-ens32</span><br><span class="line"><span class="comment">#生效从属设备team-slave-ens32的接口</span></span><br><span class="line">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/6)</span><br><span class="line">root&amp;Centos7: network-scripts#nmcli<span class="built_in"> connection </span>up team-slave-ens34</span><br><span class="line">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/7)</span><br><span class="line">root&amp;Centos7: network-scripts#nmcli<span class="built_in"> connection </span>show</span><br><span class="line">NAME              UUID                                 <span class="built_in"> TYPE </span>           DEVICE </span><br><span class="line">*team-slave-ens32  0de582b1-6818-43e5-a7f0-e66e6e656227  802-3-ethernet  ens32  </span><br><span class="line">*team-slave-ens34  4cf10d5e-7542-4d16-9b7c-e1b914048177  802-3-ethernet  ens34  </span><br><span class="line">*team0             75dbdd85-c78d-4617-9ece-0f3c69dd6616  team            team0  </span><br><span class="line">ens32             152beb06-47c5-c5e8-95a9-385590654382  802-3-ethernet  --     </span><br><span class="line">ens34             94aea789-efb3-ef4c-81b0-e8b18ecc9797  802-3-ethernet  --     </span><br><span class="line"><span class="comment">#主从设备的最后一项没有了两条杠，说明生效成功</span></span><br></pre></td></tr></table></figure><h4 id="查看team0状态"><a href="#查看team0状态" class="headerlink" title="查看team0状态"></a>查看team0状态</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: network-scripts<span class="comment">#ip a </span></span><br><span class="line"><span class="comment">#使用ip a 查看现在的网卡状态你会发现，ens32，ens34的ip地址没有了，并且显示的信息里有 master team0 字样。ens32，ens34，team0三个设备共用一个MAC地址，</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">*<span class="number">2</span>: ens32: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast master team0 <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">17</span>:<span class="number">04</span>:da brd ff:ff:ff:ff:ff:ff</span><br><span class="line">*<span class="number">3</span>: ens34: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast master team0 <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">17</span>:<span class="number">04</span>:da brd ff:ff:ff:ff:ff:ff</span><br><span class="line">*<span class="number">4</span>: team0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">17</span>:<span class="number">04</span>:da brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.18</span>.<span class="number">253.76</span>/<span class="number">16</span> brd <span class="number">172.18</span>.<span class="number">255.255</span> scope <span class="keyword">global</span> dynamic team0</span><br><span class="line">       valid_lft <span class="number">86254</span>sec preferred_lft <span class="number">86254</span>sec</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">948</span>c:<span class="number">8</span>f84:<span class="number">8438</span>:d24/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">root&amp;Centos7: network-scripts<span class="comment">#teamdctl team0 state</span></span><br><span class="line"><span class="comment">#使用网络组管理命令teamdctl，查看team0的状态</span></span><br><span class="line">setup:</span><br><span class="line"> * runner: loadbalance</span><br><span class="line">ports:</span><br><span class="line">  ens32</span><br><span class="line">    link watches:</span><br><span class="line">      *link summary: up</span><br><span class="line">      instance[link_watch_0]:</span><br><span class="line">        name: ethtool</span><br><span class="line">        link: up</span><br><span class="line">        down count: <span class="number">0</span></span><br><span class="line">  ens34</span><br><span class="line">    link watches:</span><br><span class="line">     * link summary: up</span><br><span class="line">      instance[link_watch_0]:</span><br><span class="line">        name: ethtool</span><br><span class="line">        link: up</span><br><span class="line">        down count: <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="更改team0模式"><a href="#更改team0模式" class="headerlink" title="更改team0模式"></a>更改team0模式</h3><p>网络组支持多种工作方式，常用的有runner：broadcast（广播）、activebackup（主备）、loadbalance（轮转）、roundrobin、lacp。在一开始创建team0主设备时，使用的是loadbalance（轮转）方式，接下来我会通过修改ifcfg-team0配置文件，来将工作模式改为broadcast（广播）模式。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: network-scripts#vim ifcfg-team0</span><br><span class="line"><span class="attribute">DEVICE</span>=team0</span><br><span class="line">    *<span class="attribute">TEAM_CONFIG</span>=<span class="string">"&#123;\"runner\":&#123;\"name\":\"loadbalance\"&#125;&#125;"</span>  </span><br><span class="line">#将这一行里的loadbalance改为broadcast，保存退出。                                                                   </span><br><span class="line"><span class="attribute">BOOTPROTO</span>=dhcp</span><br><span class="line"><span class="attribute">DEFROUTE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">PEERDNS</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">PEERROUTES</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">IPV4_FAILURE_FATAL</span>=<span class="literal">no</span></span><br><span class="line"><span class="attribute">IPV6INIT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">IPV6_AUTOCONF</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">IPV6_DEFROUTE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">IPV6_PEERDNS</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">IPV6_PEERROUTES</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">IPV6_FAILURE_FATAL</span>=<span class="literal">no</span></span><br><span class="line"><span class="attribute">IPV6_ADDR_GEN_MODE</span>=stable-privacy</span><br><span class="line"><span class="attribute">NAME</span>=team0</span><br><span class="line"><span class="attribute">UUID</span>=75dbdd85-c78d-4617-9ece-0f3c69dd6616</span><br><span class="line"><span class="attribute">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">DEVICETYPE</span>=Team</span><br></pre></td></tr></table></figure><h4 id="重新生效接口"><a href="#重新生效接口" class="headerlink" title="重新生效接口"></a>重新生效接口</h4><p>这一步非常重要，修改配置文件后一定不要忘了重新生效接口。对于网络组的主从接口有很多地方需要注意，否则会发生很多莫名的错误。关于网络组主接口及从属接口的默认行为，我在文章的前面部分已经写过了，没有仔细看的话，建议翻上去再认真看一遍。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root&amp;Centos7:</span> <span class="string">network-scripts#nmcli</span> <span class="string">connection</span> <span class="string">down</span> <span class="string">team0</span></span><br><span class="line"><span class="comment">#down掉team0接口</span></span><br><span class="line"><span class="string">Connection</span> <span class="string">'team0'</span> <span class="string">successfully</span> <span class="string">deactivated</span> <span class="string">(D-Bus</span> <span class="string">active</span> <span class="attr">path:</span> <span class="string">/org/freedesktop/NetworkManager/ActiveConnection/5)</span></span><br><span class="line"><span class="comment">#成功的提示信息</span></span><br><span class="line"><span class="string">root&amp;Centos7:</span> <span class="string">network-scripts#nmcli</span> <span class="string">connection</span> <span class="string">up</span> <span class="string">team0</span></span><br><span class="line"><span class="comment">#重新up team0接口</span></span><br><span class="line"><span class="string">Connection</span> <span class="string">successfully</span> <span class="string">activated</span> <span class="string">(master</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">slaves)</span> <span class="string">(D-Bus</span> <span class="string">active</span> <span class="attr">path:</span> <span class="string">/org/freedesktop/NetworkManager/ActiveConnection/10)</span></span><br><span class="line"><span class="string">root&amp;Centos7:</span> <span class="string">network-scripts#nmcli</span> <span class="string">connection</span> <span class="string">up</span> <span class="string">team-slave-ens32</span></span><br><span class="line"><span class="comment">#up team-slave-ens32接口</span></span><br><span class="line"><span class="string">Connection</span> <span class="string">successfully</span> <span class="string">activated</span> <span class="string">(D-Bus</span> <span class="string">active</span> <span class="attr">path:</span> <span class="string">/org/freedesktop/NetworkManager/ActiveConnection/11)</span></span><br><span class="line"><span class="string">root&amp;Centos7:</span> <span class="string">network-scripts#nmcli</span> <span class="string">connection</span> <span class="string">up</span> <span class="string">team-slave-ens34</span></span><br><span class="line"><span class="comment">#up team-slave-ens34接口</span></span><br><span class="line"><span class="string">Connection</span> <span class="string">successfully</span> <span class="string">activated</span> <span class="string">(D-Bus</span> <span class="string">active</span> <span class="attr">path:</span> <span class="string">/org/freedesktop/NetworkManager/ActiveConnection/12)</span></span><br><span class="line"><span class="string">root&amp;Centos7:</span> <span class="string">network-scripts#teamdctl</span> <span class="string">team0</span> <span class="string">state</span></span><br><span class="line"><span class="attr">setup:</span></span><br><span class="line"><span class="attr">  runner:</span> <span class="string">loadbalance</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="string">ens32</span></span><br><span class="line">    <span class="string">link</span> <span class="attr">watches:</span></span><br><span class="line">      <span class="string">link</span> <span class="attr">summary:</span> <span class="string">up</span></span><br><span class="line">      <span class="string">instance[link_watch_0]:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">ethtool</span></span><br><span class="line"><span class="attr">        link:</span> <span class="string">up</span></span><br><span class="line">        <span class="string">down</span> <span class="attr">count:</span> <span class="number">0</span></span><br><span class="line">  <span class="string">ens34</span></span><br><span class="line">    <span class="string">link</span> <span class="attr">watches:</span></span><br><span class="line">      <span class="string">link</span> <span class="attr">summary:</span> <span class="string">up</span></span><br><span class="line">      <span class="string">instance[link_watch_0]:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">ethtool</span></span><br><span class="line"><span class="attr">        link:</span> <span class="string">up</span></span><br><span class="line">        <span class="string">down</span> <span class="attr">count:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="删除team0，取消网络组"><a href="#删除team0，取消网络组" class="headerlink" title="删除team0，取消网络组"></a>删除team0，取消网络组</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root&amp;Centos7: network-scripts<span class="comment">#nmcli connection down team0</span></span><br><span class="line"><span class="comment">#禁用team0设备</span></span><br><span class="line">Connection 'team0' successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/<span class="number">10</span>)</span><br><span class="line">root&amp;Centos7: network-scripts<span class="comment">#nmcli connection delete team0</span></span><br><span class="line"><span class="comment">#删除team0设备</span></span><br><span class="line">Connection 'team0' (<span class="number">75</span>dbdd85-c78d-<span class="number">4617</span>-<span class="number">9</span>ece-<span class="number">0</span>f3c69dd6616) successfully deleted.</span><br><span class="line">root&amp;Centos7: network-scripts<span class="comment">#nmcli connection delete team-slave-ens32</span></span><br><span class="line"><span class="comment">#删除team0的从属设备team-slave-ens32</span></span><br><span class="line">Connection 'team-slave-ens32' (<span class="number">0</span>de582b1-<span class="number">6818</span>-<span class="number">43</span>e5-a7f0-e66e6e656227) successfully deleted.</span><br><span class="line">root&amp;Centos7: network-scripts<span class="comment">#nmcli connection delete team-slave-ens34</span></span><br><span class="line">Connection 'team-slave-ens34' (<span class="number">4</span>cf10d5e-<span class="number">7542</span>-<span class="number">4</span>d16-<span class="number">9</span>b7c-e1b914048177) successfully deleted.</span><br><span class="line">root&amp;Centos7: network-scripts<span class="comment">#ip a</span></span><br><span class="line"><span class="comment">#完成上面的四步操作后，你会发现网卡ens32和ens34的IP地址又回来了，team0设备也没有了</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">*<span class="number">2</span>: ens32: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">17</span>:<span class="number">04</span>:da brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.18</span>.<span class="number">22.200</span>/<span class="number">16</span> brd <span class="number">172.18</span>.<span class="number">255.255</span> scope <span class="keyword">global</span> ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">20</span>c:<span class="number">29</span>ff:fe17:<span class="number">4</span>da/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">*<span class="number">3</span>: ens34: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">17</span>:<span class="number">04</span>:e4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.18</span>.<span class="number">22.20</span>/<span class="number">16</span> brd <span class="number">172.18</span>.<span class="number">255.255</span> scope <span class="keyword">global</span> ens34</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::d257:f022:b22e:<span class="number">6</span>c8e/<span class="number">64</span> scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><em>总结一下配置网络组的思路：</em></p><ul><li>第一步，创建网络组的主设备</li><li>第二步，创建网络组的从属设备</li><li>第三步，生效参与网络组的各主从接口</li></ul><p><em>Note:</em> </p><ol><li>更改配置文件后，记得要重新生效各主从接口。</li><li>删除网络组之前，要先禁用网络组的主设备，再开始删除步骤。</li><li>实验过程中注意检查，一步一检查，有助于及时发现问题解决问题，是一个值得培养的好习惯。</li></ol><blockquote><p>关于网络组的更多资料可以去红帽官网查看，链接在下面。</p><p><a href="https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-Configure_Network_Teaming.html" target="_blank" rel="noopener">https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-Configure_Network_Teaming.html</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;网络组简介&quot;&gt;&lt;a href=&quot;#网络组简介&quot; class=&quot;headerlink&quot; title=&quot;网络组简介&quot;&gt;&lt;/a&gt;网络组简介&lt;/h3&gt;&lt;p&gt;网络组（Network Teaming）是在RHEL 7和CentOS 7中新出现的一种网络技术应用，是将多个网卡聚合在一起方法，从而实现冗错和提高吞吐量。是实现bonding功能的一种最新技术应用。网络组由内核驱动和teamd守护进程实现，旨在通过提供小内核驱动程序，实现数据包流的快速处理，以便提供更好性能。简单来说就是，网络组可以在牺牲更少系统资源的情况下，实现比bonding更优的性能，提供更好的性能和扩展性。bonding所具有的网络负载均衡、网络冗余高可用等优点，网络组同样拥有。&lt;/p&gt;
    
    </summary>
    
      <category term="Network" scheme="http://subtraction.tech/categories/Network/"/>
    
    
      <category term="HA" scheme="http://subtraction.tech/tags/HA/"/>
    
  </entry>
  
  <entry>
    <title>grep和正则表达式</title>
    <link href="http://subtraction.tech/Command/grep%E5%92%8C%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <id>http://subtraction.tech/Command/grep和正则表达式/</id>
    <published>2017-08-20T10:15:57.000Z</published>
    <updated>2018-04-23T13:46:33.859Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h3><p><strong>grep</strong>（global search regular expression(RE) and print out the line），是一款文本过滤（模式：pattern）工具。</p><a id="more"></a><h4 id="grep作用"><a href="#grep作用" class="headerlink" title="grep作用"></a>grep作用</h4><p>文本搜索工具，根据用户指定的“模式”对目标文本逐行进行匹配检查；打印匹配到的行。<br><strong>模式：</strong>由正则表达式字符及文本字符所编写的过滤条件。</p><h4 id="grep家族的三大分支"><a href="#grep家族的三大分支" class="headerlink" title="grep家族的三大分支"></a>grep家族的三大分支</h4><ul><li>grep支持基本的正则表达式</li><li>egrep支持扩展的正则表达式，grep的-E选项其实就是egrep</li><li>fgrep不支持正则表达式，grep的-F选项其实就是fgrep</li></ul><h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p><strong>正则表达式</strong>（REFEXP）：由一类特殊字符及文本字符所编写的模式，其中有些字符不表示字符字面意义，而表示控制或通配的功能。<br>正则表达式是vim, grep, sed, awk等众多强大文本处理工具的重要组成部分，被用来检索、替换那些匹配某个模式的文本。<br><strong>正则表达式分为两类</strong></p><ul><li>基本正则表达式：BRE</li><li>扩展正则表达式：ERE</li></ul><h3 id="grep语法"><a href="#grep语法" class="headerlink" title="grep语法"></a>grep语法</h3><p><code>grep [OPTIONS] PATTERN [FILE...]</code><br><code>grep [OPTIONS][-e PATTERN | -f FILE] [FILE...]</code></p><h4 id="grep命令选项"><a href="#grep命令选项" class="headerlink" title="grep命令选项"></a>grep命令选项</h4><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>- -color=auto</td><td>对匹配到的文本着色显示</td></tr><tr><td>-v</td><td>显示不被pattern匹配到的行</td></tr><tr><td>-i</td><td>忽略字符大小写</td></tr><tr><td>-n</td><td>显示匹配的行号</td></tr><tr><td>-c</td><td>统计匹配的行数</td></tr><tr><td>-o</td><td>仅显示匹配到的字符串</td></tr><tr><td>-q</td><td>静默模式，不输出任何信息</td></tr><tr><td>-A #</td><td>匹配行的后#行</td></tr><tr><td>-B #</td><td>匹配行的前#行</td></tr><tr><td>-C #</td><td>匹配行的前后各#行</td></tr><tr><td>-e</td><td>实现多个选项间的逻辑or关系    <code>grep –e ‘cat ’ -e ‘dog’ file</code></td></tr><tr><td>-w</td><td>匹配整个单词</td></tr><tr><td>-E</td><td>使用扩展的正则表达式</td></tr><tr><td>-F</td><td>不支持正则表达式，直接搜索文本</td></tr></tbody></table><p><strong>Note：</strong>centos6与centos7的区别，centos7上通过定义了grep的别名来高亮显示匹配到的字符串，centos6没有高亮显示。</p><h3 id="正则表达式元字符"><a href="#正则表达式元字符" class="headerlink" title="正则表达式元字符"></a>正则表达式元字符</h3><p>正则表达式元字符根据功能的不同，可以分为以下几类：字符匹配、匹配次数、位置锚定、分组。</p><h4 id="字符匹配"><a href="#字符匹配" class="headerlink" title="字符匹配"></a>字符匹配</h4><table><thead><tr><th>元字符</th><th>含义</th></tr></thead><tbody><tr><td>.</td><td>匹配任意单个字符</td></tr><tr><td>[ ]</td><td>匹配指定范围内的任意单个字符</td></tr><tr><td>[^]</td><td>匹配指定范围外的任意单个字符</td></tr><tr><td>[:alnum:]</td><td>字母和数字</td></tr><tr><td>[:alpha:]</td><td>代表任何英文大小写字符，即A-Z和a-z</td></tr><tr><td>[:lower:]</td><td>小写字母</td></tr><tr><td>[:upper:]</td><td>大写字母</td></tr><tr><td>[:blank:]</td><td>空白字符（空格和制表符）</td></tr><tr><td>[:space:]</td><td>水平和垂直的空白字符（比[:blank:]包含的范围广）</td></tr><tr><td>[:cntrl:]</td><td>不可打印的控制字符（退格、删除、警铃…）</td></tr><tr><td>[:digit:]</td><td>十进制数字</td></tr><tr><td>[:xdigit:]</td><td>十六进制数字</td></tr><tr><td>[:graph:]</td><td>可打印的非空白字符</td></tr><tr><td>[:print:]</td><td>可打印字符</td></tr><tr><td>[:punct:]</td><td>标点符号</td></tr></tbody></table><h4 id="匹配次数"><a href="#匹配次数" class="headerlink" title="匹配次数"></a>匹配次数</h4><p>用在要指定次数的字符后面，用于指定前面的字符要出现的次数；需要注意的是，默认情况下，正则表达式是工作在贪婪模式下，能匹配多少就匹配多少。</p><table><thead><tr><th>元字符</th><th>含义</th></tr></thead><tbody><tr><td>*</td><td>匹配前面的字符任意次，包括0次。</td></tr><tr><td>.*</td><td>任意长度的任意字符</td></tr><tr><td>\?</td><td>匹配其前面的字符0或1次</td></tr><tr><td>\+</td><td>匹配其前面的字符至少1次</td></tr><tr><td>\{n\}</td><td>匹配前面的字符n次</td></tr><tr><td>\{m,n\}</td><td>匹配前面的字符至少m次，至多n次</td></tr><tr><td>\{,n\}</td><td>匹配前面的字符至多n次</td></tr><tr><td>\{n,\}</td><td>匹配前面的字符至少n次</td></tr></tbody></table><h4 id="位置锚定"><a href="#位置锚定" class="headerlink" title="位置锚定"></a>位置锚定</h4><p>对特定位置进行定位</p><table><thead><tr><th>元字符</th><th>含义</th></tr></thead><tbody><tr><td>^</td><td>行首锚定，用于模式的最左侧</td></tr><tr><td>$</td><td>行尾锚定，用于模式的最右侧</td></tr><tr><td>^PATTERN$</td><td>用于模式匹配整行</td></tr><tr><td>^$</td><td>空行</td></tr><tr><td>^[[:space:]]*$</td><td>空白行</td></tr><tr><td>\&lt; 或\b</td><td>词首锚定，用于单词模式的左侧</td></tr><tr><td>> 或\b</td><td>词尾锚定；用于单词模式的右侧</td></tr><tr><td>\&lt;模式\&gt;</td><td>匹配整个单词</td></tr></tbody></table><h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><p><strong>分组：</strong>是指将一个或多个字符捆绑在一起，当作一个整体进行处理，其符号为：()<br>如：(xy)*ab 表示xy这个整体可以出现任意次<br><strong>注意：</strong></p><ol><li>分组括号中的模式匹配到的内容会被正则表达式引擎记录与内部变量中，这些变量的命名方式为：\1,\2,\3,……<br>\1:从左侧起，第一个左括号以及与之匹配的右括号之间的模式所匹配到的字符；如：(ab+(xy)<em>)中\1表示：ab+(xy)\</em>,\2表示：xy</li><li><strong>后向引用：</strong>引用前面的分组括号中的模式所匹配的字符，而非模式本身。</li></ol><h4 id="或者"><a href="#或者" class="headerlink" title="或者"></a>或者</h4><table><thead><tr><th>用法</th><th style="text-align:left">含义</th></tr></thead><tbody><tr><td>a\</td><td style="text-align:left">b</td><td>a或b</td></tr><tr><td>C\</td><td style="text-align:left">cat</td><td>C或cat</td></tr><tr><td>\(C\</td><td style="text-align:left">c\)at</td><td>Cat或cat</td></tr></tbody></table><h3 id="扩展正则表达式元字符"><a href="#扩展正则表达式元字符" class="headerlink" title="扩展正则表达式元字符"></a>扩展正则表达式元字符</h3><p>扩展正则表达式与基本正则表达式功能类似，但扩展正则表达式元字符的书写更加简单明了，下面介绍的是扩展正则表达式与基本正则表达式的两种元字符之间的不同之处。扩展正则表达式元字符依据功能也可以分为以下几类：字符匹配、匹配次数、位置锚定、分组。</p><h4 id="字符匹配-1"><a href="#字符匹配-1" class="headerlink" title="字符匹配"></a>字符匹配</h4><table><thead><tr><th>元字符</th><th>含义</th></tr></thead><tbody><tr><td>.</td><td>任意单个字符</td></tr><tr><td>[ ]</td><td>指定范围的字符</td></tr><tr><td>[^]</td><td>不在指定范围的字符</td></tr></tbody></table><h4 id="匹配次数-1"><a href="#匹配次数-1" class="headerlink" title="匹配次数"></a>匹配次数</h4><table><thead><tr><th>元字符</th><th>含义</th></tr></thead><tbody><tr><td>*</td><td>匹配前面字符任意次</td></tr><tr><td>?</td><td>0或1次</td></tr><tr><td>+</td><td>1次或多次</td></tr><tr><td>{m}</td><td>匹配m次</td></tr><tr><td>{m,n}</td><td>至少m，至多n次</td></tr></tbody></table><h4 id="位置锚定-1"><a href="#位置锚定-1" class="headerlink" title="位置锚定"></a>位置锚定</h4><table><thead><tr><th>元字符</th><th>含义</th></tr></thead><tbody><tr><td>^</td><td>行首</td></tr><tr><td>$</td><td>行尾</td></tr><tr><td>\&lt;, \b</td><td>语首</td></tr><tr><td>\&gt;, \b</td><td>语尾</td></tr></tbody></table><h4 id="分组-1"><a href="#分组-1" class="headerlink" title="分组"></a>分组</h4><p>()：用括号括起来表示要引用的内容，不需要转义。<br>后向引用：\1, \2, …</p><h4 id="或者-1"><a href="#或者-1" class="headerlink" title="或者"></a>或者</h4><table><thead><tr><th style="text-align:left">用法</th><th style="text-align:left">含义</th></tr></thead><tbody><tr><td style="text-align:left">a\</td><td style="text-align:left">b</td><td>a或b</td></tr><tr><td style="text-align:left">C\</td><td style="text-align:left">cat</td><td>C或cat</td></tr><tr><td style="text-align:left">(C\</td><td style="text-align:left">c)at</td><td>Cat或cat</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;grep&quot;&gt;&lt;a href=&quot;#grep&quot; class=&quot;headerlink&quot; title=&quot;grep&quot;&gt;&lt;/a&gt;grep&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;grep&lt;/strong&gt;（global search regular expression(RE) and print out the line），是一款文本过滤（模式：pattern）工具。&lt;/p&gt;
    
    </summary>
    
      <category term="Command" scheme="http://subtraction.tech/categories/Command/"/>
    
    
      <category term="grep" scheme="http://subtraction.tech/tags/grep/"/>
    
      <category term="RE" scheme="http://subtraction.tech/tags/RE/"/>
    
  </entry>
  
  <entry>
    <title>多网卡绑定配置-bonding</title>
    <link href="http://subtraction.tech/Network/%E5%A4%9A%E7%BD%91%E5%8D%A1%E7%BB%91%E5%AE%9A%E9%85%8D%E7%BD%AE-bonding/"/>
    <id>http://subtraction.tech/Network/多网卡绑定配置-bonding/</id>
    <published>2017-07-06T06:26:52.000Z</published>
    <updated>2018-04-23T12:43:50.134Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="Bonding概述"><a href="#Bonding概述" class="headerlink" title="Bonding概述"></a>Bonding概述</h3><p>所谓bonding就是将多块网卡绑定同一IP地址对外提供服务，可以实现网卡的带宽扩容、高可用或者负载均衡，具体的功能取决于采用的哪种bonding模式。<br>一般情况下，将多块网卡设置同一IP地址是不可能的，会导致IP地址的冲突，导致网络不可用。但是通过bonding，可以将多个物理网卡的MAC地址修改为相同的MAC地址，虚拟出一块网卡对外提供连接。其原理类似RAID，虽是多块网卡，但对访问者来说则是一块网卡。由于是将多块网卡合为一块使用，所以能够得到更好的更快的性能。</p><a id="more"></a><p>bonding技术在生产场景中是一种常用的技术。其实在 Sun和Cisco中早已存在并应用，被称为Trunking和Etherchannel技术，在Linux的Kernels 2.4.12及以后的版本中也采用了这种技术，被称为 bonding。 像Samba、Nfs这种共享文件系统，网络的吞吐量非常大，就造成网卡的压力很大，就会用到bonding技术。</p><h3 id="Bonding的优点"><a href="#Bonding的优点" class="headerlink" title="Bonding的优点"></a>Bonding的优点</h3><h4 id="网络的负载均衡"><a href="#网络的负载均衡" class="headerlink" title="网络的负载均衡"></a>网络的负载均衡</h4><p>bonding的网络负载均衡是我们在文件服务器中常会用到的，比如把多块网卡，当做一块来用，解决一个IP地址，流量过大，服务器网络压力过大的问题。对于文件服务器来说，比如NFS或SAMBA文件服务器，没有任何一个管理员会把内部网的文件服务器的IP地址弄很多个来解决网络负载的问题。如果在内网中，文件服务器为了管理和应用上的方便，大多是用同一个IP地址。对于一个百兆的本地网络来说，文件服务器在多个用户同时使用的情况下，网络压力是极大的，特别是SAMABA和NFS服务器。为解决同一个IP地址，突破流量的限制。如何在有限的资源的情况 下，实现网络负载均衡，最好的办法就是 bonding 。</p><h4 id="网络的冗余高可用"><a href="#网络的冗余高可用" class="headerlink" title="网络的冗余高可用"></a>网络的冗余高可用</h4><p>对于服务器来说，网络设备的稳定也是比较重要的，特别是网卡。在生产型的系统中，网卡的可靠性就更为重要了。在生产型的系统中，大多通过硬件设备的冗余来 提供服务器的可靠性和安全性，比如电源。bonding 也能为网卡提供冗余的支持。把网个网卡绑定到一个IP地址，当一块网卡发生物理性损坏的情况下，另一块网卡也能提供正常的服务。</p><hr><h3 id="Bonding的常见绑定模式"><a href="#Bonding的常见绑定模式" class="headerlink" title="Bonding的常见绑定模式"></a>Bonding的常见绑定模式</h3><h4 id="Mode-0-balance-rr"><a href="#Mode-0-balance-rr" class="headerlink" title="Mode 0 (balance-rr)"></a>Mode 0 (balance-rr)</h4><p><strong>轮转（Round-robin）策略：</strong>从头到尾的顺序在每一个从属设备接口上面发送数据包，一条链路故障会自动切换正常链路。<br><strong><em>特点：</em></strong>本模式提供负载均衡和容错的能力。传输数据包顺序是依次传输（即：第1个包走eth0，下一个包就走eth1….一直循环下去，直到最后一个传输完毕）；但是如果一个连接或者会话的数据包从不同的接口发出的话，中途再经过不同的链路，在客户端很有可能会出现数据包无序到达的问题，而无序到达的数据包需要重新要求被发送，这样网络的吞吐量就会下降。而且需要在接入交换机做端口聚合，否则可能无法使用。</p><h4 id="Mode-1-active-backup"><a href="#Mode-1-active-backup" class="headerlink" title="Mode 1 (active-backup)"></a>Mode 1 (active-backup)</h4><p><strong>活动-备份（主备）策略：</strong>只有一个从属设备处于活动状态，其它从属设备处于备用状态，只有在活动的从属设备接口宕掉时才会激活其他从属设备，所有流量都在活动的链路上处理。为了避免交换机发生混乱，此时绑定的MAC地址只在一个外部端口上可见。交换机配置的是捆绑的话将不能工作，因为交换机往两块网卡发包，有一半包是丢弃的。<br><strong><em>特点：</em></strong>此模式只提供容错能力，优点是可以提供高网络连接的可用性，但资源利用率较低，只有一个接口处于工作状态，在有 N 个网络接口的情况下，资源利用率为1/N。</p><h4 id="Mode-3-broadcast"><a href="#Mode-3-broadcast" class="headerlink" title="Mode 3 (broadcast)"></a>Mode 3 (broadcast)</h4><p><strong>广播策略：</strong>在所有的从属设备接口上传送所有的报文，提供容错能力。<br><strong><em>特点：</em></strong>所有包从所有网络接口发出，不做均衡，只有冗余机制，过于浪费资源。此模式适用于金融行业，因为他们需要高可靠性的网络，不允许出现任何问题。此模式需要和交换机的聚合强制不协商方式配合。</p><hr><h3 id="CentOS-6-实现Bonding配置"><a href="#CentOS-6-实现Bonding配置" class="headerlink" title="CentOS 6 实现Bonding配置"></a>CentOS 6 实现Bonding配置</h3><h4 id="创建Bonding设备的配置文件"><a href="#创建Bonding设备的配置文件" class="headerlink" title="创建Bonding设备的配置文件"></a>创建Bonding设备的配置文件</h4><p>创建bonding设备的第一步就是要先创建bond设备文件，由于之前系统没有，所以需要自己手工创建，分别是一个bond配置文件和两个从属bond的网卡配置文件。具体的操作步骤和配置文件写法，请看下面：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/sysconfig/network-scripts/ </span><br><span class="line"><span class="comment">#进入到/etc/sysconfig/network-scripts/目录</span></span><br><span class="line">vim ifcfg-bond0</span><br><span class="line"><span class="comment">#使用vim创建并编辑ifcfg-bond0配置文件，文件内容如下：</span></span><br><span class="line"><span class="attribute">DEVICE</span>=bond0</span><br><span class="line"><span class="attribute">BONDING_OPTS</span>=<span class="string">"mode=0 miimon=100"</span></span><br><span class="line"><span class="comment">#mode是用来指明bond模式的。如果mode=0，那么代表此bond设备使用的是0模式，(balance-rr)轮转策略。有0-6七种bond模式可以选择。</span></span><br><span class="line"><span class="comment">#miimon是用来进行链路监测的。如果miimon=100，那么系统每100ms 监测一次链路连接状态，如果有一条线路不通就转入另一条线路</span></span><br><span class="line"><span class="attribute">IPADDR</span>=172.18.23.33</span><br><span class="line"><span class="attribute">PREFIX</span>=16</span><br><span class="line"><span class="attribute">GATEWAY</span>=172.18.0.1</span><br><span class="line">vim ifcfg-eth0</span><br><span class="line"><span class="comment">#如果参与bond的设备配置文件存在，则直接编辑。</span></span><br><span class="line"><span class="attribute">DEVICE</span>=eth0</span><br><span class="line"><span class="attribute">BOOTPROTO</span>=none</span><br><span class="line"><span class="attribute">MASTER</span>=bond0</span><br><span class="line"><span class="comment">#MASTER=bond0说明主设备是bond0</span></span><br><span class="line"><span class="attribute">SLAVE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="comment">#SLAVE=yes说明这个设备是仆从设备</span></span><br><span class="line"><span class="attribute">USERCTL</span>=<span class="literal">no</span></span><br><span class="line"><span class="comment">#USERCTL=no指明普通用户不能配置此设备，改为yes，则普通用户也可以配置此设备。</span></span><br><span class="line">cp ifcfg-eth0 ifcfg-eth1</span><br><span class="line"><span class="comment">#如果参与bond的设备配置文件不存在，则创建后再编辑，可以选择复制已有的设备文件，因为除了设备名外其它配置都一样。</span></span><br><span class="line">vim ifcfg-eth1</span><br><span class="line"><span class="attribute">DEVICE</span>=eth1</span><br><span class="line"><span class="attribute">BOOTPROTO</span>=none</span><br><span class="line"><span class="attribute">MASTER</span>=bond0</span><br><span class="line"><span class="attribute">SLAVE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">USERCTL</span>=<span class="literal">no</span></span><br></pre></td></tr></table></figure><h4 id="生效Bond设备"><a href="#生效Bond设备" class="headerlink" title="生效Bond设备"></a>生效Bond设备</h4><p>在创建修改好bond的配置文件后，并不会立即生效，需要重启网络服务方可生效。在这里请大家注意一下NetworkManager服务，这个服务是用于图形界面的网络配置的，如果不需要最好关掉，不然会影响许多网络配置的生效。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">关闭NetworkManager服务</span><br><span class="line">chkconfig NetworkManager  off</span><br><span class="line">#禁止服务开机自启动</span><br><span class="line"><span class="built_in">service </span>NetworkManager  stop</span><br><span class="line">#停止服务</span><br><span class="line">重启网络服务</span><br><span class="line"><span class="built_in">service network </span>restart</span><br></pre></td></tr></table></figure><h4 id="查看Bond0状态"><a href="#查看Bond0状态" class="headerlink" title="查看Bond0状态"></a>查看Bond0状态</h4><p>在重启网络服务之后，需要去查看bond的状态，确保bond启用成功。一般会用到ifconfig、cat /proc/net/bonding/bond0  、cat /sys/class/net/bond0/bonding/mode 这三个命令。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ifconfig</span> </span><br><span class="line"><span class="comment">#使用ifconfig命令可以查看设备的bond信息，下图中三个设备MAC地址相同，原eth0、eth1IP地址失效，两块网卡共用bond0设备的一个IP地址。下图中蓝线标注的是这三个设备的主仆关系。</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/B56DkHkGbE.png?imageslim" alt="mark"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="regexp">/proc/</span>net<span class="regexp">/bonding/</span>bond0 </span><br><span class="line"><span class="comment">#查看bond0的状态信息，有些信息是ifconfig看不到的，如：设备的up或down。</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180422/68aCDI0bfG.png?imageslim" alt="mark"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="regexp">/sys/</span>class<span class="regexp">/net/</span>bond0<span class="regexp">/bonding/m</span>ode </span><br><span class="line">balance-rr <span class="number">0</span></span><br><span class="line"><span class="comment">#这条命令可以查看bond设备的模式策略，如balance-rr 0则表示是0模式，轮转策略。</span></span><br></pre></td></tr></table></figure><h3 id="删除Bond0"><a href="#删除Bond0" class="headerlink" title="删除Bond0"></a>删除Bond0</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ifconfig bond0 down</span><br><span class="line"><span class="comment">#禁用bond0设备</span></span><br><span class="line">rm -rf /etc/sysconfig/network-scripts/ifcfg-bond0 </span><br><span class="line"><span class="comment">#删除bond0设备的配置文件</span></span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line"><span class="comment">#将配置文件改回，删除和bond有关的设置。</span></span><br><span class="line"><span class="attribute">DEVICE</span>=eth0</span><br><span class="line"><span class="attribute">BOOTPROTO</span>=dhcp</span><br><span class="line">#此项改为dhcp后，网卡会启用dhcp服务，自动获取IP、gateway、dns等网络配置。</span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eth1</span><br><span class="line"><span class="attribute">DEVICE</span>=eth1</span><br><span class="line"><span class="attribute">BOOTPROTO</span>=dhcp</span><br><span class="line">lsmod |grep bonding</span><br><span class="line"><span class="comment">#查看bonding模块是否存在</span></span><br><span class="line">bonding               132885  0 </span><br><span class="line">rmmod bonding</span><br><span class="line"><span class="comment">#卸载bonding模块</span></span><br><span class="line">lsmod |grep bonding</span><br><span class="line"><span class="comment">#确认成功卸载</span></span><br><span class="line">service<span class="built_in"> network </span>restart</span><br><span class="line"><span class="comment">#重启网络服务</span></span><br></pre></td></tr></table></figure><h3 id="关于Bonding详细帮助"><a href="#关于Bonding详细帮助" class="headerlink" title="关于Bonding详细帮助"></a>关于Bonding详细帮助</h3><p>bonding功能强大，其功能远不止于此，比如我在此没有介绍的其它四种bonding模式，以及其具体的配置方法，注意事项。都可以在下面的文档中查到，有兴趣的朋友可以深入研读一下。</p><blockquote><p>Linux系统自带帮助文档，需要先安装才能查看。<br>yum  install  kernel-doc<br>less/usr/share/doc/kernel-doc-version/Documentation/networking/bonding.txt</p></blockquote><blockquote><p>官网文档<br><a href="https://www.kernel.org/doc/Documentation/networking/bonding.txt" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/networking/bonding.txt</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;Bonding概述&quot;&gt;&lt;a href=&quot;#Bonding概述&quot; class=&quot;headerlink&quot; title=&quot;Bonding概述&quot;&gt;&lt;/a&gt;Bonding概述&lt;/h3&gt;&lt;p&gt;所谓bonding就是将多块网卡绑定同一IP地址对外提供服务，可以实现网卡的带宽扩容、高可用或者负载均衡，具体的功能取决于采用的哪种bonding模式。&lt;br&gt;一般情况下，将多块网卡设置同一IP地址是不可能的，会导致IP地址的冲突，导致网络不可用。但是通过bonding，可以将多个物理网卡的MAC地址修改为相同的MAC地址，虚拟出一块网卡对外提供连接。其原理类似RAID，虽是多块网卡，但对访问者来说则是一块网卡。由于是将多块网卡合为一块使用，所以能够得到更好的更快的性能。&lt;/p&gt;
    
    </summary>
    
      <category term="Network" scheme="http://subtraction.tech/categories/Network/"/>
    
    
      <category term="HA" scheme="http://subtraction.tech/tags/HA/"/>
    
  </entry>
  
  <entry>
    <title>Linux文件查找利器 locate &amp; find</title>
    <link href="http://subtraction.tech/Command/Linux%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE%E5%88%A9%E5%99%A8-locate-find/"/>
    <id>http://subtraction.tech/Command/Linux文件查找利器-locate-find/</id>
    <published>2017-07-02T19:01:27.000Z</published>
    <updated>2018-04-23T12:44:08.535Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Linux的哲学思想就是一切皆文件，整个Linux系统就是由一个个的文件组成。所以对于Linux用户来说，与文件打交道是必不可少的工作。小到普通文件，大到配置文件、设备文件，可谓是一切皆文件。面对这些不计其数的文件，如何高效的查找文件，也是熟练使用Linux必不可少的技能了。<br>面对Linux里面这些海量的文件，怎样才能进行有效的快速的查找呢？这就要用到接下来要讲的locate和find命令了。locate和find是两个功能非常强大的查找命令，特别是find命令选项众多，使用选项时的灵活配合，可以帮助你快速找到想要的文件。</p><a id="more"></a><hr><h3 id="locate和find命令简介"><a href="#locate和find命令简介" class="headerlink" title="locate和find命令简介"></a>locate和find命令简介</h3><p>locate命令是一个基于数据库的快速文件搜索工具，其工作原理是在系统里创建一个包含了系统内所有文件名以及路径的文件索引数据库，搜索依赖于事先构建的索引数据库进行。由于是基于数据库（/var/lib/mlocate/mlocate.db）的搜索，所以locate命令的查找不具有实时性。locate所找的文件若是最近才创建或刚更名的，可能会找不到。<br>系统内的文件是时常改变的，数据库也不能一成不变，否则就很难达到文件查找的作用，所以索引数据库在创建好之后一般都会被放入到自动计划里，定时自动更新。此外，管理员也可以通过updatedb命令进行实时的更新，但会相当耗费系统资源，所以不要在访问高峰时段更新数据库。<br>由于locate命令进行文件的查找时，是去文件索引数据库里查找，而非深入系统中的去查找，所以比find命令整个硬盘搜寻文件速度要快。locate命令具有以下工作特性。<br><strong>locate命令工作特性：</strong></p><ul><li>查找速度快</li><li>模糊查找</li><li>非实时查找</li><li>搜索的是文件的全路径，不仅仅是文件名</li><li>可能只搜索用户具备读取和执行权限的目录</li></ul><p>find命令是一个实时查找工具，通过不同查找路径、查找条件、处理动作的组合，可以完成非常复杂的查找任务，功能非常多样且实用。而且，find命令还支持通配符和正则表达式的使用，使搜索变的更加灵活。由于是实时遍历查找，find有如下特性。<br><strong>find命令工作特点：</strong></p><ul><li>列表内容</li><li>查找速度略慢</li><li>精确查找</li><li>实时查找</li><li>可能只搜索用户具备读取和执行权限的目录</li></ul><hr><h3 id="locate命令用法"><a href="#locate命令用法" class="headerlink" title="locate命令用法"></a>locate命令用法</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">locate [OPTION]... PATTERN...</span><br></pre></td></tr></table></figure><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">常用选项：</span><br><span class="line">-<span class="ruby">i   不区分大小写 </span></span><br><span class="line"><span class="ruby">-n N   只列举前N个匹配项目</span></span><br><span class="line"><span class="ruby">-r   使用扩展的正则表达式来匹配搜索</span></span><br></pre></td></tr></table></figure><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">示例:</span><br><span class="line">locate passwd</span><br><span class="line">查找文件名包含passwd的文件</span><br><span class="line">locate <span class="keyword">conf</span></span><br><span class="line">搜索名称或路径中带有“<span class="keyword">conf</span>”的文件</span><br><span class="line">locate -r '\.<span class="keyword">conf</span>$'</span><br><span class="line">使用Regex来搜索以“.<span class="keyword">conf</span>”结尾的文件</span><br></pre></td></tr></table></figure><hr><h3 id="find命令用法"><a href="#find命令用法" class="headerlink" title="find命令用法"></a>find命令用法</h3><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find <span class="string">[OPTION]</span>... <span class="string">[查找路径]</span> <span class="string">[查找条件]</span> <span class="string">[处理动作]</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查找路径：指定具体目标路径；默认为当前目录。</span><br><span class="line">查找条件：指定的查找标准，可以文件名、大小、类型、权限等标准进行；默认找出指定路径下的所有文件。</span><br><span class="line">处理动作：对符合条件的文件做操作，默认输出至屏幕。</span><br></pre></td></tr></table></figure><p><strong>使用时如果不选定参数，则在当前目录下查找子目录与文件并显示；且任何位于参数之前的字符串，都将视为欲查找的目录名。</strong></p><h4 id="查找条件："><a href="#查找条件：" class="headerlink" title="查找条件："></a>查找条件：</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">搜索层级</span><br><span class="line">-<span class="ruby">maxdepth  level最大搜索目录深度，指定目录为第一等级</span></span><br><span class="line"><span class="ruby">-mindepth  level最小搜索目录深度</span></span><br></pre></td></tr></table></figure><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">文件名和iNode</span><br><span class="line">-<span class="ruby">name  <span class="string">"文件名称"</span>      搜索指定名称的文件，支持使用glob</span></span><br><span class="line"><span class="ruby">-iname  <span class="string">"文件名称"</span>     搜索时不区分字母大小写</span></span><br><span class="line"><span class="ruby">-inum  n              按iNode号查找</span></span><br><span class="line"><span class="ruby">-samefile  name       查找相同iNode号的文件</span></span><br><span class="line"><span class="ruby">-links  n             查找链接数为n的文件</span></span><br><span class="line"><span class="ruby">-regex  <span class="string">"PATTERN"</span>     以正则表达式匹配整个文件路径字符串，而不仅仅是文件名称</span></span><br></pre></td></tr></table></figure><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">属组和属主</span><br><span class="line">-<span class="ruby">user username查找属主为指定用户的文件</span></span><br><span class="line"><span class="ruby">-group groupname查找属组为指定组的文件</span></span><br><span class="line"><span class="ruby">-uid userid查找属主为指定UID的文件</span></span><br><span class="line"><span class="ruby">-gid gourpid查找属组为指定GID的文件</span></span><br><span class="line"><span class="ruby">-nouser查找没有属主的文件</span></span><br><span class="line"><span class="ruby">-nogroup查找没有属组的文件</span></span><br><span class="line"><span class="ruby">示例：</span></span><br><span class="line"><span class="ruby">find / -nouser</span></span><br><span class="line"><span class="ruby">搜寻系统中不属于任何人的档案，透过这个指令，可以轻易的就找出那些不太正常的档案。</span></span><br></pre></td></tr></table></figure><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">文件类型</span><br><span class="line">-<span class="keyword">type</span> <span class="type">f</span>普通文件 </span><br><span class="line">-<span class="keyword">type</span> <span class="type">d </span>目录文件</span><br><span class="line">-<span class="keyword">type</span> <span class="type">l </span>符号链接文件</span><br><span class="line">-<span class="keyword">type</span> <span class="type">s </span>套接字文件</span><br><span class="line">-<span class="keyword">type</span> <span class="type">b</span>块设备文件</span><br><span class="line">-<span class="keyword">type</span> <span class="type">c</span>字符设备文件</span><br><span class="line">-<span class="keyword">type</span> <span class="type">p</span>管道文件</span><br><span class="line">示例：</span><br><span class="line">find /dev -<span class="keyword">type</span> <span class="type">b</span></span><br><span class="line"><span class="type"></span>查找/dev目录下的块设备</span><br></pre></td></tr></table></figure><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">文件大小</span><br><span class="line">-size [+|-] #unit</span><br><span class="line">常用单位:k 、M 、G 、c (byte)</span><br><span class="line">#UNIT: (#<span class="number">-1</span>, #]</span><br><span class="line">如：<span class="number">6</span>k 表示(<span class="number">5</span>k,<span class="number">6</span>k]</span><br><span class="line">-#UNIT：[<span class="number">0</span>,#<span class="number">-1</span>]</span><br><span class="line">如：<span class="number">-6</span>k 表示[<span class="number">0</span>,<span class="number">5</span>k]</span><br><span class="line">+#UNIT：(#,∞)</span><br><span class="line">如：+<span class="number">6</span>k 表示(<span class="number">6</span>k,∞)</span><br><span class="line">示例： </span><br><span class="line">find / -size +<span class="number">1000</span>k</span><br><span class="line">找出系统中，大于 <span class="number">1</span>MB 的档案</span><br></pre></td></tr></table></figure><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">时间戳</span><br><span class="line">以“天”为单位；</span><br><span class="line">-<span class="ruby">atime[+<span class="params">|-]#   </span></span></span><br><span class="line"><span class="ruby"><span class="comment">#: [#,#+1)</span></span></span><br><span class="line"><span class="ruby"><span class="comment">#为数字，意义为在#天之前的一天之内被access过的文件</span></span></span><br><span class="line"><span class="ruby">+<span class="comment">#: [#+1,∞]</span></span></span><br><span class="line"><span class="ruby">在<span class="comment">#加一天后被access过的文件</span></span></span><br><span class="line"><span class="ruby">-<span class="comment">#: [0,#)</span></span></span><br><span class="line"><span class="ruby">在<span class="comment">#天之前被access过的文件</span></span></span><br><span class="line"><span class="ruby">-mtime       被 modification 过的档案</span></span><br><span class="line"><span class="ruby">-ctime       被 change 过状态的档案</span></span><br><span class="line"><span class="ruby">以“分钟”为单位：</span></span><br><span class="line"><span class="ruby">-amin</span></span><br><span class="line"><span class="ruby">-mmin</span></span><br><span class="line"><span class="ruby">-cmin</span></span><br><span class="line"><span class="ruby">-newer file ：</span></span><br><span class="line"><span class="ruby">file为一个存在的文件，只要文件比file还要新，就会被列出来。 用在分辨两个档案之间的新旧关系是很有用的！</span></span><br><span class="line"><span class="ruby">示例：</span></span><br><span class="line"><span class="ruby">find / -atime <span class="number">0</span></span></span><br><span class="line"><span class="ruby"><span class="number">0</span> 代表当前的时间，从现在开始到<span class="number">24</span>小时前被访问过的文件</span></span><br><span class="line"><span class="ruby">find / -mtime <span class="number">3</span> ，</span></span><br><span class="line"><span class="ruby">列出今天之前的 <span class="number">3</span>*<span class="number">24</span> ~ <span class="number">4</span>*<span class="number">24</span> 小时之间有变动过的文件</span></span><br><span class="line"><span class="ruby">find /etc -newer /etc/passwd</span></span><br><span class="line"><span class="ruby">查找 /etc 底下的档案，如果档案日期比 /etc/passwd 新就列出</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/ck8bIlG9AF.png?imageslim" alt="mark"></p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">权限</span><br><span class="line">-perm [/|-]<span class="built_in">MODE</span></span><br><span class="line">MO<span class="symbol">DE:</span> 精确权限匹配</span><br><span class="line">/<span class="built_in">MODE</span>：任何一类(u,g,o)对象的权限中只要能一位匹配即可，或关系，</span><br><span class="line">-<span class="built_in">MODE</span>：每一类对象都必须同时拥有指定权限，与关系</span><br><span class="line">对于/<span class="built_in">MODE</span>和-<span class="built_in">MODE</span>，<span class="number">0</span>权限表示不关注</span><br><span class="line">示例：</span><br><span class="line"><span class="built_in">find</span> -perm <span class="number">755</span>    </span><br><span class="line">只会匹配权限模式恰好是<span class="number">755</span>的文件</span><br><span class="line"><span class="built_in">find</span> -perm /<span class="number">222</span>   </span><br><span class="line">只要任何人有写权限，就会匹配</span><br><span class="line"><span class="built_in">find</span> -perm -<span class="number">222</span> </span><br><span class="line"> 只有当每个人都有写权限时，才会匹配</span><br><span class="line"><span class="built_in">find</span> -perm -<span class="number">002</span>  </span><br><span class="line">只有当其它人（other）有写权限时，才会匹配</span><br></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">组合条件</span><br><span class="line">与：-a</span><br><span class="line">或：-o</span><br><span class="line">非: -not ，！</span><br><span class="line">德·摩根定律：</span><br><span class="line">(非A) 或(非B) = 非(A 且B)</span><br><span class="line">(非A) 且(非B) = 非(A 或B)</span><br><span class="line">示例：</span><br><span class="line">!A -<span class="selector-tag">a</span> !B = !(A -o B)</span><br><span class="line">!A -o !B = !(A -<span class="selector-tag">a</span> B)</span><br><span class="line">排除：-prune</span><br><span class="line">路径：-path </span><br><span class="line">示例<span class="number">1</span>：</span><br><span class="line">find /etc -path ‘/etc/sane.d’ -<span class="selector-tag">a</span> -prune -o -name “*.conf”</span><br><span class="line">在/etc目录下查找除/etc/sane<span class="selector-class">.d</span> 目录之外的以.conf结尾的文件</span><br><span class="line">示例<span class="number">2</span>：</span><br><span class="line">find /etc \( -path <span class="string">'/etc/sane.d'</span> -o -path <span class="string">'/etc/fonts'</span> \) -<span class="selector-tag">a</span> prune -o -name <span class="string">"*.conf"</span></span><br><span class="line">查找/etc目录下除/etc/sane.d和/etc/fonts目录外的以.conf结尾的文件</span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/3a2JkghaLi.png?imageslim" alt="mark"><br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/dgjGAKCE3j.png?imageslim" alt="mark"></p><h4 id="处理动作"><a href="#处理动作" class="headerlink" title="处理动作:"></a>处理动作:</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">print</span></span><br><span class="line"><span class="ruby"> 显示至屏幕，默认的处理动作</span></span><br><span class="line"><span class="ruby">-ls</span></span><br><span class="line"><span class="ruby">类似于对查找到的文件执行“ls -l”命令  默认只显示最后一项查找的长格式，如果要都显示需要加\(  \),括号内条件要和括号间有空格。</span></span><br><span class="line"><span class="ruby">-delete</span></span><br><span class="line"><span class="ruby">删除查找到的文件</span></span><br><span class="line"><span class="ruby">-fls file</span></span><br><span class="line"><span class="ruby">把查找到的所有文件以长格式信息保存至指定文件中</span></span><br><span class="line"><span class="ruby">-ok COMMAND &#123;&#125; \； </span></span><br><span class="line"><span class="ruby">对查找到的每个文件执行指定的命令，对于每个文件执行命令之前，都会交互式要求用户确认</span></span><br><span class="line"><span class="ruby">-exec COMMAND &#123;&#125; \;</span></span><br><span class="line"><span class="ruby"> 对查找到的每个文件执行由COMMAND指定的命令，没有交互式确认，慎重使用。</span></span><br><span class="line"><span class="ruby">&#123;&#125;</span></span><br><span class="line"><span class="ruby"> 用于引用查找到的文件名称自身，相当于一个变量。</span></span><br><span class="line"><span class="ruby">\;</span></span><br><span class="line"><span class="ruby">表示结束，前面要有空格，否则会有语法错误</span></span><br><span class="line"><span class="ruby">示例：</span></span><br><span class="line"><span class="ruby">find -name “*.conf” -exec cp &#123;&#125; &#123;&#125;.orig \;</span></span><br><span class="line"><span class="ruby">备份配置文件，添加.orig这个扩展名</span></span><br><span class="line"><span class="ruby">find /tmp -ctime +<span class="number">3</span> -user joe -ok rm &#123;&#125; \;</span></span><br><span class="line"><span class="ruby">查找删除存在时间超过３天以上的joe的临时文件</span></span><br><span class="line"><span class="ruby">find ~ -perm -<span class="number">002</span> -exec chmodo -w &#123;&#125; \;</span></span><br><span class="line"><span class="ruby">在你的主目录中寻找可被其它用户写入的文件，找到后取消写权限</span></span><br><span class="line"><span class="ruby">find / -perm +<span class="number">7000</span> -exec ls -l &#123;&#125; \;</span></span><br><span class="line"><span class="ruby">将找到的文件使用 ls -l 列出来</span></span><br></pre></td></tr></table></figure><hr><h3 id="补充：参数替换命令xargs"><a href="#补充：参数替换命令xargs" class="headerlink" title="补充：参数替换命令xargs"></a>补充：参数替换命令xargs</h3><blockquote><p>由于很多命令不支持管道 “|”来传递参数，而日常工作中有这个必要，所以就有了xargs命令。xargs用于产生某个命令的参数，xargs可以读入标准输入的数据，并且以空格符或回车符将标准输入的数据分隔成为参数。<br>find传递查找到的文件至后面指定的命令时，查找到所有符合条件的文件一次性传递给后面的命令，有些命令不能接受过多参数，命令执行可能会失败，这个问题xargs可以解决。<br><strong>注意：文件名或者是其他意义的名词内含有空格符的情况</strong><br><strong>find和xargs格式：find | xargs COMMAND</strong></p></blockquote><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line"><span class="keyword">ls</span>  f*  | xargs  rm</span><br><span class="line">列出以f开头的文件传递给rm删除</span><br><span class="line">查找<span class="string">/sbin</span>下属主拥有读写执行任何一项权限的文件以长格式列出</span><br><span class="line">find  <span class="string">/sbin</span>  -perm +700  | <span class="keyword">ls</span> -l </span><br><span class="line">这个命令是错误的，不会成功执行。</span><br><span class="line">find  <span class="string">/sbin</span>  -perm +700  | xargsls  –l  </span><br><span class="line">    正确写法</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>如果你要查找一个文件的话，使用 find 会是一个不错的主意！ find具有众多的参数指令，而且还支持正则表达式和通配符，使用灵活。根据文件的属性使用find命令进行查找也非常实用，配合处理命令可以完成许多复杂的工作,尤其是在查找特殊的文件，以及特殊的文件权限 (SUID/SGID等等) 时， 是相当有用的工具之一！不过缺点也是很明显的，速度上和locate就没法比了。locate是一个快速搜索工具，缺点是在功能上比find逊色一些，但在进行一些不算复杂的搜索时，还是locate快速有效。<br>希望看过之后对你有所帮助，祝你用好locate &amp; find，提高工作效率。</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;Linux的哲学思想就是一切皆文件，整个Linux系统就是由一个个的文件组成。所以对于Linux用户来说，与文件打交道是必不可少的工作。小到普通文件，大到配置文件、设备文件，可谓是一切皆文件。面对这些不计其数的文件，如何高效的查找文件，也是熟练使用Linux必不可少的技能了。&lt;br&gt;面对Linux里面这些海量的文件，怎样才能进行有效的快速的查找呢？这就要用到接下来要讲的locate和find命令了。locate和find是两个功能非常强大的查找命令，特别是find命令选项众多，使用选项时的灵活配合，可以帮助你快速找到想要的文件。&lt;/p&gt;
    
    </summary>
    
      <category term="Command" scheme="http://subtraction.tech/categories/Command/"/>
    
    
      <category term="find" scheme="http://subtraction.tech/tags/find/"/>
    
      <category term="locate" scheme="http://subtraction.tech/tags/locate/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7搭建yum服务器</title>
    <link href="http://subtraction.tech/Automate/CentOS-7%E6%90%AD%E5%BB%BAyum%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>http://subtraction.tech/Automate/CentOS-7搭建yum服务器/</id>
    <published>2017-06-23T08:15:34.000Z</published>
    <updated>2018-04-23T12:37:17.687Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本篇文章要讲述的是如何在CentOS 7上搭建yum服务器，来为网络中的计算机提供yum服务。但在开始正式的搭建之前，我还要先向读者朋友们介绍一下什么是yum，以及yum服务器是用来做什么的。有了对yum作用的基本了解，才能对搭建yum服务器的必要性有充分的认识。</p><a id="more"></a><p>首先你要知道什么是yum，yum（全称为 Yellow dog Updater, Modified）是一个在Fedora和RedHat以及CentOS中的Shell前端软件包管理器。基于RPM包管理，能够从指定的服务器自动下载RPM包并且安装，可以自动处理依赖性关系，并且一次安装所有依赖的软件包，从而无须繁琐地一次次下载、安装、升级。<br>看到yum的强大功能后，你是否会好奇它是如何实现的？下面我就为朋友们简单介绍一下yum的工作机制，让大家对接下来要进行的yum服务搭建，有一个原理性的认识。</p><h3 id="yum的工作机制"><a href="#yum的工作机制" class="headerlink" title="yum的工作机制"></a>yum的工作机制</h3><h4 id="yum服务器"><a href="#yum服务器" class="headerlink" title="yum服务器:"></a>yum服务器:</h4><p> yum服务器的作用主要是为yum客户机提供访问，上面提供了用户所需的所有RPM软件包，并且会根据这些软件包生成一份元数据repodate,这里面记录有所有软件包的信息，以及依赖关系等。</p><h4 id="yum客户端："><a href="#yum客户端：" class="headerlink" title="yum客户端："></a>yum客户端：</h4><p>yum客户端可通过FTP或HTTP这类网络协议来访问yum服务器，缓存下yum服务器上提供的缓存数据文件，通过这份文件获取需要的软件包，然后去服务器一次性下载安装，解决依赖性问题。</p><p><em>有了上面的简单介绍，我想你应该对yum有了初步的了解，yum可谓是一个自动化管理软件包的神器，无论是在学习还是生产中，对yum的使用都是必不可少的，它可以大大的提高我们的工作效率，解决令使用者头疼的软件包依赖问题。当然，你应该也可以明白yum的功能是依赖于yum服务器来实现的，所以现在你应该对yum服务器有一个新的认识了。</em></p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>接下来就要开始正式的安装工作了，不过在正式开始之前，还需稍作准备，以确保实验的成功。由于yum服务器是在局域网里面为众多的客户机提供访问服务，所以要在防火墙上打开相应的访问端口，客户机才能进行访问，如果不在防火墙上打开相应的端口或关闭防火墙，即使服务器配置成功，客户机也无法进行访问。所以为了实验的简单易懂，我在这里就为大家直接演示如何关闭Linux上的两大安全堡垒，防火墙和SELinux。</p><h4 id="1-关闭防火墙"><a href="#1-关闭防火墙" class="headerlink" title="1.关闭防火墙"></a>1.关闭防火墙</h4><p>执行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">disable</span> firewalld.service禁止防火墙自启动 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl stop firewalld.service 关闭防火墙服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iptables -vnL验证防火墙是否成功关闭</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/1iDm91jfj6.png?imageslim" alt="mark"></p><h4 id="2-关闭SElinux"><a href="#2-关闭SElinux" class="headerlink" title="2.关闭SElinux"></a>2.关闭SElinux</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/selinux/config             编辑SELinux配置文件</span></span><br><span class="line"><span class="attribute">SELINUX</span>=permissive  更改参数，设置<span class="attribute">SELINUX</span>=permissive</span><br><span class="line">这里用到了vim编辑器，如果对它的使用方法不熟悉，可以出门左拐去看我之前写vim使用手册，这里就不多做介绍了。</span><br></pre></td></tr></table></figure><p>selinux配置文件<br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/aB636BgCb2.png?imageslim" alt="mark"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> setenforce  0    设置监控模式为许可状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> getenforce            验证设置是否生效，设置生效后执行命令后会回显<span class="string">"permissive"</span></span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/83Jkc2I8Ji.png?imageslim" alt="mark"></p><h3 id="安装FTP服务"><a href="#安装FTP服务" class="headerlink" title="安装FTP服务"></a>安装FTP服务</h3><p>做完准备工作后，就可开始搭建的第一步，安装vsftpd软件包，搭建ftp服务器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir /mnt/cdrom         创建挂载点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mount /dev/sr0  /mnt/cdrom/挂载光盘到挂载点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> df                        查看挂载，检查光盘是否挂载成功</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rpm -ivh /mnt/cdrom/Packages/vsftpd-3.0.2-21.el7.x86_64.rpm     使用rpm安装FTP服务</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/AgahbElkdh.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/62b0DJ4Id6.png?imageslim" alt="mark"></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -ql vsftpd检查安装的服务</span></span><br><span class="line">执行rpm -ql vsftpd 命令，确保下面两个文件是存在的。</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">vsftpd</span>.<span class="title">service</span></span></span><br><span class="line">/var/ftp</span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/GmkBf99LLK.png?imageslim" alt="mark"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl start vsftpd      启动ftp服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ss -tnl                     21端口打开，验证服务开启</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">enable</span> vsftpd     设为开机自动启动ftp服务</span></span><br></pre></td></tr></table></figure><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/ea6La3E00a.png?imageslim" alt="mark"></p><h3 id="配置yum服务器"><a href="#配置yum服务器" class="headerlink" title="配置yum服务器"></a>配置yum服务器</h3><p>完成上面的步骤后ftp就搭建成功了，可以开始配置yum服务器了。生产环境内部有可能存在多个版本的系统，所以可以多建几个yum源，放在不同的目录下，供不同版本的系统使用。这里我以centos  6 和 7 为例，创建两个yum源。<br>1.在/var/ftp/pub/下建立两个存放yum源的目录</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p <span class="regexp">/var/</span>ftp<span class="regexp">/pub/</span>centos<span class="regexp">/&#123;6,7&#125;</span></span><br></pre></td></tr></table></figure><p>2.将centos 6 和 7的安装光盘内的软件拷贝到对应目录下。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cp -r /mnt/cdrom/* /var/ftp/pub/centos/7</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp -r /mnt/cdrom/* /var/ftp/pub/centos/6</span></span><br></pre></td></tr></table></figure><p>3.设置完成后我们可在浏览器里访问我们设置好的yum服务器，方式如下：ftp：\\ IP地址<br><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/mf9dlcGhiG.png?imageslim" alt="mark"></p><h3 id="配置yum客户端"><a href="#配置yum客户端" class="headerlink" title="配置yum客户端"></a>配置yum客户端</h3><p>在设置完成服务器之后就可以进行客户端的配置，配置好客户端之后，便可以利用yum服务器进行安装了。<br>1.创建配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">进入到/etc/yum.repos.d/目录中，删除原有配置文件，创建一个名为base.repo的文件，并进行编辑。</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span>  /etc/yum.repos.d/     </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf  *</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/yum.repos.d/base.repo</span></span><br></pre></td></tr></table></figure><p>2.编辑配置文件<br>在配置文件里写入以下内容，就可以完成配置了。<br>[base]     yum仓库名<br>name=描述<br>baseurl=访问yum源的路径<br>enabled=yum仓库是否启用<br>gpgkey=是否检验软件合法性</p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/2fkag28I6m.png?imageslim" alt="mark"></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到此yum服务器的配置就完成了，你可以使用yum安装httpd验证效果，如果使用rpm命令来安装httpd,你会遇到非常令人苦恼的软件包依赖问题，而且依赖关系错综复杂，导致你无法顺利安装。但这个问题却可以通过yum安装来解决。<br>yum是一个非常高效的包管理工具，所以在生产中搭建一台yum服务器是必不可少的，可以大大提升软件的安装、卸载速度。节约时间，提高效率。</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;本篇文章要讲述的是如何在CentOS 7上搭建yum服务器，来为网络中的计算机提供yum服务。但在开始正式的搭建之前，我还要先向读者朋友们介绍一下什么是yum，以及yum服务器是用来做什么的。有了对yum作用的基本了解，才能对搭建yum服务器的必要性有充分的认识。&lt;/p&gt;
    
    </summary>
    
      <category term="Automate" scheme="http://subtraction.tech/categories/Automate/"/>
    
    
      <category term="yum" scheme="http://subtraction.tech/tags/yum/"/>
    
  </entry>
  
  <entry>
    <title>vim使用手册</title>
    <link href="http://subtraction.tech/Command/vim%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/"/>
    <id>http://subtraction.tech/Command/vim使用手册/</id>
    <published>2017-05-23T19:26:49.000Z</published>
    <updated>2018-04-23T12:40:37.011Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="vim简介"><a href="#vim简介" class="headerlink" title="vim简介"></a>vim简介</h3><blockquote><p>Vim是从vi发展出来的一个文本编辑器。拥有特别丰富和方便的编程功能，例如：代码补完、编译及错误跳转等。在程序员中被广泛使用。和Emacs并列成为类Unix系统用户最喜欢的编辑器。</p></blockquote><a id="more"></a><blockquote><p>Vim的第一个版本由布莱姆·米勒在1991年发布。最初的简称是 <em>Vi IMitation</em>，随着功能的不断增加，正式名称改成了 <em>Vi IMproved</em>。现在是在开放源代码方式下发行的自由软件。</p></blockquote><blockquote><p>布莱姆·米勒在80年代末购入他的Amiga计算机时，Amiga上还没有他最常用的编辑器vi。Bram从一个开源的vi复制Stevie开始，开发了Vim的1.0版本。最初的目标只是完全复制vi的功能，那个时候的Vim是 <em>Vi IMitation</em>（模拟）的简称。1991年Vim 1.14版被<em>“Fred Fish Disk #591”</em>这个Amiga用的免费软体集所收录了。1992年1.22版本的Vim被移植到了UNIX和MS-DOS上。从那个时候开始，Vim的全名就变成 <em>Vi IMproved</em>（改良）了。</p></blockquote><blockquote><p>在这之后，Vim加入了不计其数的新功能。做为第一个里程碑的是1994年的3.0版本加入了多视窗编辑模式（分区视窗）。从那之后，同一萤幕可以显示的Vim编辑文件数可以不止一个了。1996年发布的Vim 4.0是第一个利用GUI（图形用户界面）的版本。1998年5.0版本的Vim加入了highlight（语法高亮）功能。2001年的Vim 6.0版本加入了代码折叠、插件、多国语言支持、垂直分区视窗等功能。2006 年5月发布的Vim 7.0版更加入了拼字检查、上下文相关补全，标签页编辑等新功能。2008年8月发布的Vim 7.2，合并了Vim 7.1以来的所有修正补丁，并且加入了脚本的浮点数支持。现在最新的版本是2013年8月发布的Vim 7.4，这个版本除了包含最新修正的补丁之外，还加入了“永久撤销”、“Blowfish算法加密”、“文本隐藏”和“Lua以及Python3的接口”等新功能。</p></blockquote><hr><h3 id="vim的使用方法"><a href="#vim的使用方法" class="headerlink" title="vim的使用方法"></a>vim的使用方法</h3><h4 id="打开文件"><a href="#打开文件" class="headerlink" title="打开文件"></a>打开文件</h4><p><code>vim</code> 是以vim命令后加文件名的方式来打开文件的，但vim功能强大，在打开文件时还可以加入参数实现更多的功能。用法：<code>vim  [OPTION]...  FILE...</code></p><h5 id="vim命令的选项及作用："><a href="#vim命令的选项及作用：" class="headerlink" title="vim命令的选项及作用："></a>vim命令的选项及作用：</h5><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>+</td><td>打开文件后光标默认在尾行行首</td></tr><tr><td>+#</td><td>打开文件后光标处于第#行的行首</td></tr><tr><td>+/PATTERN</td><td>打开文件后，直接让光标处于第一个被PATTERN匹配到的行的行首</td></tr><tr><td>-b file</td><td>以二进制方式打开文件</td></tr><tr><td>-d  file1 file2…</td><td>比较多个文件</td></tr><tr><td>-m  file</td><td>以只读方式打开文件，打开后对文件的修改无法保存</td></tr><tr><td>ex  file 或 vim –e</td><td>直接进入扩展命令模式</td></tr></tbody></table><p><strong>补充:</strong></p><ul><li><p>如果该文件存在，文件被打开并显示内容 </p></li><li><p>如果该文件不存在，当编辑后第一次存盘时创建它</p></li><li><p>如果目录不存在，将无法保存编辑内容</p></li></ul><h3 id="vim的三种模式"><a href="#vim的三种模式" class="headerlink" title="vim的三种模式"></a>vim的三种模式</h3><p><code>vim</code> 是一款模式编辑器，对vim的操作进行在vim的三种模式之上。</p><p><em>所谓三种模式分别是：</em></p><ol><li>命令(Normal)模式 ，默认模式，主要作用是移动光标，剪切/粘贴文本。</li><li>插入(Insert)或编辑模式 ，主要作用是修改文本。</li><li>扩展命令(extended command )模式 ，主要作用是保存，退出等。</li></ol><p>所以，想要娴熟操作vim，在三种模式之间的切换是必不可少的。vim的模式切换是以命令模式为基础的，也就是打开文件时的第一个界面，vim打开文件默认是在命令模式界面。因此，无论你是要进入扩展模式还是插入模式，都需要在命令模式进行切换，扩展模式和插入模式之间是不能直接切换的。</p><h4 id="vim三种主要模式之间的切换："><a href="#vim三种主要模式之间的切换：" class="headerlink" title="vim三种主要模式之间的切换："></a>vim三种主要模式之间的切换：</h4><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>Esc键</td><td>退出当前模式</td></tr><tr><td>2Esc键</td><td>直接返回到命令模式</td></tr><tr><td>Esc键</td><td>插入模式转到命令模式</td></tr><tr><td>：</td><td>命令模式转到扩展命令模式</td></tr><tr><td>2ESC , enter</td><td>扩展命令模式转到命令模式</td></tr></tbody></table><hr><h4 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h4><h5 id="命令模式进入插入模式"><a href="#命令模式进入插入模式" class="headerlink" title="命令模式进入插入模式"></a>命令模式进入插入模式</h5><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>i</td><td>insert, 在光标所在处输入</td></tr><tr><td>I</td><td>在当前光标所在行的行首输入</td></tr><tr><td>a</td><td>append, 在光标所在处后面输入</td></tr><tr><td>A</td><td>在当前光标所在行的行尾输入</td></tr><tr><td>o</td><td>在当前光标所在行的下方打开一个新行</td></tr><tr><td>O</td><td>在当前光标所在行的上方打开一个新行</td></tr></tbody></table><h5 id="命令模式光标间跳转"><a href="#命令模式光标间跳转" class="headerlink" title="命令模式光标间跳转"></a>命令模式光标间跳转</h5><h6 id="字符间跳转："><a href="#字符间跳转：" class="headerlink" title="字符间跳转："></a>字符间跳转：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>h</td><td>左</td></tr><tr><td>l</td><td>右</td></tr><tr><td>j</td><td>下</td></tr><tr><td>k</td><td>上</td></tr><tr><td>#command</td><td>跳转由#指定的个数的字符</td></tr></tbody></table><h6 id="单词间跳转："><a href="#单词间跳转：" class="headerlink" title="单词间跳转："></a>单词间跳转：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>w</td><td>下一个单词的词首</td></tr><tr><td>e</td><td>当前或下一单词的词尾</td></tr><tr><td>b</td><td>当前或前一个单词的词首</td></tr><tr><td>#COMMAND</td><td>由#指定一次跳转的单词数</td></tr></tbody></table><h6 id="当前页跳转："><a href="#当前页跳转：" class="headerlink" title="当前页跳转："></a>当前页跳转：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>H</td><td>页首</td></tr><tr><td>M</td><td>页中间行</td></tr><tr><td>L</td><td>页底</td></tr></tbody></table><h6 id="行首行尾跳转："><a href="#行首行尾跳转：" class="headerlink" title="行首行尾跳转："></a>行首行尾跳转：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>^</td><td>跳转至行首的第一个非空白字符</td></tr><tr><td>0</td><td>跳转至行首</td></tr><tr><td>$</td><td>跳转至行尾</td></tr></tbody></table><h6 id="行间移动："><a href="#行间移动：" class="headerlink" title="行间移动："></a>行间移动：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>#G</td><td>跳转至由#指定行</td></tr><tr><td>G</td><td>最后一行</td></tr><tr><td>1G，gg</td><td>第一行</td></tr></tbody></table><h6 id="句间移动"><a href="#句间移动" class="headerlink" title="句间移动"></a>句间移动</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>)</td><td>下一句</td></tr><tr><td>(</td><td>上一句</td></tr></tbody></table><h6 id="段落间移动："><a href="#段落间移动：" class="headerlink" title="段落间移动："></a>段落间移动：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>}</td><td>下一段</td></tr><tr><td>{</td><td>上一段</td></tr></tbody></table><h5 id="命令模式翻屏操作"><a href="#命令模式翻屏操作" class="headerlink" title="命令模式翻屏操作"></a>命令模式翻屏操作</h5><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>Ctrl+f</td><td>向文件尾部翻一屏</td></tr><tr><td>Ctrl+b</td><td>向文件首部翻一屏</td></tr><tr><td>Ctrl+d</td><td>向文件尾部翻半屏</td></tr><tr><td>Ctrl+u</td><td>向文件首部翻半屏</td></tr></tbody></table><h5 id="命令模式编辑操作"><a href="#命令模式编辑操作" class="headerlink" title="命令模式编辑操作"></a>命令模式编辑操作</h5><h6 id="字符编辑："><a href="#字符编辑：" class="headerlink" title="字符编辑："></a>字符编辑：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>x</td><td>删除光标处的字符</td></tr><tr><td>#x</td><td>删除光标处起始的#个字符</td></tr><tr><td>xp</td><td>交换光标所在处的字符及其后面字符的位置</td></tr><tr><td>~</td><td>转换大小写</td></tr><tr><td>J</td><td>删除当前行后的换行符</td></tr><tr><td>gU</td><td>变大写</td></tr><tr><td>gu</td><td>变小写</td></tr><tr><td>100 i sun [ESC]</td><td>粘贴“sun”100次</td></tr></tbody></table><h6 id="替换命令-r-replace"><a href="#替换命令-r-replace" class="headerlink" title="替换命令(r, replace)"></a>替换命令(r, replace)</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>r</td><td>替换光标所在处的字符</td></tr><tr><td>R</td><td>切换成REPLACE模式，可进行选择替换</td></tr></tbody></table><h6 id="删除命令（d-delete）"><a href="#删除命令（d-delete）" class="headerlink" title="删除命令（d,delete）"></a>删除命令（d,delete）</h6><table><thead><tr><th>按键</th><th style="text-align:left">作用</th></tr></thead><tbody><tr><td>d</td><td style="text-align:left">删除命令，可结合光标跳转字符，实现范围删除</td></tr><tr><td>d$</td><td style="text-align:left">删除到行尾</td></tr><tr><td>d^</td><td style="text-align:left">删除到非空行首</td></tr><tr><td>d0</td><td style="text-align:left">删除到行首</td></tr><tr><td>dw</td><td style="text-align:left">删除到下一个单词的词首</td></tr><tr><td>de</td><td style="text-align:left">删除到当前或下一单词的词尾</td></tr><tr><td>db</td><td style="text-align:left">删除到当前或前一个单词的词首</td></tr><tr><td>#COMMAND</td><td style="text-align:left">删除到由#指定一次跳转的单词数</td></tr><tr><td>dd</td><td style="text-align:left">删除光标所在的行</td></tr><tr><td>#dd</td><td style="text-align:left">删除光标所在处由#指定的多行</td></tr><tr><td>D</td><td style="text-align:left">从当前光标位置一直删除到行尾，留空行，等同于d$</td></tr></tbody></table><h6 id="复制命令-y-yank-："><a href="#复制命令-y-yank-：" class="headerlink" title="复制命令(y, yank)："></a>复制命令(y, yank)：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>y</td><td>复制，行为相似于d命令</td></tr><tr><td>y$</td><td>复制到行尾</td></tr><tr><td>y0</td><td>复制到行首</td></tr><tr><td>y^</td><td>复制到非空行首</td></tr><tr><td>ye</td><td>复制到当前或下一单词的词尾</td></tr><tr><td>yw</td><td>复制到下一个单词的词首</td></tr><tr><td>yb</td><td>复制到当前或前一个单词的词首</td></tr><tr><td>#COMMAND</td><td>复制到由#指定一次跳转的单词数</td></tr><tr><td>yy</td><td>复制整行</td></tr><tr><td>#yy</td><td>复制光标所在处由#指定的多行</td></tr><tr><td>Y</td><td>从当前光标位置一直复制到行尾，留空行，等同于d$</td></tr></tbody></table><h6 id="粘贴命令-p-paste-："><a href="#粘贴命令-p-paste-：" class="headerlink" title="粘贴命令(p, paste)："></a>粘贴命令(p, paste)：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>p</td><td>缓冲区存的如果为整行，则粘贴当前光标所在行的下方；否则，则粘贴至当前光标所在处的后面</td></tr><tr><td>P</td><td>缓冲区存的如果为整行，则粘贴当前光标所在行的上方；否则，则粘贴至当前光标所在处的前面</td></tr></tbody></table><h6 id="改变命令-c-change"><a href="#改变命令-c-change" class="headerlink" title="改变命令(c, change)"></a>改变命令(c, change)</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>c</td><td>修改后切换成插入模式</td></tr><tr><td>c$</td><td>删除到行尾，并切换成插入模式</td></tr><tr><td>c^</td><td>删除到非空行首，并切换成插入模式</td></tr><tr><td>c0</td><td>删除到行首，并切换成插入模式</td></tr><tr><td>cb</td><td>删除到当前或前一个单词的词首，并切换成插入模式</td></tr><tr><td>ce</td><td>删除到当前或下一单词的词尾，并切换成插入模式</td></tr><tr><td>cw</td><td>删除到下一个单词的词首，并切换成插入模式</td></tr><tr><td>#COMMAND</td><td>删除到由#指定一次跳转的单词数，并切换成插入模式</td></tr><tr><td>cc</td><td>删除当前行，并切换成插入模式</td></tr><tr><td>#cc</td><td>删除#指定的多行，并切换成插入模式</td></tr><tr><td>C</td><td>删除当前光标到行尾，并切换成插入模式</td></tr></tbody></table><h6 id="撤销更改"><a href="#撤销更改" class="headerlink" title="撤销更改"></a>撤销更改</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>u</td><td>撤销最近的更改</td></tr><tr><td>#u</td><td>撤销之前多次更改</td></tr><tr><td>U</td><td>撤消光标落在这行后所有此行的更改</td></tr><tr><td>Ctrl-r</td><td>重做最后的“撤消”更改</td></tr><tr><td>.</td><td>重复前一个操作</td></tr><tr><td>n.</td><td>重复前一个操作n次</td></tr></tbody></table><hr><h4 id="扩展命令模式"><a href="#扩展命令模式" class="headerlink" title="扩展命令模式"></a>扩展命令模式</h4><h5 id="扩展命令模式下的简单命令用法："><a href="#扩展命令模式下的简单命令用法：" class="headerlink" title="扩展命令模式下的简单命令用法："></a>扩展命令模式下的简单命令用法：</h5><p>在命令模式下按<code>:</code>进入扩展命令模式，进入后，编辑器的底部左下角会出现一个命令提示符，在这个命令提示符后面输入命令，可以进行扩展命令模式下的操作。</p><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>w</td><td>写（存）磁盘文件</td></tr><tr><td>wq</td><td>写入并退出</td></tr><tr><td>x</td><td>写入并退出</td></tr><tr><td>q</td><td>退出</td></tr><tr><td>q！</td><td>不存盘退出，即使更改都将丢失</td></tr><tr><td>r filename</td><td>读文件内容到当前文件中</td></tr><tr><td>w filename</td><td>将当前文件内容写入另一个文件</td></tr><tr><td>!command</td><td>执行命令</td></tr><tr><td>r!command</td><td>读入命令的输出</td></tr></tbody></table><h5 id="扩展命令模式：地址定界"><a href="#扩展命令模式：地址定界" class="headerlink" title="扩展命令模式：地址定界"></a>扩展命令模式：地址定界</h5><p><em>在扩展命令模式下进行地址定界方法一：利用行数进行定界</em><br><strong>格式</strong> <code>:开始#，结束#</code></p><table><thead><tr><th>用法</th><th>含义</th></tr></thead><tbody><tr><td>#</td><td>具体第#行，例如2表示第2行</td></tr><tr><td>#,#</td><td>从左侧#表示起始行，到右侧#表示结尾行</td></tr><tr><td>#,+#</td><td>从左侧#表示的起始行，加上右侧#表示的行数</td></tr><tr><td>2,+3</td><td>表示2到5行</td></tr><tr><td>.</td><td>表示当前行</td></tr><tr><td>$</td><td>表示最后一行</td></tr><tr><td>. ,$-1</td><td>当前行到倒数第二行</td></tr><tr><td>%</td><td>全文, 相当于1,$</td></tr></tbody></table><p><em>在扩展命令模式下进行地址定界方法二：利用正则进行定界</em></p><p><strong>格式 </strong><code>:/正则1/,/正则2/</code> </p><p>从第一次被pat1模式匹配到的行开始，一直到第一次被pat2匹配到的行结束。</p><table><thead><tr><th>用法</th><th>含义</th></tr></thead><tbody><tr><td>#,/pat/</td><td>从第#行开始，一直到第一次被pat匹配到的行结束</td></tr><tr><td>/pat/,$</td><td>从第一次被pat模式匹配到的行开始，到行尾结束</td></tr></tbody></table><p><em>扩展使用方式：后跟一个编辑命令</em></p><p><strong>格式1</strong> <code>:/正则1/,/正则2/ cmd</code> </p><p><strong>格式2</strong> <code>:#,# cmd</code></p><table><thead><tr><th>用法</th><th>含义</th></tr></thead><tbody><tr><td>d</td><td>删除匹配到的内容</td></tr><tr><td>y</td><td>复制匹配到的内容</td></tr><tr><td>w file</td><td>将范围内的行另存至指定文件中</td></tr><tr><td>r file</td><td>在指定位置插入指定文件中的所有内容</td></tr></tbody></table><h5 id="扩展命令模式：查找"><a href="#扩展命令模式：查找" class="headerlink" title="扩展命令模式：查找"></a>扩展命令模式：查找</h5><h6 id="查找命令："><a href="#查找命令：" class="headerlink" title="查找命令："></a>查找命令：</h6><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>/PATTERN</td><td>从当前光标所在处向文件尾部查找</td></tr><tr><td>?PATTERN</td><td>从当前光标所在处向文件首部查找</td></tr><tr><td>n</td><td>与命令同方向</td></tr><tr><td>N</td><td>与命令反方向</td></tr></tbody></table><h5 id="扩展命令模式：查找并替换"><a href="#扩展命令模式：查找并替换" class="headerlink" title="扩展命令模式：查找并替换"></a>扩展命令模式：查找并替换</h5><p>扩展命令模式下，在命令提示符后面输入字母<code>s</code>，然后按格式输入要查找和替换的内容，便可进行查找替换。<br><strong>格式</strong>  <code>:s/要查找的内容/替换为的内容/修饰符</code></p><table><thead><tr><th>格式项</th><th>作用</th></tr></thead><tbody><tr><td>要查找的内容</td><td>分割符后输入要查找的内容，可使用模式，也就是正则表达式</td></tr><tr><td>替换为的内容</td><td>不能使用模式，但可以使用\1, \2, …等后向引用符号；还可以使用“&amp;”引用前面查找时查找到的整个内容</td></tr></tbody></table><table><thead><tr><th>修饰符</th><th>作用</th></tr></thead><tbody><tr><td>i</td><td>忽略大小写</td></tr><tr><td>g</td><td>全局替换；默认情况下，每一行只替换第一次出现</td></tr><tr><td>gc</td><td>全局替换，每次替换前询问</td></tr></tbody></table><p><strong>Note：</strong>如果查找和替换的内容中包含路径，再使用”/“作为分割符就不方便了，这时可以使用@、#等特殊符号来做分割符。<br><em>例如：</em></p><p><code>s@/etc@/var@g</code></p><p><code>s#/boot#/#i</code></p><hr><h4 id="vim的寄存器"><a href="#vim的寄存器" class="headerlink" title="vim的寄存器"></a>vim的寄存器</h4><ul><li>有26个命名寄存器和1个无命名寄存器，常存放不同的剪贴版内容，可以不同会话间共享</li><li>寄存器名称a，b,…,z,格式：“寄存器放在数字和命令之间<br>如：3”tyy 表示复制3行到t寄存器中<br> “tp 表示将t寄存器内容粘贴</li><li>未指定，将使用无命名寄存器</li><li>有10个数字寄存器，用0，1，…，9表示，0存放最近复制内容，1存放最近删除内容。当新的文本变更和删除时，1转存到2，2转存到3，以此类推。数字寄存器不能在不同会话间共享</li></ul><h4 id="编辑二进制文件"><a href="#编辑二进制文件" class="headerlink" title="编辑二进制文件"></a>编辑二进制文件</h4><ul><li>以二进制方式打开文件，例如：<code>vim –b binaryfile</code></li><li>扩展命令模式下，利用xxd命令转换为可读的十六进制，例如：<code>:%!xxd</code></li><li>扩展命令模式下，利用xxd命令转换回二进制，进行二进制文件的编辑。例如：<code>:%!xxd –r</code></li></ul><h4 id="可视化模式"><a href="#可视化模式" class="headerlink" title="可视化模式"></a>可视化模式</h4><p>在可视化模式下允许移动光标选择文本块，选中的文字可被删除，复制，变更，过滤，搜索，替换等。</p><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>v</td><td>命令模式下，进入面向字符的可视化模式</td></tr><tr><td>V</td><td>命令模式下，进入面向行的可视化模式</td></tr><tr><td>ctrl-v</td><td>命令模式下，进入面向块的可视化模式</td></tr><tr><td>w</td><td>选择一个单词</td></tr><tr><td>)</td><td>选择一句</td></tr><tr><td>}</td><td>选择一段</td></tr><tr><td>箭头</td><td>字符间移动</td></tr></tbody></table><h4 id="多文件模式"><a href="#多文件模式" class="headerlink" title="多文件模式"></a>多文件模式</h4><p>多文件模式可以同时打开多个文件进行编辑</p><p><strong>用法：</strong><code>vim   FILE1  FILE2  FILE3 ...</code></p><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>:next</td><td>下一个</td></tr><tr><td>:prev</td><td>前一个</td></tr><tr><td>:first</td><td>第一个</td></tr><tr><td>:last</td><td>最后一个</td></tr><tr><td>:wall</td><td>保存所有</td></tr><tr><td>:qall</td><td>退出所有</td></tr><tr><td>:wqall</td><td>保存退出所有</td></tr></tbody></table><h4 id="使用多个“窗口”"><a href="#使用多个“窗口”" class="headerlink" title="使用多个“窗口”"></a>使用多个“窗口”</h4><p>多窗口模式可以同时打开多个窗口进行编辑，<br><strong>用法：</strong> <code>vim -o|-O FILE1 FILE2 ...</code></p><ul><li>-o: 水平分割</li><li>-O: 垂直分割</li><li>在窗口间切换：Ctrl+w </li></ul><p><strong>单文件窗口分割方法：</strong></p><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>Ctrl+w,s  或  :split</td><td>水平分割</td></tr><tr><td>Ctrl+w,v  或  :vertical</td><td>垂直分割</td></tr><tr><td>ctrl+w , q</td><td>取消相邻窗口</td></tr><tr><td>ctrl+w , o</td><td>取消全部窗口</td></tr><tr><td>:wqall</td><td>退出</td></tr></tbody></table><h4 id="关闭文件"><a href="#关闭文件" class="headerlink" title="关闭文件"></a>关闭文件</h4><h5 id="扩展模式退出编辑器："><a href="#扩展模式退出编辑器：" class="headerlink" title="扩展模式退出编辑器："></a>扩展模式退出编辑器：</h5><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>:q</td><td>退出</td></tr><tr><td>:q!</td><td>强制退出，丢弃做出的修改</td></tr><tr><td>:wq</td><td>保存退出</td></tr><tr><td>:x</td><td>保存退出</td></tr></tbody></table><h5 id="命令模式下退出编辑器："><a href="#命令模式下退出编辑器：" class="headerlink" title="命令模式下退出编辑器："></a>命令模式下退出编辑器：</h5><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>ZZ</td><td>保存退出</td></tr><tr><td>ZQ</td><td>不保存退出</td></tr></tbody></table><hr><h4 id="定制vim的工作特性"><a href="#定制vim的工作特性" class="headerlink" title="定制vim的工作特性"></a>定制vim的工作特性</h4><p>定义vim的工作特性可以为使用带来许多便利，增加使用乐趣。</p><p><strong>定制vim的工作特性有两种方法:</strong></p><ul><li>一种是将设置写入配置文件，这样可以永久有效。<ul><li>配置文件：永久有效<ul><li>全局：/etc/vimrc  —–&gt;将配置写入此文件将对所有用户有效。</li><li>个人：~/.vimrc ——-&gt;将配置写入此文件只对个人有效。</li></ul></li></ul></li><li>一种方法是在vim的扩展模式下直接设置，只对当前vim进程有效。<ul><li>扩展模式：当前vim进程有效</li></ul></li></ul><p><strong>常用工作特性设置参数：</strong></p><table><thead><tr><th>特性</th><th>参数</th></tr></thead><tbody><tr><td>行号显示</td><td>set number, 简写为set nu</td></tr><tr><td>行号取消显示</td><td>set nonumber, 简写为set nonu</td></tr><tr><td>括号成对匹配</td><td>set showmatch, 简写为set sm</td></tr><tr><td>括号取消成对匹配</td><td>set nosm</td></tr><tr><td>自动缩进启用</td><td>set ai</td></tr><tr><td>自动缩进禁用</td><td>set noai</td></tr><tr><td>高亮搜索启用</td><td>set hlsearch</td></tr><tr><td>高亮搜索禁用</td><td>set nohlsearch</td></tr><tr><td>语法高亮启用</td><td>syntax on</td></tr><tr><td>语法高亮禁用</td><td>syntax off</td></tr><tr><td>忽略字符的大小写启用</td><td>set ic</td></tr><tr><td>忽略字符的大小写不忽略</td><td>set noic</td></tr><tr><td>文件格式启用windows格式</td><td>set fileformat=dos</td></tr><tr><td>文件格式启用unix格式</td><td>set fileformat=unix</td></tr><tr><td>设置文本宽度</td><td>set textwidth=65 (vimonly)</td></tr><tr><td>设置文本宽度</td><td>set wrapmargin=15</td></tr></tbody></table><hr><h3 id="vi-vim内置帮助"><a href="#vi-vim内置帮助" class="headerlink" title="vi/vim内置帮助"></a>vi/vim内置帮助</h3><p>vimtutor 命令是以vim编辑器打开vim帮助文档，在里面可以边看帮助文档边练习操作，非常便捷，是学习vim的必备工具。而且在里面做的修改不会保存。</p><p><em>在扩展命令模式下输入以下命令可以查看vim内置帮助：</em></p><ul><li>help</li><li>helptopic</li><li>help option-list</li><li>setor:set all</li></ul><blockquote><p><strong>推荐Vim好文一篇：</strong><a href="https://linux.cn/article-8997-1.html" target="_blank" rel="noopener">https://linux.cn/article-8997-1.html</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;vim简介&quot;&gt;&lt;a href=&quot;#vim简介&quot; class=&quot;headerlink&quot; title=&quot;vim简介&quot;&gt;&lt;/a&gt;vim简介&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;Vim是从vi发展出来的一个文本编辑器。拥有特别丰富和方便的编程功能，例如：代码补完、编译及错误跳转等。在程序员中被广泛使用。和Emacs并列成为类Unix系统用户最喜欢的编辑器。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Command" scheme="http://subtraction.tech/categories/Command/"/>
    
    
      <category term="vim" scheme="http://subtraction.tech/tags/vim/"/>
    
  </entry>
  
  <entry>
    <title>Linux帮助使用方法</title>
    <link href="http://subtraction.tech/Command/Linux%E5%B8%AE%E5%8A%A9%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/"/>
    <id>http://subtraction.tech/Command/Linux帮助使用方法/</id>
    <published>2017-04-29T08:38:43.000Z</published>
    <updated>2018-04-23T12:38:29.313Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>获取帮助的能力决定了Linux水平的高低！这是我在初学Linux时听老司机说过的一句话，后来随着对Linux学习的不断深入，对这句话就更是深有体会。出于对这句话的高度认同，我将平时使用Linux帮助的一些方法与总结，汇总后写成这篇博客。</p><a id="more"></a><p>linux不同于Windows，相对于Windows更加专业化，懂得和接触过的人也相对Windows要少很多，所以我们在使用上遇到问题，也很难像Windows那样在网上可以搜出一大堆问题的解决方案。所以更加专业化的系统在使用上遇到问题时，就需要更加专业化的解决方案。那应当如何获得更加有效的解决方案呢？别担心，方法还是有很多的，你既可以用linux本身自带的强大帮助功能，也可以去软件和系统发行版的官网上获取官方资料。哈哈！能这么方便这要多亏了linux的本身强大和无数前辈们秉承开源精神的无私奉献，才使得我们可以少掉些坑走的更远。在此对那些走在linux道路上的前辈表示感谢。<br>不仅如此，学会使用帮助命令可以大大减轻你学linux的负担，都知道linux是靠命令行操作的，那你知道他有多少命令? 想知道吗？不卖关子了，你在命令行界面连按两下Tab键（就是Q左面的那个键）。没错，你没看错是两千多，而且这还不包括哪些还未安装的命令，你以为这就完了！别忘了每条命令还有着千奇百怪数不清的参数。怕是老司机也不能都记住，我就老老实实去学如何查帮助了。<br> 我在接下来的文章里面总结了一些常用的获取帮助资料的方法，希望在您看后可以帮到你。祝你每天都有收获！</p><hr><h3 id="获取帮助的途径"><a href="#获取帮助的途径" class="headerlink" title="获取帮助的途径"></a>获取帮助的途径</h3><p>获取帮助的途径还是有很多的，但总的来说还是先使用linux本身的帮助工具，不能解决再去网上寻找答案。下面是遇到问题常用的解决途径：</p><ol><li>使用手册（manual）<br>man command</li><li>信息页（info）<br>info command</li><li>帮助（help）<br>help command<br>command –help</li><li>程序自身的帮助文档<br>README （说明）<br>INSTALL  （安装）<br>ChangeLog （更新日志）</li><li>程序官方文档<br>官方站点：Documentation</li><li>发行版的官方文档</li><li>Google</li></ol><hr><h3 id="man"><a href="#man" class="headerlink" title="man"></a>man</h3><p>man命令的实用性非常高，基本上所有的类Unix系统都支持，所以man的使用学习是非常重要的。我们之所以可以man到帮助文档，是因为系统里有帮助文档存在，那man的帮助文档一般都躲在哪？提供man命令帮助的文件存放在/usr/share/man目录下。<br>man工具的功能非常强大，几乎每个命令都有man的“页面”，man页面分组为不同的“章节”统称为Linux手册。</p><h4 id="man命令常用参数："><a href="#man命令常用参数：" class="headerlink" title="man命令常用参数："></a>man命令常用参数：</h4><ul><li>查看man手册页<br>man [章节] keyword<br>这是man命令的使用方法，如：man  5   passwd</li><li>列出所有帮助<br>man -a keyword<br>会为你逐个打开相关的所有手册页</li><li>搜索man手册<br>man -k keyword<br>列出所有包含关键字的文档，在记不清具体关键字时可以用它来搜索。</li><li>列出符合关键字的可用手册页<br>man -f  keyword<br>搜索符合关键字的手册页列出，并标注文档分类，做简单描述。相当于whatis命令。</li><li>打印man帮助文件的路径<br>man -w [章节] keyword</li></ul><h4 id="man命令可用的帮助文档分类有"><a href="#man命令可用的帮助文档分类有" class="headerlink" title="man命令可用的帮助文档分类有:"></a>man命令可用的帮助文档分类有:</h4><table><thead><tr><th>章节</th><th>代表内容</th></tr></thead><tbody><tr><td>1</td><td>用户命令</td></tr><tr><td>2</td><td>内核调用的函数与工具</td></tr><tr><td>3</td><td>常见的函数与函数库</td></tr><tr><td>4</td><td>设备文件及特殊文件的说明</td></tr><tr><td>5</td><td>配置文件</td></tr><tr><td>6</td><td>游戏</td></tr><tr><td>7</td><td>惯例与协议</td></tr><tr><td>8</td><td>管理类的命令</td></tr><tr><td>9</td><td>内核相关的文件</td></tr></tbody></table><h4 id="man帮助段落说明"><a href="#man帮助段落说明" class="headerlink" title="man帮助段落说明"></a>man帮助段落说明</h4><p>一般来讲帮助文件都很长很多，如果你想翻看的话，就要理解帮助文档的目录结构与操作方法，不然看起可是相当的费力。你可以先看一下name明白大概意思，再看description的详细描述说明，注意细节。再看options的每个参数的意思，没有找到想要的信息也别着急，还有see also可以参见相关的文档。</p><p>下图是man帮助的各段落含义说明：</p><table><thead><tr><th>结构名称</th><th>代表意义</th></tr></thead><tbody><tr><td>NAME</td><td>名称及简要说明</td></tr><tr><td>SYNOPSYS</td><td>格式和使用方法说明</td></tr><tr><td>[ ]</td><td>可选内容</td></tr><tr><td>&lt; &gt;</td><td>必选内容</td></tr><tr><td>a\</td><td>b</td><td>二选一</td></tr><tr><td>{ }</td><td>分组</td></tr><tr><td>…</td><td>同一内容可出现多次</td></tr><tr><td>DESCRIPTION</td><td>详细说明</td></tr><tr><td>EXAMPLES</td><td>示例（附带简单说明）</td></tr><tr><td>OVERVIEW</td><td>概述</td></tr><tr><td>DEFAULTS</td><td>默认的功能</td></tr><tr><td>OPTIONS</td><td>可用选项及其介绍说明</td></tr><tr><td>ENVIRONMENT</td><td>环境变量</td></tr><tr><td>FILES</td><td>相关文件</td></tr><tr><td>SEE ALSO</td><td>其它帮助参考</td></tr><tr><td>AUTHOR</td><td>作者</td></tr><tr><td>COPYRIGHT</td><td>版本信息</td></tr><tr><td>REPORTING BUGS</td><td>bug信息</td></tr><tr><td>HISTORY</td><td>维护历史与联系方式</td></tr></tbody></table><hr><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/ihj1b2620k.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/EmG48D0d59.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/biiaaL0mbE.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/9Ij138k1gE.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/i8j8562HdG.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/A7LH13578d.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/7GgbBCCe23.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/J4HCijGeki.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/f7decD33J2.png?imageslim" alt="mark"></p><h4 id="man命令的操作按键"><a href="#man命令的操作按键" class="headerlink" title="man命令的操作按键"></a>man命令的操作按键</h4><p>使用这些快捷键可以快速有效的翻阅帮助文档，搜索和跳转是非常好用的功能。</p><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>空格键</td><td>向下翻一页</td></tr><tr><td>Page Down</td><td>向下翻一页</td></tr><tr><td>Page Up</td><td>向上翻一页</td></tr><tr><td>y , k</td><td>向文件首部翻一行</td></tr><tr><td>e , j</td><td>向文件尾部翻一行</td></tr><tr><td>b</td><td>向文件首部翻屏</td></tr><tr><td>u</td><td>向文件首部翻半屏</td></tr><tr><td>d</td><td>向文件尾部翻半屏</td></tr><tr><td>HOME</td><td>直接前往首页</td></tr><tr><td>END</td><td>直接前往尾页</td></tr><tr><td>1G</td><td>回到文件首部</td></tr><tr><td>G</td><td>翻至文件尾部</td></tr><tr><td>：</td><td>跳转至第#行</td></tr><tr><td>/关键词</td><td>从上至下搜索某个关键词</td></tr><tr><td>?关键词</td><td>从下至上搜索某个关键词</td></tr><tr><td>n</td><td>定位到下一个搜索到的关键词</td></tr><tr><td>N</td><td>定位到上一个搜索到的关键词</td></tr><tr><td>N</td><td>退出帮助文档</td></tr><tr><td>q</td><td>退出帮助文档</td></tr></tbody></table><hr><h3 id="info"><a href="#info" class="headerlink" title="info"></a>info</h3><p>man常用于命令参考，GNU工具info则更适合通用文档参考。info的页面的结构就像一个网站，没有参数，列出所有的页面，每一页分为“节点”,链接节点之前有”<em>“字符提示。 info帮助文档存放在/usr/share/info路径下。</em></p><p><strong>用法：</strong><code>info command</code></p><h3 id="info中的操作按键"><a href="#info中的操作按键" class="headerlink" title="info中的操作按键"></a>info中的操作按键</h3><table><thead><tr><th>按键</th><th>作用</th></tr></thead><tbody><tr><td>空格键</td><td>向下翻一页</td></tr><tr><td>Page Down</td><td>向下翻一页</td></tr><tr><td>Page Up</td><td>向上翻一页</td></tr><tr><td>tab</td><td>在节点之间移动，有节点的地方，通常会以*显示</td></tr><tr><td>Enter</td><td>当光标在节点上面时，按下Enter可以进入该节点</td></tr><tr><td>b</td><td>移动光标到该节点画面当中的第一个节点处</td></tr><tr><td>e</td><td>移动光标到该节点画面当中的最后一个节点处</td></tr><tr><td>n</td><td>前往下一个信息页面</td></tr><tr><td>p</td><td>前往上一个信息页面</td></tr><tr><td>u</td><td>向上移动一层</td></tr><tr><td>s(/)</td><td>在信息页面当中进行搜索</td></tr><tr><td>h</td><td>显示帮助菜单</td></tr><tr><td>?</td><td>指令列表</td></tr><tr><td>q</td><td>退出</td></tr></tbody></table><h5 id="info界面"><a href="#info界面" class="headerlink" title="info界面"></a>info界面</h5><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/1G1GcL8fhD.png?imageslim" alt="mark"></p><h3 id="help"><a href="#help" class="headerlink" title="help"></a>help</h3><p>help也是一个简单易用的帮助命令，不过他在外部命令和内部命令上的用法稍有不同。所以在使用之前可以用type命令查看一下命令的类型，参考不同用法。<strong>用法：</strong><code>type  command</code>       如果输出 XXX is a shell builtin 则是内部命令 ， 其它输出则是外部命令。<br>外部命令：<br><code>command --help  或command -h</code><br>内部命令：<br><code>help command 或man bash</code><br>Help命令可以显示大多数的帮助用法和参数列表，但并非所有的。查阅方法与man相似，可以参考上面man的使用方法。但在内部命令的查询上它比man更加实用。</p><p> <img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/7HCI4d9Ggb.png?imageslim" alt="mark"></p><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/lEBc09m3B8.png?imageslim" alt="mark"></p><hr><h3 id="本地帮助文档"><a href="#本地帮助文档" class="headerlink" title="本地帮助文档"></a>本地帮助文档</h3><p>通过本地文档查看帮助,没有网络也可以获取这些资料，linux内部有很多的文档，这些文档无法用man 或info命令查看，只有进入到/usr/share/doc目录下才能查看，这里面的文件内容非常详尽。而且数量众多，只是/usr/share/doc/下就有1012条目录，这还不包括在这之下的子目录。<br><strong>/usr/share/doc目录下主要包含以下内容:</strong></p><ul><li>安装了的软件包的子目录,包括了这些软件的相关原理说明  </li></ul><ul><li>常见文档：README 、INSTALL 、CHANGES</li><li>不适合其它地方的文档的位置<ul><li>配置文件范例</li><li>HTML/PDF/PS 格式的文档</li><li>授权书详情</li></ul></li></ul><h5 id="usr-share-doc-目录下的子目录"><a href="#usr-share-doc-目录下的子目录" class="headerlink" title="/usr/share/doc/目录下的子目录"></a>/usr/share/doc/目录下的子目录</h5><p> <img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/9GGI7A7BeB.png?imageslim" alt="mark"></p><hr><h3 id="在线帮助"><a href="#在线帮助" class="headerlink" title="在线帮助"></a>在线帮助</h3><p>通过在线文档获取帮助，也是解决问题的常用方法。一般是去系统发行版或第三方软件发行商的官方网站去查找官方资料。当然你也可以去谷歌上看看，还是有一些不错的资料的。我就不建议使用百度了，广告多还查不到多少实用的东西。顺便再介绍两个谷歌的搜索小技巧：</p><ol><li>Openstack file type:pdf   筛选指定类型的文件</li><li>rhcasite:redhat.com  /docs   在指定网站只搜索文档</li></ol><p>常见第三方应用程序官方文档</p><ul><li><a href="http://www.nginx.org" target="_blank" rel="noopener">http://www.nginx.org</a>    </li><li><a href="http://tomcat.apache.org" target="_blank" rel="noopener">http://tomcat.apache.org</a></li><li><a href="http://httpd.apache.org" target="_blank" rel="noopener">http://httpd.apache.org</a></li><li><a href="http://www.python.org" target="_blank" rel="noopener">http://www.python.org</a></li></ul><p>通过发行版官方网站可以获得安装指南、部署指南、虚拟化指南等<br>红帽知识库和官方在线文档链接:</p><ul><li><a href="http://kbase.redhat.com" target="_blank" rel="noopener">http://kbase.redhat.com</a></li><li><a href="http://www.redhat.com/docs" target="_blank" rel="noopener">http://www.redhat.com/docs</a></li><li><a href="http://access.redhat.com" target="_blank" rel="noopener">http://access.redhat.com</a></li></ul><p>比较专业的网站和搜索：</p><ul><li><a href="http://tldp.org" target="_blank" rel="noopener">http://tldp.org</a></li><li><a href="http://www.slideshare.net" target="_blank" rel="noopener">http://www.slideshare.net</a></li><li><a href="http://www.google.com" target="_blank" rel="noopener">http://www.google.com</a></li></ul><h5 id="kbase-redhat-com红帽的知识库网站"><a href="#kbase-redhat-com红帽的知识库网站" class="headerlink" title="kbase.redhat.com红帽的知识库网站"></a>kbase.redhat.com红帽的知识库网站</h5><p><img src="http://p7ds7yr9p.bkt.clouddn.com/blog/180423/Al7h5imkJf.png?imageslim" alt="mark"></p><hr><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>可能你还要问，遇到问题为什么不去求教大神呢！这样查资料不是很慢。呵呵！我只能说大神很忙了。遇到问题还是尽量自己独立解决比较好，平时多和大牛们交流学习，经常使用帮助也有助于能力的提升，说不定那天你也成大神了。一般来说，大神都不会真的去记命令的，只会记忆一些比较重要的，像那些比较少用的命令和参数都是需要的时候去查帮助的，所以不会查帮助，你离大神还有十万八千里。<br>还有最后要强调的一点，由于linux是外国人发明的，所以大部分的帮助文档。都是外国人写的，很少有中文文档，即使有翻译过来的中文文档，也由于翻译水平的不同，而至使有些表达与作者原意不符。所以一开始就老老实实看英文文档吧！即使英语水平并不是很好，也要坚持。利用好手机和电脑上的翻译软件，多查多看，时间久了你就会发现其实并不是很难，英语是必要要掌握的技能。<br>总之会用帮助可以大大提升你的学习效率，提高你的水平。</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;获取帮助的能力决定了Linux水平的高低！这是我在初学Linux时听老司机说过的一句话，后来随着对Linux学习的不断深入，对这句话就更是深有体会。出于对这句话的高度认同，我将平时使用Linux帮助的一些方法与总结，汇总后写成这篇博客。&lt;/p&gt;
    
    </summary>
    
      <category term="Command" scheme="http://subtraction.tech/categories/Command/"/>
    
    
      <category term="man" scheme="http://subtraction.tech/tags/man/"/>
    
  </entry>
  
</feed>
